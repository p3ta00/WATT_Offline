| Section | Question Number | Answer |
| --- | --- | --- |
| Windows Internals | Question 1 | 5.885 |
| Windows Internals | Question 2 | AttachConsole |
| Static Analysis On Linux | Question 1 | 3399c4043c56fea40a8189de302fd889 |
| Static Analysis On Windows | Question 1 | bff6a1000a86f8edf3673d576786ec75b80bed0c458a8ca0bd52d12b74099071 |
| Dynamic Analysis | Question 1 | 127.0.0.1 |
| Code Analysis | Question 1 | Software\\Microsoft\\Windows\\CurrentVersion\\Run |
| Code Analysis | Question 2 | sub\_40A7A3 |
| Debugging | Question 1 | FC4883E4F0E8C0000000415141 |
| Creating Detection Rules | Question 1 | Done |
| Skills Assessment | Question 1 | 1c7243c8f3586b799a5f9a2e4200aa92 |
| Skills Assessment | Question 2 | No |
| Skills Assessment | Question 3 | brbconfig.tmp |
| Skills Assessment | Question 4 | brb.3dtuts.by |
| Skills Assessment | Question 5 | Yes |
| Skills Assessment | Question 6 | CryptDecrypt |

## Acronyms Used in Writeups

| Acronym | Meaning |
| --- | --- |
| STMIP | Spawned Target Machine IP Address |
| STMPO | Spawned Target Machine Port |
| PMVPN | Personal Machine with a Connection to the Academy's VPN |
| PWNIP | Pwnbox IP Address (or PMVPN IP Address) |
| PWNPO | Pwnbox Port (or PMVPN Port) |

# Windows Internals

## Question 1

### "In the C:\\Samples\\MalwareAnalysis directory of this section's target, there is a file called potato.exe. Use pestudio (C:\\Tools\\pestudio\\pestudio) to examine this executable's sections and provide the entropy of the .text section as your answer."

Students need to first connect to the spawned target using RDP with the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution 
```

```
┌─[us-academy-1]─[10.10.14.121]─[htb-ac-594497@htb-k00i1srhur]─[~]
└──╼ [★]$ xfreerdp /v:10.129.205.250 /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution 

[15:24:34:981] [3180:3181] [INFO][com.freerdp.crypto] - creating directory /home/htb-ac-594497/.config/freerdp
[15:24:34:981] [3180:3181] [INFO][com.freerdp.crypto] - creating directory [/home/htb-ac-594497/.config/freerdp/certs]
<SNIP>
```

Then, students need to launch `pestudio` from the Tools directory seen on the Desktop:

![[HTB Solutions/CDSA/z. images/c49621421dd212d7f05376dbbd0d6cb8_MD5.jpg]]

After launching `pestudio`, students need to go to `file` -> `open file` and select `potato.exe`:

![[HTB Solutions/CDSA/z. images/f6c05d0899178e50a3776b4c520a2ca0_MD5.jpg]]

Students need to use the drop down arrow to expand `sections (characteristics > virtualized)`. As a result, the entropy of the `.text` section will be displayed:

![[HTB Solutions/CDSA/z. images/33709ae1f00b08319dfd63d3ddc2fb99_MD5.jpg]]

Answer: `5.885`

# Windows Internals

## Question 2

### "In the C:\\Samples\\MalwareAnalysis directory of this section's target, there is a file called potato.exe. Use x64dbg (C:\\Tools\\x64dbg\\release\\x64) to open this executable and navigate to the Symbols tab. Enter the exported Kernel32.dll function whose name starts with "Attach". Answer format: Attach\_"

From the previously established RDP session, students need to first open `x64dbg`:

![[HTB Solutions/CDSA/z. images/7fc0d2ec8c196e8b5e771f5625fa6cd2_MD5.jpg]]

Then, students need to choose `file` -> `open` , selecting the `potato.exe` file:

![[HTB Solutions/CDSA/z. images/b9526c74a9f9bc5cbe69424597c5fe59_MD5.jpg]]

Subsequently, students need to click the `Symbols` tab, and inspect the `kernel32.dll` module:

![[HTB Solutions/CDSA/z. images/f0f2cfd72dcc9e6f17db5405934bb013_MD5.jpg]]

Students will find the exported function is named `AttachConsole`.

Answer: `AttachConsole`

# Static Analysis on Linux

## Question 1

### "In the /home/htb-student/Samples/MalwareAnalysis directory of this section's target, there is a file called potato.exe. Compute the IMPHASH of this file and submit it as your answer."

Students need to first connect to the spawned target using SSH, with the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
ssh htb-student@STMIP
```

```
┌─[us-academy-1]─[10.10.14.121]─[htb-ac-594497@htb-k00i1srhur]─[~]
└──╼ [★]$ ssh htb-student@10.129.160.133

The authenticity of host '10.129.160.133 (10.129.160.133)' can't be established.
ECDSA key fingerprint is SHA256:0loReoHRiJTAMnDSjRnm+AKJqFgmSa3nrD7TT8SC/qI.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.129.160.133' (ECDSA) to the list of known hosts.
htb-student@10.129.160.133's password: 
Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-122-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage
Last login: Thu Jul 27 01:50:37 2023 from 10.10.14.23

htb-student@remnux:~$ 
```

Then, students need to use `ipmhash_calc.py` to determine the IMPHASH of `potato.exe`:

Code: shell

```shell
python3 imphash_calc.py /home/htb-student/Samples/MalwareAnalysis/potato.exe 
```

```
htb-student@remnux:~$ python3 imphash_calc.py /home/htb-student/Samples/MalwareAnalysis/potato.exe 

3399c4043c56fea40a8189de302fd889
```

Answer: `3399c4043c56fea40a8189de302fd889`

# Static Analysis on Windows

## Question 1

### "In the C:\\Samples\\MalwareAnalysis directory of this section's target, there is a file called dharma\_sample.exe. Calculate the file's SHA256 hash and enter it as your answer."

Students need to first connect to the spawned target using RDP with the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution 
```

```
┌─[us-academy-1]─[10.10.14.121]─[htb-ac-594497@htb-k00i1srhur]─[~]
└──╼ [★]$ xfreerdp /v:10.129.236.19 /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution 

[15:24:34:981] [3180:3181] [INFO][com.freerdp.crypto] - creating directory /home/htb-ac-594497/.config/freerdp
[15:24:34:981] [3180:3181] [INFO][com.freerdp.crypto] - creating directory [/home/htb-ac-594497/.config/freerdp/certs]
<SNIP>
```

Then, students to open `powershell` and use the `Get-FileHash` cmdlet to calculate the SHA256 hash for `dharma_sample.exe`:

Code: powershell

```powershell
Get-FileHash -algorithm sha256 C:\Samples\MalwareAnalysis\dharma_sample.exe
```

```
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:\Users\htb-student> Get-FileHash -algorithm sha256 C:\Samples\MalwareAnalysis\dharma_sample.exe

Algorithm       Hash                                                                   Path
---------       ----                                                                   ----
SHA256          BFF6A1000A86F8EDF3673D576786EC75B80BED0C458A8CA0BD52D12B74099071       C:\Samples\MalwareAnalysis\dh...
```

Answer: `BFF6A1000A86F8EDF3673D576786EC75B80BED0C458A8CA0BD52D12B74099071`

# Dynamic Analysis

## Question 1

### "Use Noriben to perform dynamic analysis on shell.exe. Enter the IP address shell.exe pings as your answer."

Students need to first connect to the spawned target using RDP with the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution
```

```
┌─[us-academy-1]─[10.10.14.121]─[htb-ac-594497@htb-k00i1srhur]─[~]
└──╼ [★]$ xfreerdp /v:10.129.236.19 /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution 

[15:24:34:981] [3180:3181] [INFO][com.freerdp.crypto] - creating directory /home/htb-ac-594497/.config/freerdp
[15:24:34:981] [3180:3181] [INFO][com.freerdp.crypto] - creating directory [/home/htb-ac-594497/.config/freerdp/certs]
<SNIP>
```

Next, students need to open a Command Prompt and launch `Noriben.py`:

Code: cmd

```cmd
cd C:\Tools\Noriben-master
.\Noriben.py
```

```
Microsoft Windows [Version 10.0.19043.928]
(c) Microsoft Corporation. All rights reserved.

C:\Users\htb-student>cd C:\Tools\Noriben-master

C:\Tools\Noriben-master>python .\Noriben.py

--===[ Noriben v1.8.8
[*] Using filter file: ProcmonConfiguration.PMC
[*] Using procmon EXE: C:\ProgramData\chocolatey\bin\procmon.exe
[*] Procmon session saved to: Noriben_07_Aug_23__07_59_219622.pml
[*] Launching Procmon ...
```

Subsequently, students need to run `shell.exe` :

![[HTB Solutions/CDSA/z. images/01152420e75bd985fcc924276ff0a7cb_MD5.jpg]]

Closing the `Sandbox detected` window, students need to allow several minutes for `shell.exe` to finish running. Once complete, students need to terminate `ProcMon`, then use `Ctrl+C` to cancel Noriben:

```
--===[ Noriben v1.8.8
[*] Using filter file: ProcmonConfiguration.PMC
[*] Using procmon EXE: C:\ProgramData\chocolatey\bin\procmon.exe
[*] Procmon session saved to: Noriben_07_Aug_23__08_17_369897.pml
[*] Launching Procmon ...
[*] Procmon is running. Run your executable now.
[*] When runtime is complete, press CTRL+C to stop logging.

[*] Termination of Procmon commencing... please wait
[*] Procmon terminated
[*] Saving report to: Noriben_07_Aug_23__08_17_369897.txt
[*] Saving timeline to: Noriben_07_Aug_23__08_17_369897_timeline.csv
[*] Exiting with error code: 0: Normal exit
```

Finally, students need to inspect the resulting `.txt` file that was generated, discovering that the `shell.exe` program pings the loopback IP address at `127.0.0.1`:

![[HTB Solutions/CDSA/z. images/9c9c78a923d9bf1bb43fd664537048c1_MD5.jpg]]

Answer: `127.0.0.1`

# Code Analysis

## Question 1

### "Download additional\_samples.zip from this module's resources (available at the upper right corner) and transfer the .zip file to this section's target. Unzip additional\_samples.zip (password: infected) and use IDA to analyze orange.exe. Enter the registry key that it modifies for persistence as your answer. Answer format: SOFTWARE\_\_\_\_"

Students need to first download the `additional_samples.zip` archive to their attack host:

Code: shell

```shell
wget https://academy.hackthebox.com/storage/resources/additional_samples.zip
```

```
┌─[us-academy-1]─[10.10.14.121]─[htb-ac-594497@htb-k00i1srhur]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/resources/additional_samples.zip

--2023-08-07 16:34:55--  https://academy.hackthebox.com/storage/resources/additional_samples.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.21.126, 104.18.20.126, 2606:4700::6812:157e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.21.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 69392 (68K) [application/zip]
Saving to: ‘additional_samples.zip’

additional_samples. 100%[===================>]  67.77K  --.-KB/s    in 0.002s  

2023-08-07 16:34:55 (38.0 MB/s) - ‘additional_samples.zip’ saved [69392/69392]
```

Subsequently, students need to now connect to the spawned target using RDP with the credentials `htb-student:HTB_@cademy_stdnt!`, while utilizing a shared drive:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution /drive:share,/home/htb-ac-XXXXXX
```

```
┌─[us-academy-1]─[10.10.14.121]─[htb-ac-594497@htb-k00i1srhur]─[~]
└──╼ [★]$ xfreerdp /v:10.129.33.33 /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution /drive:share,/home/htb-ac-594497

[16:36:38:793] [5006:5007] [WARN][com.freerdp.crypto] - Certificate verification failure 'self signed certificate (18)' at stack position 0
[16:36:38:793] [5006:5007] [WARN][com.freerdp.crypto] - CN = DESKTOP-VJF8GH8
[16:36:39:096] [5006:5007] [INFO][com.freerdp.gdi] - Local framebuffer format  PIXEL_FORMAT_BGRX32
<SNIP>
```

Once connected, students need to transfer the `additonal_samples.zip` file to the target machine, by way of the shared drive:

![[HTB Solutions/CDSA/z. images/2036ff0395902efd8969ab22fc20d046_MD5.jpg]]

Students need to unzip it (providing '`infected`' as the password) to extract the contents. Consequently, students need to run `IDA` as administrator, selecting `New` and choosing the `orange.exe` file for analysis:

![[HTB Solutions/CDSA/z. images/2fcbdbd1dae7e459f61b3c2007d85bdc_MD5.jpg]]

Then, students need to inspect the `sub_40A908` function:

![[HTB Solutions/CDSA/z. images/bd6ba683a7e7c6fb1cc988cebf5e716e_MD5.jpg]]

This section uses the `wsprintfA` function to format a string and generate a desired registry path. The function takes a format string, in this case `aSoftSicSfSindS`, which contains format specifiers (`%s`).

The previous pushed strings like "`n\R`", "`rsi`", etc. are used to replace the `%s` specifiers in the format string. The final output will be the complete registry path which is stored in the `SubKey` local variable. Based on the given strings, this will form the registry path `Software\Microsoft\Windows\CurrentVersion\Run`.

Answer: `Software\Microsoft\Windows\CurrentVersion\Run`

# Code Analysis

## Question 2

### "Download additional\_samples.zip from this module's resources (available at the upper right corner) and transfer the .zip file to this section's target. Unzip additional\_samples.zip (password: infected) and use IDA to analyze orange.exe. Enter the name of the function that is holding the name of the file intrenat.exe that orange.exe drops as your answer. Answer format: sub\_4XXXX3"

Students need to first download the `additional_samples.zip` archive to their attack host:

Code: cmd

```cmd
wget https://academy.hackthebox.com/storage/resources/additional_samples.zip
```

```
┌─[us-academy-1]─[10.10.14.121]─[htb-ac-594497@htb-k00i1srhur]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/resources/additional_samples.zip

--2023-08-07 16:34:55--  https://academy.hackthebox.com/storage/resources/additional_samples.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.21.126, 104.18.20.126, 2606:4700::6812:157e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.21.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 69392 (68K) [application/zip]
Saving to: ‘additional_samples.zip’

additional_samples. 100%[===================>]  67.77K  --.-KB/s    in 0.002s  

2023-08-07 16:34:55 (38.0 MB/s) - ‘additional_samples.zip’ saved [69392/69392]
```

Subsequently, students need to now connect to the spawned target using RDP with the credentials `htb-student:HTB_@cademy_stdnt!`, while utilizing a shared drive:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution /drive:share,/home/htb-ac-XXXXXX
```

```
┌─[us-academy-1]─[10.10.14.121]─[htb-ac-594497@htb-k00i1srhur]─[~]
└──╼ [★]$ xfreerdp /v:10.129.33.33 /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution /drive:share,/home/htb-ac-594497

[16:36:38:793] [5006:5007] [WARN][com.freerdp.crypto] - Certificate verification failure 'self signed certificate (18)' at stack position 0
[16:36:38:793] [5006:5007] [WARN][com.freerdp.crypto] - CN = DESKTOP-VJF8GH8
[16:36:39:096] [5006:5007] [INFO][com.freerdp.gdi] - Local framebuffer format  PIXEL_FORMAT_BGRX32
<SNIP>
```

Once connected, students need to transfer the `additonal_samples.zip` file to the target machine, by way of the shared drive:

![[HTB Solutions/CDSA/z. images/2036ff0395902efd8969ab22fc20d046_MD5.jpg]]

Students need to unzip it (providing '`infected`' as the password) to extract the contents. Consequently, students need to run `IDA` as administrator, selecting `New` and choosing the `orange.exe` file for analysis:

![[HTB Solutions/CDSA/z. images/2fcbdbd1dae7e459f61b3c2007d85bdc_MD5.jpg]]

Then, students need to inspect the various functions within the program, honing in specifically on the `sub_40A7A3` function:

![[HTB Solutions/CDSA/z. images/e351535a801de9e507172fd775acc00b_MD5.jpg]]

Here, students will find the file name of `intrenat.exe`.

Answer: `sub_40A7A3`

# Debugging

## Question 1

### "Reproduce all the debugging procedures mentioned in this section and provide the hidden shellcode-related hex values from the final screenshot as your answer. Remove all spaces."

Students need to begin by making the following changes to the `inetsim.conf` file:

```
service_bind_address <Our machine's/VM's TUN IP>
dns_default_ip <Our machine's/VM's TUN IP>
dns_default_hostname www
dns_default_domainname iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com
```

Code: shell

```shell
sudo nano /etc/inetsim/inetsim.conf
```

![[HTB Solutions/CDSA/z. images/8b576dcb9a7234953b51f9083e0845ae_MD5.jpg]]

![[HTB Solutions/CDSA/z. images/219d2520ead211b4f85a3b37eff93f0d_MD5.jpg]]

Afterwards, students need to run `inetsim`:

Code: shell

```shell
sudo inetsim
```

```
┌─[us-academy-1]─[10.10.15.183]─[htb-ac-594497@htb-19y2etcd35]─[~]
└──╼ [★]$ sudo inetsim

INetSim 1.3.2 (2020-05-19) by Matthias Eckert & Thomas Hungenberg
Main logfile '/var/log/inetsim/main.log' does not exist. Trying to create it...
Main logfile '/var/log/inetsim/main.log' successfully created.
Sub logfile '/var/log/inetsim/service.log' does not exist. Trying to create it...
Sub logfile '/var/log/inetsim/service.log' successfully created.
Debug logfile '/var/log/inetsim/debug.log' does not exist. Trying to create it...
Debug logfile '/var/log/inetsim/debug.log' successfully created.
Using log directory:      /var/log/inetsim/
Using data directory:     /var/lib/inetsim/
Using report directory:   /var/log/inetsim/report/
Using configuration file: /etc/inetsim/inetsim.conf
Parsing configuration file.
Configuration file parsed successfully.
=== INetSim main process started (PID 5789) ===
Session ID:     5789
Listening on:   10.10.15.183
Real Date/Time: 2024-03-26 17:32:30
Fake Date/Time: 2024-03-26 17:32:30 (Delta: 0 seconds)
 Forking services...
  * dns_53_tcp_udp - started (PID 5793)
  * dummy_1_tcp - started (PID 5820)
  * chargen_19_udp - started (PID 5819)
  * syslog_514_udp - started (PID 5807)
  * ident_113_tcp - started (PID 5806)
  * smtp_25_tcp - started (PID 5796)
  * daytime_13_udp - started (PID 5811)
  * http_80_tcp - failed!
  * quotd_17_udp - started (PID 5817)
  * time_37_tcp - started (PID 5808)
  * quotd_17_tcp - started (PID 5816)
  * echo_7_udp - started (PID 5813)
  * time_37_udp - started (PID 5809)
  * daytime_13_tcp - started (PID 5810)
  * irc_6667_tcp - started (PID 5803)
  * echo_7_tcp - started (PID 5812)
  * ntp_123_udp - started (PID 5804)
  * discard_9_tcp - started (PID 5814)
  * tftp_69_udp - started (PID 5802)
  * chargen_19_tcp - started (PID 5818)
  * dummy_1_udp - started (PID 5821)
  * discard_9_udp - started (PID 5815)
  * finger_79_tcp - started (PID 5805)
  * smtps_465_tcp - started (PID 5797)
  * pop3s_995_tcp - started (PID 5799)
  * ftp_21_tcp - started (PID 5800)
  * https_443_tcp - started (PID 5795)
  * pop3_110_tcp - started (PID 5798)
  * ftps_990_tcp - started (PID 5801)
 done.
Simulation running.
```

Next, students need connect to the spawned target using RDP with the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution
```

```
┌─[us-academy-2]─[10.10.15.183]─[htb-ac-594497@htb-19y2etcd35]─[~]
└──╼ [★]$ xfreerdp /v:10.129.205.250 /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution 

[17:33:49:722] [5838:5839] [INFO][com.freerdp.crypto] - creating directory /home/htb-ac-594497/.config/freerdp
[17:33:49:722] [5838:5839] [INFO][com.freerdp.crypto] - creating directory [/home/htb-ac-594497/.config/freerdp/certs]
[17:33:49:722] [5838:5839] [INFO][com.freerdp.crypto] - created directory [/home/htb-ac-594497/.config/freerdp/server]
```

After connecting, students need to set the spawned target's DNS to be pointed at their attack host. Therefore, students must navigate to `Control Panel` -> `Network and Internet` -> `Network Connections`, and adjust the DNS server in the ipv4 settings:

![[HTB Solutions/CDSA/z. images/3e212ce45e3796b0c6c77afbec253a91_MD5.jpg]]

Subsequently, students need to launch `x64dbg` then set the Entry Breakpoint:

![[HTB Solutions/CDSA/z. images/fc173c28c1b5cc9dbdf87b00063b7e0e_MD5.jpg]]

Additionally, students need to adjust the font size of the `x64dbg` application by navigating to `Options` -> `Appearance` -> `Font` -> `Application Font*`, selecting a larger font size. Then, students need to close and re-launch `x64dbg`:

![[HTB Solutions/CDSA/z. images/6bd4dbe7bd7d788532299d161e3790d4_MD5.jpg]]

Now, students need to open `shell.exe` in the debugger. Then, students need to `Search for` > `Current Module` > `String references`:

![[HTB Solutions/CDSA/z. images/fd7c4baf0dab5b6f2545f7a070dc5f3a_MD5.jpg]]

![[HTB Solutions/CDSA/z. images/aaa4d63c7918047afe3be5359770c66a_MD5.jpg]]

Students need to modify the instruction for each instance of the `"sandbox detected!"` string. Starting from the bottom, students need to double click the string to go to the address of the instruction:

![[HTB Solutions/CDSA/z. images/3fdd127ab0e796bf834ceab5e0045cd5_MD5.jpg]]

The `cmp dword ptr ss:[rsp+0x30], 0x1` instruction will be changed to `cmp dword ptr ss:[rsp+0x30], 0x0`.

Students need to repeat this step, altering the instructions for the other two instances of the `"sandbox detected"` string, starting from the second to last:

![[HTB Solutions/CDSA/z. images/b56d2c6d12b3e5a30aad7ccb183b9968_MD5.jpg]]

The `je` instruction will be changed to `jne`.

Finally, students need to adjust the first `sandbox detected` string:

![[HTB Solutions/CDSA/z. images/ece849b6b8297f827d5cd765dc38b6d9_MD5.jpg]]

The `jne` instruction becomes `jmp`.

After making the changes, students need to save the patched executable by pressing `Ctrl+P` -> `Patch File` , choosing `patched_shell.exe` as the file name and saving it to the Desktop:

![[HTB Solutions/CDSA/z. images/644504af941dfc0fac7b0b2d6ee1ac87_MD5.jpg]]

Students need to run `patched_shell.exe` to confirm that the sandbox detection has been bypassed:

![[HTB Solutions/CDSA/z. images/4e1162d0769050623a1166ec338cc4c1_MD5.jpg]]

Consequently, students need to close `x64dbg` and re-open it, this time opening the `patched_shell.exe` inside the debugger:

![[HTB Solutions/CDSA/z. images/6cc9f0efa92a5949584b0b52bcd98185_MD5.jpg]]

To probe deeper into the process injection, students need to set breakpoints at WINAPI functions `VirtualAllocEx`, `WriteProcessMemory`, and `CreateRemoteThread` by way of the `Symbols` tab:

![[HTB Solutions/CDSA/z. images/010f3c7488521b5ade7ece6d5ee70efa_MD5.jpg]]

![[HTB Solutions/CDSA/z. images/b975f3eeedec33bca187bfddd8c3852d_MD5.jpg]]

![[HTB Solutions/CDSA/z. images/90ce3062fd5a5034f400a216e8a0b51f_MD5.jpg]]

After setting the breakpoints, students need to select `Run` from the toolbar until they reach the breakpoint for `WriteProcessMemory`:

![[HTB Solutions/CDSA/z. images/b0f3cd13cc1bc07bc7dd64e5bd712768_MD5.jpg]]

At this point, students need to open another instance of `x64dbg` and attach the `notepad` process:

![[HTB Solutions/CDSA/z. images/4353dc11211c7e50ba0cb72cacbf06bb_MD5.jpg]]

Back to the first debugger running `patched_shell.exe`, students need to copy the value from the `rdx` register:

![[HTB Solutions/CDSA/z. images/6c50929b53b52da2388fce19a2103542_MD5.jpg]]

In the second `x64dbg` instance running `notepad.exe` , students need to right-click on the memory view and `Go to` > `Expression` then paste in the copied address:

![[HTB Solutions/CDSA/z. images/0f29f277c2a9bb4b02c87780e85f74ee_MD5.jpg]]

Finally, students need to go back to the first debugger, and `run` the `patched_shell.exe`.

Checking the second debugger with `notepad` attached, students will find the hidden shellcode-related hex values:

![[HTB Solutions/CDSA/z. images/21a8601b553c9efe379775545acbeef2_MD5.jpg]]

Answer: `FC4883E4F0E8C0000000415141`

# Creating Detection Rules

## Question 1

### "Generate a Yara rule automatically for dharma\_sample.exe, located in the /home/htb-student/Samples/MalwareAnalysis directory, by utilizing yarGen.py. Following this, employ the created Yara rule for the identification of the malware present in the /home/htb-student/Samples/MalwareAnalysis directory, as an exercise. Enter "Done" when you are done practicing."

Students need to first connect to the spawned target using SSH, with the credentials `htb-student:HTB_@cademy_stdnt!`:

Code: shell

```shell
ssh htb-student@10.129.160.133
```

```
┌─[us-academy-1]─[10.10.14.121]─[htb-ac-594497@htb-k00i1srhur]─[~]
└──╼ [★]$ ssh htb-student@10.129.160.133

The authenticity of host '10.129.160.133 (10.129.160.133)' can't be established.
ECDSA key fingerprint is SHA256:0loReoHRiJTAMnDSjRnm+AKJqFgmSa3nrD7TT8SC/qI.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.129.160.133' (ECDSA) to the list of known hosts.
htb-student@10.129.160.133's password: 
Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-122-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage
Last login: Thu Jul 27 01:50:37 2023 from 10.10.14.23

htb-student@remnux:~$ 
```

Then, students need to reproduce the steps shown in the section, copying `dharma_sample.exe` into a new `Test` directory and then running `yarGen.py` to create a list of YARA rules automatically:

Code: shell

```shell
mkdir /home/htb-student/Samples/MalwareAnalysis/Test
cp /home/htb-student/Samples/MalwareAnalysis/dharma_sample.exe /home/htb-student/Samples/MalwareAnalysis/Test/
cd yarGen-0.23.4/
sudo python3 yarGen.py -m /home/htb-student/Samples/MalwareAnalysis/Test/
```

```
htb-student@remnux:~$ mkdir /home/htb-student/Samples/MalwareAnalysis/Test
htb-student@remnux:~$ cp /home/htb-student/Samples/MalwareAnalysis/dharma_sample.exe /home/htb-student/Samples/MalwareAnalysis/Test/
htb-student@remnux:~$ cd yarGen-0.23.4/
htb-student@remnux:~/yarGen-0.23.4$ sudo python3 yarGen.py -m /home/htb-student/Samples/MalwareAnalysis/Test/
[sudo] password for htb-student: 
------------------------------------------------------------------------
                   _____            
    __ _____ _____/ ___/__ ___      
   / // / _ \`/ __/ (_ / -_) _ \     
   \_, /\_,_/_/  \___/\__/_//_/     
  /___/  Yara Rule Generator        
         Florian Roth, July 2020, Version 0.23.3
   
  Note: Rules have to be post-processed
  See this post for details: https://medium.com/@cyb3rops/121d29322282
------------------------------------------------------------------------
[+] Using identifier 'Test'
[+] Using reference 'https://github.com/Neo23x0/yarGen'
[+] Using prefix 'Test'
[+] Processing PEStudio strings ...
[+] Reading goodware strings from database 'good-strings.db' ...
    (This could take some time and uses several Gigabytes of RAM depending on your db size)
[+] Total: 4029 / Added 4029 entries
<SNIP>
[+] Loading ./dbs/good-exports-part5.db ...
[+] Total: 404321 / Added 71962 entries
[+] Processing /home/htb-student/Samples/MalwareAnalysis/Test/dharma_sample.exe ...
[+] Generating statistical data ...
[+] Generating Super Rules ... (a lot of magic)
[+] Generating Simple Rules ...
[-] Applying intelligent filters to string findings ...
[-] Filtering string set for /home/htb-student/Samples/MalwareAnalysis/Test/dharma_sample.exe ...
[=] Generated 1 SIMPLE rules.
[=] All rules written to yargen_rules.yar
[+] yarGen run finished
```

Students need to inspect the contents of the generated `yargen_rules.yar` file:

Code: shell

```shell
cat yargen_rules.yar
```

```
htb-student@remnux:~/yarGen-0.23.4$ cat yargen_rules.yar 
/*
   YARA Rule Set
   Author: yarGen Rule Generator
   Date: 2024-10-07
   Identifier: Test
   Reference: https://github.com/Neo23x0/yarGen
*/

/* Rule Set ----------------------------------------------------------------- */

rule dharma_sample {
   meta:
      description = "Test - file dharma_sample.exe"
      author = "yarGen Rule Generator"
      reference = "https://github.com/Neo23x0/yarGen"
      date = "2024-10-07"
      hash1 = "bff6a1000a86f8edf3673d576786ec75b80bed0c458a8ca0bd52d12b74099071"
   strings:
      $x1 = "C:\\crysis\\Release\\PDB\\payload.pdb" fullword ascii
      $s2 = "sssssbs" fullword ascii
      $s3 = "sssssbsss" fullword ascii
      $s4 = "{RDqP^\\" fullword ascii
      $s5 = "QtVN$0w" fullword ascii
      $s6 = "RSDS%~m" fullword ascii
      $s7 = "$m@J:b" fullword ascii
      $s8 = "YXSHbh" fullword ascii
      $s9 = ")$ATou" fullword ascii
      $s10 = "T2-*6L" fullword ascii
      $s11 = "_i%K)j" fullword ascii
      $s12 = ")Pg,U{" fullword ascii
      $s13 = ") ])~2'X" fullword ascii
      $s14 = "9Fm*EK" fullword ascii
      $s15 = "ipgypA" fullword ascii
      $s16 = "H;B cl" fullword ascii
      $s17 = "&KP6IG" fullword ascii
      $s18 = "0[ :FZ" fullword ascii
      $s19 = "A!6\`pT" fullword ascii
      $s20 = ")3ty/\\" fullword ascii
   condition:
      uint16(0) == 0x5a4d and filesize < 300KB and
      1 of ($x*) and 4 of them
}
```

Subsequently, students need to use this rule to scan the `MalwareAnalysis` directory:

Code: shell

```shell
yara /home/htb-student/yarGen-0.23.4/yargen_rules.yar /home/htb-student/Samples/MalwareAnalysis/
```

```
htb-student@remnux:~/yarGen-0.23.4$ yara /home/htb-student/yarGen-0.23.4/yargen_rules.yar /home/htb-student/Samples/MalwareAnalysis/

dharma_sample /home/htb-student/Samples/MalwareAnalysis//dharma_sample.exe
```

Students will notice that `dharma_sample.exe` was returned. Once finished, students need to submit `Done` to complete the section.

Answer: `Done`

# Skills Assessment

## Question 1

### "Enter the MD5 hash of the malware as your answer."

Students need to first download the `additional_samples.zip` archive to their attack host:

Code: shell

```shell
wget https://academy.hackthebox.com/storage/resources/additional_samples.zip
```

```
┌─[us-academy-1]─[10.10.14.121]─[htb-ac-594497@htb-k00i1srhur]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/resources/additional_samples.zip

--2023-08-07 16:34:55--  https://academy.hackthebox.com/storage/resources/additional_samples.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.21.126, 104.18.20.126, 2606:4700::6812:157e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.21.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 69392 (68K) [application/zip]
Saving to: ‘additional_samples.zip’

additional_samples. 100%[===================>]  67.77K  --.-KB/s    in 0.002s  

2023-08-07 16:34:55 (38.0 MB/s) - ‘additional_samples.zip’ saved [69392/69392]
```

Subsequently, students need to now connect to the spawned target using RDP with the credentials `htb-student:HTB_@cademy_stdnt!`, while utilizing a shared drive:

Code: shell

```shell
xfreerdp /v:STMIP /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution /drive:share,/home/htb-ac-XXXXXX
```

```
┌─[us-academy-1]─[10.10.14.121]─[htb-ac-594497@htb-k00i1srhur]─[~]
└──╼ [★]$ xfreerdp /v:10.129.205.250 /u:htb-student /p:HTB_@cademy_stdnt! /dynamic-resolution /drive:share,/home/htb-ac-594497

[16:36:38:793] [5006:5007] [WARN][com.freerdp.crypto] - Certificate verification failure 'self signed certificate (18)' at stack position 0
[16:36:38:793] [5006:5007] [WARN][com.freerdp.crypto] - CN = DESKTOP-VJF8GH8
[16:36:39:096] [5006:5007] [INFO][com.freerdp.gdi] - Local framebuffer format  PIXEL_FORMAT_BGRX32
<SNIP>
```

Once connected, students need to transfer the `additonal_samples.zip` file to the target machine, by way of the shared drive:

![[HTB Solutions/CDSA/z. images/2036ff0395902efd8969ab22fc20d046_MD5.jpg]]

After dropping the archive to the desktop, students need to unzip it (providing '`infected`' as the password) and extract the contents.

Subsequently, students need to press `shift` + `right-click` inside the newly extracted directory, selecting `Open Powershell window here`:

![[HTB Solutions/CDSA/z. images/d7b1ed1fd82c39b1b10e87bc3094531e_MD5.jpg]]

Here, students need to utilize the `Get-FileHash` cmdlet to calculate the MD5 hash of `apple.exe`:

Code: powershell

```powershell
Get-FileHash -algorithm md5 .\additional_samples\apple.exe
```

```
PS C:\Users\htb-student\Desktop\additional_samples> Get-FileHash -algorithm md5 .\additional_samples\apple.exe

Algorithm       Hash                                                                   Path
---------       ----                                                                   ----
MD5             1C7243C8F3586B799A5F9A2E4200AA92                                       C:\Users\htb-student\Desktop\additional_samples\additional_samples\apple.exe
```

Answer: `1C7243C8F3586B799A5F9A2E4200AA92`

# Skills Assessment

## Question 2

### "Does the malware employ packing techniques? Answer format: Yes/No"

From the previously established RDP session, students need to open a powershell window in the previously extracted `additional_samples` directory. Then, students need to use `strings` against the `apple.exe` malware sample:

Code: powershell

```powershell
strings .\additional_samples\apple.exe
```

```
PS C:\Users\htb-student\Desktop\additional_samples> strings .\additional_samples\apple.exe

Strings v2.54 - Search for ANSI and Unicode strings in binary images.
Copyright (C) 1999-2021 Mark Russinovich
Sysinternals - www.sysinternals.com

!This program cannot be run in DOS mode.
S{@
Rich
.text
\`.rdata
@.data
.pdata
@.rsrc
@.reloc
WATAUH
t{H
tkH
\$@H
l$HH
t$PH
<SNIP>
```

Noting the lack of any `UPX` strings in the output, students should conclude that the malware is not employing any packing techniques.

Answer: `No`

# Skills Assessment

## Question 3

### "It appears that the malware is dropping a .tmp file following the infection. Enter the complete name of this .tmp file as your answer. Answer format: \_.tmp"

From the previously established RDP session, students need to use File Explorer to view the contents of the extracted `additional_samples` directory. Then, students need to double-click `apple.exe` run the malware sample:

![[HTB Solutions/CDSA/z. images/5fdd4f15cd266eaf0ac62e9883e692ae_MD5.jpg]]

Students will find the program creates a `brbconfig.tmp` file inside the working directory.

Additionally, students can run `Noriben.py` , waiting to run `apple.exe` until after `procmon` launches. Then, students need to examine the output of the corresponding `.txt` file generated:

Code: cmd

```cmd
cd C:\Tools\Noriben-master
.\Noriben.py
```

```
Microsoft Windows [Version 10.0.19043.928]
(c) Microsoft Corporation. All rights reserved.

C:\Users\htb-student>cd C:\Tools\Noriben-master

C:\Tools\Noriben-master>python .\Noriben.py

--===[ Noriben v1.8.8
[*] Using filter file: ProcmonConfiguration.PMC
[*] Using procmon EXE: C:\ProgramData\chocolatey\bin\procmon.exe
[*] Procmon session saved to: Noriben_09_Aug_23__10_35_139661.pml
[*] Launching Procmon ...
[*] Procmon is running. Run your executable now.
[*] When runtime is complete, press CTRL+C to stop logging.

[*] Termination of Procmon commencing... please wait
[*] Procmon terminated
[*] Saving report to: Noriben_09_Aug_23__10_35_139661.txt
[*] Saving timeline to: Noriben_09_Aug_23__10_35_139661_timeline.csv
[*] Exiting with error code: 0: Normal exit
```

![[HTB Solutions/CDSA/z. images/4ddfffd473af4ac07e8255f842a09481_MD5.jpg]]

Answer: `brbconfig.tmp`

# Skills Assessment

## Question 4

### "Examine the communication patterns of the malware and provide the domain it interacts with as your answer. Answer format: \_.\_.\_"

From the previously established RDP session, students need to run `wireshark` as administrator and begin listening on the `ethernet0 2` interface. Additionally, students need to add a display filter, filtering out any traffic associated with their attack host IP:

```
ip.addr != PWNIP
```

Then, students need to run `apple.exe` and observe the traffic:

![[HTB Solutions/CDSA/z. images/56d93074d3da5fde9d56c6a866766b0a_MD5.jpg]]

Quickly, students will observe the malware trying to interact with `brb.3dtuts.by`.

Answer: `brb.3dtuts.by`

# Skills Assessment

## Question 5

### "Does the malware achieve persistence by altering the Software\\Microsoft\\Windows\\CurrentVersion\\Run registry key? Answer format: Yes/No"

From the previously established RDP session, students need to launch `ida` as administrator, selecting `New` -> `Disassemble a new file` and choosing `apple.exe` as the program to attach. Then, students need to select `Search` -> `Text`:

![[HTB Solutions/CDSA/z. images/743008e7124fb4e2c9567d70970923ce_MD5.jpg]]

Subsequently, students need to enter "`\run`" as the string to search for:

![[HTB Solutions/CDSA/z. images/1f6107de97883d7eff0fb9b3bb0d2424_MD5.jpg]]

Students will be taken to the text view, where the disassembled code shows evidence that the program indeed tries to interact with the `Software\Microsoft\Windows\CurrentVersion\Run` registry key:

![[HTB Solutions/CDSA/z. images/674aeb7646681a5c8f70e9e6ed8a7889_MD5.jpg]]

Answer: `Yes`

# Skills Assessment

## Question 6

### "After which function in x64dbg should a breakpoint be placed to unveil the decrypted content of the .tmp file? Answer format: C\_\_\_\_\_\_\_\_\_\_t"

From the previously established RDP session, students need to open `x64dbg` as administrator. Then, they need to go to `File` -> `Open` and select the `apple.exe` malware sample to be debugged.

Next, students need to go to the `Symbols` tab at the top, setting a breakpoint on the `ReadFile` function of `kernel32.dll`:

![[HTB Solutions/CDSA/z. images/9a2bd1df5a0cb4409dc6b7b4c4cf3b5b_MD5.jpg]]

Subsequently, students need to return to `CPU` view, and run the program. The disassembler stops at the `ReadFile` API call, and students need to follow the return argument seen in the `Stack Frame`:

![[HTB Solutions/CDSA/z. images/bfd955ac722254f5f6ec1c2acebb2650_MD5.jpg]]

In the disassembled code, students will find the existence of the `CrypDecrypt` function. Therefore, students need to set a breakpoint on the instruction directly below, then run the program once again:

![[HTB Solutions/CDSA/z. images/63566b1915a58edc8d86640119c74bf7_MD5.jpg]]

Students will find the decrypted content of the .tmp file inside the `stack frame`:

![[HTB Solutions/CDSA/z. images/eaaa1956c2d26aa609cddbad33dcf2b8_MD5.jpg]]

Answer: `CryptDecrypt`