# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer

# 25\. Enumerating AWS Cloud Infrastructure

In this Learning Module, we will cover the following Learning Units:

-   Reconnaissance of Cloud Resources on the Internet
-   Reconnaissance via Cloud Service Provider's API
-   Initial IAM Reconnaissance
-   IAM Resources Enumeration

As part of the PEN-200 course, this module will focus on the critical techniques for conducting reconnaissance and enumeration specifically within Amazon Web Services (AWS), one of the most widely used cloud platforms.

_Reconnaissance_, also known as _information gathering_, is typically the first stage in _penetration testing methodologies_ or a [_cyber-attack kill chain_](https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html). This is an important phase because it helps discover all the information, we can find about the target to expand its attack surface.

During the reconnaissance phase, we can describe _enumeration_ as the process of identifying, categorizing, and listing components and resources within the target.

As we progress through the labs, we'll notice that this process has a recursive nature. While conducting the reconnaissance and enumeration phase, we might identify a vulnerability granting us further access to the environment. Once this happens, it becomes necessary to conduct the reconnaissance phase all over again for the newly found assets with our greater understanding and permissions.

In this Module, we'll focus on reconnaissance and enumeration of targets hosted on [_public cloud service providers_](https://csrc.nist.gov/glossary/term/cloud_provider) (CSPs). For our hands-on experience, we'll use [_Amazon Web Services_](https://aws.amazon.com/what-is-aws/) (AWS) as our lab environment.

First, we'll take an external approach, meaning we'll analyze only what is publicly accessible. We'll learn how to identify whether a target has resources hosted on a cloud platform and move on to exploring techniques for enumerating cloud resources from the outside perspective.

Next, we'll shift to an internal perspective, acting as if we've already gained access to the target's environment. We'll explore how to list cloud resources from the inside using the Cloud Service Provider's API.

By understanding and simulating these techniques, we'll also gain valuable insights into how to safeguard cloud environments effectively.

## 25.1. About the Public Cloud Labs

Before we jump in, let's run through a standard disclaimer.

This module uses OffSec's Public Cloud Labs for challenges and walkthroughs. **OffSec's Public Cloud Labs** are a type of lab environment that will complement the learning experience with hands-on practice. In contrast to our more common VM labs found elsewhere in OffSec Learning Modules (in which learners will connect to the lab through a VPN, or via in-browser VMs), learners using the Public Cloud Labs will interact directly with the cloud environment through the Internet.

OffSec believes strongly in the advantages of learning and practicing in a hands-on environment, and we believe that the OffSec Public Cloud Labs represent an excellent opportunity for both new learners and practitioners who want to stay sharp.

Please note the following:

1.  The lab environment should not be used for activities not described or requested in the learning materials you encounter. It is not designed to serve as a playground to test additional items that are out of the scope of the Learning Module.
    
2.  The lab environment should not be used to take action against any asset external to the lab. This is specifically noteworthy because some Modules may describe or even demonstrate attacks against vulnerable cloud deployments for the purpose of describing how those deployments can be secured.
    
3.  Existing rules and requirements against sharing OffSec training materials still apply. Credentials and other details of the lab are not meant to be shared. OffSec monitors activity in the Public Cloud Labs (including resource usage) and monitors for abnormal events that are not related to activities described in the learning modules.
    

Activities that are flagged as suspicious will result in an investigation. If the investigation determines that a student acted outside of the guidelines described above, or otherwise intentionally abused the OffSec Public Cloud Labs, OffSec may choose to rescind that learner's access to the OffSec Public Cloud Labs and/or terminate the learner's account.

Progress between sessions is not saved. Note that a Public Cloud Lab that is restarted will return to its original state. After an hour has elapsed, the Public Cloud Lab will prompt to determine if the session is still active. If there is no response, the lab session will end. Learners can continue to manually extend a session for up to ten hours. The learning material is designed to accommodate the limitations of the environment. No learner is expected or required to complete all of the activities in a Module within a single lab session. Even so, learners may choose to break up their learning into multiple sessions with the labs. We recommend making a note of the series of commands and actions that were completed previously to facilitate the restoration of the lab environment to the state it was in when the learner left. This is especially important when working through complex labs that require multiple actions.

## 25.2. Reconnaissance of Cloud Resources on the Internet

This Learning Unit covers the following Learning Objectives:

-   Perform Domain and Subdomain Reconnaissance
-   Identify Service-specific Domains

The first part of the [_NIST Definition of Cloud Computing Model_](https://nvlpubs.nist.gov/nistpubs/legacy/sp/nistspecialpublication800-145.pdf) states:

Cloud computing is a model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources...

There is also an essential characteristic of this model that states:

Broad network access: Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous _thin_ or _thick client_ platforms (e.g., mobile phones, tablets, laptops, and workstations).

The terms "ubiquitous" and "convenient" in the description, coupled with the "Broad network access" characteristic, introduce an inherent aspect of public accessibility to cloud resources.

The cloud computing model has evolved since that initial definition. We can find cloud resources that are not meant to be publicly accessible by default or at all, such as _network interfaces_, _virtual disks_, etc. These are internal components of bigger resources facing the internet but, nevertheless, we can consider them as cloud resources. Some of those components can even be shared between other users.

In this Module, the attacker's goal during discovery and reconnaissance is to find publicly accessible resources as well as resources that weren't meant to be publicly accessible (typically due to misconfigurations).

In this Learning Unit, we'll discuss techniques for discovering cloud resources accessible on the public network that don't require authenticated interaction with the CSP API.

## 25.2.1. Accessing the Lab

For the hands-on experience in this Module, we'll adopt the role of an _attacker_ during the reconnaissance phase, focusing on a single organization as target. Without any information but the domain name, our initial steps will be to collect all the information we can get.

There are some preparatory steps needed to set up our lab environment found at the end of this section. Deployment will take a few minutes to complete and, once complete, the additional services might take 5-10 minutes to start.

Once the lab finishes its deployment, we'll receive some pieces of information we'll need later while working in the lab.

-   Public DNS IP Address
-   Domain name of the target
-   Credentials for the IAM user _attacker_
    -   ACCESS\_KEY\_ID
    -   SECRET\_ACCESS\_KEY

First, we need to configure the DNS in our local environment to use the public DNS set for this lab.

Because this is a simulated exercise, we will not conduct any action on a real published domain. Instead, we'll be targeting a custom public DNS deployed within the lab. The techniques and tools we'll use apply to any public domain, however. After the lab starts, it will take roughly five minutes for the custom DNS server to start responding. We can confirm that all services have started when we can successfully query the DNS server.

Tip

We should also keep in mind that the public IP address of the DNS server will change every time we restart the lab, and we'll need to run this configuration again.

In our _Kali_ machine, we can check our current DNS server by reading the **/etc/resolv.conf** file.

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 1 - Getting DNS Servers in Our Kali Machine

We need to add a new _nameserver_ line at the beginning of the file so that our DNS queries first go to our lab DNS server. We'll use **nano** to modify the file, as shown below:

```
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```

> Listing 2 - Modifying /etc/resolv.conf to Add a New Nameserver

We can test the configuration with command line tool such as _host_, which is used for performing DNS lookups and is commonly installed by default on _Linux_.

Let's assume **www.offseclab.io** exists in our target domain. We'll first run a DNS lookup specifying the DNS server's public IP address. This will validate that the DNS server is responding as expected.

Next, we'll run a DNS lookup again without specifying a DNS server. The tool will use the system's DNS configuration. This will help confirm that our system configuration is also working as expected.

Tip

Some ISPs restrict customers from querying external DNS servers. If this occurs, the two commands in the listing below will fail. While not common, this can happen. As a workaround, using a mobile device as a hotspot to connect our lab to the internet is an option. In the worst-case scenario, this issue would only affect our ability to work on the 'Domain Reconnaissance' section.

```
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```

> Listing 3 - Testing DNS Configurations in Kali Using host Tool

Finally, we should keep in mind that the configuration we set up in the DNS will not be permanent. The default network configuration in _Kali_ uses _Network Manager_, and it will overwrite the content of the **resolv.conf** file every time we restart the network service or the whole operating system.

When we finish working in our lab, we need to reset our local Kali machine's DNS settings. To do this, we can again edit the **/etc/resolv.conf** file and remove the _nameserver_ entry that we set while configuring the lab. Another easier way is to restart the _NetworkManager_ service, which will return the file to the original state.

```
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

> Listing 4 - Resetting the DNS Settings

We can ensure everything is working as expected by navigating to any public site in the web browser.

For now, we'll start the lab to retrieve the DNS public IP address and configure the network in our local machine to use that secondary DNS server. We'll set aside the user's credentials for now and use them later in the module.

## 25.2.2. Domain and Subdomain Reconnaissance

Let's begin analyzing the target from the attacker's perspective. Currently, all we know about our target is its domain name: **offseclab.io**.

There are several things we can learn by analyzing the domain and the public IP address. In this section, we'll focus mainly on cloud-related information.

Let's begin by getting the _authoritative_ DNS servers, i.e. the name servers that contain all records for this domain. We'll use the **host** command with the **\-t ns** argument to query the _nameserver_ records of the **offseclab.io** domain.

```
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

> Listing 5 - Querying Nameserver Records of offseclab.io Domain

The names are very descriptive, and we can deduce the domain is managed by AWS. We can validate this by running the **whois** command to check the DNS registrar information of those domains. We'll pipe the output to the **grep** command to filter only the line that contains the organization name.

```
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

> Listing 6 - Getting the Registrar Information of awsdns-00.com Domain

Now, we are sure that the **offseclab.io** domain is managed by AWS, very likely using the [_Route53_](https://aws.amazon.com/route53/) service. This doesn't mean the rest of the infrastructure is also hosted in AWS, so we need to keep digging.

Let's continue, using the **host** command again to get the public IP address of the website **www.offseclab.io**.

Tip

The public IP address in the listing below will be different every time we start the lab.

```
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

> Listing 7 - Getting the Public IP address of www.offseclab.io

In the same way as before, we can learn some things by querying the DNS and doing a _reverse_ DNS lookup. We'll use the **host** command again, but this time we'll query the public IP address. We'll also use **whois** to learn more details about the public IP address, paying special attention to the _OrgName_ value.

```
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com

kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```

> Listing 8 - Getting Details of the Public IP Address of the Website

With the whois lookup, we realize that the public IP belongs to Amazon and with the reverse lookup, we learn two things: it's a resource hosted in AWS (**amazonaws.com**) and the resource is an [_Amazon Elastic Compute Cloud_](https://aws.amazon.com/ec2/?nc2=h_ql_prod_fs_ec2) (Amazon EC2) instance.

Tip

The EC2 instance is a virtual machine in the AWS cloud. EC2 is a common service used to host websites, applications, and other services that require a server.

By doing some reconnaissance on the domain, we learned that the resource is hosted in a public CSP. This helps adapt our pentesting methodology and techniques to target the correct cloud environment.

While doing passive reconnaissance around the domain and public IP address, we should also include more [_OSINT_](https://osintframework.com/) research to collect more information about the target. The data we gather during this stage could be useful during later reconnaissance. Because the target in this lab is not a real organization, we won't find more data at this stage, so we'll skip this.

It's worth noticing that this phase should be executed recursively, meaning that we should do the same for other domains, subdomains, and public IP addresses we find.

Finally, we will run an automated tool that will retrieve some information we already have but will also perform a _dictionary attack_ to discover more subdomains. There are many tools that do this. In this lab, we'll use the _dnsenum_ tool that comes with Kali. The only required parameter is the domain name we are going to target, i.e. **offseclab.io**. We'll also add the **\--threads 500** argument to increase the threads that will execute the requests to the DNS, thus speeding up the attack in case of any throttling.

```
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```

> Listing 9 - Using dnsenum to Automate DNS Reconnaissance of offseclab.io Domain

The output confirms the name servers and the public IP address we got before. We also discovered some subdomains. The other two sites are fictional for this lab and don't contain real vulnerabilities, so we don't need to analyze them further in this lab.

Let's wrap up this section by providing a glimpse of what we have learned about the target through reconnaissance:

-   The domain service is hosted in AWS, so it's likely using AWS Route53 service.
-   The domain name resolves to a public IP, which is also provided by AWS, specifically to the EC2 service.
-   This public IP serves several websites including the main site **www.offseclab.io**, meaning they are running inside an EC2 instance.

In the next section, we'll analyze the main site while continuing to perform cloud-related reconnaissance.

#### Labs

1.  What command is used to query the authoritative DNS servers for the domain offseclab.io?

```
A) host -t ns offseclab.io

B) whois offseclab.io

C) dig offseclab.io

D) nslookup offseclab.io
```

Answer