# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer

# 21\. The Metasploit Framework

In this Learning Module, we will cover the following Learning Units:

-   Getting Familiar with Metasploit
-   Using Metasploit Payloads
-   Performing Post-Exploitation with Metasploit
-   Automating Metasploit

As we have worked through previous Modules, it should be clear that locating, working with, and fixing public exploits is difficult. They must be modified to fit each scenario and tested for malicious code. Each uses a unique command-line syntax and there is no standardization in coding practices or languages.

In addition, even in the most basic attack scenarios, there is a variety of post-exploitation tools, auxiliary tools, and attack techniques to consider.

Exploit frameworks aim to address some or all these issues. Although they vary somewhat in form and function, each aims to consolidate and streamline the process of exploitation by offering a variety of exploits, simplifying the usage of these exploits, easing lateral movement, and assisting with the management of compromised infrastructure. Most of these frameworks offer dynamic payload capabilities. This means that for each exploit in the framework, we can choose various payloads to deploy.

Over the past few years, several exploit and post-exploitation frameworks have been developed, including:

-   [_Metasploit_](https://www.metasploit.com/)
-   [_Covenant_](https://github.com/cobbr/Covenant)
-   [_Cobalt Strike_](https://www.cobaltstrike.com/)
-   [_PowerShellEmpire_](https://github.com/BC-SECURITY/Empire)

Each offering some or all these capabilities.

While frameworks such as Cobalt Strike are commercial offerings, the Metasploit Framework (MSF, or simply _Metasploit_) is open-source, frequently updated, and the focus of this Module.

The Metasploit Framework, maintained by [_Rapid7_](https://www.rapid7.com/), is described by its authors as "an advanced platform for developing, testing, and using exploit code". The project initially started off as a [portable network game](https://threatpost.com/qa-hd-moore-metasploit-disclosure-and-ethics-052010/73998/) and has evolved into a powerful tool for penetration testing, exploit development, and vulnerability research. The Framework has slowly but surely become the leading free exploit collection and development framework for security auditors. Metasploit is frequently updated with new exploits and is constantly being improved and further developed by Rapid7 and the security community.

Kali Linux includes the [_metasploit-framework_](https://www.kali.org/tools/metasploit-framework/) package, which contains the open-source elements of the Metasploit project. Newcomers to Metasploit are often overwhelmed by the multitude of features and different use-cases for the tool as it includes components for information gathering, vulnerability research and development, client-side attacks, post-exploitation, and much more.

With such overwhelming capabilities, it's easy to get lost within Metasploit. Fortunately, the framework is well thought out and offers a unified and sensible interface.

In this Module, we will provide a walkthrough of the Metasploit Framework, including features and usage along with some explanation of its inner workings. While we cover Metasploit in particular, we'll discuss various concepts which are true for other exploit frameworks as well. The main goal of this Module is to understand how these frameworks can assist us in a real penetration test.

## 21.1. Getting Familiar with Metasploit

This Learning Unit covers the following Learning Objectives:

-   Set up and navigate Metasploit
-   Use auxiliary modules
-   Leverage exploit modules

In this Learning Unit, we will get familiar with the Metasploit Framework (MSF). We'll start with setting up the environment and navigating through the framework. Then, we'll get familiar with two types of [_modules_](https://docs.rapid7.com/metasploit/modules/). In Metasploit, modules are the primary way of interacting with the framework and are used to perform tasks such as scanning or exploiting a target. First, we'll explore Metasploit's auxiliary modules and how we can use them for tasks such as protocol enumeration and port scanning. Finally, we'll review exploit modules contained in Metasploit.

## 21.1.1. Setup and Work with MSF

Although the Metasploit Framework comes preinstalled on Kali Linux, it doesn't start a database service in its default configuration. While using a database is not mandatory to run Metasploit, there are various compelling reasons to do so, such as storing information about target hosts and keeping track of successful exploitation attempts. Metasploit uses [_PostgreSQL_](https://www.postgresql.org/) as a database service, which is neither active nor enabled on boot time on Kali.

We can start the database service as well as create and initialize the MSF database with **msfdb init**.

```
kali@kali:~$ sudo msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

> Listing 1 - Creating and initializing the Metasploit database

To enable the database service at boot time we can use [**systemctl**](https://en.wikipedia.org/wiki/Systemd).

```
kali@kali:~$ sudo systemctl enable postgresql
Synchronizing state of postgresql.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service â†’ /lib/systemd/system/postgresql.service.
```

> Listing 2 - Enabling the postgresql database service at boot time

Now, let's launch the Metasploit command-line interface with [**msfconsole**](https://docs.rapid7.com/metasploit/msf-overview/).

```
kali@kali:~$ sudo msfconsole
...                                                                              
       =[ metasploit v6.2.20-dev                          ]
+ -- --=[ 2251 exploits - 1187 auxiliary - 399 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use help <command> to learn more 
about any command
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

> Listing 3 - Starting the Metasploit Framework

To hide the banner and version information while starting up, we can add the **\-q** option to the msfconsole command.

Once the Metasploit command-line interface is started, we can verify database connectivity with **db\_status**.

```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

> Listing 4 - Confirming database connectivity

Listing 4 shows that the database is connected, and we are all set up. Now, let's get familiar with the command-line interface of Metasploit and how to use it.

The command-line interface of Metasploit provides numerous commands to navigate and use the framework, divided into [categories](https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/). These categories consist of _Core Commands_, _Module Commands_, _Job Commands_, _Resource Script Commands_, _Database Backend Commands_, _Credentials Backend Commands_, and _Developer Commands_. Throughout this Module, we'll use commands from most of these categories.

We can get a list of all available commands by entering **help**.

```
msf6 > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    ...

Module Commands
===============

    Command       Description
    -------       -----------
    ...
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index

    
Job Commands
============

    Command       Description
    -------       -----------
    ...

Resource Script Commands
========================

    Command       Description
    -------       -----------
    ...

Database Backend Commands
=========================

    Command           Description
    -------           -----------
    ...
    db_nmap           Executes nmap and records the output automatically
    ...
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces

Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database
    
Developer Commands
==================

    Command       Description
    -------       -----------
    ...
```

> Listing 5 Help menu of MSF commands

Before we jump into performing operations within Metasploit, let's discuss one important concept first: _workspaces_. Let's assume we have performed a penetration test and Metasploit stored all information about our target and its infrastructure in the database. When we start the next penetration test, this information still exists in the database. To address this and avoid mixing each assessment's results with results from different assessments, we can use workspaces.

The Metasploit **workspace** command lists all previously created workspaces. We can switch to a workspace by adding the name to the command. To create a new workspace, we must provide the workspace name as argument to **\-a**.

Let's create a workspace named **pen200** where we'll store the results of this section and the next one.

```
msf6 > workspace
* default

msf6 > workspace -a pen200
[*] Added workspace: pen200
[*] Workspace: pen200
```

> Listing 6 - Creating workspace pen200

Once created, Metasploit will use it as a current workspace as shown in listing 6.

Now, let's populate the database and get familiar with some of the _Database Backend Commands_. For this, we'll scan BRUTE2 with **db\_nmap** which is a wrapper to execute Nmap inside Metasploit and save the findings in the database. The command has identical syntax to Nmap:

```
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]

msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 21/tcp   open  ftp?
...
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open  http          Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
```

> Listing 7 - Using db\_nmap to scan BRUTE2

Listing 7 shows the results of the port scan performed with Nmap. As stated earlier, if the database service is running, Metasploit will log findings and information about discovered hosts, services, or credentials in a convenient, accessible database.

To get a list of all discovered hosts up to this point, we can enter **hosts**.

```
msf6 > hosts

Hosts
=====

address         mac  name  os_name       os_flavor  os_sp  purpose  info  comments
-------         ---  ----  -------       ---------  -----  -------  ----  --------
192.168.50.202             Windows 2016                    server
```

> Listing 8 - Display all discovered hosts

In addition, we can enter **services** to display the discovered services from our port scan. We can also filter for a specific port number by providing it as argument for **\-p**.

```
msf6 > services
Services
========

host            port  proto  name           state  info
----            ----  -----  ----           -----  ----
192.168.50.202  21    tcp    ftp            open
192.168.50.202  135   tcp    msrpc          open   Microsoft Windows RPC
192.168.50.202  139   tcp    netbios-ssn    open   Microsoft Windows netbios-ssn
192.168.50.202  445   tcp    microsoft-ds   open
192.168.50.202  3389  tcp    ms-wbt-server  open   Microsoft Terminal Services
192.168.50.202  5357  tcp    http           open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
192.168.50.202  8000  tcp    http           open   Golang net/http server Go-IPFS json-rpc or InfluxDB API

msf6 > services -p 8000
Services
========

host            port  proto  name  state  info
----            ----  -----  ----  -----  ----
192.168.50.202  8000  tcp    http  open   Golang net/http server Go-IPFS json-rpc or InfluxDB API
```

> Listing 9 - Display all discovered services

Listing 9 shows all discovered services up to this point. As we can filter for specific port numbers, we can quickly identify all hosts with a specific service running.

When working on an assessment with numerous target systems, Database Backend Commands are invaluable in identifying important information and discovering potential attack vectors. We can also use the results stored in the database as input to modules, which we'll discuss in the next section.

Before we head into the next section, let's briefly review modules again. As stated, modules are used to perform tasks in Metasploit such as scanning or exploiting a target. The framework includes several thousand modules, divided into categories.

The categories are displayed on the splash screen summary, but we can also view them with the **show -h** command.

```
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits, payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets, actions
msf6 > 
```

> Listing 10 - Help flag for the show command

Listing 10 shows the categories of Metasploit's modules. To activate a module, we need to enter **use** with the module name. The modules all follow a common slash-delimited hierarchical syntax (_module type/os, vendor, app, operation, or protocol/module name_), which makes it easy to explore and use the modules. We'll begin by exploring auxiliary modules in the next section and then dive into exploit modules.

## Resources

Some of the labs require you to start the target machine(s) below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video.

The Metasploit Framework - Setup and Work with MSF - VM #1

#### Labs

1.  What command creates and initializes the MSF database?

Answer